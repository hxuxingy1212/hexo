<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="å¾é‘«"><meta name="copyright" content="å¾é‘«"><meta name="generator" content="Hexo 5.4.2"><meta name="theme" content="hexo-theme-yun"><title>JUCå¹¶å‘ç¼–ç¨‹ | å¾é‘«çš„ç¬”è®°</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/star-markdown-css@0.3.3/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/prism-theme-vars/base.css"><script src="https://fastly.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="preconnect" href="https://fastly.jsdelivr.net/npm/" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"example.com","root":"/","title":"å¾é‘«çš„ç¬”è®°","version":"1.10.6","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"æœç´¢...","empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹: ${query}","hits":"æ‰¾åˆ° ${hits} æ¡ç»“æœ","hits_time":"æ‰¾åˆ° ${hits} æ¡ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰"},"anonymous_image":"https://cdn.yunyoujun.cn/img/avatar/none.jpg","fireworks":{"colors":null},"vendors":{"host":"https://fastly.jsdelivr.net/npm/","darken":"https://fastly.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><meta name="description" content="img {             border: #4da5f5 2px solid;         }   è¿›ç¨‹ä¸çº¿ç¨‹æ¦‚è¿°è¿›ç¨‹ä¸çº¿ç¨‹ è¿›ç¨‹  ç¨‹åºç”±æŒ‡ä»¤å’Œæ•°æ®ç»„æˆï¼Œä½†è¿™äº›æŒ‡ä»¤è¦è¿è¡Œï¼Œæ•°æ®è¦è¯»å†™ï¼Œå°±å¿…é¡»å°†æŒ‡ä»¤åŠ è½½è‡³ CPUï¼Œæ•°æ®åŠ è½½è‡³å†…å­˜ã€‚åœ¨æŒ‡ä»¤è¿è¡Œè¿‡ç¨‹ä¸­è¿˜éœ€è¦ç”¨åˆ°ç£ç›˜ã€ç½‘ç»œç­‰è®¾å¤‡ã€‚è¿›ç¨‹å°±æ˜¯ç”¨æ¥åŠ è½½æŒ‡ä»¤ã€ç®¡ç†å…§å­˜ã€ç®¡ç†T0çš„ å½“ä¸€ä¸ªç¨‹åºè¢«è¿è¡Œï¼Œä»ç£ç›˜åŠ è½½è¿™ä¸ªç¨‹åºçš„ä»£ç è‡³å†…å­˜ï¼Œ">
<meta property="og:type" content="article">
<meta property="og:title" content="JUCå¹¶å‘ç¼–ç¨‹">
<meta property="og:url" content="http://example.com/2022/08/08/JUC/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/index.html">
<meta property="og:site_name" content="å¾é‘«çš„ç¬”è®°">
<meta property="og:description" content="img {             border: #4da5f5 2px solid;         }   è¿›ç¨‹ä¸çº¿ç¨‹æ¦‚è¿°è¿›ç¨‹ä¸çº¿ç¨‹ è¿›ç¨‹  ç¨‹åºç”±æŒ‡ä»¤å’Œæ•°æ®ç»„æˆï¼Œä½†è¿™äº›æŒ‡ä»¤è¦è¿è¡Œï¼Œæ•°æ®è¦è¯»å†™ï¼Œå°±å¿…é¡»å°†æŒ‡ä»¤åŠ è½½è‡³ CPUï¼Œæ•°æ®åŠ è½½è‡³å†…å­˜ã€‚åœ¨æŒ‡ä»¤è¿è¡Œè¿‡ç¨‹ä¸­è¿˜éœ€è¦ç”¨åˆ°ç£ç›˜ã€ç½‘ç»œç­‰è®¾å¤‡ã€‚è¿›ç¨‹å°±æ˜¯ç”¨æ¥åŠ è½½æŒ‡ä»¤ã€ç®¡ç†å…§å­˜ã€ç®¡ç†T0çš„ å½“ä¸€ä¸ªç¨‹åºè¢«è¿è¡Œï¼Œä»ç£ç›˜åŠ è½½è¿™ä¸ªç¨‹åºçš„ä»£ç è‡³å†…å­˜ï¼Œ">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-08_17.41.29.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-09_10.06.22.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2Fpic1.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-09_14.00.14.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-09_14.41.57.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-09_14.42.14.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-09_14.54.28.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-09_16.07.13.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-09_16.02.20.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-09_16.10.25.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-09_16.14.17.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-09_16.15.41.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-09_16.21.07.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-09_16.24.58.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-09_16.29.43.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-09_16.28.11.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-09_14.54.28.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-10_14.00.08.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-10_15.05.51.png ">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-10_16.04.10.png ">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-10_16.06.39.png ">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-10_16.05.49.png ">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-10_16.31.02.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2Fimage-20220802165615796.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2Fimage-20220802165537556.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-11_15.51.19.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-11_15.51.28.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-11_15.51.42.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-08_17.41.29.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-11_17.17.39.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-15_16.06.48.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-15_16.03.20.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-16_09.38.07.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-16_15.35.39.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-16_16.51.13.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-16_16.56.55.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-17_14.44.19.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-23_16.09.29.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-19_09.29.04.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-25_09.25.52.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-25_09.26.12.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-25_14.33.38.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-25_15.35.08.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-24_16.15.22.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-24_16.15.28.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-24_16.18.09.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-24_16.20.31.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-24_16.20.36.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-24_16.26.45.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-24_16.26.57.png">
<meta property="og:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-24_17.00.07.png">
<meta property="article:published_time" content="2022-08-08T05:49:35.197Z">
<meta property="article:modified_time" content="2022-09-21T09:42:45.117Z">
<meta property="article:author" content="å¾é‘«">
<meta property="article:tag" content="java">
<meta property="article:tag" content="JUCå¹¶å‘ç¼–ç¨‹">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-08_17.41.29.png"><script>(function() {
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script></head><body><script src="https://code.iconify.design/2/2.1.1/iconify.min.js"></script><script>// Define global variable
IconifyProviders = {
  // Empty prefix: overwrite default API provider configuration
  '': {
    // Use custom API first, use Iconify public API as backup
    resources: [
        'https://api.iconify.design',
    ],
    // Wait for 1 second before switching API hosts
    rotate: 1000,
  },
};</script><script defer src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="æ–‡ç« ç›®å½•"><span class="icon iconify" data-icon="ri:list-ordered"></span></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="ç«™ç‚¹æ¦‚è§ˆ"><span class="icon iconify" data-icon="ri:passport-line"></span></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="å¾é‘«"><img width="96" loading="lazy" src="/images/touxiang2.jpg" alt="å¾é‘«"><span class="site-author-status" title="ä¸æƒ³ä¸Šå­¦">ğŸ˜­</span></a><div class="site-author-name"><a href="/about/">å¾é‘«</a></div><span class="site-name">å¾é‘«çš„ç¬”è®°</span><sub class="site-subtitle"></sub><div class="site-description">è®°å½•æ¯ä¸€å¤©æ‰€å­¦</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="é¦–é¡µ"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:home-4-line"></span></span></a><div class="site-state-item"><a href="/archives/" title="å½’æ¡£"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:archive-line"></span></span><span class="site-state-item-count">18</span></a></div><div class="site-state-item"><a href="/categories/" title="åˆ†ç±»"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:folder-2-line"></span></span><span class="site-state-item-count">12</span></a></div><div class="site-state-item"><a href="/tags/" title="æ ‡ç­¾"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="site-state-item-count">11</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://yun.yunyoujun.cn" title="æ–‡æ¡£"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:settings-line"></span></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://qun.qq.com/qqweb/qunpro/share?_wv=3&amp;_wwv=128&amp;appChannel=share&amp;inviteCode=28OEdR&amp;appChannel=share&amp;businessType=9&amp;from=246610&amp;biz=ka" title="QQ é¢‘é“ - å°äº‘ä¹‹å®¶" target="_blank" style="color:#12B7F5"><span class="icon iconify" data-icon="ri:qq-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/YunYouJun" title="GitHub" target="_blank" style="color:#6e5494"><span class="icon iconify" data-icon="ri:github-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://cdn.yunyoujun.cn/img/about/white-qrcode-and-search.jpg" title="å¾®ä¿¡" target="_blank" style="color:#1AAD19"><span class="icon iconify" data-icon="ri:wechat-2-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:me@yunyoujun.cn" title="E-Mail" target="_blank" style="color:#8E71C1"><span class="icon iconify" data-icon="ri:mail-line"></span></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/albums/" title="ç›¸å†Œ" style="color:dodgerblue"><span class="icon iconify" data-icon="ri:camera-fill"></span></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><span class="icon iconify" data-icon="ri:contrast-2-line"></span></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">è¿›ç¨‹ä¸çº¿ç¨‹æ¦‚è¿°</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B"><span class="toc-number">1.1.</span> <span class="toc-text">è¿›ç¨‹ä¸çº¿ç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%B6%E5%8F%91%E4%B8%8E%E5%B9%B6%E8%A1%8C"><span class="toc-number">1.2.</span> <span class="toc-text">å¹¶å‘ä¸å¹¶è¡Œ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E4%B8%8E%E5%BC%82%E6%AD%A5"><span class="toc-number">1.3.</span> <span class="toc-text">åŒæ­¥ä¸å¼‚æ­¥</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%95%88%E7%8E%87%E9%97%AE%E9%A2%98"><span class="toc-number">1.4.</span> <span class="toc-text">å¤šçº¿ç¨‹æ•ˆç‡é—®é¢˜</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Java%E7%BA%BF%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">Javaçº¿ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%92%8C%E8%BF%90%E8%A1%8C%E7%BA%BF%E7%A8%8B"><span class="toc-number">2.1.</span> <span class="toc-text">åˆ›å»ºå’Œè¿è¡Œçº¿ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80"><span class="toc-number">2.1.1.</span> <span class="toc-text">æ–¹æ³•ä¸€</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C"><span class="toc-number">2.1.2.</span> <span class="toc-text">æ–¹æ³•äºŒ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%89"><span class="toc-number">2.1.3.</span> <span class="toc-text">æ–¹æ³•ä¸‰</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%BA%BF%E7%A8%8B"><span class="toc-number">2.2.</span> <span class="toc-text">æŸ¥çœ‹çº¿ç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B-API"><span class="toc-number">2.3.</span> <span class="toc-text">çº¿ç¨‹ API</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#API%E6%80%BB%E8%A7%88"><span class="toc-number">2.3.1.</span> <span class="toc-text">APIæ€»è§ˆ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#run%E5%92%8Cstart"><span class="toc-number">2.3.2.</span> <span class="toc-text">runå’Œstart</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sleep%E5%92%8Cyield"><span class="toc-number">2.3.3.</span> <span class="toc-text">sleepå’Œyield</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#join"><span class="toc-number">2.3.4.</span> <span class="toc-text">join</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#interrupt"><span class="toc-number">2.3.5.</span> <span class="toc-text">interrupt</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#park%E6%89%93%E6%96%AD"><span class="toc-number">2.3.6.</span> <span class="toc-text">parkæ‰“æ–­</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%87%E6%97%B6%E6%96%B9%E6%B3%95"><span class="toc-number">2.3.7.</span> <span class="toc-text">è¿‡æ—¶æ–¹æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Daemon%E5%AE%88%E6%8A%A4%E7%BA%BF%E7%A8%8B"><span class="toc-number">2.3.8.</span> <span class="toc-text">Daemonå®ˆæŠ¤çº¿ç¨‹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E7%8A%B6%E6%80%81"><span class="toc-number">2.4.</span> <span class="toc-text">çº¿ç¨‹çŠ¶æ€</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94%E7%A7%8D%E7%8A%B6%E6%80%81"><span class="toc-number">2.4.1.</span> <span class="toc-text">äº”ç§çŠ¶æ€</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AD%E7%A7%8D%E7%8A%B6%E6%80%81"><span class="toc-number">2.4.2.</span> <span class="toc-text">å…­ç§çŠ¶æ€</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E7%AB%A0%E5%B0%8F%E7%BB%93"><span class="toc-number">2.5.</span> <span class="toc-text">æœ¬ç« å°ç»“</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%9E%8B%E4%B9%8B%E7%AE%A1%E7%A8%8B"><span class="toc-number">3.</span> <span class="toc-text">å…±äº«æ¨¡å‹ä¹‹ç®¡ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB%E9%97%AE%E9%A2%98"><span class="toc-number">3.1.</span> <span class="toc-text">å…±äº«é—®é¢˜</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#java%E4%BB%A3%E7%A0%81%E7%9A%84%E4%BD%93%E7%8E%B0"><span class="toc-number">3.1.1.</span> <span class="toc-text">javaä»£ç çš„ä½“ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%B4%E7%95%8C%E5%8C%BA-Critical-Seetion"><span class="toc-number">3.1.2.</span> <span class="toc-text">ä¸´ç•ŒåŒº Critical Seetion</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AB%9E%E6%80%81%E6%9D%A1%E4%BB%B6Race-Condition"><span class="toc-number">3.1.3.</span> <span class="toc-text">ç«æ€æ¡ä»¶Race Condition</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#synchronized"><span class="toc-number">3.2.</span> <span class="toc-text">synchronized</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E5%88%86%E6%9E%90"><span class="toc-number">3.3.</span> <span class="toc-text">çº¿ç¨‹å®‰å…¨åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%98%E9%87%8F%E5%AE%89%E5%85%A8%E5%88%86%E6%9E%90"><span class="toc-number">3.3.1.</span> <span class="toc-text">å˜é‡å®‰å…¨åˆ†æ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E7%B1%BB"><span class="toc-number">3.3.2.</span> <span class="toc-text">å¸¸è§çº¿ç¨‹å®‰å…¨ç±»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90"><span class="toc-number">3.3.3.</span> <span class="toc-text">å®ä¾‹åˆ†æ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Monitor%E6%A6%82%E5%BF%B5"><span class="toc-number">3.4.</span> <span class="toc-text">Monitoræ¦‚å¿µ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E5%A4%B4"><span class="toc-number">3.4.1.</span> <span class="toc-text">å¯¹è±¡å¤´</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Monitor"><span class="toc-number">3.4.2.</span> <span class="toc-text">Monitor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%81%E4%BC%98%E5%8C%96"><span class="toc-number">3.4.3.</span> <span class="toc-text">é”ä¼˜åŒ–</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%94%81"><span class="toc-number">3.4.3.1.</span> <span class="toc-text">è½»é‡çº§é”</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%81%E8%86%A8%E8%83%80"><span class="toc-number">3.4.4.</span> <span class="toc-text">é”è†¨èƒ€</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E6%97%8B%E4%BC%98%E5%8C%96"><span class="toc-number">3.4.5.</span> <span class="toc-text">è‡ªæ—‹ä¼˜åŒ–</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%81%8F%E5%90%91%E9%94%81"><span class="toc-number">3.4.6.</span> <span class="toc-text">åå‘é”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%81%E6%B6%88%E9%99%A4"><span class="toc-number">3.4.7.</span> <span class="toc-text">é”æ¶ˆé™¤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#wait-notify"><span class="toc-number">3.5.</span> <span class="toc-text">wait&#x2F;notify</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E4%B9%8Bwait-notify"><span class="toc-number">3.5.1.</span> <span class="toc-text">åŸç†ä¹‹wait&#x2F;notify</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#API%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.5.2.</span> <span class="toc-text">APIä»‹ç»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wait-notify%E6%AD%A3%E7%A1%AE%E4%BD%BF%E7%94%A8"><span class="toc-number">3.5.3.</span> <span class="toc-text">wait&#x2F;notifyæ­£ç¡®ä½¿ç”¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E6%A8%A1%E5%BC%8F%E4%B9%8B%E4%BF%9D%E6%8A%A4%E6%80%A7%E6%9A%82%E5%81%9C"><span class="toc-number">3.5.4.</span> <span class="toc-text">åŒæ­¥æ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%94%9F%E4%BA%A7%E8%80%85%E8%B4%B9%E8%80%85"><span class="toc-number">3.5.5.</span> <span class="toc-text">å¼‚æ­¥æ¨¡å¼ä¹‹ç”Ÿäº§è€…è´¹è€…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Park-amp-Unpark"><span class="toc-number">3.5.6.</span> <span class="toc-text">Park &amp; Unpark</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2"><span class="toc-number">3.6.</span> <span class="toc-text">çº¿ç¨‹çŠ¶æ€è½¬æ¢</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B4%BB%E8%B7%83%E6%80%A7"><span class="toc-number">3.7.</span> <span class="toc-text">æ´»è·ƒæ€§</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E6%8A%8A%E9%94%81"><span class="toc-number">3.7.1.</span> <span class="toc-text">å¤šæŠŠé”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%BB%E9%94%81"><span class="toc-number">3.7.2.</span> <span class="toc-text">æ­»é”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B4%BB%E9%94%81"><span class="toc-number">3.7.3.</span> <span class="toc-text">æ´»é”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A5%A5%E9%A5%BF%E7%8E%B0%E8%B1%A1"><span class="toc-number">3.7.4.</span> <span class="toc-text">é¥¥é¥¿ç°è±¡</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ReentrantLock"><span class="toc-number">3.8.</span> <span class="toc-text">ReentrantLock</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%AD%E6%B3%95"><span class="toc-number">3.8.1.</span> <span class="toc-text">è¯­æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AF%E9%87%8D%E5%85%A5"><span class="toc-number">3.8.2.</span> <span class="toc-text">å¯é‡å…¥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AF%E6%89%93%E6%96%AD"><span class="toc-number">3.8.3.</span> <span class="toc-text">å¯æ‰“æ–­</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%81%E8%B6%85%E6%97%B6"><span class="toc-number">3.8.4.</span> <span class="toc-text">é”è¶…æ—¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AC%E5%B9%B3%E9%94%81"><span class="toc-number">3.8.5.</span> <span class="toc-text">å…¬å¹³é”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F"><span class="toc-number">3.8.6.</span> <span class="toc-text">æ¡ä»¶å˜é‡</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E6%A8%A1%E5%BC%8F%E4%B9%8B%E9%A1%BA%E5%BA%8F%E6%8E%A7%E5%88%B6"><span class="toc-number">3.9.</span> <span class="toc-text">åŒæ­¥æ¨¡å¼ä¹‹é¡ºåºæ§åˆ¶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%BA%E5%AE%9A%E9%A1%BA%E5%BA%8F%E4%B9%8Bwait-amp-notify"><span class="toc-number">3.9.1.</span> <span class="toc-text">å›ºå®šé¡ºåºä¹‹wait  &amp; notify</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%BA%E5%AE%9A%E9%A1%BA%E5%BA%8F%E4%B9%8Bpark-amp-unpark"><span class="toc-number">3.9.2.</span> <span class="toc-text">å›ºå®šé¡ºåºä¹‹park &amp; unpark</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%A4%E6%9B%BF%E8%BE%93%E5%87%BA%E4%B9%8Bwait-amp-notify"><span class="toc-number">3.9.3.</span> <span class="toc-text">äº¤æ›¿è¾“å‡ºä¹‹wait&amp;notify</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%A4%E6%9B%BF%E8%BE%93%E5%87%BA%E4%B9%8Bawait-amp-signal"><span class="toc-number">3.9.4.</span> <span class="toc-text">äº¤æ›¿è¾“å‡ºä¹‹await&amp;signal</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%A4%E6%9B%BF%E8%BE%93%E5%87%BA%E4%B9%8Bpark-amp-unpark"><span class="toc-number">3.9.5.</span> <span class="toc-text">äº¤æ›¿è¾“å‡ºä¹‹park&amp;unpark</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E7%AB%A0%E5%B0%8F%E7%BB%93-1"><span class="toc-number">3.10.</span> <span class="toc-text">æœ¬ç« å°ç»“</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%BC%8F%E4%B9%8B%E5%86%85%E5%AD%98"><span class="toc-number">4.</span> <span class="toc-text">å…±äº«æ¨¡å¼ä¹‹å†…å­˜</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Java-%E5%85%A7%E5%AD%98%E6%A8%A1%E5%9E%8B"><span class="toc-number">4.1.</span> <span class="toc-text">Java å…§å­˜æ¨¡å‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E6%80%A7"><span class="toc-number">4.2.</span> <span class="toc-text">åŸå­æ€§</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E8%A7%81%E6%80%A7"><span class="toc-number">4.3.</span> <span class="toc-text">å¯è§æ€§</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%80%E4%B8%8D%E5%87%BA%E7%9A%84%E5%BE%AA%E7%8E%AF"><span class="toc-number">4.3.1.</span> <span class="toc-text">é€€ä¸å‡ºçš„å¾ªç¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">4.3.2.</span> <span class="toc-text">åˆ†æ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8volatile%E8%A7%A3%E5%86%B3"><span class="toc-number">4.3.3.</span> <span class="toc-text">ä½¿ç”¨volatileè§£å†³</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8synchronzied%E8%A7%A3%E5%86%B3"><span class="toc-number">4.3.4.</span> <span class="toc-text">ä½¿ç”¨synchronziedè§£å†³</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8lock%E8%A7%A3%E5%86%B3"><span class="toc-number">4.3.5.</span> <span class="toc-text">ä½¿ç”¨lockè§£å†³</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%E5%AF%B9%E6%AF%94"><span class="toc-number">4.3.6.</span> <span class="toc-text">è§£å†³æ–¹æ³•å¯¹æ¯”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%88%E6%AD%A2%E6%A8%A1%E5%BC%8F%E4%B9%8B%E4%B8%A4%E9%98%B6%E6%AE%B5%E7%BB%88%E6%AD%A2%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.3.7.</span> <span class="toc-text">ç»ˆæ­¢æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E6%A8%A1%E5%BC%8F%E4%B9%8B-%E7%8A%B9%E8%B1%AB%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.3.8.</span> <span class="toc-text">åŒæ­¥æ¨¡å¼ä¹‹ çŠ¹è±«æ¨¡å¼</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%89%E5%BA%8F%E6%80%A7"><span class="toc-number">4.4.</span> <span class="toc-text">æœ‰åºæ€§</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98"><span class="toc-number">4.4.1.</span> <span class="toc-text">é—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E4%BB%A4%E9%87%8D%E6%8E%92%E4%BC%98%E5%8C%96"><span class="toc-number">4.4.2.</span> <span class="toc-text">æŒ‡ä»¤é‡æ’ä¼˜åŒ–</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#volatile%E5%8E%9F%E7%90%86"><span class="toc-number">4.4.3.</span> <span class="toc-text">volatileåŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%9D%E8%AF%81%E5%8F%AF%E8%A7%81%E6%80%A7"><span class="toc-number">4.4.3.1.</span> <span class="toc-text">ä¿è¯å¯è§æ€§</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%9D%E8%AF%81%E6%9C%89%E5%BA%8F%E6%80%A7"><span class="toc-number">4.4.3.2.</span> <span class="toc-text">ä¿è¯æœ‰åºæ€§</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%B1%8F%E9%9A%9C"><span class="toc-number">4.4.3.3.</span> <span class="toc-text">å†…å­˜å±éšœ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8C%E9%87%8D%E6%A3%80%E6%9F%A5%E9%94%81%E7%9A%84%E5%8D%95%E4%BE%8B"><span class="toc-number">4.4.4.</span> <span class="toc-text">åŒé‡æ£€æŸ¥é”çš„å•ä¾‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E6%9C%89%E5%BA%8F%E6%80%A7"><span class="toc-number">4.4.5.</span> <span class="toc-text">å¤„ç†æœ‰åºæ€§</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#happens-before"><span class="toc-number">4.4.6.</span> <span class="toc-text">happens-before</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%A0%E9%A2%98"><span class="toc-number">4.5.</span> <span class="toc-text">ä¹ é¢˜</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#balking-%E6%A8%A1%E5%BC%8F%E4%B9%A0%E9%A2%98"><span class="toc-number">4.5.1.</span> <span class="toc-text">balking æ¨¡å¼ä¹ é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E5%8D%95%E4%BE%8B%E4%B9%A0%E9%A2%98"><span class="toc-number">4.5.2.</span> <span class="toc-text">çº¿ç¨‹å®‰å…¨å•ä¾‹ä¹ é¢˜</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E7%AB%A0%E5%B0%8F%E7%BB%93-2"><span class="toc-number">4.6.</span> <span class="toc-text">æœ¬ç« å°ç»“</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%BC%8F%E4%B9%8B%E6%97%A0%E9%94%81"><span class="toc-number">5.</span> <span class="toc-text">å…±äº«æ¨¡å¼ä¹‹æ— é”</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CAS-%E4%B8%8E-volatile"><span class="toc-number">5.1.</span> <span class="toc-text">CAS ä¸ volatile</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E5%9F%BA%E6%9C%AC%E7%B1%BB"><span class="toc-number">5.2.</span> <span class="toc-text">åŸå­åŸºæœ¬ç±»</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E5%BC%95%E7%94%A8"><span class="toc-number">5.3.</span> <span class="toc-text">åŸå­å¼•ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AtomicReference"><span class="toc-number">5.3.1.</span> <span class="toc-text">AtomicReference</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AtomicStampedReference"><span class="toc-number">5.3.2.</span> <span class="toc-text">AtomicStampedReference</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AtomicMarkableReference"><span class="toc-number">5.3.3.</span> <span class="toc-text">AtomicMarkableReference</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E6%95%B0%E7%BB%84"><span class="toc-number">5.4.</span> <span class="toc-text">åŸå­æ•°ç»„</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">5.4.1.</span> <span class="toc-text">é€šç”¨æ–¹æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8B%AC%E6%9C%89%E6%96%B9%E6%B3%95"><span class="toc-number">5.4.2.</span> <span class="toc-text">ç‹¬æœ‰æ–¹æ³•</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5%E6%9B%B4%E6%96%B0%E5%99%A8"><span class="toc-number">5.5.</span> <span class="toc-text">å­—æ®µæ›´æ–°å™¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E7%B4%AF%E5%8A%A0%E5%99%A8"><span class="toc-number">5.6.</span> <span class="toc-text">åŸå­ç´¯åŠ å™¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Unsafe"><span class="toc-number">5.7.</span> <span class="toc-text">**Unsafe **</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E7%AB%A0%E5%B0%8F%E7%BB%93-3"><span class="toc-number">5.8.</span> <span class="toc-text">æœ¬ç« å°ç»“</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%9E%8B%E4%B9%8B%E4%B8%8D%E5%8F%AF%E5%8F%98"><span class="toc-number">6.</span> <span class="toc-text">å…±äº«æ¨¡å‹ä¹‹ä¸å¯å˜</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8D%E5%8F%AF%E5%8F%98%E7%B1%BB%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">6.1.</span> <span class="toc-text">ä¸å¯å˜ç±»çš„ä½¿ç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8D%E5%8F%AF%E5%8F%98%E7%B1%BB%E8%AE%BE%E8%AE%A1"><span class="toc-number">6.2.</span> <span class="toc-text">ä¸å¯å˜ç±»è®¾è®¡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F"><span class="toc-number">6.3.</span> <span class="toc-text">äº«å…ƒæ¨¡å¼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A0%E7%8A%B6%E6%80%81%E7%B1%BB%E8%AE%BE%E8%AE%A1"><span class="toc-number">6.4.</span> <span class="toc-text">æ— çŠ¶æ€ç±»è®¾è®¡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E7%AB%A0%E5%B0%8F%E7%BB%93-4"><span class="toc-number">6.5.</span> <span class="toc-text">æœ¬ç« å°ç»“</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">7.</span> <span class="toc-text">çº¿ç¨‹æ± </span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">7.1.</span> <span class="toc-text">è‡ªå®šä¹‰çº¿ç¨‹æ± </span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">7.1.1.</span> <span class="toc-text">é˜»å¡é˜Ÿåˆ—çš„å®ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%AE%9E%E7%8E%B0"><span class="toc-number">7.1.2.</span> <span class="toc-text">çº¿ç¨‹æ± å®ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B6%85%E6%97%B6%E8%8E%B7%E5%8F%96"><span class="toc-number">7.1.3.</span> <span class="toc-text">è¶…æ—¶è·å–</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B6%85%E6%97%B6%E6%B7%BB%E5%8A%A0"><span class="toc-number">7.1.4.</span> <span class="toc-text">è¶…æ—¶æ·»åŠ </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%92%E7%BB%9D%E7%AD%96%E7%95%A5"><span class="toc-number">7.1.5.</span> <span class="toc-text">æ‹’ç»ç­–ç•¥</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ThreadPoolExecutor"><span class="toc-number">7.2.</span> <span class="toc-text">ThreadPoolExecutor</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%8A%B6%E6%80%81"><span class="toc-number">7.2.1.</span> <span class="toc-text">çº¿ç¨‹æ± çŠ¶æ€</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95"><span class="toc-number">7.2.2.</span> <span class="toc-text">çº¿ç¨‹æ± æ„é€ æ–¹æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%BA%E5%AE%9A%E5%A4%A7%E5%B0%8F%E7%BA%BF%E7%A8%8B"><span class="toc-number">7.2.3.</span> <span class="toc-text">å›ºå®šå¤§å°çº¿ç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%A6%E7%BC%93%E5%86%B2%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">7.2.4.</span> <span class="toc-text">å¸¦ç¼“å†²çº¿ç¨‹æ± </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E7%BA%BF%E7%A8%8B%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">7.2.5.</span> <span class="toc-text">å•çº¿ç¨‹çº¿ç¨‹æ± </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%90%E4%BA%A4%E4%BB%BB%E5%8A%A1"><span class="toc-number">7.2.6.</span> <span class="toc-text">æäº¤ä»»åŠ¡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E6%9D%9F%E4%BB%BB%E5%8A%A1"><span class="toc-number">7.2.7.</span> <span class="toc-text">ç»“æŸä»»åŠ¡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E5%AE%83%E6%96%B9%E6%B3%95"><span class="toc-number">7.2.8.</span> <span class="toc-text">å…¶å®ƒæ–¹æ³•</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E6%A8%A1%E5%BC%8F%E4%B9%8B%E5%B7%A5%E4%BD%9C%E7%BA%BF%E7%A8%8B"><span class="toc-number">7.3.</span> <span class="toc-text">å¼‚æ­¥æ¨¡å¼ä¹‹å·¥ä½œçº¿ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A5%A5%E9%A5%BF%E7%8E%B0%E8%B1%A1-1"><span class="toc-number">7.3.1.</span> <span class="toc-text">é¥¥é¥¿ç°è±¡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">7.3.2.</span> <span class="toc-text">ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± </span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Fork-Join"><span class="toc-number">7.4.</span> <span class="toc-text">Fork&#x2F;Join</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-number">7.4.1.</span> <span class="toc-text">æ¦‚å¿µ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-number">7.4.2.</span> <span class="toc-text">ä½¿ç”¨</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#J-U-C"><span class="toc-number">8.</span> <span class="toc-text">J.U.C</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E9%9B%86%E5%90%88%E7%B1%BB%E6%A6%82%E8%BF%B0"><span class="toc-number">8.1.</span> <span class="toc-text">çº¿ç¨‹å®‰å…¨é›†åˆç±»æ¦‚è¿°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%81%97%E7%95%99%E7%9A%84%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E9%9B%86"><span class="toc-number">8.1.1.</span> <span class="toc-text">é—ç•™çš„çº¿ç¨‹å®‰å…¨é›†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Collections%E8%A3%85%E9%A5%B0%E7%9A%84%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E9%9B%86%E5%90%88"><span class="toc-number">8.1.2.</span> <span class="toc-text">ä½¿ç”¨Collectionsè£…é¥°çš„çº¿ç¨‹å®‰å…¨é›†åˆ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#java-util-concurrent"><span class="toc-number">8.1.3.</span> <span class="toc-text">java.util.concurrent.*</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AQS"><span class="toc-number">8.2.</span> <span class="toc-text">AQS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ReentrantLock-1"><span class="toc-number">8.3.</span> <span class="toc-text">ReentrantLock</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%81%E9%87%8D%E5%85%A5%E5%8E%9F%E7%90%86"><span class="toc-number">8.3.1.</span> <span class="toc-text">é”é‡å…¥åŸç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AF%E6%89%93%E6%96%AD%E5%8E%9F%E7%90%86"><span class="toc-number">8.3.2.</span> <span class="toc-text">å¯æ‰“æ–­åŸç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AC%E5%B9%B3%E9%94%81%E5%8E%9F%E7%90%86"><span class="toc-number">8.3.3.</span> <span class="toc-text">å…¬å¹³é”åŸç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F%E5%8E%9F%E7%90%86"><span class="toc-number">8.3.4.</span> <span class="toc-text">æ¡ä»¶å˜é‡åŸç†</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%BB%E5%86%99%E9%94%81"><span class="toc-number">8.4.</span> <span class="toc-text">è¯»å†™é”</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">8.4.1.</span> <span class="toc-text">æ³¨æ„äº‹é¡¹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BB%E5%86%99%E9%94%81%E5%8E%9F%E7%90%86"><span class="toc-number">8.4.2.</span> <span class="toc-text">è¯»å†™é”åŸç†</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#stampedlock"><span class="toc-number">8.5.</span> <span class="toc-text">stampedlock</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Semaphore"><span class="toc-number">8.6.</span> <span class="toc-text">Semaphore</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Semaphore-%E5%BA%94%E7%94%A8"><span class="toc-number">8.6.1.</span> <span class="toc-text">Semaphore åº”ç”¨</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CountdownLatch"><span class="toc-number">8.7.</span> <span class="toc-text">CountdownLatch</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8"><span class="toc-number">8.7.1.</span> <span class="toc-text">åº”ç”¨</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CyclicBarrier"><span class="toc-number">8.8.</span> <span class="toc-text">CyclicBarrier</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ConcurrentHashMap"><span class="toc-number">9.</span> <span class="toc-text">ConcurrentHashMap</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E6%AF%94"><span class="toc-number">9.1.</span> <span class="toc-text">å¯¹æ¯”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hashtable"><span class="toc-number">9.2.</span> <span class="toc-text">hashtable</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#V1-7"><span class="toc-number">9.3.</span> <span class="toc-text">V1.7</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#V1-8"><span class="toc-number">9.4.</span> <span class="toc-text">V1.8</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LinkedBlockingQueue"><span class="toc-number">9.5.</span> <span class="toc-text">LinkedBlockingQueue</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A5%E9%98%9F%E5%87%BA%E9%98%9F%E5%8E%9F%E7%90%86"><span class="toc-number">9.5.1.</span> <span class="toc-text">å…¥é˜Ÿå‡ºé˜ŸåŸç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E9%94%81%E5%88%86%E6%9E%90"><span class="toc-number">9.5.2.</span> <span class="toc-text">åŠ é”åˆ†æ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E6%AF%94%E8%BE%83"><span class="toc-number">9.5.3.</span> <span class="toc-text">æ€§èƒ½æ¯”è¾ƒ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConcurrentLinkedQueue"><span class="toc-number">9.6.</span> <span class="toc-text">ConcurrentLinkedQueue</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CopyOnWriteArrayList"><span class="toc-number">9.7.</span> <span class="toc-text">CopyOnWriteArrayList</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ThreadLocal"><span class="toc-number">10.</span> <span class="toc-text">ThreadLocal</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E9%80%9A%E4%BF%A1"><span class="toc-number">11.</span> <span class="toc-text">çº¿ç¨‹é€šä¿¡</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CompletableFuture"><span class="toc-number">12.</span> <span class="toc-text">CompletableFuture</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Future%E6%8E%A5%E5%8F%A3"><span class="toc-number">12.1.</span> <span class="toc-text">Futureæ¥å£</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Futurntask"><span class="toc-number">12.2.</span> <span class="toc-text">Futurntask</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CompletableFuture-1"><span class="toc-number">12.3.</span> <span class="toc-text">CompletableFuture</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">12.3.1.</span> <span class="toc-text">ä»‹ç»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CompletionStage%E6%8E%A5%E5%8F%A3"><span class="toc-number">12.3.2.</span> <span class="toc-text">CompletionStageæ¥å£</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CompletableFuture%E4%BD%BF%E7%94%A8"><span class="toc-number">12.3.3.</span> <span class="toc-text">CompletableFutureä½¿ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA"><span class="toc-number">12.3.3.1.</span> <span class="toc-text">åˆ›å»º</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-number">12.3.3.2.</span> <span class="toc-text">åŸºæœ¬ä½¿ç”¨</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#get%E5%92%8Cjoin%E5%8C%BA%E5%88%AB"><span class="toc-number">12.3.3.3.</span> <span class="toc-text">getå’ŒjoinåŒºåˆ«</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%81%E5%BC%8F%E7%BC%96%E7%A8%8B-ComletableFuture%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-number">12.3.3.4.</span> <span class="toc-text">æµå¼ç¼–ç¨‹+ComletableFutureæ€§èƒ½ä¼˜åŒ–</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#API"><span class="toc-number">12.3.3.5.</span> <span class="toc-text">API</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#0078E7;"><link itemprop="mainEntityOfPage" href="http://example.com/2022/08/08/JUC/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="å¾é‘«"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="å¾é‘«çš„ç¬”è®°"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">JUCå¹¶å‘ç¼–ç¨‹</h1><div class="post-meta"><div class="post-time"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-line"></span></span> <time title="åˆ›å»ºæ—¶é—´ï¼š2022-08-08 13:49:35" itemprop="dateCreated datePublished" datetime="2022-08-08T13:49:35+08:00">2022-08-08</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-2-line"></span></span> <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-09-21 17:42:45" itemprop="dateModified" datetime="2022-09-21T17:42:45+08:00">2022-09-21</time></div><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><span class="icon iconify" data-icon="ri:folder-line"></span></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/Java/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">Java</span></a></span> > <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/Java/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">JUCå¹¶å‘ç¼–ç¨‹</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/java/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="tag-name">java</span></a><a class="tag-item" href="/tags/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="tag-name">JUCå¹¶å‘ç¼–ç¨‹</span></a></span></div><div class="post-author"><span class="author-name">å¾é‘«</span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><style>
        img {
            border: #4da5f5 2px solid;
        }
</style>

<h1 id="è¿›ç¨‹ä¸çº¿ç¨‹æ¦‚è¿°"><a href="#è¿›ç¨‹ä¸çº¿ç¨‹æ¦‚è¿°" class="headerlink" title="è¿›ç¨‹ä¸çº¿ç¨‹æ¦‚è¿°"></a><strong>è¿›ç¨‹ä¸çº¿ç¨‹æ¦‚è¿°</strong></h1><h2 id="è¿›ç¨‹ä¸çº¿ç¨‹"><a href="#è¿›ç¨‹ä¸çº¿ç¨‹" class="headerlink" title="è¿›ç¨‹ä¸çº¿ç¨‹"></a><strong>è¿›ç¨‹ä¸çº¿ç¨‹</strong></h2><blockquote>
<p><strong>è¿›ç¨‹</strong></p>
<ul>
<li>ç¨‹åºç”±æŒ‡ä»¤å’Œæ•°æ®ç»„æˆï¼Œä½†è¿™äº›æŒ‡ä»¤è¦è¿è¡Œï¼Œæ•°æ®è¦è¯»å†™ï¼Œå°±å¿…é¡»å°†æŒ‡ä»¤åŠ è½½è‡³ CPUï¼Œæ•°æ®åŠ è½½è‡³å†…å­˜ã€‚åœ¨æŒ‡ä»¤è¿è¡Œè¿‡ç¨‹ä¸­è¿˜éœ€è¦ç”¨åˆ°ç£ç›˜ã€ç½‘ç»œç­‰è®¾å¤‡ã€‚è¿›ç¨‹å°±æ˜¯ç”¨æ¥åŠ è½½æŒ‡ä»¤ã€ç®¡ç†å…§å­˜ã€ç®¡ç†T0çš„</li>
<li>å½“ä¸€ä¸ªç¨‹åºè¢«è¿è¡Œï¼Œä»ç£ç›˜åŠ è½½è¿™ä¸ªç¨‹åºçš„ä»£ç è‡³å†…å­˜ï¼Œè¿™æ—¶å°±å¼€å¯äº†ä¸€ä¸ªè¿›ç¨‹ã€‚</li>
<li>è¿›ç¨‹å°±å¯ä»¥è§†ä¸ºç¨‹åºçš„ä¸€ä¸ªå®ä¾‹ã€‚å¤§éƒ¨åˆ†ç¨‹åºå¯ä»¥åŒæ—¶è¿è¡Œå¤šä¸ªå®ä¾‹è¿›ç¨‹ï¼ˆä¾‹å¦‚è®°äº‹æœ¬ã€ç”»å›¾ã€æµè§ˆå™¨ç­‰ï¼‰ï¼Œä¹Ÿæœ‰çš„ç¨‹åºåªèƒ½å¯åŠ¨ä¸€ä¸ªå®ä¾‹è¿›ç¨‹ï¼ˆä¾‹å¦‚ç½‘æ˜“äº‘éŸ³ä¹ã€360 å®‰å…¨å«å£«ç­‰ï¼‰</li>
</ul>
</blockquote>
<blockquote>
<p><strong>çº¿ç¨‹</strong></p>
<ul>
<li>ä¸€ä¸ªè¿›ç¨‹ä¹‹å†…å¯ä»¥åˆ†ä¸ºä¸€åˆ°å¤šä¸ªçº¿ç¨‹ã€‚</li>
<li>ä¸€ä¸ªçº¿ç¨‹å°±æ˜¯ä¸€ä¸ªæŒ‡ä»¤æµï¼Œå°†æŒ‡ä»¤æµä¸­çš„ä¸€æ¡æ¡æŒ‡ä»¤ä»¥ä¸€å®šçš„é¡ºåºäº¤ç»™ CPU æ‰§è¡Œ</li>
<li>Java ä¸­ï¼Œçº¿ç¨‹ä½œä¸ºæœ€å°è°ƒåº¦å•ä½ï¼Œè¿›ç¨‹ä½œä¸ºèµ„æºåˆ†é…çš„æœ€å°å•ä½ã€‚åœ¨ windows ä¸­è¿›ç¨‹æ˜¯ä¸æ´»åŠ¨çš„ï¼Œåªæ˜¯ä½œä¸ºçº¿ç¨‹çš„å®¹å™¨</li>
</ul>
</blockquote>
<blockquote>
<p><strong>äºŒè€…å¯¹æ¯”</strong></p>
<ul>
<li>è¿›ç¨‹åŸºæœ¬ä¸Šç›¸äº’ç‹¬ç«‹çš„ï¼Œè€Œçº¿ç¨‹å­˜åœ¨äºè¿›ç¨‹å†…ï¼Œæ˜¯è¿›ç¨‹çš„ä¸€ä¸ªå­é›†</li>
<li>è¿›ç¨‹æ‹¥æœ‰å…±äº«çš„èµ„æºï¼Œå¦‚å†…å­˜ç©ºé—´ç­‰ï¼Œä¾›å…¶å†…éƒ¨çš„çº¿ç¨‹å…±äº«</li>
<li>è¿›ç¨‹é—´é€šä¿¡è¾ƒä¸ºå¤æ‚</li>
<li>åŒä¸€å°è®¡ç®—æœºçš„è¿›ç¨‹é€šä¿¡ç§°ä¸º IPC (Inter-process communication)</li>
<li>ä¸åŒè®¡ç®—æœºä¹‹é—´çš„è¿›ç¨‹é€šä¿¡ï¼Œéœ€è¦é€šè¿‡ç½‘ç»œï¼Œå¹¶éµå®ˆå…±åŒçš„åè®®ï¼Œä¾‹å¦‚ HTTP</li>
<li>çº¿ç¨‹é€šä¿¡ç›¸å¯¹ç®€å•ï¼Œå› ä¸ºå®ƒä»¬å…±äº«è¿›ç¨‹å†…çš„å†…å­˜ï¼Œä¸€ä¸ªä¾‹å­æ˜¯å¤šä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®åŒä¸€ä¸ªå…±äº«å˜é‡</li>
<li>çº¿ç¨‹æ›´è½»é‡ï¼Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æˆæœ¬ä¸€èˆ¬ä¸Šè¦æ¯”è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ä½</li>
</ul>
</blockquote>
<h2 id="å¹¶å‘ä¸å¹¶è¡Œ"><a href="#å¹¶å‘ä¸å¹¶è¡Œ" class="headerlink" title="å¹¶å‘ä¸å¹¶è¡Œ"></a>å¹¶å‘ä¸å¹¶è¡Œ</h2><table>
    <tr>
        <td>å¹¶å‘(concurrentï¼‰æ˜¯åŒä¸€æ—¶é—´åº”å¯¹å¤šä»¶äº‹æƒ…çš„èƒ½åŠ›</td>
        <td>å¹¶è¡Œï¼ˆparallelï¼‰æ˜¯åŒä¸€æ—¶é—´åŠ¨æ‰‹åšå¤šä»¶äº‹æƒ…çš„èƒ½åŠ›</td>
    </tr>
    <tr>
        <td style="width:35%"><img
                src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/image-20220808113518496.png"></td>
        <td style="width:35%"><img
                src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/image-20220808134702662.png"></td>
    </tr>
</table>

<h2 id="åŒæ­¥ä¸å¼‚æ­¥"><a href="#åŒæ­¥ä¸å¼‚æ­¥" class="headerlink" title="åŒæ­¥ä¸å¼‚æ­¥"></a><strong>åŒæ­¥ä¸å¼‚æ­¥</strong></h2><p>ä»æ–¹æ³•è°ƒç”¨çš„è§’åº¦æ¥è®²ï¼Œå¦‚æœ</p>
<ul>
<li>éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œæ‰èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯åŒæ­¥</li>
<li>ä¸éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œå°±èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯å¼‚æ­¥</li>
</ul>
<blockquote>
<p>æ³¨æ„ï¼šåŒæ­¥åœ¨å¤šçº¿ç¨‹ä¸­è¿˜æœ‰å¦å¤–ä¸€å±‚æ„æ€ï¼Œæ˜¯è®©å¤šä¸ªçº¿ç¨‹æ­¥è°ƒä¸€è‡´    </p>
</blockquote>
<h2 id="å¤šçº¿ç¨‹æ•ˆç‡é—®é¢˜"><a href="#å¤šçº¿ç¨‹æ•ˆç‡é—®é¢˜" class="headerlink" title="å¤šçº¿ç¨‹æ•ˆç‡é—®é¢˜"></a><strong>å¤šçº¿ç¨‹æ•ˆç‡é—®é¢˜</strong></h2><ul>
<li>å•æ ¸ cpuä¸‹ï¼Œå¤šçº¿ç¨‹ä¸èƒ½å®é™…æé«˜ç¨‹åºè¿è¡Œæ•ˆç‡ï¼Œåªæ˜¯ä¸ºäº†èƒ½å¤Ÿåœ¨ä¸åŒçš„ä»»åŠ¡ä¹‹é—´åˆ‡æ¢ï¼Œä¸åŒçº¿ç¨‹è½®æµä½¿ç”¨cpuï¼Œä¸è‡³äºä¸€ä¸ªçº¿ç¨‹æ€»å ç”¨ cpuï¼Œåˆ«çš„çº¿ç¨‹æ²¡æ³•å¹²æ´»</li>
<li>å¤šæ ¸ cpu å¯ä»¥å¹¶è¡Œè·‘å¤šä¸ªçº¿ç¨‹ï¼Œä½†èƒ½å¦æé«˜ç¨‹åºè¿è¡Œæ•ˆç‡è¿˜æ˜¯è¦åˆ†æƒ…å†µçš„æœ‰äº›ä»»åŠ¡ï¼Œç»è¿‡ç²¾å¿ƒè®¾è®¡ï¼Œå°†ä»»åŠ¡æ‹†åˆ†ï¼Œå¹¶è¡Œæ‰§è¡Œï¼Œå½“ç„¶å¯ä»¥æé«˜ç¨‹åºçš„è¿è¡Œæ•ˆç‡ã€‚ä½†ä¸æ˜¯æ‰€æœ‰è®¡ç®—ä»»åŠ¡éƒ½èƒ½æ‹†åˆ†ï¼ˆå‚è€ƒåæ–‡çš„ã€é˜¿å§†è¾¾å°”å®šå¾‹ã€‘ï¼‰ä¹Ÿä¸æ˜¯æ‰€æœ‰ä»»åŠ¡éƒ½éœ€è¦æ‹†åˆ†ï¼Œä»»åŠ¡çš„ç›®çš„å¦‚æœä¸åŒï¼Œè°ˆæ‹†åˆ†å’Œæ•ˆç‡æ²¡å•¥æ„ä¹‰</li>
<li>IO æ“ä½œä¸å ç”¨ cpuï¼Œåªæ˜¯æˆ‘ä»¬ä¸€èˆ¬æ‹·è´æ–‡ä»¶ä½¿ç”¨çš„æ˜¯ã€é˜»å¡10ã€‘ï¼Œè¿™æ—¶ç›¸å½“äºçº¿ç¨‹è™½ç„¶ä¸ç”¨ epuï¼Œä½†éœ€è¦ä¸€ç›´ç­‰å¾… 10 ç»“æŸï¼Œæ²¡èƒ½å……åˆ†åˆ©ç”¨çº¿ç¨‹ã€‚æ‰€ä»¥æ‰æœ‰åé¢çš„ã€éé˜»å¡10ã€‘ å’Œã€å¼‚æ­¥ IOã€‘ä¼˜åŒ– </li>
</ul>
<h1 id="Javaçº¿ç¨‹"><a href="#Javaçº¿ç¨‹" class="headerlink" title="Javaçº¿ç¨‹"></a><strong>Javaçº¿ç¨‹</strong></h1><h2 id="åˆ›å»ºå’Œè¿è¡Œçº¿ç¨‹"><a href="#åˆ›å»ºå’Œè¿è¡Œçº¿ç¨‹" class="headerlink" title="åˆ›å»ºå’Œè¿è¡Œçº¿ç¨‹"></a><strong>åˆ›å»ºå’Œè¿è¡Œçº¿ç¨‹</strong></h2><h3 id="æ–¹æ³•ä¸€"><a href="#æ–¹æ³•ä¸€" class="headerlink" title="æ–¹æ³•ä¸€"></a><strong>æ–¹æ³•ä¸€</strong></h3><p><strong>ä½¿ç”¨ThreadåŒ¿åå†…éƒ¨ç±»åˆ›å»º</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public class day01 &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        Thread thread = new Thread(()-&gt;&#123;</span><br><span class="line">            System.out.println(&quot;åŒ¿åå†…éƒ¨ç±»åˆ›å»ºçº¿ç¨‹&quot;);</span><br><span class="line">        &#125;);</span><br><span class="line">        thread.setName(&quot;T1&quot;);</span><br><span class="line">        thread.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ–¹æ³•äºŒ"><a href="#æ–¹æ³•äºŒ" class="headerlink" title="æ–¹æ³•äºŒ"></a><strong>æ–¹æ³•äºŒ</strong></h3><p>ä½¿ç”¨ Runnable é…åˆ Thread<br>æŠŠã€çº¿ç¨‹ã€‘å’Œã€ä»»åŠ¡ã€‘ï¼ˆè¦æ‰§è¡Œçš„ä»£ç ï¼‰åˆ†å¼€<br>Thread ä»£è¡¨çº¿ç¨‹<br>Runnable å¯è¿è¡Œçš„ä»»åŠ¡ï¼ˆçº¿ç¨‹è¦æ‰§è¡Œçš„ä»£ç ï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public class day01 &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        Runnable runnable =new Runnable() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">                System.out.println(&quot;ä½¿ç”¨Runnableè¾…åŠ©Threadåˆ›å»ºçº¿ç¨‹&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        Thread thread = new Thread(runnable,&quot;T1&quot;);</span><br><span class="line">        thread.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>lambdaç®€åŒ–</strong></p>
<blockquote>
<p>å¸¦æœ‰@FunctionalInterfaceæ³¨è§£çš„ç±»å¯ä»¥ä½¿ç”¨lambdaç®€åŒ–</p>
</blockquote>
<p><strong>æ–¹æ³•ä¸€å’Œæ–¹æ³•äºŒçš„åº•å±‚åŸç†</strong></p>
<blockquote>
<p>æ–¹æ³•ä¸€å®é™…ä¸Šé‡å†™äº†Threadçš„runæ–¹æ³•ï¼Œè°ƒç”¨startä¼šè¿è¡Œè¿™ä¸ªrunæ–¹æ³•<br>æ–¹æ³•äºŒå®é™…ä¸Šåœ¨æ„é€ æ–¹æ³•é‡Œå°†runableå¯¹è±¡ç»™äº†Threadçš„ä¸€ä¸ªæˆå‘˜å˜é‡ï¼Œå¹¶ä¸”runæ–¹æ³•é‡Œä¼šåˆ¤æ–­æ˜¯å¦æœ‰è¿™ä¸ªå¯¹è±¡ï¼Œå¦‚æœæœ‰è°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„runæ–¹æ³•</p>
</blockquote>
<p><strong>å°ç»“</strong></p>
<ul>
<li>æ–¹æ³•1æ˜¯æŠŠçº¿ç¨‹å’Œä»»åŠ¡åˆå¹¶åœ¨äº†ä¸€èµ·ï¼Œæ–¹æ³•2æ˜¯æŠŠçº¿ç¨‹å’Œä»»åŠ¡åˆ†å¼€äº†</li>
<li>ç”¨Runnable æ›´å®¹æ˜“ä¸çº¿ç¨‹æ± ç­‰é«˜çº§ API é…åˆ</li>
<li>ç”¨ Runable è®©ä»»åŠ¡ç±»è„±ç¦»äº† Thread ç»§æ‰¿ä½“ç³»ï¼Œæ›´çµæ´»</li>
</ul>
<h3 id="æ–¹æ³•ä¸‰"><a href="#æ–¹æ³•ä¸‰" class="headerlink" title="æ–¹æ³•ä¸‰"></a><strong>æ–¹æ³•ä¸‰</strong></h3><p>ä½¿ç”¨æœªæ¥ä»»åŠ¡å¯¹è±¡è¾…åŠ©Threadåˆ›å»ºçº¿ç¨‹<br>FutureTaskå¯¹è±¡å®é™…ä¸Šä¹Ÿå®ç°äº†Runableï¼ŒåŒæ—¶ä¹Ÿå®ç°äº†Futureæ¥å£ï¼Œç”¨äºè·å–è¿”å›å€¼</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public class day01 &#123;</span><br><span class="line">    public static void main(String[] args) throws ExecutionException, InterruptedException &#123;</span><br><span class="line">        FutureTask&lt;Integer&gt; futureTask = new FutureTask&lt;&gt;(new Callable&lt;Integer&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public Integer call() throws Exception &#123;</span><br><span class="line">                System.out.println(&quot;ä½¿ç”¨æœªæ¥ä»»åŠ¡å¯¹è±¡åˆ›å»ºçº¿ç¨‹&quot;);</span><br><span class="line">                Thread.sleep(1000);//ç­‰å¾…1s</span><br><span class="line">                return 100;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        Thread thread = new Thread(futureTask,&quot;T1&quot;);</span><br><span class="line">        thread.start();</span><br><span class="line">        System.out.println(futureTask.get());//ä¸»çº¿ç¨‹è¿è¡Œåˆ°æ­¤å¤„ä¼šå µå¡ï¼Œç›´åˆ°å­çº¿ç¨‹è¿è¡Œå®Œæˆè¿”å›</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æŸ¥çœ‹çº¿ç¨‹"><a href="#æŸ¥çœ‹çº¿ç¨‹" class="headerlink" title="æŸ¥çœ‹çº¿ç¨‹"></a><strong>æŸ¥çœ‹çº¿ç¨‹</strong></h2><p><strong>linux</strong></p>
<blockquote>
<p>ps -ef |grep java æŸ¥çœ‹javaè¿›ç¨‹</p>
</blockquote>
<p><strong>java</strong></p>
<blockquote>
<ul>
<li>jps å‘½ä»¤æŸ¥çœ‹æ‰€æœ‰ Java è¿›ç¨‹</li>
<li>jstack <PID> æŸ¥çœ‹æŸä¸ª Java è¿›ç¨‹ï¼ˆPIDï¼‰çš„æ‰€æœ‰çº¿ç¨‹çŠ¶æ€</li>
<li>jconsole æ¥æŸ¥çœ‹æŸä¸ª Java è¿›ç¨‹ä¸­çº¿ç¨‹çš„è¿è¡Œæƒ…å†µï¼ˆå›¾å½¢ç•Œé¢ï¼‰</li>
</ul>
</blockquote>
<p><strong>æ ˆä¸æ ˆå¸§</strong></p>
<blockquote>
<p>Java Virtual Machine Stacks (Java è™šæ‹Ÿæœºæ ˆï¼‰<br>æˆ‘ä»¬éƒ½çŸ¥é“JVMä¸­ç”±å †ã€æ ˆã€æ–¹æ³•åŒºæ‰€ç»„æˆï¼Œå…¶ä¸­æ ˆå†…å­˜æ˜¯ç»™è°ç”¨çš„å‘¢ï¼Ÿå…¶å®å°±æ˜¯çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å¯åŠ¨åï¼Œè™šæ‹Ÿæœºå°±ä¼šä¸ºå…¶åˆ†é…ä¸€å—æ ˆå†…å­˜ã€‚<br>æ¯ä¸ªæ ˆç”±å¤šä¸ªæ ˆå¸§ï¼ˆFrameï¼‰ç»„æˆï¼Œå¯¹åº”ç€æ¯æ¬¡æ–¹æ³•è°ƒç”¨æ—¶æ‰€å ç”¨çš„å†…å­˜<br>æ¯ä¸ªçº¿ç¨‹åªèƒ½æœ‰ä¸€ä¸ªæ´»åŠ¨æ ˆå¸§ï¼Œå¯¹åº”ç€å½“å‰æ­£åœ¨æ‰§è¡Œçš„é‚£ä¸ªæ–¹æ³•</p>
</blockquote>
<p><strong>çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢</strong><br>çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢(Thread Context Switch)<br>å› ä¸ºä»¥ä¸‹ä¸€äº›åŸå› å¯¼è‡´ cpu ä¸å†æ‰§è¡Œå½“å‰çš„çº¿ç¨‹ï¼Œè½¬è€Œæ‰§è¡Œå¦ä¸€ä¸ªçº¿ç¨‹çš„ä»£ç </p>
<ul>
<li>çº¿ç¨‹çš„ cpu æ—¶é—´ç‰‡ç”¨å®Œ</li>
<li>åƒåœ¾å›æ”¶</li>
<li>æœ‰æ›´é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹éœ€è¦è¿è¡Œ</li>
<li>çº¿ç¨‹è‡ªå·±è°ƒç”¨äº† sleepã€ yieldã€ waitã€ joinã€ parkã€ synchronizedã€ lock ç­‰æ–¹æ³•</li>
</ul>
<blockquote>
<p>å½“ Context Switch å‘ç”Ÿæ—¶ï¼Œéœ€è¦ç”±æ“ä½œç³»ç»Ÿä¿å­˜å½“å‰çº¿ç¨‹çš„çŠ¶æ€ï¼Œå¹¶æ¢å¤å¦ä¸€ä¸ªçº¿ç¨‹çš„çŠ¶æ€ï¼ŒJava ä¸­å¯¹åº”çš„æ¦‚å¿µå°±æ˜¯ç¨‹åºè®¡æ•°å™¨(Program Counter Registerï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯è®°ä½ä¸‹ä¸€æ¡jvmæŒ‡ä»¤çš„æ‰§è¡Œåœ°å€ï¼Œæ˜¯çº¿ç¨‹ç§æœ‰çš„<br>çŠ¶æ€åŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨ã€è™šæ‹Ÿæœºæ ˆä¸­æ¯ä¸ªæ ˆå¸§çš„ä¿¡æ¯ï¼Œå¦‚å±€éƒ¨å˜é‡ã€æ“ä½œæ•°æ ˆã€è¿”å›åœ°å€ç­‰<br>Context Switch é¢‘ç¹å‘ç”Ÿä¼šå½±å“æ€§èƒ½</p>
</blockquote>
<h2 id="çº¿ç¨‹-API"><a href="#çº¿ç¨‹-API" class="headerlink" title="çº¿ç¨‹ API"></a><strong>çº¿ç¨‹ API</strong></h2><h3 id="APIæ€»è§ˆ"><a href="#APIæ€»è§ˆ" class="headerlink" title="APIæ€»è§ˆ"></a><strong>APIæ€»è§ˆ</strong></h3><table>
<thead>
<tr>
<th>æ–¹æ³•å</th>
<th>static</th>
<th>åŠŸèƒ½è¯´æ˜</th>
<th>æ³¨æ„</th>
</tr>
</thead>
<tbody><tr>
<td>start()</td>
<td></td>
<td>å¯åŠ¨ä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œåœ¨æ–°çº¿ç¨‹è¿è¡Œrunæ–¹æ³•ä¸­çš„ä»£ç </td>
<td>startåªæ˜¯è®©çº¿ç¨‹è¿›å…¥å°±ç»ªçŠ¶æ€ï¼Œé‡Œé¢çš„ä»£ç ä¸ä¸€å®šç«‹åˆ»è¿è¡Œ(CPUçš„æ—¶é—´ç‰‡è¿˜æ²¡è½®åˆ°å®ƒ)æ¯ä¸ªçº¿ç¨‹å¯¹è±¡çš„startåªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œå¦‚æœå¤šæ¬¡è°ƒç”¨ä¼šå‡ºç°IllegalThreadStateException</td>
</tr>
<tr>
<td>run()</td>
<td></td>
<td>æ–°çº¿ç¨‹å¯åŠ¨åä¼šè°ƒç”¨çš„æ–¹æ³•</td>
<td>å¦‚æœåœ¨æ„é€ Threadå¯¹è±¡æ—¶ä¼ é€’äº†Runableå‚æ•°ï¼Œåˆ™çº¿ç¨‹å¯åŠ¨ä¼šè°ƒç”¨Runableçš„runæ–¹æ³•ï¼Œå¦åˆ™é»˜è®¤ä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚ä½†æ˜¯é€šå¸¸ä¼šåˆ›å»ºThreadçš„å¯¹è±¡é‡å†™runã€‚</td>
</tr>
<tr>
<td>join()</td>
<td></td>
<td>ç­‰å¾…çº¿ç¨‹è¿è¡Œç»“æŸ</td>
<td></td>
</tr>
<tr>
<td>join(long)</td>
<td></td>
<td>ç­‰å¾…çº¿ç¨‹è¿è¡Œç»“æŸ</td>
<td></td>
</tr>
<tr>
<td>getId()</td>
<td></td>
<td>è·å–çº¿ç¨‹å”¯ä¸€id</td>
<td></td>
</tr>
<tr>
<td>getName()</td>
<td></td>
<td>è·å–çº¿ç¨‹åå­—</td>
<td></td>
</tr>
<tr>
<td>setName()</td>
<td></td>
<td>è®¾ç½®çº¿ç¨‹åå­—</td>
<td></td>
</tr>
<tr>
<td>getPriority()</td>
<td></td>
<td>è·å–çº¿ç¨‹ä¼˜å…ˆçº§</td>
<td></td>
</tr>
<tr>
<td>setPriority(int)</td>
<td></td>
<td>ä¿®æ”¹çº¿ç¨‹ä¼˜å…ˆçº§</td>
<td>javaä¸­è§„å®šçº¿ç¨‹ä¼˜å…ˆçº§æ˜¯1-10æ•´æ•°ï¼Œè¾ƒå¤§ä¼˜å…ˆçº§èƒ½æé«˜è¢«cpuçš„è°ƒåº¦æœºç‡</td>
</tr>
<tr>
<td>getState()</td>
<td></td>
<td>è·å–çº¿ç¨‹çŠ¶æ€</td>
<td>javaä¸­çº¿ç¨‹çŠ¶æ€ä¸€å…±æ˜¯6ä¸ªenumè¡¨ç¤º</td>
</tr>
<tr>
<td>isInterrupted()</td>
<td></td>
<td>åˆ¤æ–­æ˜¯å¦è¢«æ‰“æ–­</td>
<td>ä¸ä¼šæ¸…é™¤æ‰“æ–­çš„æ ‡è®°</td>
</tr>
<tr>
<td>isAlive()</td>
<td></td>
<td>çº¿ç¨‹æ˜¯å¦å­˜æ´»</td>
<td></td>
</tr>
<tr>
<td>interrupt()</td>
<td></td>
<td>æ‰“æ–­çº¿ç¨‹</td>
<td>å¦‚æœè¢«æ‰“æ–­çº¿ç¨‹æ­£åœ¨sleep,wait,joinä¼šå¯¼è‡´è¢«æ‰“æ–­çš„çº¿ç¨‹æŠ›å‡ºInterruptedExceptionï¼Œå¹¶æ¸…é™¤æ‰“æ–­æ ‡è®°;å¦‚æœæ‰“æ–­çš„æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ï¼Œåˆ™ä¼šè®¾ç½®æ‰“æ–­æ ‡è®°ï¼›parkçš„çº¿ç¨‹è¢«æ‰“æ–­ï¼Œä¹Ÿä¼šè®¾ç½®æ‰“æ–­æ ‡è®°</td>
</tr>
<tr>
<td>interrupted()</td>
<td>static</td>
<td>åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­</td>
<td>ä¼šæ¸…é™¤æ‰“æ–­æ ‡è®°</td>
</tr>
<tr>
<td>currentThread()</td>
<td>static</td>
<td>è·å–å½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹</td>
<td></td>
</tr>
<tr>
<td>sleep(long)</td>
<td>static</td>
<td>è®©å½“å‰æ‰§è¡Œçš„çº¿ç¨‹ä¼‘çœ næ¯«ç§’ï¼Œè®©å‡ºæ—¶é—´ç‰‡</td>
<td></td>
</tr>
<tr>
<td>yield()</td>
<td>static</td>
<td>æç¤ºè°ƒåº¦å™¨è®©å‡ºå½“å‰çº¿ç¨‹cpuçš„ä½¿ç”¨</td>
<td>ä¸»è¦æ˜¯ä¸ºäº†æµ‹è¯•å’Œè°ƒè¯•</td>
</tr>
</tbody></table>
<h3 id="runå’Œstart"><a href="#runå’Œstart" class="headerlink" title="runå’Œstart"></a><strong>runå’Œstart</strong></h3><blockquote>
<p>ä¸»æ–¹æ³•ä¸­å¿…é¡»è°ƒç”¨startæ–¹æ³•è€Œä¸æ˜¯runï¼Œè°ƒç”¨runæ–¹æ³•ä¼šè·‘å®ä¾‹æ–¹æ³•ï¼Œè€Œä¸æ˜¯å¼€å¯ä¸€ä¸ªçº¿ç¨‹è·‘runæ–¹æ³•ã€‚<br>startä¸èƒ½å¤šæ¬¡è°ƒç”¨ï¼Œåªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œå¦åˆ™ä¼šæŠ›å‡ºIllegalThreadStateException<br>Threadåˆå§‹åŒ–æ—¶çº¿ç¨‹çŠ¶æ€æ˜¯newï¼Œè°ƒç”¨startåæ˜¯runnable</p>
</blockquote>
<h3 id="sleepå’Œyield"><a href="#sleepå’Œyield" class="headerlink" title="sleepå’Œyield"></a><strong>sleepå’Œyield</strong></h3><p><strong>sleep</strong></p>
<blockquote>
<ol>
<li>è°ƒç”¨ sleep ä¼šè®©å½“å‰çº¿ç¨‹ä» Runing è¿›å…¥ Timed_waiting çŠ¶æ€</li>
<li>å…¶å®ƒçº¿ç¨‹å¯ä»¥ä½¿ç”¨ interrupt æ–¹æ³•æ‰“æ–­æ­£åœ¨ç¡çœ çš„çº¿ç¨‹ï¼Œè¿™æ—¶ sleep æ–¹æ³•ä¼šæŠ›å‡º InterruptedException</li>
<li>ç¡çœ ç»“æŸåçš„çº¿ç¨‹æœªå¿…ä¼šç«‹åˆ»å¾—åˆ°æ‰§è¡Œ</li>
<li>å»ºè®®ç”¨ TimeUnit çš„ sleep ä»£æ›¿ Thread çš„ sleep æ¥è·å¾—æ›´å¥½çš„å¯è¯»æ€§</li>
</ol>
</blockquote>
<p><strong>yield</strong></p>
<blockquote>
<ol>
<li>è°ƒç”¨ yield ä¼šè®©å½“å‰çº¿ç¨‹ä» Runing è¿›å…¥Runable çŠ¶æ€ï¼Œç„¶åè°ƒåº¦æ‰§è¡Œå…¶å®ƒåŒä¼˜å…ˆçº§çš„çº¿ç¨‹ã€‚å¦‚æœè¿™æ—¶æ²¡æœ‰åŒä¼˜å…ˆçº§çš„çº¿ç¨‹ï¼Œé‚£ä¹ˆä¸èƒ½ä¿è¯è®©å½“å‰çº¿ç¨‹æš‚åœçš„æ•ˆæœ</li>
<li>å…·ä½“çš„å®ç°ä¾èµ–äºæ“ä½œç³»ç»Ÿçš„ä»»åŠ¡è°ƒåº¦å™¨</li>
</ol>
</blockquote>
<p><strong>çº¿ç¨‹ä¼˜å…ˆçº§</strong></p>
<blockquote>
<p>çº¿ç¨‹ä¼˜å…ˆçº§ä¼šæç¤ºï¼ˆhintï¼‰è°ƒåº¦å™¨ä¼˜å…ˆè°ƒåº¦è¯¥çº¿ç¨‹ï¼Œä½†å®ƒä»…ä»…æ˜¯ä¸€ä¸ªæç¤ºï¼Œè°ƒåº¦å™¨å¯ä»¥å¿½ç•¥å®ƒ<br>å¦‚æœ cpu æ¯”è¾ƒå¿™ï¼Œé‚£ä¹ˆä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹ä¼šè·å¾—æ›´å¤šçš„æ—¶é—´ç‰‡ï¼Œä½† cpu é—²æ—¶ï¼Œä¼˜å…ˆçº§å‡ ä¹æ²¡ä½œç”¨</p>
</blockquote>
<p><strong>å¯¹æ¯”</strong></p>
<blockquote>
<ol>
<li>yieldæ˜¯è¿›å…¥å°±ç»ªçŠ¶æ€ï¼Œsleepæ˜¯ç­‰å¾…çŠ¶æ€ï¼Œå°±ç»ªçŠ¶æ€æ˜¯æœ‰å¯èƒ½è¢«è°ƒåº¦è¿è¡Œçš„ï¼Œè€Œç­‰å¾…å°±ä¸€å®šä¸ä¼š</li>
<li>sleepæœ‰ä¸€ä¸ªç­‰å¾…æ—¶é—´ï¼Œè€Œyieldæ˜¯æ²¡æœ‰ç­‰å¾…æ—¶é—´çš„</li>
<li>yieldå’Œçº¿ç¨‹ä¼˜å…ˆçº§éƒ½ä¸èƒ½çœŸæ­£æ§åˆ¶æ—¶é—´è°ƒåº¦ï¼Œè€Œåœ¨ä¸€ä¸ªå¤§èŒƒå›´çš„å¯ä»¥åšåˆ°å°½é‡è®©å‡º</li>
</ol>
</blockquote>
<p><strong>sleepé˜²æ­¢cpu100%</strong></p>
<blockquote>
<p>åœ¨æ²¡æœ‰åˆ©ç”¨cpuæ¥è®¡ç®—æ—¶ï¼Œä¸è¦è®© while(true)ç©ºè½¬æµªè´¹cpuï¼Œè¿™æ—¶å¯ä»¥ä½¿ç”¨ yield æˆ– sleep æ¥è®©å‡º cpu çš„ä½¿ç”¨æƒç»™å…¶ä»–ç¨‹åº</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public class day01 &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        while (true) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                Thread.sleep(50);</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="join"><a href="#join" class="headerlink" title="join"></a><strong>join</strong></h3><blockquote>
<p>ä½œç”¨ï¼šå¤šçº¿ç¨‹å¼‚æ­¥æ‰§è¡Œå…±äº«è¿è¡Œæ—¶é—´ï¼Œç­‰å¾…æ‰€æœ‰çº¿ç¨‹è¿è¡Œå®Œæ¯•è·å–ç»“æœ</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">long start = System.currentTimeMillis();</span><br><span class="line">        Thread thread1 = new Thread(() -&gt; &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                Thread.sleep(1000);</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        Thread thread2 = new Thread(() -&gt; &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                Thread.sleep(2000);</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        thread1.start();</span><br><span class="line">        thread2.start();</span><br><span class="line">        thread1.join();</span><br><span class="line">        thread2.join();</span><br><span class="line">        long end = System.currentTimeMillis();</span><br><span class="line">        System.out.println((end - start) / 1000+&quot;ç§’&quot;);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>è¾“å‡º:<br>2ç§’</p>
</blockquote>
<h3 id="interrupt"><a href="#interrupt" class="headerlink" title="interrupt"></a><strong>interrupt</strong></h3><p><strong>æ‰“æ–­ sleep, wait, join çš„çº¿ç¨‹</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Thread thread1 = new Thread(() -&gt; &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        Thread.sleep(1000);</span><br><span class="line">    &#125; catch (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(Thread.currentThread().isInterrupted());</span><br><span class="line">&#125;);</span><br><span class="line">Thread.sleep(500);</span><br><span class="line">thread1.start();</span><br><span class="line">thread1.interrupt();</span><br></pre></td></tr></table></figure>
<p><strong>è¾“å‡º</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">java.lang.InterruptedException: sleep interrupted</span><br><span class="line">	at java.lang.Thread.sleep(Native Method)</span><br><span class="line">	at day01.lambda$main$0(day01.java:10)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:750)</span><br><span class="line">false</span><br></pre></td></tr></table></figure>

<p><strong>æ‰“æ–­æ­£å¸¸è¿è¡Œçš„çº¿ç¨‹</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Thread thread1 = new Thread(() -&gt; &#123;</span><br><span class="line">    while (true) &#123;</span><br><span class="line">        boolean isInterrupted = Thread.currentThread().isInterrupted();</span><br><span class="line">        if (isInterrupted) &#123;</span><br><span class="line">            System.out.println(&quot;è¢«æ‰“æ–­äº†&quot;);</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">Thread.sleep(500);</span><br><span class="line">thread1.start();</span><br><span class="line">thread1.interrupt();</span><br></pre></td></tr></table></figure>

<p><strong>æ³¨æ„</strong></p>
<blockquote>
<p>æ‰“æ–­æ­£å¸¸çš„çº¿ç¨‹ï¼Œæ­¤æ—¶åªä¼šä¿®æ”¹isInterruptedè¿™ä¸ªé™æ€å˜é‡çš„å€¼ä¸ºtrueï¼Œå¹¶ä¸ä¼šæŠ¥é”™ï¼Œåªæœ‰æ‰“æ–­sleep,join,yeildæ‰ä¼šæŠ¥é”™ï¼Œå¹¶ä¸”éƒ½ä¸ä¼šé€€å‡ºï¼Œè€Œæ˜¯ç»§ç»­è¿è¡Œã€‚<br>æ‰“æ–­sleep.join,yeildä¼šæ¸…é™¤æ‰“æ–­æ ‡è®°ï¼Œç½®ä¸ºfalseï¼Œæ­¤æ—¶å¦‚æœæœ‰å…¶ä»–éœ€è¦ï¼Œéœ€è¦å†æ¬¡æ‰“æ–­ï¼Œè°ƒç”¨interruptæ‰‹åŠ¨è®¾ç½®ä¸ºtrue</p>
</blockquote>
<p><strong>ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼</strong></p>
<blockquote>
<p>Two Phase Termination<br>åœ¨ä¸€ä¸ªçº¿ç¨‹ T1ä¸­å¦‚ä½•â€œä¼˜é›…â€ç»ˆæ­¢çº¿ç¨‹ T2ï¼Ÿè¿™é‡Œçš„ã€ä¼˜é›…ã€‘æŒ‡çš„æ˜¯ç»™ T2ä¸€ä¸ªæ–™ç†åäº‹çš„æœºä¼šã€‚<br><strong>é”™è¯¯æ€è·¯</strong></p>
<ol>
<li>ä½¿ç”¨çº¿ç¨‹å¯¹è±¡çš„stopæ–¹æ³•åœæ­¢çº¿ç¨‹<br>stop æ–¹æ³•ä¼šçœŸæ­£æ€æ­»çº¿ç¨‹ï¼Œå¦‚æœè¿™æ—¶çº¿ç¨‹é”ä½äº†å…±äº«èµ„æºï¼Œé‚£ä¹ˆå½“å®ƒè¢«æ€æ­»åå°±å†ä¹Ÿæ²¡æœ‰æœºä¼šé‡Šæ”¾é”ï¼Œå…¶å®ƒçº¿ç¨‹å°†æ°¸è¿œæ— æ³•è·å–é”stopå·²ç»è¢«åºŸå¼ƒäº†</li>
<li>ä½¿ç”¨ System.exit(int) æ–¹æ³•åœæ­¢çº¿ç¨‹<br>ç›®çš„ä»…æ˜¯åœæ­¢ä¸€ä¸ªçº¿ç¨‹ï¼Œä½†è¿™ç§åšæ³•ä¼šè®©æ•´ä¸ªç¨‹åºéƒ½åœæ­¢</li>
</ol>
</blockquote>
<p><strong>æµç¨‹å›¾</strong></p>
<img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-08_17.41.29.png" width="60%" loading="lazy">

<p><strong>ä½¿ç”¨interruptå®ç°</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">public class day01 &#123;</span><br><span class="line">    public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">        TwoPhaseTermination twoPhaseTermination = new TwoPhaseTermination();</span><br><span class="line">        twoPhaseTermination.start();</span><br><span class="line">        Thread.sleep(3500);</span><br><span class="line">        twoPhaseTermination.stop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class TwoPhaseTermination &#123;</span><br><span class="line">    private Thread monitor;</span><br><span class="line"></span><br><span class="line">    void start() &#123;</span><br><span class="line">        monitor = new Thread(() -&gt; &#123;</span><br><span class="line">            while (true) &#123;</span><br><span class="line">                Thread thread = Thread.currentThread();</span><br><span class="line">                if (thread.isInterrupted()) &#123;//åˆ¤æ–­æ‰“æ–­æ ‡è®°ï¼Œä¸ºtrueæ—¶è¿›å…¥</span><br><span class="line">                    System.out.println(&quot;å–„åå·¥ä½œ...&quot;);</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                try &#123;</span><br><span class="line">                    System.out.println(&quot;æ‰§è¡Œç›‘æ§...&quot;);</span><br><span class="line">                    Thread.sleep(1000);//ç¡çœ å·²é˜²æ­¢CPU100%</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                    thread.interrupt();//å› ä¸ºsleepä¸­è¢«æ‰“æ–­äº†ï¼Œé‡ç½®äº†æ‰“æ–­æ ‡è®°ï¼Œéœ€è¦é‡æ–°æ‰“æ–­è®¾ç½®ä¸ºture</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        monitor.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void stop()&#123;</span><br><span class="line">        monitor.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è¾“å‡º</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">æ‰§è¡Œç›‘æ§...</span><br><span class="line">æ‰§è¡Œç›‘æ§...</span><br><span class="line">æ‰§è¡Œç›‘æ§...</span><br><span class="line">æ‰§è¡Œç›‘æ§...</span><br><span class="line">å–„åå·¥ä½œ...</span><br><span class="line">java.lang.InterruptedException: sleep interrupted</span><br><span class="line">	at java.lang.Thread.sleep(Native Method)</span><br><span class="line">	at TwoPhaseTermination.lambda$start$0(day01.java:27)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:750)</span><br></pre></td></tr></table></figure>

<h3 id="parkæ‰“æ–­"><a href="#parkæ‰“æ–­" class="headerlink" title="parkæ‰“æ–­"></a><strong>parkæ‰“æ–­</strong></h3><blockquote>
<ol>
<li>parkæ˜¯locksupportçš„ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œç”¨äºæ‰“æ–­å½“å‰çº¿ç¨‹</li>
<li>è°ƒç”¨åä»£ç ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œä¸å¾€åæ‰§è¡Œ,ä¸æ”¹å˜isInterrupted</li>
<li>å½“isInterruptedä¸ºtrueæ—¶,parkå¤±æ•ˆ</li>
</ol>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public class Day02 &#123;</span><br><span class="line">    public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        Thread thread  = new Thread(()-&gt;&#123;</span><br><span class="line">            System.out.println(&quot;æ‰“æ–­å‰...&quot;);</span><br><span class="line">            LockSupport.park();</span><br><span class="line">            System.out.println(&quot;æ‰“æ–­å...&quot;);</span><br><span class="line">        &#125;);</span><br><span class="line">        thread.start();</span><br><span class="line">        Thread.sleep(1000);</span><br><span class="line">        thread.interrupt();//1ç§’åæ‰“æ–­ï¼Œè®¾ç½®ä¸ºtrueï¼Œparkè¢«æ‰“æ–­ï¼Œä»£ç ç»§ç»­è¿è¡Œ</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>è¾“å‡º</strong><br>æ‰“æ–­å‰â€¦<br>æ‰“æ–­åâ€¦</p>
</blockquote>
<h3 id="è¿‡æ—¶æ–¹æ³•"><a href="#è¿‡æ—¶æ–¹æ³•" class="headerlink" title="è¿‡æ—¶æ–¹æ³•"></a><strong>è¿‡æ—¶æ–¹æ³•</strong></h3><table>
<thead>
<tr>
<th>æ–¹æ³•å</th>
<th>static</th>
<th>åŠŸèƒ½è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>stop()</td>
<td></td>
<td>åœæ­¢çº¿ç¨‹è¿è¡Œ</td>
</tr>
<tr>
<td>suspend()</td>
<td></td>
<td>æŒ‚èµ·ï¼ˆæš‚åœï¼‰çº¿ç¨‹è¿è¡Œ</td>
</tr>
<tr>
<td>resume()</td>
<td></td>
<td>æ¢å¤çº¿ç¨‹è¿è¡Œ</td>
</tr>
</tbody></table>
<blockquote>
<p>è¿™äº›æ–¹æ³•å·²è¿‡æ—¶ï¼Œå®¹æ˜“ç ´ååŒæ­¥ä»£ç å—ï¼Œé€ æˆçº¿ç¨‹æ­»é”</p>
</blockquote>
<h3 id="Daemonå®ˆæŠ¤çº¿ç¨‹"><a href="#Daemonå®ˆæŠ¤çº¿ç¨‹" class="headerlink" title="Daemonå®ˆæŠ¤çº¿ç¨‹"></a><strong>Daemonå®ˆæŠ¤çº¿ç¨‹</strong></h3><p><strong>javaæ‰€æœ‰çº¿ç¨‹ç»“æŸè¿è¡Œï¼Œç¨‹åºæ‰ä¼šç»“æŸè¿è¡Œï¼Œå³ä½¿ä¸»çº¿ç¨‹ç»“æŸäº†ï¼Œè¿˜æœ‰çº¿ç¨‹åœ¨å¾ªç¯æ‰§è¡Œï¼Œé‚£ä¹ˆç¨‹åºä¸é€€å‡º<br>æœ‰ä¸€ç§ç‰¹æ®Šçš„çº¿ç¨‹å«åšå®ˆæŠ¤çº¿ç¨‹ï¼Œåªè¦å…¶å®ƒéå®ˆæŠ¤çº¿ç¨‹è¿è¡Œç»“æŸäº†ï¼Œå³ä½¿å®ˆæŠ¤çº¿ç¨‹çš„ä»£ç æ²¡æœ‰æ‰§è¡Œå®Œï¼Œä¹Ÿä¼šå¼ºåˆ¶ç»“æŸã€‚</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Thread thread = new Thread(() -&gt; &#123;</span><br><span class="line">    while (true) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Thread.sleep(500);</span><br><span class="line">            System.out.println(&quot;å­çº¿ç¨‹æŒç»­è¿è¡Œä¸­...&quot;);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">thread.setDaemon(true);//è®¾ç½®å­çº¿ç¨‹ä¸ºå®ˆæŠ¤çº¿ç¨‹</span><br><span class="line">thread.start();</span><br><span class="line">Thread.sleep(1000);</span><br><span class="line">System.out.println(&quot;ä¸»çº¿ç¨‹ç»“æŸè¿è¡Œ...&quot;);</span><br></pre></td></tr></table></figure>

<p><strong>è¾“å‡º</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å­çº¿ç¨‹æŒç»­è¿è¡Œä¸­...</span><br><span class="line">ä¸»çº¿ç¨‹ç»“æŸè¿è¡Œ...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ³¨æ„<br>åƒåœ¾å›æ”¶å™¨çº¿ç¨‹å°±æ˜¯ä¸€ç§å®ˆæŠ¤çº¿ç¨‹<br>Tomcat ä¸­çš„Acceptor å’Œ Poller çº¿ç¨‹éƒ½æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œæ‰€ä»¥ Tomcat æ¥æ”¶åˆ° shutdown å‘½ä»¤åï¼Œä¸ä¼šç­‰å¾…å®ƒä»¬å¤„ç†å®Œå½“å‰è¯·æ±‚</p>
</blockquote>
<h2 id="çº¿ç¨‹çŠ¶æ€"><a href="#çº¿ç¨‹çŠ¶æ€" class="headerlink" title="çº¿ç¨‹çŠ¶æ€"></a><strong>çº¿ç¨‹çŠ¶æ€</strong></h2><h3 id="äº”ç§çŠ¶æ€"><a href="#äº”ç§çŠ¶æ€" class="headerlink" title="äº”ç§çŠ¶æ€"></a><strong>äº”ç§çŠ¶æ€</strong></h3><img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-09_10.06.22.png" width="60%" loading="lazy">

<blockquote>
<p>ã€åˆå§‹çŠ¶æ€ã€‘ä»…æ˜¯åœ¨è¯­è¨€å±‚é¢åˆ›å»ºäº†çº¿ç¨‹å¯¹è±¡ï¼Œè¿˜æœªä¸æ“ä½œç³»ç»Ÿçº¿ç¨‹å…³è”<br>ã€å¯è¿è¡ŒçŠ¶æ€ã€‘ï¼ˆå°±ç»ªçŠ¶æ€ï¼‰æŒ‡è¯¥çº¿ç¨‹å·²ç»è¢«åˆ›å»ºï¼ˆä¸æ“ä½œç³»ç»Ÿçº¿ç¨‹å…³è”ï¼‰ï¼Œå¯ä»¥ç”± CPU è°ƒåº¦æ‰§è¡Œ<br>ã€è¿è¡ŒçŠ¶æ€ã€‘æŒ‡è·å–äº† CPU æ—¶é—´ç‰‡è¿è¡Œä¸­çš„çŠ¶æ€å½“CPU æ—¶é—´ç‰‡ç”¨å®Œï¼Œä¼šä»ã€è¿è¡ŒçŠ¶æ€ã€‘è½¬æ¢è‡³ã€å¯è¿è¡ŒçŠ¶æ€ã€‘ï¼Œä¼šå¯¼è‡´çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢<br>ã€é˜»å¡çŠ¶æ€ã€‘</p>
<ul>
<li>å¦‚æœè°ƒç”¨äº†é˜³å¡APIï¼Œå¦‚ BIO è¯»å†™æ–‡ä»¶ï¼Œè¿™æ—¶è¯¥çº¿ç¨‹å®é™…ä¸ä¼šç”¨åˆ°CPUï¼Œä¼šå¯¼è‡´çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿›å…¥ã€é˜»å¡çŠ¶æ€ã€‘</li>
<li>ç­‰BTO æ“ä½œå®Œæ¯•ï¼Œä¼šç”±æ“ä½œç³»ç»Ÿå”¤é†’é˜»å¡çš„çº¿ç¨‹ï¼Œè½¬æ¢è‡³ã€å¯è¿è¡ŒçŠ¶æ€ã€‘</li>
<li>ä¸ã€å¯è¿è¡ŒçŠ¶æ€ã€‘çš„åŒºåˆ«æ˜¯ï¼Œå¯¹ã€é˜»å¡çŠ¶æ€ã€‘çš„çº¿ç¨‹æ¥è¯´åªè¦å®ƒä»¬ä¸€ç›´ä¸å”¤é†’ï¼Œè°ƒåº¦å™¨å°±ä¸€ç›´ä¸ä¼šè€ƒè™‘è°ƒåº¦å®ƒä»¬</li>
</ul>
<p>ã€ç»ˆæ­¢çŠ¶æ€ã€‘è¡¨ç¤ºçº¿ç¨‹å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œç”Ÿå‘½å‘¨æœŸå·²ç»ç»“æŸï¼Œä¸ä¼šå†è½¬æ¢ä¸ºå…¶å®ƒçŠ¶æ€</p>
</blockquote>
<h3 id="å…­ç§çŠ¶æ€"><a href="#å…­ç§çŠ¶æ€" class="headerlink" title="å…­ç§çŠ¶æ€"></a><strong>å…­ç§çŠ¶æ€</strong></h3><img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2Fpic1.png" width="60%" loading="lazy">

<blockquote>
<ul>
<li>æ–°å»ºï¼šæ²¡æœ‰å’Œæ“ä½œç³»ç»Ÿçš„çº¿ç¨‹å…³è”ï¼Œåªæ˜¯åˆ›å»ºäº†javaå¯¹è±¡</li>
<li>ç»ˆç»“ï¼šä»£ç æ‰§è¡Œå®Œå°±è¿›å…¥ç»ˆç»“äº†ï¼Œä¸å¯é€†</li>
<li>å¯è¿è¡Œï¼šåŒ…å«äº†æ“ä½œç³»ç»Ÿå±‚é¢çš„å¯è¿è¡Œï¼Œè¿è¡Œï¼Œé˜»å¡(ç”±äºBOIåœ¨javaä¸­æ— æ³•åŒºåˆ†)ä¸‰ç§çŠ¶æ€</li>
<li>é˜»å¡ï¼šå½“å¯è¿è¡ŒçŠ¶æ€è·å–é”å¤±è´¥æ—¶ï¼Œè¿›å…¥è¯¥çŠ¶æ€ï¼Œå½“å…¶ä»–çº¿ç¨‹é‡Šæ”¾é”æ—¶ï¼Œé˜»å¡çŠ¶æ€è½¬ä¸ºå¯è¿è¡Œ</li>
<li>ç­‰å¾…ï¼šå½“å¯è¿è¡ŒçŠ¶æ€è·å¾—äº†é”ä½†æ˜¯è¿˜æœ‰ä¸€äº›èµ„æºæ²¡è·å–ï¼Œå¯ä»¥ä½¿ç”¨waitè¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œç”±å…¶å®ƒçº¿ç¨‹ä½¿ç”¨notifyæ¥å”¤é†’ç­‰å¾…,ä½¿ç”¨joinä¹Ÿå¯ä»¥è¿›å…¥ç­‰å¾…</li>
<li>æœ‰æ—¶é™ç­‰å¾…ï¼šå’Œç­‰å¾…ä¸€æ ·ï¼Œåˆ°æ—¶é—´ä¼šè‡ªåŠ¨å”¤é†’ï¼Œä¸”åœ¨å¯è¿è¡ŒçŠ¶æ€æ—¶ï¼Œåªè¦è°ƒç”¨sleepå°±å¯ä»¥è¿›å…¥è¯¥çŠ¶æ€</li>
</ul>
<p>æ³¨æ„ï¼š<br>é˜»å¡ï¼Œç­‰å¾…ï¼Œæœ‰æ—¶é™ç­‰å¾…éƒ½æ˜¯javaAPIå±‚é¢çš„ç»†åˆ†ï¼Œä¸å ç”¨æ—¶é—´ç‰‡</p>
</blockquote>
<h2 id="æœ¬ç« å°ç»“"><a href="#æœ¬ç« å°ç»“" class="headerlink" title="æœ¬ç« å°ç»“"></a><strong>æœ¬ç« å°ç»“</strong></h2><blockquote>
<p><strong>æœ¬ç« çš„é‡ç‚¹åœ¨äºæŒæ¡</strong></p>
<p><strong>çº¿ç¨‹åˆ›å»º</strong><br><strong>çº¿ç¨‹é‡è¦api</strong>ï¼Œå¦‚ start, run, sleep, join, interrupt ç­‰<br><strong>çº¿ç¨‹çŠ¶æ€</strong><br><strong>åº”ç”¨æ–¹é¢</strong></p>
<ul>
<li>å¼‚æ­¥è°ƒç”¨ï¼šä¸»çº¿ç¨‹æ‰§è¡ŒæœŸé—´ï¼Œå…¶å®ƒçº¿ç¨‹å¼‚æ­¥æ‰§è¡Œè€—æ—¶æ“ä½œ</li>
<li>æé«˜æ•ˆç‡ï¼šå¹¶è¡Œè®¡ç®—ï¼Œç¼©çŸ­è¿ç®—æ—¶é—´</li>
<li>åŒæ­¥ç­‰å¾…ï¼šjoin</li>
<li>ç»Ÿç­¹è§„åˆ’ï¼šåˆç†ä½¿ç”¨çº¿ç¨‹ï¼Œå¾—åˆ°æœ€ä¼˜æ•ˆæœ I</li>
</ul>
<p><strong>åŸç†æ–¹é¢</strong></p>
<ul>
<li>çº¿ç¨‹è¿è¡Œæµç¨‹ï¼šæ ˆã€æ ˆå¸§ã€ä¸Šä¸‹æ–‡åˆ‡æ¢ã€ç¨‹åºè®¡æ•°å™¨</li>
<li>Thread ä¸¤ç§åˆ›å»ºæ–¹å¼çš„æºç </li>
</ul>
<p><strong>æ¨¡å¼æ–¹é¢</strong></p>
<ul>
<li>ä¸¤é˜¶æ®µç»ˆæ­¢</li>
</ul>
</blockquote>
<h1 id="å…±äº«æ¨¡å‹ä¹‹ç®¡ç¨‹"><a href="#å…±äº«æ¨¡å‹ä¹‹ç®¡ç¨‹" class="headerlink" title="å…±äº«æ¨¡å‹ä¹‹ç®¡ç¨‹"></a><strong>å…±äº«æ¨¡å‹ä¹‹ç®¡ç¨‹</strong></h1><h2 id="å…±äº«é—®é¢˜"><a href="#å…±äº«é—®é¢˜" class="headerlink" title="å…±äº«é—®é¢˜"></a><strong>å…±äº«é—®é¢˜</strong></h2><h3 id="javaä»£ç çš„ä½“ç°"><a href="#javaä»£ç çš„ä½“ç°" class="headerlink" title="javaä»£ç çš„ä½“ç°"></a><strong>javaä»£ç çš„ä½“ç°</strong></h3><p>ä¸¤ä¸ªçº¿ç¨‹å¯¹åˆå§‹å€¼ä¸ºâ—çš„é™æ€å˜é‡ä¸€ä¸ªåšè‡ªå¢ï¼Œä¸€ä¸ªåšè‡ªå‡ï¼Œå„åš5000æ¬¡ï¼Œç»“æœæ˜¯0å—ï¼Ÿ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">static int s = 0;</span><br><span class="line">public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">    Thread thread1 = new Thread(()-&gt;&#123;</span><br><span class="line">        for (int i = 0; i &lt; 5000; i++) &#123;</span><br><span class="line">            s++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    Thread thread2 = new Thread(()-&gt;&#123;</span><br><span class="line">        for (int i = 0; i &lt; 5000; i++) &#123;</span><br><span class="line">            s--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    thread1.start();</span><br><span class="line">    thread2.start();</span><br><span class="line">    thread1.join();</span><br><span class="line">    thread2.join();</span><br><span class="line">    System.out.println(&quot;s=&quot;+s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>è¾“å‡º</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s=99</span><br></pre></td></tr></table></figure>

<h3 id="ä¸´ç•ŒåŒº-Critical-Seetion"><a href="#ä¸´ç•ŒåŒº-Critical-Seetion" class="headerlink" title="ä¸´ç•ŒåŒº Critical Seetion"></a><strong>ä¸´ç•ŒåŒº Critical Seetion</strong></h3><blockquote>
<p>ä¸€ä¸ªç¨‹åºè¿è¡Œå¤šä¸ªçº¿ç¨‹æœ¬èº«æ˜¯æ²¡æœ‰é—®é¢˜çš„<br>é—®é¢˜å‡ºåœ¨å¤šä¸ªçº¿ç¨‹è®¿é—®å…±äº«èµ„æº</p>
<ul>
<li>å¤šä¸ªçº¿ç¨‹è¯»å…±äº«èµ„æºå…¶å®ä¹Ÿæ²¡æœ‰é—®é¢˜</li>
<li>åœ¨å¤šä¸ªçº¿ç¨‹å¯¹å…±äº«èµ„æºè¯»å†™æ“ä½œæ—¶å‘ç”ŸæŒ‡ä»¤äº¤é”™ï¼Œå°±ä¼šå‡ºç°é—®é¢˜<br>ä¸€æ®µä»£ç å—å†…å¦‚æœå­˜åœ¨å¯¹å…±äº«èµ„æºçš„å¤šçº¿ç¨‹è¯»å†™æ“ä½œï¼Œç§°è¿™æ®µä»£ç å—ä¸ºä¸´ç•ŒåŒº</li>
</ul>
</blockquote>
<p><strong>ä¾‹å¦‚ä¸‹é¢çš„ä»£ç </strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">static int counter = 0;</span><br><span class="line">static void increment()</span><br><span class="line">//ä¸´ç•ŒåŒº</span><br><span class="line">&#123;</span><br><span class="line">    counter++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static void decrement()</span><br><span class="line">//ä¸´ç•ŒåŒº</span><br><span class="line">&#123;</span><br><span class="line">    counter--;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ç«æ€æ¡ä»¶Race-Condition"><a href="#ç«æ€æ¡ä»¶Race-Condition" class="headerlink" title="ç«æ€æ¡ä»¶Race Condition"></a><strong>ç«æ€æ¡ä»¶Race Condition</strong></h3><blockquote>
<p>å¤šä¸ªçº¿ç¨‹åœ¨ä¸´ç•ŒåŒºå†…æ‰§è¡Œï¼Œç”±äºä»£ç çš„æ‰§è¡Œåºåˆ—ä¸åŒè€Œå¯¼è‡´ç»“æœæ— æ³•é¢„æµ‹ï¼Œç§°ä¹‹ä¸ºå‘ç”Ÿäº†ç«æ€æ¡ä»¶</p>
</blockquote>
<p><strong>å¦‚ä½•å¤„ç†å…±äº«é—®é¢˜</strong></p>
<blockquote>
<p>ä¸ºäº†é¿å…ä¸´ç•ŒåŒºçš„ç«æ€æ¡ä»¶å‘ç”Ÿï¼Œæœ‰å¤šç§æ‰‹æ®µå¯ä»¥è¾¾åˆ°ç›®çš„ã€‚</p>
<ul>
<li>é˜»å¡å¼çš„è§£å†³æ–¹æ¡ˆï¼šsynchronized, Lock</li>
<li>éé˜»å¡å¼çš„è§£å†³æ–¹æ¡ˆï¼šåŸå­å˜é‡</li>
</ul>
</blockquote>
<h2 id="synchronized"><a href="#synchronized" class="headerlink" title="synchronized"></a><strong>synchronized</strong></h2><blockquote>
<p>ä¿—ç§°ã€å¯¹è±¡é”ã€‘ï¼Œå®ƒé‡‡ç”¨äº’æ–¥çš„æ–¹å¼åŒä¸€æ—¶åˆ»è‡³å¤šåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æŒæœ‰ã€å¯¹è±¡é”ã€‘ï¼Œå…¶å®ƒçº¿ç¨‹å†æƒ³è·å–è¿™ä¸ªã€å¯¹è±¡é”ã€‘æ—¶å°±ä¼šé˜»å¡ä½ã€‚è¿™æ ·å°±èƒ½ä¿è¯æ‹¥æœ‰é”çš„çº¿ç¨‹å¯ä»¥å®‰å…¨çš„æ‰§è¡Œä¸´ç•ŒåŒºå†…çš„ä»£ç ï¼Œä¸ç”¨æ‹…å¿ƒçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢<br><strong>æ³¨æ„</strong><br>è™½ç„¶java ä¸­äº’æ–¥å’ŒåŒæ­¥éƒ½å¯ä»¥é‡‡ç”¨ synchronized å…³é”®å­—æ¥å®Œæˆï¼Œä½†å®ƒä»¬è¿˜æ˜¯æœ‰åŒºåˆ«çš„ï¼š</p>
<ul>
<li>äº’æ–¥æ˜¯ä¿è¯ä¸´ç•ŒåŒºçš„ç«æ€æ¡ä»¶å‘ç”Ÿï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä¸´ç•ŒåŒºä»£ç </li>
<li>åŒæ­¥æ˜¯ç”±äºçº¿ç¨‹æ‰§è¡Œçš„å…ˆåã€é¡ºåºä¸åŒã€éœ€è¦ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å…¶å®ƒçº¿ç¨‹è¿è¡Œåˆ°æŸä¸ªç‚¹</li>
</ul>
</blockquote>
<h2 id="çº¿ç¨‹å®‰å…¨åˆ†æ"><a href="#çº¿ç¨‹å®‰å…¨åˆ†æ" class="headerlink" title="çº¿ç¨‹å®‰å…¨åˆ†æ"></a><strong>çº¿ç¨‹å®‰å…¨åˆ†æ</strong></h2><h3 id="å˜é‡å®‰å…¨åˆ†æ"><a href="#å˜é‡å®‰å…¨åˆ†æ" class="headerlink" title="å˜é‡å®‰å…¨åˆ†æ"></a><strong>å˜é‡å®‰å…¨åˆ†æ</strong></h3><blockquote>
<p><strong>æˆå‘˜å˜é‡å’Œé™æ€å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿ</strong><br>å¦‚æœå®ƒä»¬æ²¡æœ‰å…±äº«ï¼Œåˆ™çº¿ç¨‹å®‰å…¨<br>å¦‚æœå®ƒä»¬è¢«å…±äº«äº†ï¼Œæ ¹æ®å®ƒä»¬çš„çŠ¶æ€æ˜¯å¦èƒ½å¤Ÿæ”¹å˜ï¼Œåˆåˆ†ä¸¤ç§æƒ…å†µ</p>
<ul>
<li>å¦‚æœåªæœ‰è¯»æ“ä½œï¼Œåˆ™çº¿ç¨‹å®‰å…¨</li>
<li>å¦‚æœæœ‰è¯»å†™æ“ä½œï¼Œåˆ™è¿™æ®µä»£ç æ˜¯ä¸´ç•ŒåŒºï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨</li>
</ul>
<p><strong>å±€éƒ¨å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿ</strong><br>å±€éƒ¨å˜é‡æ˜¯çº¿ç¨‹å®‰å…¨çš„<br>ä½†å±€éƒ¨å˜é‡å¼•ç”¨çš„å¯¹è±¡åˆ™æœªå¿…</p>
<ul>
<li>å¦‚æœè¯¥å¯¹è±¡æ²¡æœ‰é€ƒç¦»æ–¹æ³•çš„ä½œç”¨è®¿é—®ï¼Œå®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„</li>
<li>å¦‚æœè¯¥å¯¹è±¡é€ƒç¦»æ–¹æ³•çš„ä½œç”¨èŒƒå›´ï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨</li>
</ul>
</blockquote>
<p><strong>å±€éƒ¨å˜é‡ä¸ºä»€ä¹ˆå®‰å…¨ï¼Ÿ</strong></p>
<blockquote>
<p>å±€éƒ¨å˜é‡åœ¨æ ˆå¸§ä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„æ ˆ</p>
</blockquote>
<p><strong>å±€éƒ¨å˜é‡å¼•ç”¨ä¸ºä»€ä¹ˆä¸å®‰å…¨ï¼Ÿ</strong><br><img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-09_14.00.14.png" width="60%" loading="lazy"></p>
<blockquote>
<p>å½“å±€éƒ¨å˜é‡å¼•ç”¨æš´éœ²ç»™å¤–é¢æ—¶ï¼Œå…¶æ ˆå¸§å­˜çš„æ˜¯åœ°å€ï¼ŒæŒ‡å‘å †å†…å­˜ä¸­çš„å¯¹è±¡ï¼Œè€Œè¿™ä¸ªå¯¹è±¡ä¹Ÿå¯èƒ½è¢«å…¶ä»–çº¿ç¨‹ä¸­å¼•ç”¨æ—¶ï¼Œä¸å®‰å…¨</p>
</blockquote>
<p><strong>é‡å†™çˆ¶ç±»ç ´åå®‰å…¨ï¼Ÿ</strong></p>
<blockquote>
<p>å­ç±»é‡å†™çˆ¶ç±»æ–¹æ³•å¯èƒ½ç ´åçº¿ç¨‹å®‰å…¨ï¼Œä½¿ç”¨privateå’Œfinalä¿®é¥°å¯ä»¥é¿å…</p>
</blockquote>
<h3 id="å¸¸è§çº¿ç¨‹å®‰å…¨ç±»"><a href="#å¸¸è§çº¿ç¨‹å®‰å…¨ç±»" class="headerlink" title="å¸¸è§çº¿ç¨‹å®‰å…¨ç±»"></a><strong>å¸¸è§çº¿ç¨‹å®‰å…¨ç±»</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">String          //å­—ç¬¦ä¸²</span><br><span class="line">Integer         //åŒ…è£…ç±»</span><br><span class="line">String Buffer   //å­—ç¬¦ä¸²æ‹¼æ¥</span><br><span class="line">Random          //éšæœºæ•°</span><br><span class="line">Vector          //listçš„å®‰å…¨å®ç°</span><br><span class="line">Hashtable       //mapçš„å®‰å…¨å®ç°</span><br><span class="line">java.util.concurrent åŒ…ä¸‹çš„ç±»</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å¤šä¸ªçº¿ç¨‹è°ƒç”¨å®ƒä»¬åŒä¸€ä¸ªå®ä¾‹çš„æŸä¸ªæ–¹æ³•æ—¶ï¼Œæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚<br>å®ƒä»¬çš„æ¯ä¸ªæ–¹æ³•æ˜¯åŸå­çš„,ä½†æ³¨æ„å®ƒä»¬å¤šä¸ªæ–¹æ³•çš„ç»„åˆä¸æ˜¯åŸå­çš„</p>
</blockquote>
<p><strong>ä¸å¯å˜ç±»çš„çº¿ç¨‹å®‰å…¨æ€§</strong></p>
<blockquote>
<p>Stringã€Integer ç­‰éƒ½æ˜¯ä¸å¯å˜ç±»ï¼Œå› ä¸ºå…¶å†…éƒ¨çš„çŠ¶æ€ä¸å¯ä»¥æ”¹å˜ï¼Œå› æ­¤å®ƒä»¬çš„æ–¹æ³•éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„</p>
</blockquote>
<p><strong>Stringä¸ºä»€ä¹ˆç”¨finalä¿®é¥°ï¼Ÿ</strong></p>
<blockquote>
<p>å› ä¸ºä½¿ç”¨finalä¿®é¥°é˜²æ­¢å­ç±»é‡å†™ï¼Œç ´åçº¿ç¨‹å®‰å…¨æ€§</p>
</blockquote>
<h3 id="å®ä¾‹åˆ†æ"><a href="#å®ä¾‹åˆ†æ" class="headerlink" title="å®ä¾‹åˆ†æ"></a><strong>å®ä¾‹åˆ†æ</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@Aspect</span><br><span class="line">@Component</span><br><span class="line">public class MyAspect &#123;</span><br><span class="line">    // æ˜¯å¦å®‰å…¨ï¼Ÿ</span><br><span class="line">    private long start;</span><br><span class="line">    @Before(&quot;execution(* *ï¼ˆ..ï¼‰)&quot;)</span><br><span class="line">    public void before()&#123;</span><br><span class="line">        start = System.nanoTime();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @After(&quot;execution(* *(..))&quot;)</span><br><span class="line">    public void after()&#123;</span><br><span class="line">        long end = System.nanoTime();</span><br><span class="line">        System.out.println(&quot;cost time:&quot;+(end-start));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ä»¥ä¸Šä»£ç ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¦‚æœéœ€è¦å®ç°ï¼Œå¯ä»¥æ”¹ä¸ºç¯ç»•é€šçŸ¥ï¼Œå¹¶å°†startå’Œendä½œä¸ºå±€éƒ¨å˜é‡</p>
</blockquote>
<h2 id="Monitoræ¦‚å¿µ"><a href="#Monitoræ¦‚å¿µ" class="headerlink" title="Monitoræ¦‚å¿µ"></a><strong>Monitoræ¦‚å¿µ</strong></h2><h3 id="å¯¹è±¡å¤´"><a href="#å¯¹è±¡å¤´" class="headerlink" title="å¯¹è±¡å¤´"></a>å¯¹è±¡å¤´</h3><img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-09_14.41.57.png" width="70%" loading="lazy">
<img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-09_14.42.14.png" width="70%" loading="lazy">

<h3 id="Monitor"><a href="#Monitor" class="headerlink" title="Monitor"></a><strong>Monitor</strong></h3><blockquote>
<p><strong>Monitor è¢«ç¿»è¯‘ä¸ºç›‘è§†å™¨æˆ–ç®¡ç¨‹</strong><br>æ¯ä¸ª Java å¯¹è±¡éƒ½å¯ä»¥å…³è”ä¸€ä¸ª Monitor å¯¹è±¡ï¼Œå¦‚æœä½¿ç”¨ synchronized ç»™å¯¹è±¡ä¸Šé”ï¼ˆé‡é‡çº§ï¼‰ä¹‹åï¼Œè¯¥å¯¹è±¡å¤´çš„ Mark Word ä¸­å°±è¢«è®¾ç½®æŒ‡å‘ Monitor å¯¹è±¡çš„æŒ‡é’ˆ<br>åŸæ¥çš„hashcodeåˆ†ä»£å¹´é¾„ç­‰ä¿¡æ¯éƒ½ä¼šå­˜åœ¨Monitorä¸­ï¼Œå½“è§£é”æ—¶é‡ç½®å›æ¥<br>Monitoræ˜¯æ“ä½œç³»ç»Ÿå±‚é¢çš„å¯¹è±¡ï¼Œcå®ç°çš„ï¼Œå¯¹javaä¸å¯è§</p>
</blockquote>
<p><strong>Monitor ç»“æ„å¦‚ä¸‹</strong></p>
<img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-09_14.54.28.png" width="70%" loading="lazy">


<blockquote>
<p>åˆšå¼€å§‹ Monitor ä¸­ Owner ä¸º null<br>å½“ Thread-2 æ‰§è¡Œ synchronized(obj) å°±ä¼šå°† Monitor çš„æ‰€æœ‰è€… Owner ç½®ä¸º Thread-2, Monitorä¸­åªèƒ½æœ‰ä¸€ä¸ªOwner<br>åœ¨ Thread-2 ä¸Šé”çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœ Thread-3, Thread-4, Thread,5 ä¹Ÿæ¥æ‰§è¡Œ synchronizedfobj)ï¼Œå°±ä¼šè¿›å…¥EntryList BLOCKEDçŠ¶æ€<br>Thread-2 æ‰§è¡Œå®ŒåŒæ­¥ä»£ç å—çš„å†…å®¹ï¼Œç„¶åå”¤é†’ EntryList ä¸­ç­‰å¾…çš„çº¿ç¨‹æ¥ç«äº‰é”ï¼Œç«äº‰çš„æ—¶æ˜¯éå…¬å¹³çš„<br>å›¾ä¸­ WaitSet ä¸­çš„ Thread-0, Thread-1 æ˜¯ä¹‹å‰è·å¾—è¿‡é”ï¼Œä½†æ¡ä»¶ä¸æ»¡è¶³è¿›å…¥WAITING çŠ¶æ€çš„çº¿ç¨‹ï¼Œåé¢è®² wait-notify æ—¶ä¼šåˆ†æ<br><strong>æ³¨æ„</strong></p>
<ul>
<li>synchronized å¿…é¡»æ˜¯è¿›å…¥åŒä¸€ä¸ªå¯¹è±¡çš„ monitor æ‰æœ‰ä¸Šè¿°çš„æ•ˆæœ</li>
<li>ä¸åŠ  synchronized çš„å¯¹è±¡ä¸ä¼šå…³è”ç›‘è§†å™¨ï¼Œä¸éµä»ä»¥ä¸Šè§„åˆ™</li>
</ul>
</blockquote>
<p><strong>ä»å­—èŠ‚ç è§’åº¦åˆ†æSynchronized</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Code:</span><br><span class="line">  stack=2, locals=3, args_size=1</span><br><span class="line">     0: getstatic     #2                  // Field lock:Ljava/lang/Object;</span><br><span class="line">     3: dup</span><br><span class="line">     4: astore_1</span><br><span class="line">     5: monitorenter</span><br><span class="line">     6: getstatic     #3                  // Field counter:I</span><br><span class="line">     9: iconst_1</span><br><span class="line">    10: iadd</span><br><span class="line">    11: putstatic     #3                  // Field counter:I</span><br><span class="line">    14: aload_1</span><br><span class="line">    15: monitorexit</span><br><span class="line">    16: goto          24</span><br><span class="line">    19: astore_2</span><br><span class="line">    20: aload_1</span><br><span class="line">    21: monitorexit</span><br><span class="line">    22: aload_2</span><br><span class="line">    23: athrow</span><br><span class="line">    24: return</span><br><span class="line">  Exception table:</span><br><span class="line">     from    to  target type</span><br><span class="line">         6    16    19   any</span><br><span class="line">        19    22    19   any</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>è§£é‡Š</p>
<blockquote>
<p>0-4    è·å–é”å¯¹è±¡<br>5      è°ƒç”¨cå®ç°çš„monitorenteræ–¹æ³•ï¼Œå°†å¯¹è±¡çš„markwordä¿®æ”¹ä¸ºmonitorenterçš„åœ°å€ï¼Œå¹¶å­˜åŸå…ˆçš„markwordä¿¡æ¯åˆ°monitorenterä¸­<br>6-14   æ‰§è¡ŒåŒæ­¥ä»£ç å—ä¸­çš„å†…å®¹<br>15     è§£é”ï¼Œå°†markwordè¿˜åŸï¼Œå¹¶å°†ownerè®©å‡ºï¼Œå”¤é†’EntryList ä¸­ç­‰å¾…çš„çº¿ç¨‹æ¥ç«äº‰é”<br>19-23  å‡ºç°å¼‚å¸¸æ—¶å†æ¬¡æ‰§è¡Œè§£é”ï¼Œç¡®ä¿é”æˆåŠŸé‡Šæ”¾</p>
</blockquote>
<h3 id="é”ä¼˜åŒ–"><a href="#é”ä¼˜åŒ–" class="headerlink" title="é”ä¼˜åŒ–"></a><strong>é”ä¼˜åŒ–</strong></h3><h4 id="è½»é‡çº§é”"><a href="#è½»é‡çº§é”" class="headerlink" title="è½»é‡çº§é”"></a><strong>è½»é‡çº§é”</strong></h4><blockquote>
<p>è½»é‡çº§é”çš„ä½¿ç”¨åœºæ™¯ï¼šå¦‚æœä¸€ä¸ªå¯¹è±¡è™½ç„¶æœ‰å¤šçº¿ç¨‹è®¿é—®ï¼Œä½†å¤šçº¿ç¨‹è®¿é—®çš„æ—¶é—´æ˜¯é”™å¼€çš„(ä¹Ÿå°±æ˜¯æ²¡æœ‰ç«äº‰)é‚£ä¹ˆå¯ä»¥ä½¿ç”¨è½»é‡çº§é”æ¥ä¼˜åŒ–ã€‚<br>è½»é‡çº§é”å¯¹ä½¿ç”¨è€…æ˜¯é€æ˜çš„ï¼Œå³è¯­æ³•ä»ç„¶æ˜¯ synchronizedï¼Œä¼šå…ˆå°è¯•è½»é‡çº§é”ï¼Œå¤±è´¥åå†é‡é‡çº§é”</p>
</blockquote>
<p><strong>è½»é‡é”çš„è¿‡ç¨‹</strong></p>
<p><strong>åˆ›å»ºé”è®°å½•(Lock Record)å¯¹è±¡ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½çš„æ ˆå¸§éƒ½ä¼šåŒ…å«ä¸€ä¸ªé”è®°å½•çš„ç»“æ„ï¼Œå†…éƒ¨å¯ä»¥å­˜å‚¨é”å®šå¯¹è±¡çš„ Mark Word</strong></p>
<img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-09_16.07.13.png" width="50%" loading="lazy">

<p><strong>è®©é”è®°å½•ä¸­ Object reference æŒ‡å‘é”å¯¹è±¡ï¼Œå¹¶å°è¯•ç”¨ cas æ›¿æ¢ Object çš„ Mark Wordï¼Œå°† Mark Word çš„å€¼å­˜å…¥é”è®°å½•</strong></p>
<img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-09_16.02.20.png" width="50%" loading="lazy">

<p><strong>å¦‚æœ cas æ›¿æ¢æˆåŠŸï¼Œå¯¹è±¡å¤´ä¸­å­˜å‚¨äº†é”è®°å½•åœ°å€å’ŒçŠ¶æ€ e8ï¼Œè¡¨ç¤ºç”±è¯¥çº¿ç¨‹ç»™å¯¹è±¡åŠ é”ï¼Œè¿™æ—¶å›¾ç¤ºå¦‚ä¸‹</strong></p>
<img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-09_16.10.25.png" width="50%" loading="lazy">

<p><strong>å¦‚æœ cas å¤±è´¥ï¼Œæœ‰ä¸¤ç§æƒ…å†µ</strong></p>
<ul>
<li><strong>å¦‚æœæ˜¯å…¶å®ƒçº¿ç¨‹å·²ç»æŒæœ‰äº†è¯¥ Object çš„è½»é‡çº§é”ï¼Œè¿™æ—¶è¡¨æ˜æœ‰ç«äº‰ï¼Œè¿›å…¥é”è†¨èƒ€è¿‡ç¨‹ï¼Œåç»­è¯´æ˜</strong></li>
<li><strong>å¦‚æœæ˜¯è‡ªå·±æ‰§è¡Œäº† synchronized é”é‡å…¥ï¼Œé‚£ä¹ˆå†æ·»åŠ ä¸€æ¡ Lock Record ä½œä¸ºé‡å…¥çš„è®¡æ•°ï¼ŒåŸæœ¬è®°å½•çš„Hashcodeç­‰å˜ä¸ºnullï¼Œå¦‚ä¸‹</strong></li>
</ul>
<img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-09_16.14.17.png" width="50%" loading="lazy">


<p><strong>å½“é€€å‡º synchronized ä»£ç å—ï¼ˆè§£é”æ—¶ï¼‰å¦‚æœæœ‰å–å€¼ä¸º null çš„é”è®°å½•ï¼Œè¡¨ç¤ºæœ‰é‡å…¥ï¼Œè¿™æ—¶é‡ç½®é”è®°å½•ï¼Œè¡¨ç¤ºé‡å…¥è®¡æ•°å‡ä¸€</strong></p>
<img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-09_16.15.41.png" width="50%" loading="lazy">

<p><strong>å½“é€€å‡º synchronized ä»£ç å—ï¼ˆè§£é”æ—¶ï¼‰é”è®°å½•çš„å€¼ä¸ä¸º nullï¼Œè¿™æ—¶ä½¿ç”¨ cas å°† Mark Word çš„å€¼æ¢å¤ç»™å¯¹è±¡å¤´</strong></p>
<ul>
<li><strong>æˆåŠŸï¼Œåˆ™è§£é”æˆåŠŸ</strong></li>
<li><strong>å¤±è´¥ï¼Œè¯´æ˜è½»é‡çº§é”è¿›è¡Œäº†é”è†¨èƒ€æˆ–å·²ç»å‡çº§ä¸ºé‡é‡çº§é”ï¼Œè¿›å…¥é‡é‡çº§é”è§£é”æµç¨‹</strong></li>
</ul>
<h3 id="é”è†¨èƒ€"><a href="#é”è†¨èƒ€" class="headerlink" title="é”è†¨èƒ€"></a><strong>é”è†¨èƒ€</strong></h3><p><strong>å¦‚æœåœ¨å°è¯•åŠ è½»é‡çº§é”çš„è¿‡ç¨‹ä¸­ï¼ŒCASæ“ä½œæ— æ³•æˆåŠŸï¼Œè¿™æ—¶ä¸€ç§æƒ…å†µå°±æ˜¯æœ‰å…¶å®ƒçº¿ç¨‹ä¸ºæ­¤å¯¹è±¡åŠ ä¸Šäº†è½»é‡çº§é”ï¼ˆæœ‰ç«äº‰ï¼‰ï¼Œè¿™æ—¶éœ€è¦è¿›è¡Œé”è†¨èƒ€ï¼Œå°†è½»é‡çº§é”å˜ä¸ºé‡é‡çº§é”ã€‚</strong></p>
<p><strong>å½“ Thread-1 è¿›è¡Œè½»é‡çº§åŠ é”æ—¶ï¼ŒThread-0 å·²ç»å¯¹è¯¥å¯¹è±¡åŠ äº†è½»é‡çº§é”</strong><br><img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-09_16.21.07.png" width="65%" loading="lazy"></p>
<p><strong>è¿™æ—¶ Thread-1 åŠ è½»é‡çº§é”å¤±è´¥ï¼Œè¿›å…¥é”è†¨èƒ€æµç¨‹</strong></p>
<ul>
<li><strong>Object å¯¹è±¡ç”³è¯· Monitor é”ï¼Œè®©MarkwordæŒ‡å‘é‡é‡çº§é”åœ°å€ï¼Œå¹¶ä¸”æ ‡è¯†ä½å˜ä¸º10</strong></li>
<li><strong>ç„¶åè‡ªå·±è¿›å…¥Monitor çš„ EntryList BLOCKED</strong></li>
</ul>
<img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-09_16.24.58.png" width="65%" loading="lazy">

<p><strong>å½“ Thread-0 é€€å‡ºåŒæ­¥å—è§£é”æ—¶ï¼Œä½¿ç”¨ cas å°† Mark Word çš„å€¼æ¢å¤ç»™å¯¹è±¡å¤´ï¼Œå¤±è´¥ã€‚è¿™æ—¶ä¼šè¿›å…¥é‡é‡çº§è§£é”æµç¨‹</strong><br><strong>å³æŒ‰ç…§ Monitor åœ°å€æ‰¾åˆ° Monitor å¯¹è±¡ï¼Œè®¾ç½® Owner ä¸º nulï¼Œå”¤é†’ EntryList ä¸­ BLOCKED çº¿ç¨‹</strong></p>
<h3 id="è‡ªæ—‹ä¼˜åŒ–"><a href="#è‡ªæ—‹ä¼˜åŒ–" class="headerlink" title="è‡ªæ—‹ä¼˜åŒ–"></a><strong>è‡ªæ—‹ä¼˜åŒ–</strong></h3><p><strong>é‡é‡çº§é”ç«äº‰çš„æ—¶å€™ï¼Œè¿˜å¯ä»¥ä½¿ç”¨è‡ªæ—‹æ¥è¿›è¡Œä¼˜åŒ–ï¼Œå¦‚æœå½“å‰çº¿ç¨‹è‡ªæ—‹æˆåŠŸï¼ˆå³è¿™æ—¶å€™æŒé”çº¿ç¨‹å·²ç»é€€å‡ºäº†åŒæ­¥å—ï¼Œé‡Šæ”¾äº†é”)ï¼Œè¿™æ—¶å½“å‰çº¿ç¨‹å°±å¯ä»¥é¿å…é˜»å¡ã€‚</strong></p>
<p><strong>è‡ªæ—‹æˆåŠŸæƒ…å†µï¼Œé‡è¯•å°è¯•æˆåŠŸè·å–é”</strong></p>
<img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-09_16.29.43.png" width="55%" loading="lazy">

<p><strong>è‡ªæ—‹å¤±è´¥æƒ…å†µï¼Œåªèƒ½é˜»å¡</strong></p>
<img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-09_16.28.11.png" width="55%" loading="lazy">

<blockquote>
<p><strong>æ³¨æ„</strong></p>
<ul>
<li>åœ¨Java 6 ä¹‹åè‡ªæ—‹é”æ˜¯è‡ªé€‚åº”çš„ï¼Œæ¯”å¦‚å¯¹è±¡åˆšåˆšçš„ä¸€æ¬¡è‡ªæ—‹æ“ä½œæˆåŠŸè¿‡ï¼Œé‚£ä¹ˆè®¤ä¸ºè¿™æ¬¡è‡ªæ—‹æˆåŠŸçš„å¯èƒ½æ€§ä¼šé«˜ï¼Œå°±å¤šè‡ªæ—‹å‡ æ¬¡ï¼›åä¹‹ï¼Œå°±å°‘è‡ªæ—‹ç”šè‡³ä¸è‡ªæ—‹ï¼Œæ€»ä¹‹ï¼Œæ¯”è¾ƒæ™ºèƒ½ã€‚</li>
<li>è‡ªæ—‹ä¼šå ç”¨ CPU æ—¶é—´ï¼Œå•æ ¸ CPU è‡ªæ—‹å°±æ˜¯æµªè´¹ï¼Œå¤šæ ¸ CPU è‡ªæ—‹æ‰èƒ½å‘æŒ¥ä¼˜åŠ¿ã€‚</li>
<li>Java 7 ä¹‹åä¸èƒ½æ§åˆ¶æ˜¯å¦å¼€å¯è‡ªæ—‹åŠŸèƒ½</li>
</ul>
</blockquote>
<h3 id="åå‘é”"><a href="#åå‘é”" class="headerlink" title="åå‘é”"></a><strong>åå‘é”</strong></h3><p><strong>è½»é‡çº§é”åœ¨æ²¡æœ‰ç«äº‰æ—¶ï¼ˆå°±è‡ªå·±è¿™ä¸ªçº¿ç¨‹ï¼‰ï¼Œæ¯æ¬¡é‡å…¥ä»ç„¶éœ€è¦æ‰§è¡Œ CAS æ“ä½œã€‚</strong><br><strong>Java 6 ä¸­å¼•å…¥äº†åå‘é”æ¥åšè¿›ä¸€æ­¥ä¼˜åŒ–ï¼šåªæœ‰ç¬¬ä¸€æ¬¡ä½¿ç”¨ CAS å°†çº¿ç¨‹ I è®¾ç½®åˆ°å¯¹è±¡çš„ Mark Word å¤´ï¼Œä¹‹åå‘ç°è¿™ä¸ªçº¿ç¨‹ 1D æ˜¯è‡ªå·±çš„å°±è¡¨ç¤ºæ²¡æœ‰ç«äº‰ï¼Œä¸ç”¨é‡æ–° CASã€‚ä»¥ååªè¦ä¸å‘ç”Ÿç«äº‰ï¼Œè¿™ä¸ªå¯¹è±¡å°±å½’è¯¥çº¿ç¨‹æ‰€æœ‰</strong></p>
<blockquote>
<p>ä¸€ä¸ªå¯¹è±¡åˆ›å»ºæ—¶ï¼š</p>
<ul>
<li>å¦‚æœå¼€å¯äº†åå‘é”ï¼ˆé»˜è®¤å¼€å¯)ï¼Œé‚£ä¹ˆå¯¹è±¡åˆ›å»ºåï¼Œmarkword å€¼ä¸º 0x05 å³æœ€å3ä½ä¸º101ï¼Œè¿™æ—¶å®ƒçš„threadã€ epochã€ age éƒ½ä¸º0</li>
<li>åå‘é”æ˜¯é»˜è®¤æ˜¯å»¶è¿Ÿçš„ï¼Œä¸ä¼šåœ¨ç¨‹åºå¯åŠ¨æ—¶ç«‹å³ç”Ÿæ•ˆï¼Œå¦‚æœæƒ³é¿å…å»¶è¿Ÿï¼Œå¯ä»¥åŠ  VM å‚æ•°</li>
</ul>
<p> <strong>xx:BiasedLockingStartupDelay=e æ¥ç¦ç”¨å»¶è¿Ÿ</strong></p>
<ul>
<li>å¦‚æœæ²¡æœ‰å¼€å¯åå‘é”ï¼Œé‚£ä¹ˆå¯¹è±¡åˆ›å»ºåï¼Œmarkword å€¼ä¸º Ox01 å³æœ€å3ä½ä¸º 001ï¼Œè¿™æ—¶å®ƒçš„ hashcode. ageéƒ½ä¸º0ï¼Œç¬¬ä¸€æ¬¡ç”¨åˆ° hashcode æ—¶æ‰ä¼šèµ‹å€¼</li>
</ul>
</blockquote>
<p><strong>ç¦ç”¨åå‘é”</strong></p>
<blockquote>
<p>-XXï¼š-UseBiasedLocking ç¦ç”¨åå‘é”</p>
</blockquote>
<p><strong>è°ƒç”¨hashCodeå–æ¶ˆåå‘é”</strong></p>
<blockquote>
<p>åŸå› ï¼šå› ä¸ºåå‘é”é‡Œå­˜çš„æ˜¯æ“ä½œç³»ç»Ÿå±‚é¢çš„çº¿ç¨‹id(51ä½)ï¼Œæ²¡æœ‰åœ°æ–¹å­˜hashcode,æ‰€ä»¥ç”¨åˆ°hashcodeæ—¶ä¼šæ’¤é”€åå‘é”</p>
</blockquote>
<p><strong>å…¶ä»–çº¿ç¨‹è·å–é”å–æ¶ˆåå‘é”</strong></p>
<blockquote>
<p>è¿™æ—¶åå‘çŠ¶æ€é‡æ–°å˜ä¸º0ï¼Œåå‘é”å˜ä¸ºè½»é‡çº§é”</p>
</blockquote>
<p><strong>è°ƒç”¨wait/notifyå–æ¶ˆåå‘é”</strong></p>
<blockquote>
<p>å› ä¸ºç­‰å¾…å”¤é†’æœºåˆ¶åªæœ‰é‡é‡é”æœ‰</p>
</blockquote>
<p><strong>æ‰¹é‡é‡åå‘</strong></p>
<blockquote>
<p>å¦‚æœå¯¹è±¡è™½ç„¶è¢«å¤šä¸ªçº¿ç¨‹è®¿é—®ï¼Œä½†æ²¡æœ‰ç«äº‰ï¼Œè¿™æ—¶åå‘äº†çº¿ç¨‹T1çš„å¯¹è±¡ä»æœ‰æœºä¼šé‡æ–°åå‘T2ï¼Œé‡åå‘ä¼šé‡ç½®å¯¹è±¡çš„ Thread ID<br>å½“æ’¤é”€åå‘é”é˜ˆå€¼è¶…è¿‡20 æ¬¡åï¼Œjvm ä¼šè¿™æ ·è§‰å¾—ï¼Œæˆ‘æ˜¯ä¸æ˜¯åå‘é”™äº†å‘¢ï¼Œäºæ˜¯ä¼šåœ¨ç»™è¿™äº›å¯¹è±¡åŠ é”æ—¶é‡æ–°åå‘è‡³åŠ é”çº¿ç¨‹</p>
</blockquote>
<p><strong>æ‰¹é‡æ’¤é”€</strong></p>
<blockquote>
<p>å½“æ’’é”€åå‘é”é˜ˆå€¼è¶…è¿‡ 40 æ¬¡åï¼Œjvm ä¼šè¿™æ ·è§‰å¾—ï¼Œè‡ªå·±ç¡®å®åå‘é”™äº†ï¼Œæ ¹æœ¬å°±ä¸è¯¥åå‘ã€‚äºæ˜¯æ•´ä¸ªç±»çš„æ‰€æœ‰å¯¹è±¡éƒ½ä¼šå˜ä¸ºä¸å¯åå‘çš„ï¼Œæ–°å»ºçš„å¯¹è±¡ä¹Ÿæ˜¯ä¸å¯åå‘çš„</p>
</blockquote>
<h3 id="é”æ¶ˆé™¤"><a href="#é”æ¶ˆé™¤" class="headerlink" title="é”æ¶ˆé™¤"></a><strong>é”æ¶ˆé™¤</strong></h3><blockquote>
<p>-XX:-EliminateLocks<br>JITå³æ—¶ç¼–è¯‘å™¨ä¼šåˆ†æä»£ç ï¼Œå¦‚æœæ–¹æ³•ä¸­çš„å±€éƒ¨å˜é‡æ²¡æœ‰é€ƒé€¸ï¼Œé‚£ä¹ˆå¯¹å®ƒåŠ é”æ²¡æœ‰æ„ä¹‰ï¼Œä¸ä¼šåŠ ä»»ä½•é”ã€‚</p>
</blockquote>
<h2 id="wait-notify"><a href="#wait-notify" class="headerlink" title="wait/notify"></a><strong>wait/notify</strong></h2><h3 id="åŸç†ä¹‹wait-notify"><a href="#åŸç†ä¹‹wait-notify" class="headerlink" title="åŸç†ä¹‹wait/notify"></a><strong>åŸç†ä¹‹wait/notify</strong></h3><img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-09_14.54.28.png" width="70%" loading="lazy">

<blockquote>
<p>Ownerçº¿ç¨‹è·å¾—é”ä½†å‘ç°æ¡ä»¶ä¸æ»¡è¶³ï¼Œè°ƒç”¨ wait æ–¹æ³•ï¼Œå³å¯è¿›å…¥ WaitSet å˜ä¸º WAITING çŠ¶æ€<br>BLOCKED å’Œ WAITING çš„çº¿ç¨‹éƒ½å¤„äºé˜»å¡çŠ¶æ€ï¼Œä¸å ç”¨ CPU æ—¶é—´ç‰‡<br>BLOCKED çº¿ç¨‹ä¼šåœ¨ Owner çº¿ç¨‹é‡Šæ”¾é”æ—¶å”¤é†’<br>WAITING çº¿ç¨‹ä¼šåœ¨ Owner çº¿ç¨‹è°ƒç”¨ notify æˆ– notifyAll æ—¶å”¤é†’ï¼Œä½†å”¤é†’åå¹¶ä¸æ„å‘³è€…ç«‹åˆ»è·å¾—é”ï¼Œä»éœ€è¿›å…¥EntryList é‡æ–°ç«äº‰</p>
</blockquote>
<h3 id="APIä»‹ç»"><a href="#APIä»‹ç»" class="headerlink" title="APIä»‹ç»"></a><strong>APIä»‹ç»</strong></h3><blockquote>
<ul>
<li>obj.wait(ï¼‰ è®©è¿›å…¥ object ç›‘è§†å™¨çš„çº¿ç¨‹åˆ° waitSet ç­‰å¾…</li>
<li>obj.notify() åœ¨ object ä¸Šæ­£åœ¨ waitSet ç­‰å¾…çš„çº¿ç¨‹ä¸­æŒ‘ä¸€ä¸ªå”¤é†’</li>
<li>obj.notifyA11() è®© object ä¸Šæ­£åœ¨ waitSet ç­‰å¾…çš„çº¿ç¨‹å…¨éƒ¨å”¤é†’</li>
</ul>
<p><strong>æ³¨æ„</strong><br>å®ƒä»¬éƒ½æ˜¯çº¿ç¨‹ä¹‹é—´è¿›è¡Œåä½œçš„æ‰‹æ®µï¼Œéƒ½å±äº Object å¯¹è±¡çš„æ–¹æ³•ã€‚å¿…é¡»è·å¾—æ­¤å¯¹è±¡çš„é”ï¼Œæ‰èƒ½è°ƒç”¨è¿™å‡ ä¸ªæ–¹æ³•</p>
</blockquote>
<p><strong>sleep( 1ong n) å’Œwait(1ong n) çš„åŒºåˆ«</strong></p>
<blockquote>
<ul>
<li>sleep æ˜¯ Thread æ–¹æ³•ï¼Œè€Œ wait æ˜¯ Object çš„æ–¹æ³•</li>
<li>sleep ä¸éœ€è¦å¼ºåˆ¶å’Œ synchronized é…åˆä½¿ç”¨ï¼Œä½† wait éœ€è¦å’Œ synchronized ä¸€èµ·ç”¨</li>
<li>sleep åœ¨ç¡çœ çš„åŒæ—¶ï¼Œä¸ä¼šé‡Šæ”¾å¯¹è±¡é”çš„ï¼Œä½† wait åœ¨ç­‰å¾…çš„æ—¶å€™ä¼šé‡Šæ”¾å¯¹è±¡é”ã€‚</li>
<li>å®ƒä»¬çŠ¶æ€éƒ½æ˜¯TIMED_WAITING</li>
</ul>
</blockquote>
<h3 id="wait-notifyæ­£ç¡®ä½¿ç”¨"><a href="#wait-notifyæ­£ç¡®ä½¿ç”¨" class="headerlink" title="wait/notifyæ­£ç¡®ä½¿ç”¨"></a><strong>wait/notifyæ­£ç¡®ä½¿ç”¨</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">synchronized (lock) &#123;</span><br><span class="line">    while (æ¡ä»¶ä¸æˆç«‹) &#123;</span><br><span class="line">        lock.wait();</span><br><span class="line">    &#125;</span><br><span class="line">    å¹²æ´»</span><br><span class="line">&#125;</span><br><span class="line">//å¦ä¸€ä¸ªçº¿ç¨‹</span><br><span class="line">synchronized (lock) &#123;</span><br><span class="line">    lock.notifyAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="åŒæ­¥æ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœ"><a href="#åŒæ­¥æ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœ" class="headerlink" title="åŒæ­¥æ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœ"></a><strong>åŒæ­¥æ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœ</strong></h3><p><strong>å³ Guarded Suspensionï¼Œç”¨åœ¨ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„æ‰§è¡Œç»“æœ</strong></p>
<img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-10_14.00.08.png" width="70%" loading="lazy">

<blockquote>
<p><strong>è¦ç‚¹</strong></p>
<ul>
<li>æœ‰ä¸€ä¸ªç»“æœéœ€è¦ä»ä¸€ä¸ªçº¿ç¨‹ä¼ é€’åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œè®©ä»–ä»¬å…³è”åŒä¸€ä¸ª GuardedObject</li>
<li>å¦‚æœæœ‰ç»“æœä¸æ–­ä»ä¸€ä¸ªçº¿ç¨‹åˆ°å¦ä¸€ä¸ªçº¿ç¨‹é‚£ä¹ˆå¯ä»¥ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆè§ç”Ÿäº§è€…/æ¶ˆè´¹è€…ï¼‰</li>
<li>JDK ä¸­ï¼Œjoin çš„å®ç°ã€Future çš„å®ç°ï¼Œé‡‡ç”¨çš„å°±æ˜¯æ­¤æ¨¡å¼</li>
<li>å› ä¸ºè¦ç­‰å¾…å¦ä¸€æ–¹çš„ç»“æœï¼Œå› æ­¤å½’ç±»åˆ°åŒæ­¥æ¨¡å¼</li>
</ul>
</blockquote>
<p><strong>è™šå‡å”¤é†’</strong></p>
<blockquote>
<p>å…¶ä»–çº¿ç¨‹é”™è¯¯çš„å”¤é†’äº†ä¸è¯¥å”¤é†’çš„çº¿ç¨‹(notifyæ˜¯éšæœºçš„,è€Œnotifyallæ˜¯æ‰€æœ‰äºº)</p>
</blockquote>
<p><strong>åŒæ­¥æ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœä»£ç å®ç°</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">public class GuardedObject &#123;</span><br><span class="line"></span><br><span class="line">    private int id;</span><br><span class="line"></span><br><span class="line">    public GuardedObject(int id) &#123;</span><br><span class="line">        this.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int getId() &#123;</span><br><span class="line">        return id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //ç»“æœ</span><br><span class="line">    private Object response;</span><br><span class="line"></span><br><span class="line">    //è·å–ç»“æœ</span><br><span class="line">    public Object get() throws InterruptedException &#123;</span><br><span class="line">        synchronized (this) &#123;</span><br><span class="line">            while (response == null) &#123;</span><br><span class="line">                this.wait();</span><br><span class="line">            &#125;</span><br><span class="line">            return response;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //äº§ç”Ÿç»“æœ</span><br><span class="line">    public void complete(Object response) &#123;</span><br><span class="line">        synchronized (this) &#123;</span><br><span class="line">            this.response = response;</span><br><span class="line">            this.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //æ‰©å±•è¶…æ—¶ç­‰å¾…</span><br><span class="line">    public Object get(long timeout) throws InterruptedException &#123;</span><br><span class="line">        synchronized (this) &#123;</span><br><span class="line">            long begin = System.currentTimeMillis();//å¼€å§‹æ—¶é—´</span><br><span class="line">            long passTime = 0;//ç»å†çš„æ—¶é—´</span><br><span class="line">            while (response == null) &#123;</span><br><span class="line">                long waitTime = timeout - passTime;//è¿™ä¸€è½®åº”è¯¥è¦ç­‰å¾…çš„æ—¶é—´</span><br><span class="line">                if (waitTime &lt;= 0)//ä¸éœ€è¦ç­‰äº†</span><br><span class="line">                    break;</span><br><span class="line">                this.wait(waitTime);</span><br><span class="line">                passTime = System.currentTimeMillis() - begin;//æ±‚å¾—ç»å†çš„æ—¶é—´</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            return response;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class MailBoxes &#123;</span><br><span class="line">    private static Map&lt;Integer, GuardedObject&gt; boxs = new Hashtable&lt;&gt;();</span><br><span class="line">    private static int id = 1;</span><br><span class="line"></span><br><span class="line">    private static synchronized int generateId() &#123;</span><br><span class="line">        return id++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static GuardedObject getGuardedObject(int id) &#123;</span><br><span class="line">        return boxs.remove(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static GuardedObject createGuardedObject()&#123;</span><br><span class="line">        GuardedObject go = new GuardedObject(generateId());</span><br><span class="line">        boxs.put(go.getId(),go);</span><br><span class="line">        return go;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static Set&lt;Integer&gt; getIds()&#123;</span><br><span class="line">        return boxs.keySet();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ä¸Šè¿°ä»£ç å®ç°äº†è¶…æ—¶ç­‰å¾…ï¼Œå‘é€è€…å’Œæ¥æ”¶è€…çš„ç»“å¶ï¼Œå¤šä¸ªä»»åŠ¡çš„ç®¡ç†<br>å‘é€è€…å’Œæ¥æ”¶è€…ä¸€å¯¹ä¸€ä¸€ä¸€å¯¹åº”ï¼Œå¦‚æœæ˜¯å¤šæ¶ˆæ¯å‘é€ï¼Œé‚£ä¹ˆå¯ä»¥é€‰æ‹©æ¶ˆè´¹è€…ç”Ÿäº§è€…æ¨¡å¼</p>
</blockquote>
<h3 id="å¼‚æ­¥æ¨¡å¼ä¹‹ç”Ÿäº§è€…è´¹è€…"><a href="#å¼‚æ­¥æ¨¡å¼ä¹‹ç”Ÿäº§è€…è´¹è€…" class="headerlink" title="å¼‚æ­¥æ¨¡å¼ä¹‹ç”Ÿäº§è€…è´¹è€…"></a><strong>å¼‚æ­¥æ¨¡å¼ä¹‹ç”Ÿäº§è€…è´¹è€…</strong></h3><blockquote>
<p><strong>è¦ç‚¹</strong></p>
<ul>
<li>ä¸å‰é¢çš„ä¿æŠ¤æ€§æš‚åœä¸­çš„ GuardObject ä¸åŒï¼Œä¸éœ€è¦äº§ç”Ÿç»“æœå’Œæ¶ˆè´¹ç»“æœçš„çº¿ç¨‹â€”â€”å¯¹åº”</li>
<li>æ¶ˆè´¹é˜Ÿåˆ—å¯ä»¥ç”¨æ¥å¹³è¡¡ç”Ÿäº§å’Œæ¶ˆè´¹çš„çº¿ç¨‹èµ„æº</li>
<li>ç”Ÿäº§è€…ä»…è´Ÿè´£äº§ç”Ÿç»“æœæ•°æ®ï¼Œä¸å…³å¿ƒæ•°æ®è¯¥å¦‚ä½•å¤„ç†ï¼Œè€Œæ¶ˆè´¹è€…ä¸“å¿ƒå¤„ç†ç»“æœæ•°æ®</li>
<li>æ¶ˆæ¯é˜Ÿåˆ—æ˜¯æœ‰å®¹é‡é™åˆ¶çš„ï¼Œæ»¡æ—¶ä¸ä¼šå†åŠ å…¥æ•°æ®ï¼Œç©ºæ—¶ä¸ä¼šå†æ¶ˆè€—æ•°æ®</li>
<li>JDK ä¸­å„ç§é˜»å¡é˜Ÿåˆ—ï¼Œé‡‡ç”¨çš„å°±æ˜¯è¿™ç§æ¨¡å¼</li>
</ul>
</blockquote>
<img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-10_15.05.51.png " width="70%" loading="lazy">

<p><strong>ä»£ç å®ç°</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">final class Message &#123;</span><br><span class="line">    private int id;</span><br><span class="line">    private Object message;</span><br><span class="line">    public Message(int id, Object message) &#123;</span><br><span class="line">        this.id = id;</span><br><span class="line">        this.message = message;</span><br><span class="line">    &#125;</span><br><span class="line">    public int getId() &#123;</span><br><span class="line">        return id;</span><br><span class="line">    &#125;</span><br><span class="line">    public Object getMessage() &#123;</span><br><span class="line">        return message;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return &quot;Message&#123;&quot; +</span><br><span class="line">                &quot;id=&quot; + id +</span><br><span class="line">                &quot;, message=&quot; + message +</span><br><span class="line">                &#x27;&#125;&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//æ¶ˆæ¯é˜Ÿåˆ—ï¼Œçº¿ç¨‹é€šä¿¡</span><br><span class="line">class MessageQueue &#123;</span><br><span class="line">    private LinkedList&lt;Message&gt; list = new LinkedList&lt;&gt;();//åŒç«¯é“¾è¡¨</span><br><span class="line">    private int capcity = 0;//é˜Ÿåˆ—å®¹é‡</span><br><span class="line">    //åˆå§‹åŒ–å®¹é‡å¤§å°</span><br><span class="line">    public MessageQueue(int capcity) &#123;</span><br><span class="line">        this.capcity = capcity;</span><br><span class="line">    &#125;</span><br><span class="line">    //è·å–æ¶ˆæ¯</span><br><span class="line">    public Message take() throws InterruptedException &#123;</span><br><span class="line">        synchronized (list) &#123;</span><br><span class="line">            while (list.isEmpty()) &#123;</span><br><span class="line">                list.wait();</span><br><span class="line">            &#125;</span><br><span class="line">            Message message = list.removeFirst();</span><br><span class="line">            list.notifyAll();</span><br><span class="line">            return message;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //æ·»åŠ æ¶ˆæ¯</span><br><span class="line">    public void put(Message message) throws InterruptedException &#123;</span><br><span class="line">        synchronized (list) &#123;</span><br><span class="line">            while (list.size() &gt;= capcity) &#123;</span><br><span class="line">                list.wait();</span><br><span class="line">            &#125;</span><br><span class="line">            list.add(message);</span><br><span class="line">            list.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Park-amp-Unpark"><a href="#Park-amp-Unpark" class="headerlink" title="Park &amp; Unpark"></a><strong>Park &amp; Unpark</strong></h3><p><strong>ç‰¹ç‚¹</strong></p>
<blockquote>
<p><strong>ä¸Object çš„ wait &amp; notify ç›¸æ¯”</strong></p>
<ul>
<li>wait, notify å’Œ notifyAll å¿…é¡»é…åˆ Object Monitor ä¸€èµ·ä½¿ç”¨ï¼Œè€Œ park, unpark ä¸å¿…</li>
<li>park &amp; unpark æ˜¯ä»¥çº¿ç¨‹ä¸ºå•ä½æ¥ã€é˜»å¡ã€‘å’Œã€å”¤é†’ã€‘çº¿ç¨‹ï¼Œè€Œ notify åªèƒ½éšæœºå”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ï¼Œ</li>
<li>notifyAll æ˜¯å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ï¼Œå°±ä¸é‚£ä¹ˆã€ç²¾ç¡®ã€‘</li>
<li>park &amp; unpark å¯ä»¥å…ˆ umparkï¼Œè€Œ wait &amp; notify ä¸èƒ½å…ˆ notify</li>
</ul>
<p><strong>å…¶ä»–</strong></p>
<ul>
<li>parkæ˜¯locksupportçš„ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œç”¨äºæ‰“æ–­å½“å‰çº¿ç¨‹</li>
<li>è°ƒç”¨åä»£ç ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œä¸å¾€åæ‰§è¡Œ,ä¸æ”¹å˜isInterrupted</li>
<li>å½“isInterruptedä¸ºtrueæ—¶,parkå¤±æ•ˆ,åªæœ‰ä¸ºfalseï¼Œpark&amp;unparkæ‰ç”Ÿæ•ˆ</li>
</ul>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Thread thread1 = new Thread(()-&gt;&#123;                </span><br><span class="line">    try &#123;                                        </span><br><span class="line">        System.out.println(&quot;å¼€å§‹ç¡çœ &quot;);              </span><br><span class="line">        Thread.sleep(1000);                      </span><br><span class="line">    &#125; catch (InterruptedException e) &#123;           </span><br><span class="line">        e.printStackTrace();                     </span><br><span class="line">    &#125;                                            </span><br><span class="line">    System.out.println(&quot;å¼€å§‹park&quot;);                </span><br><span class="line">    LockSupport.park();                          </span><br><span class="line">    System.out.println(&quot;parkç»“æŸ&quot;);                </span><br><span class="line">&#125;);                                              </span><br><span class="line">thread1.start();                                 </span><br><span class="line">Thread.sleep(3000);                              </span><br><span class="line">System.out.println(&quot;å¼€å§‹unpark&quot;);                  </span><br><span class="line">LockSupport.unpark(thread1);                                                                                                             </span><br></pre></td></tr></table></figure>
<p><strong>park &amp; unparkåŸç†</strong></p>
<p><strong>park</strong></p>
<blockquote>
<p><strong>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ä¸€ä¸ª Parker å¯¹è±¡ï¼Œç”±ä¸‰éƒ¨åˆ†ç»„æˆ _counterï¼Œ_cond å’Œ_mutex,éƒ½æ˜¯cä»£ç å®ç°çš„javaçœ‹ä¸åˆ°</strong></p>
<p>çº¿ç¨‹å°±åƒä¸€ä¸ªæ—…äººï¼ŒParker å°±åƒä»–éšèº«æºå¸¦çš„èƒŒåŒ…ï¼Œæ¡ä»¶å˜é‡å°±å¥½æ¯”èƒŒåŒ…ä¸­çš„å¸ç¯·ã€‚counter å°±å¥½æ¯”èƒŒåŒ…ä¸­çš„å¤‡ç”¨å¹²ç²®ï¼ˆ0 ä¸ºè€—å°½ï¼Œ1ä¸ºå……è¶³ï¼‰<br>è°ƒç”¨ park å°±æ˜¯è¦çœ‹éœ€ä¸éœ€è¦åœä¸‹æ¥æ­‡æ¯</p>
<ul>
<li>å¦‚æœå¤‡ç”¨å¹²ç²®è€—å°½ï¼Œé‚£ä¹ˆé’»è¿›å¸ç¯·æ­‡æ¯</li>
<li>å¦‚æœå¤‡ç”¨å¹²ç²®å……è¶³ï¼Œé‚£ä¹ˆä¸éœ€åœç•™ï¼Œç»§ç»­å‰è¿›</li>
</ul>
<p>è°ƒç”¨ unparkï¼Œå°±å¥½æ¯”ä»¤å¹²ç²®å……è¶³</p>
<ul>
<li>å¦‚æœè¿™æ—¶çº¿ç¨‹è¿˜åœ¨å¸ç¯·ï¼Œå°±å”¤é†’è®©ä»–ç»§ç»­å‰è¿›</li>
<li>å¦‚æœè¿™æ—¶çº¿ç¨‹è¿˜åœ¨è¿è¡Œï¼Œé‚£ä¹ˆä¸‹æ¬¡ä»–è°ƒç”¨ park æ—¶ï¼Œä»…æ˜¯æ¶ˆè€—æ‰å¤‡ç”¨å¹²ç²®ï¼Œä¸éœ€åœç•™ç»§ç»­å‰è¿›</li>
<li>å› ä¸ºèƒŒåŒ…ç©ºé—´æœ‰é™ï¼Œå¤šæ¬¡è°ƒç”¨ unpark ä»…ä¼šè¡¥å……ä¸€ä»½å¤‡ç”¨å¹²ç²®</li>
</ul>
</blockquote>
<img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-10_16.04.10.png " width="70%" loading="lazy">

<blockquote>
<ol>
<li>å½“å‰çº¿ç¨‹è°ƒç”¨ Unsafe.park0 æ–¹æ³•</li>
<li>æ£€æŸ¥_counterï¼Œæœ¬æƒ…å†µä¸º0ï¼Œè¿™æ—¶ï¼Œè·å¾—_mutex äº’æ–¥é”</li>
<li>çº¿ç¨‹è¿›å…¥_cond æ¡ä»¶å˜é‡é˜»å¡</li>
<li>è®¾ç½®_counter =0</li>
</ol>
</blockquote>
<p><strong>parkåå†unpark</strong></p>
<img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-10_16.06.39.png " width="70%" loading="lazy">



<blockquote>
<ol>
<li>è°ƒç”¨ Unsafe.unpark(Thread_0) æ–¹æ³•ï¼Œè®¾ç½®_counter ä¸º1</li>
<li>å”¤é†’_cond æ¡ä»¶å˜é‡ä¸­çš„ Thread 0</li>
<li>Thread 0 æ¢å¤è¿è¡Œ</li>
<li>è®¾ç½® counter ä¸º0</li>
</ol>
</blockquote>
<p><strong>å…ˆunpark</strong></p>
<img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-10_16.05.49.png " width="70%" loading="lazy">


<blockquote>
<ol>
<li>è°ƒç”¨ Unsafe.unpark(Thread 0) æ–¹æ³•ï¼Œè®¾ç½® counter ä¸ºï¼</li>
<li>å½“å‰çº¿ç¨‹è°ƒç”¨ Unsafe.park0 æ–¹æ³•</li>
<li>æ£€æŸ¥_counterï¼Œæœ¬æƒ…å†µä¸º1ï¼Œè¿™æ—¶çº¿ç¨‹æ— éœ€é˜»å¡ï¼Œç»§ç»­è¿è¡Œ</li>
<li>è®¾ç½®_counter ä¸º0</li>
</ol>
</blockquote>
<h2 id="çº¿ç¨‹çŠ¶æ€è½¬æ¢"><a href="#çº¿ç¨‹çŠ¶æ€è½¬æ¢" class="headerlink" title="çº¿ç¨‹çŠ¶æ€è½¬æ¢"></a><strong>çº¿ç¨‹çŠ¶æ€è½¬æ¢</strong></h2><img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-10_16.31.02.png" width="70%" loading="lazy">

<blockquote>
<p>1:è°ƒç”¨startè¿›å…¥runnable<br>2:è°ƒç”¨waitæ—¶è¿›å…¥waitingï¼Œè°ƒç”¨notify,interruptæ—¶ï¼Œç«äº‰é”å¤±è´¥è¿›å…¥blockedï¼Œç«äº‰é”æˆåŠŸè¿›å…¥runnable<br>3:è°ƒç”¨joinè¿›å…¥waitingï¼Œç­‰å¾…çš„çº¿ç¨‹è¿è¡Œç»“æŸæˆ–è€…è°ƒç”¨interruptè¿›å…¥runnableã€‚<br>4:è°ƒç”¨parkè¿›å…¥waitingï¼Œè°ƒç”¨unparkæˆ–è€…interruptè¿›å…¥runnable<br>5:è°ƒç”¨wait(long)è¿›å…¥time_waiting,è‡ªç„¶ç»“æŸæˆ–è€…è°ƒç”¨notify,interruptæ—¶ï¼Œç«äº‰é”å¤±è´¥è¿›å…¥blockedï¼Œç«äº‰é”æˆåŠŸè¿›å…¥runnable<br>6:è°ƒç”¨join(long)è¿›å…¥time_waitingï¼Œè‡ªç„¶ç»“æŸæˆ–è€…è°ƒç”¨interruptæ—¶è¿›å…¥runnable<br>7:è°ƒç”¨sleep(long)è¿›å…¥time_waitingï¼Œè‡ªç„¶ç»“æŸè¿›å…¥runnable<br>8:è°ƒç”¨LockSupport.parkNanos(long nanos)æˆ–è€…LockSupport.parkUntil(long millis)è¿›å…¥time_waitingï¼Œè°ƒç”¨unparkæˆ–è€…interruptæˆ–è€…è¶…æ—¶ï¼Œè¿›å…¥runnable<br>9:ç«äº‰é”å¤±è´¥è¿›å…¥blockedï¼Œç«äº‰é”æˆåŠŸè¿›å…¥runnable<br>10:ä»£ç è¿è¡Œå®Œæ¯•è¿›å…¥</p>
</blockquote>
<h2 id="æ´»è·ƒæ€§"><a href="#æ´»è·ƒæ€§" class="headerlink" title="æ´»è·ƒæ€§"></a><strong>æ´»è·ƒæ€§</strong></h2><h3 id="å¤šæŠŠé”"><a href="#å¤šæŠŠé”" class="headerlink" title="å¤šæŠŠé”"></a><strong>å¤šæŠŠé”</strong></h3><blockquote>
<p>æ ¹æ®å¯¹è±¡æ‰§è¡Œä¸åŒè¡Œä¸ºæ—¶,é”åŒä¸€å¯¹è±¡å®¹æ˜“é€ æˆä¸å¿…è¦çš„å¹¶å‘éšæ‚£<br><strong>è§£å†³ï¼šä½¿ç”¨å¤šæŠŠé”</strong></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">private static Object lock1 = new Object();</span><br><span class="line">private static Object lock2 = new Object();</span><br><span class="line"></span><br><span class="line">public void do1() &#123;</span><br><span class="line">    synchronized (lock1) &#123;</span><br><span class="line">        //do1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">public void do2() &#123;</span><br><span class="line">    synchronized (lock2) &#123;</span><br><span class="line">        //do2</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>å°†é”çš„ç²’åº¦ç»†åˆ†</strong></p>
<ul>
<li>å¥½å¤„ï¼Œæ˜¯å¯ä»¥å¢å¼ºå¹¶å‘åº¦</li>
<li>åå¤„ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹éœ€è¦åŒæ—¶è·å¾—å¤šæŠŠé”ï¼Œå°±å®¹æ˜“å‘ç”Ÿæ­»é”</li>
</ul>
</blockquote>
<h3 id="æ­»é”"><a href="#æ­»é”" class="headerlink" title="æ­»é”"></a><strong>æ­»é”</strong></h3><blockquote>
<p>æœ‰è¿™æ ·çš„æƒ…å†µï¼šä¸€ä¸ªçº¿ç¨‹éœ€è¦åŒæ—¶è·å–å¤šæŠŠé”ï¼Œè¿™æ—¶å°±å®¹æ˜“å‘ç”Ÿæ­»é”<br>t1çº¿ç¨‹ è·å¾—Aå¯¹è±¡é”ï¼Œæ¥ä¸‹æ¥æƒ³è·å–Bå¯¹è±¡çš„é”<br>t2 çº¿ç¨‹è·å¾—Bå¯¹è±¡é”ï¼Œæ¥ä¸‹æ¥æƒ³è·å– Aå¯¹è±¡çš„é”</p>
</blockquote>
<p><strong>å®šä½æ­»é”</strong></p>
<blockquote>
<p>æ£€æµ‹æ­»é”å¯ä»¥ä½¿ç”¨ jconsoleå·¥å…·ï¼Œæˆ–è€…ä½¿ç”¨ jps å®šä½è¿›ç¨‹ idï¼Œå†ç”¨ jstack å®šä½æ­»é”</p>
</blockquote>
<h3 id="æ´»é”"><a href="#æ´»é”" class="headerlink" title="æ´»é”"></a><strong>æ´»é”</strong></h3><blockquote>
<p>ç”±äºä»£ç ä¸­ä¿©çº¿ç¨‹çš„é€€å‡ºæ¡ä»¶äº’ç›¸åˆ¶çº¦å¯¼è‡´ä¸æ–­è¿è¡Œï¼Œæ— æ³•é€€å‡º</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">static volatile int count = 10;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        new Thread(() -&gt; &#123;</span><br><span class="line">            while (count &gt; 0) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    Thread.sleep(200);</span><br><span class="line">                    count--;</span><br><span class="line">                    System.out.println(&quot;count:&quot; + count);</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">        new Thread(() -&gt; &#123;</span><br><span class="line">            while (count &lt; 20) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    Thread.sleep(200);</span><br><span class="line">                    count++;</span><br><span class="line">                    System.out.println(&quot;count:&quot; + count);</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="é¥¥é¥¿ç°è±¡"><a href="#é¥¥é¥¿ç°è±¡" class="headerlink" title="é¥¥é¥¿ç°è±¡"></a><strong>é¥¥é¥¿ç°è±¡</strong></h3><blockquote>
<p>è§£å†³æ­»é”é—®é¢˜å¯ä»¥æ”¹å˜è·å–é”çš„é¡ºåºï¼Œéƒ½æ˜¯å…ˆAå†Bè¿™æ ·å°±å¯ä»¥è§£å†³äº†ï¼Œä½†æ˜¯ä¹Ÿé€ æˆäº†é¥¥é¥¿ç°è±¡ï¼Œä¸€æ–¹ä¸€ç›´éš¾ä»¥è·å–é”<br>å¾ˆå¤šæ•™ç¨‹ä¸­æŠŠé¥¥é¥¿å®šä¹‰ä¸ºï¼Œä¸€ä¸ªçº¿ç¨‹ç”±äºä¼˜å…ˆçº§å¤ªä½ï¼Œå§‹ç»ˆå¾—ä¸åˆ° CPU è°ƒåº¦æ‰§è¡Œï¼Œä¹Ÿä¸èƒ½å¤Ÿç»“æŸï¼Œé¥¥é¥¿çš„æƒ…å†µä¸æ˜“æ¼”ç¤ºï¼Œè®²è¯»å†™é”æ—¶ä¼šæ¶‰åŠé¥¥é¥¿é—®é¢˜</p>
</blockquote>
<h2 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="ReentrantLock"></a><strong>ReentrantLock</strong></h2><blockquote>
<p><strong>ç›¸å¯¹äº synchronized å®ƒå…·å¤‡å¦‚ä¸‹ç‰¹ç‚¹</strong></p>
<ul>
<li>å¯ä¸­æ–­(å…¶ä»–çº¿ç¨‹å¯ä»¥ä¸­æ–­å¦ä¸€ä¸ªçº¿ç¨‹çš„é”)</li>
<li>å¯ä»¥è®¾ç½®è¶…æ—¶æ—¶é—´</li>
<li>å¯ä»¥è®¾ç½®ä¸ºå…¬å¹³é”(å…¬å¹³ç«äº‰)</li>
<li>æ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡(æœ‰å¤šä¸ªä¼‘æ¯å®¤ï¼ŒæŒ‰æ¡ä»¶è¿›å…¥entryset)</li>
</ul>
<p><strong>ä¸ synchronized ä¸€æ ·ï¼Œéƒ½æ”¯æŒå¯é‡å…¥</strong></p>
</blockquote>
<h3 id="è¯­æ³•"><a href="#è¯­æ³•" class="headerlink" title="è¯­æ³•"></a><strong>è¯­æ³•</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//è·å–é”</span><br><span class="line">Lock reentrantLock = new ReentrantLock();</span><br><span class="line">try&#123;</span><br><span class="line">    reentrantLock.lock();</span><br><span class="line">    //ä¸´ç•ŒåŒº</span><br><span class="line">&#125;finally &#123;</span><br><span class="line">    //é‡Šæ”¾é”</span><br><span class="line">    reentrantLock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>reentrantLock.lock()æ”¾åœ¨tryé‡Œé¢å’Œå¤–é¢éƒ½æ˜¯ä¸€æ ·çš„</p>
</blockquote>
<h3 id="å¯é‡å…¥"><a href="#å¯é‡å…¥" class="headerlink" title="å¯é‡å…¥"></a><strong>å¯é‡å…¥</strong></h3><blockquote>
<p>å¯é‡å…¥æ˜¯æŒ‡åŒä¸€ä¸ªçº¿ç¨‹å¦‚æœé¦–æ¬¡è·å¾—äº†è¿™æŠŠé”ï¼Œé‚£ä¹ˆå› ä¸ºå®ƒæ˜¯è¿™æŠŠé”çš„æ‹¥æœ‰è€…ï¼Œå› æ­¤æœ‰æƒåˆ©å†æ¬¡è·å–è¿™æŠŠé”<br>å¦‚æœæ˜¯ä¸å¯é‡å…¥é”ï¼Œé‚£ä¹ˆç¬¬äºŒæ¬¡è·å¾—é”æ—¶ï¼Œè‡ªå·±ä¹Ÿä¼šè¢«é”æŒ¡ä½</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">private static ReentrantLock lock = new ReentrantLock();</span><br><span class="line">public static void m1()&#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    try &#123;</span><br><span class="line">        System.out.println(&quot;m1è·å¾—é”&quot;);</span><br><span class="line">        m2();</span><br><span class="line">    &#125;finally &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">public static void m2()&#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    try &#123;</span><br><span class="line">        System.out.println(&quot;m2è·å¾—é”&quot;);</span><br><span class="line">    &#125;finally &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å¯æ‰“æ–­"><a href="#å¯æ‰“æ–­" class="headerlink" title="å¯æ‰“æ–­"></a><strong>å¯æ‰“æ–­</strong></h3><blockquote>
<p>æ²¡æœ‰è·å–é”å°±è¿›å…¥é˜»å¥—é˜Ÿåˆ—ï¼Œå…¶å®ƒçº¿ç¨‹å¯ä»¥ç”¨ interruput æ–¹æ³•æ‰“æ–­ï¼Œè®©å…¶ç»“æŸåŒæ­¥ä»£ç <br>å¯æ‰“æ–­ä¹Ÿæ˜¯ä¸€ç§é¢„é˜²æ­»é”çš„æªæ–½</p>
</blockquote>
<p><strong>ä»£ç å®ç°</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">private static ReentrantLock lock = new ReentrantLock();</span><br><span class="line">public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">    Thread t1 = new Thread(()-&gt;&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            System.out.println(&quot;å°è¯•è·å–é”&quot;);</span><br><span class="line">            lock.lockInterruptibly();</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.out.println(&quot;æ²¡æœ‰è·å¾—é”ï¼Œé˜»å¡ä¸­è¢«æ‰“æ–­äº†&quot;);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">            System.out.println(&quot;è·å–åˆ°é”&quot;);</span><br><span class="line">        &#125;finally &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    lock.lock();</span><br><span class="line">    t1.start();</span><br><span class="line">    Thread.sleep(1000);</span><br><span class="line">    t1.interrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><strong>è¾“å‡º</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">å°è¯•è·å–é”</span><br><span class="line">java.lang.InterruptedException</span><br><span class="line">	at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireInterruptibly(AbstractQueuedSynchronizer.java:898)</span><br><span class="line">	at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireInterruptibly(AbstractQueuedSynchronizer.java:1222)</span><br><span class="line">	at java.util.concurrent.locks.ReentrantLock.lockInterruptibly(ReentrantLock.java:335)</span><br><span class="line">	at day04.lambda$main$0(day04.java:11)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:750)</span><br><span class="line">æ²¡æœ‰è·å¾—é”ï¼Œé˜»å¡ä¸­è¢«æ‰“æ–­äº†</span><br></pre></td></tr></table></figure>

<h3 id="é”è¶…æ—¶"><a href="#é”è¶…æ—¶" class="headerlink" title="é”è¶…æ—¶"></a><strong>é”è¶…æ—¶</strong></h3><blockquote>
<p>ä½¿ç”¨trylock,å½“è·å–é”æˆåŠŸæ—¶è¿”å›trueï¼Œå¤±è´¥æ—¶ï¼Œfalseï¼Œå¹¶ä¸”ä¸ä¼šé˜»å¡<br>trylock(long n)è®¾ç½®äº†è¶…æ—¶æ—¶é—´åˆ™å¯ä»¥ç­‰å¾…ï¼ŒæŒ‡å®šæ—¶é—´å†…è·å–åˆ°é”åˆ™è¿”å›true<br>trylock(long n)é˜»å¡æœŸé—´å¯ä»¥è¢«æ‰“æ–­ï¼Œæ‰“æ–­åæŠ›å¼‚å¸¸ï¼Œåœ¨å¼‚å¸¸ä¸­ç›´æ¥è¿”å›</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Thread t1 = new Thread(()-&gt;&#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        if (!lock.tryLock(2, TimeUnit.SECONDS)) &#123;</span><br><span class="line">            //è·å–é”å¤±è´¥</span><br><span class="line">            System.out.println(&quot;è·å–é”å¤±è´¥&quot;);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        return;//è¢«æ‰“æ–­ç›´æ¥è¿”å›</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">        System.out.println(&quot;è·å–é”æˆåŠŸ&quot;);</span><br><span class="line">    &#125;finally &#123;</span><br><span class="line">        lock.unlock();//é‡Šæ”¾é”</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="å…¬å¹³é”"><a href="#å…¬å¹³é”" class="headerlink" title="å…¬å¹³é”"></a><strong>å…¬å¹³é”</strong></h3><blockquote>
<p>é»˜è®¤æ˜¯ä¸å…¬å¹³çš„ï¼Œå¯ä»¥åœ¨æ„é€ æ–¹æ³•ä¸­è®¾ç½®true ï½œ false<br>å…¬å¹³é”ä¸€èˆ¬æ²¡æœ‰å¿…è¦ï¼Œä¼šé™ä½å¹¶å‘åº¦ï¼Œåé¢åˆ†æåŸç†æ—¶ä¼šè®²è§£</p>
</blockquote>
<h3 id="æ¡ä»¶å˜é‡"><a href="#æ¡ä»¶å˜é‡" class="headerlink" title="æ¡ä»¶å˜é‡"></a><strong>æ¡ä»¶å˜é‡</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Thread t1 = new Thread(()-&gt;&#123;</span><br><span class="line">    Condition condition = lock.newCondition();//åˆ›å»ºä¸€ä¸ªæ¡ä»¶å˜é‡ï¼ˆä¼‘æ¯å®¤ï¼‰</span><br><span class="line">    lock.lock();</span><br><span class="line">    try &#123;</span><br><span class="line">        condition.await();//è¿›å…¥ä¼‘æ¯å®¤</span><br><span class="line">    &#125; catch (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    condition.signal();//å”¤é†’</span><br><span class="line">    condition.signalAll();//å”¤é†’æ‰€æœ‰</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>ä½¿ç”¨æµç¨‹</strong></p>
<ul>
<li>await å‰éœ€è¦è·å¾—é”</li>
<li>await æ‰§è¡Œåï¼Œä¼šé‡Šæ”¾é”ï¼Œè¿›å…¥ conditionObject ç­‰å¾…</li>
<li>await çš„çº¿ç¨‹è¢«å”¤é†’ï¼ˆæˆ–æ‰“æ–­ã€æˆ–è¶…æ—¶ï¼‰å–é‡æ–°ç«äº‰ lock é”</li>
<li>ç«äº‰ lock é”æˆåŠŸåï¼Œä»avait åç»§ç»­æ‰§è¡Œ</li>
</ul>
</blockquote>
<h2 id="åŒæ­¥æ¨¡å¼ä¹‹é¡ºåºæ§åˆ¶"><a href="#åŒæ­¥æ¨¡å¼ä¹‹é¡ºåºæ§åˆ¶" class="headerlink" title="åŒæ­¥æ¨¡å¼ä¹‹é¡ºåºæ§åˆ¶"></a><strong>åŒæ­¥æ¨¡å¼ä¹‹é¡ºåºæ§åˆ¶</strong></h2><h3 id="å›ºå®šé¡ºåºä¹‹wait-amp-notify"><a href="#å›ºå®šé¡ºåºä¹‹wait-amp-notify" class="headerlink" title="å›ºå®šé¡ºåºä¹‹wait  &amp; notify"></a><strong>å›ºå®šé¡ºåºä¹‹wait  &amp; notify</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">private static Object lock = new Object();</span><br><span class="line">private static boolean t2Runned = false;//åˆ¤æ–­t2æ˜¯å¦å·²ç»è¿è¡Œ</span><br><span class="line"></span><br><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">    Thread t1 = new Thread(() -&gt; &#123;</span><br><span class="line">        synchronized (lock) &#123;</span><br><span class="line">            while (!t2Runned) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    lock.wait();</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(&quot;t1è¿è¡Œ&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    Thread t2 = new Thread(() -&gt; &#123;</span><br><span class="line">        synchronized (lock) &#123;</span><br><span class="line">            System.out.println(&quot;t2è¿è¡Œ&quot;);</span><br><span class="line">            t2Runned = true;</span><br><span class="line">            lock.notifyAll();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    t1.start();</span><br><span class="line">    t2.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å›ºå®šé¡ºåºä¹‹park-amp-unpark"><a href="#å›ºå®šé¡ºåºä¹‹park-amp-unpark" class="headerlink" title="å›ºå®šé¡ºåºä¹‹park &amp; unpark"></a><strong>å›ºå®šé¡ºåºä¹‹park &amp; unpark</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Thread t1 = new Thread(() -&gt; &#123;</span><br><span class="line">    LockSupport.park();</span><br><span class="line">    System.out.println(&quot;t1è¿è¡Œ&quot;);</span><br><span class="line">&#125;);</span><br><span class="line">Thread t2 = new Thread(() -&gt; &#123;</span><br><span class="line">    LockSupport.unpark(t1);</span><br><span class="line">    System.out.println(&quot;t2è¿è¡Œ&quot;);</span><br><span class="line">&#125;);</span><br><span class="line">t1.start();</span><br><span class="line">t2.start();</span><br></pre></td></tr></table></figure>

<h3 id="äº¤æ›¿è¾“å‡ºä¹‹wait-amp-notify"><a href="#äº¤æ›¿è¾“å‡ºä¹‹wait-amp-notify" class="headerlink" title="äº¤æ›¿è¾“å‡ºä¹‹wait&amp;notify"></a><strong>äº¤æ›¿è¾“å‡ºä¹‹wait&amp;notify</strong></h3><p>çº¿ç¨‹1è¾“å‡ºa5æ¬¡ï¼Œçº¿ç¨‹2è¾“å‡ºb5æ¬¡ï¼Œçº¿ç¨‹3è¾“å‡ºc5æ¬¡ã€‚ç°åœ¨è¦æ±‚è¾“å‡º abeabeabeabeabe æ€ä¹ˆå®ç°</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">public class day04 &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        WaitNotify waitNotify = new WaitNotify(1, 5);</span><br><span class="line">        new Thread(() -&gt; &#123;</span><br><span class="line">            waitNotify.print(&quot;a&quot;, 1, 2);</span><br><span class="line">        &#125;).start();</span><br><span class="line">        new Thread(() -&gt; &#123;</span><br><span class="line">            waitNotify.print(&quot;b&quot;, 2, 3);</span><br><span class="line">        &#125;).start();</span><br><span class="line">        new Thread(() -&gt; &#123;</span><br><span class="line">            waitNotify.print(&quot;c&quot;, 3, 1);</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class WaitNotify &#123;</span><br><span class="line">    private int flag;</span><br><span class="line">    private int loopNumber;</span><br><span class="line"></span><br><span class="line">    public void print(String str, int WaitFlag, int NextFlag) &#123;</span><br><span class="line">        for (int i = 0; i &lt; loopNumber; i++) &#123;</span><br><span class="line">            synchronized (this) &#123;</span><br><span class="line">                while (WaitFlag != flag) &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        this.wait();</span><br><span class="line">                    &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.print(str);</span><br><span class="line">                flag = NextFlag;</span><br><span class="line">                this.notifyAll();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    public WaitNotify(int flag, int loopNumber) &#123;</span><br><span class="line">        this.flag = flag;</span><br><span class="line">        this.loopNumber = loopNumber;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="äº¤æ›¿è¾“å‡ºä¹‹await-amp-signal"><a href="#äº¤æ›¿è¾“å‡ºä¹‹await-amp-signal" class="headerlink" title="äº¤æ›¿è¾“å‡ºä¹‹await&amp;signal"></a><strong>äº¤æ›¿è¾“å‡ºä¹‹await&amp;signal</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">public class day04 &#123;</span><br><span class="line">    public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">        AwaitSignal awaitSignal = new AwaitSignal(5);</span><br><span class="line">        Condition condition1 = awaitSignal.newCondition();</span><br><span class="line">        Condition condition2 = awaitSignal.newCondition();</span><br><span class="line">        Condition condition3 = awaitSignal.newCondition();</span><br><span class="line">        new Thread(() -&gt; &#123;</span><br><span class="line">            awaitSignal.print(&quot;a&quot;, condition1, condition2);</span><br><span class="line">        &#125;).start();</span><br><span class="line">        new Thread(() -&gt; &#123;</span><br><span class="line">            awaitSignal.print(&quot;b&quot;, condition2, condition3);</span><br><span class="line">        &#125;).start();</span><br><span class="line">        new Thread(() -&gt; &#123;</span><br><span class="line">            awaitSignal.print(&quot;c&quot;, condition3, condition1);</span><br><span class="line">        &#125;).start();</span><br><span class="line">        Thread.sleep(500);</span><br><span class="line">        awaitSignal.lock();</span><br><span class="line">        try &#123;</span><br><span class="line">            condition1.signal();</span><br><span class="line">        &#125;finally &#123;</span><br><span class="line">            awaitSignal.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class AwaitSignal extends ReentrantLock &#123;</span><br><span class="line">    private int loopNumber;</span><br><span class="line"></span><br><span class="line">    public AwaitSignal(int loopNumber) &#123;</span><br><span class="line">        this.loopNumber = loopNumber;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void print(String str, Condition current, Condition next) &#123;</span><br><span class="line">        for (int i = 0; i &lt; loopNumber; i++) &#123;</span><br><span class="line">            lock();</span><br><span class="line">            try &#123;</span><br><span class="line">                current.await();</span><br><span class="line">                System.out.print(str);</span><br><span class="line">                next.signal();</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; finally &#123;</span><br><span class="line">                unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="äº¤æ›¿è¾“å‡ºä¹‹park-amp-unpark"><a href="#äº¤æ›¿è¾“å‡ºä¹‹park-amp-unpark" class="headerlink" title="äº¤æ›¿è¾“å‡ºä¹‹park&amp;unpark"></a><strong>äº¤æ›¿è¾“å‡ºä¹‹park&amp;unpark</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">public class day04 &#123;</span><br><span class="line">    static Thread t1,t2,t3;</span><br><span class="line">    public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">        ParkUnpark parkUnpark = new ParkUnpark(5);</span><br><span class="line">         t1 = new Thread(() -&gt; &#123;</span><br><span class="line">            parkUnpark.print(&quot;a&quot;,t2);</span><br><span class="line">        &#125;);</span><br><span class="line">         t2 =  new Thread(() -&gt; &#123;</span><br><span class="line">            parkUnpark.print(&quot;b&quot;, t3);</span><br><span class="line">        &#125;);</span><br><span class="line">         t3 =  new Thread(() -&gt; &#123;</span><br><span class="line">            parkUnpark.print(&quot;c&quot;, t1);</span><br><span class="line">        &#125;);</span><br><span class="line">         t1.start();</span><br><span class="line">         t2.start();</span><br><span class="line">         t3.start();</span><br><span class="line">        Thread.sleep(500);</span><br><span class="line">        LockSupport.unpark(t1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class ParkUnpark &#123;</span><br><span class="line">    private int loopNumber;</span><br><span class="line"></span><br><span class="line">    public ParkUnpark(int loopNumber) &#123;</span><br><span class="line">        this.loopNumber = loopNumber;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void print(String str, Thread next) &#123;</span><br><span class="line">        for (int i = 0; i &lt; loopNumber; i++) &#123;</span><br><span class="line">            LockSupport.park();</span><br><span class="line">            System.out.print(str);</span><br><span class="line">            LockSupport.unpark(next);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æœ¬ç« å°ç»“-1"><a href="#æœ¬ç« å°ç»“-1" class="headerlink" title="æœ¬ç« å°ç»“"></a><strong>æœ¬ç« å°ç»“</strong></h2><blockquote>
<p><strong>æœ¬ç« æˆ‘ä»¬éœ€è¦é‡ç‚¹æŒæ¡çš„æ˜¯</strong><br>åˆ†æå¤šçº¿ç¨‹è®¿é—®å…±äº«èµ„æºæ—¶ï¼Œå“ªäº›ä»£ç ç‰‡æ®µå±äºä¸´ç•ŒåŒº<br>ä½¿ç”¨ synchronized äº’æ–¥è§£å†³ä¸´ç•ŒåŒºçš„çº¿ç¨‹å®‰å…¨é—®é¢˜</p>
<ul>
<li>æŒæ¡ synchronized é”å¯¹è±¡è¯­æ³•</li>
<li>æŒæ¡ synchronzied åŠ è½½æˆå‘˜æ–¹æ³•å’Œé™æ€æ–¹æ³•è¯­æ³•ï¼Œ</li>
<li>æŒæ¡ wait/notify åŒæ­¥æ–¹æ³•<br>ä½¿ç”¨ lock äº’æ–¥è§£å†³ä¸´ç•ŒåŒºçš„çº¿ç¨‹å®‰å…¨é—®é¢˜</li>
<li>æŒæ¡ lock çš„ä½¿ç”¨ç»†èŠ‚ï¼šå¯æ‰“æ–­ã€é”è¶…æ—¶ã€å…¬å¹³é”ã€æ¡ä»¶å˜é‡<br>å­¦ä¼šåˆ†æå˜é‡çš„çº¿ç¨‹å®‰å…¨æ€§ã€æŒæ¡å¸¸è§çº¿ç¨‹å®‰å…¨ç±»çš„ä½¿ç”¨<br>äº†è§£çº¿ç¨‹æ´»è·ƒæ€§é—®é¢˜ï¼šæ­»é”ã€æ´»é”ã€é¥¥é¥¿</li>
</ul>
<p><strong>åº”ç”¨æ–¹é¢</strong></p>
<ul>
<li>äº’æ–¥ï¼šä½¿ç”¨ synchronized æˆ– Lockè¾¾åˆ°å…±äº«èµ„æºäº’æ–¥æ•ˆæœ</li>
<li>åŒæ­¥ï¼šä½¿ç”¨ wait/notify æˆ– Lock çš„æ¡ä»¶å˜é‡æ¥è¾¾åˆ°çº¿ç¨‹é—´é€šä¿¡æ•ˆæœ</li>
</ul>
<p><strong>åŸç†æ–¹é¢</strong></p>
<ul>
<li>monitorã€ synchronized wait/notify åŸç†</li>
<li>synchronized è¿›é˜¶åŸç†</li>
<li>park &amp; unpark åŸç†</li>
</ul>
<p><strong>æ¨¡å¼æ–¹é¢</strong></p>
<ul>
<li>åŒæ­¥æ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœ</li>
<li>å¼‚æ­¥æ¨¡å¼ä¹‹ç”Ÿäº§è€…æ¶ˆè´¹è€…</li>
<li>åŒæ­¥æ¨¡å¼ä¹‹é¡ºåºæ§åˆ¶</li>
</ul>
</blockquote>
<h1 id="å…±äº«æ¨¡å¼ä¹‹å†…å­˜"><a href="#å…±äº«æ¨¡å¼ä¹‹å†…å­˜" class="headerlink" title="å…±äº«æ¨¡å¼ä¹‹å†…å­˜"></a><strong>å…±äº«æ¨¡å¼ä¹‹å†…å­˜</strong></h1><h2 id="Java-å…§å­˜æ¨¡å‹"><a href="#Java-å…§å­˜æ¨¡å‹" class="headerlink" title="Java å…§å­˜æ¨¡å‹"></a><strong>Java å…§å­˜æ¨¡å‹</strong></h2><blockquote>
<p><strong>JMMå³ Java Memory Modelï¼Œå®ƒå®šä¹‰äº†ä¸»å­˜ã€å·¥ä½œå†…å­˜æŠ½è±¡æ¦‚å¿µï¼Œåº•å±‚å¯¹åº”ç€ CPU å¯„å­˜å™¨ã€ç¼“å­˜ã€ç¡¬ä»¶å†…å­˜ã€CPUæŒ‡ä»¤ä¼˜åŒ–ç­‰ã€‚</strong></p>
<p><strong>JMM ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢</strong></p>
<ul>
<li>åŸå­æ€§-ä¿è¯æŒ‡ä»¤ä¸ä¼šå—åˆ°çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å½±å“</li>
<li>å¯è§æ€§-ä¿è¯æŒ‡ä»¤ä¸ä¼šå— cpuç¼“å­˜çš„å½±å“</li>
<li>æœ‰åºæ€§-ä¿è¯æŒ‡ä»¤ä¸ä¼šå— cpu æŒ‡ä»¤å¹¶è¡Œä¼˜åŒ–çš„å½±å“</li>
</ul>
</blockquote>
<h2 id="åŸå­æ€§"><a href="#åŸå­æ€§" class="headerlink" title="åŸå­æ€§"></a><strong>åŸå­æ€§</strong></h2><blockquote>
<p>åŸå­æ€§-ä¿è¯æŒ‡ä»¤ä¸ä¼šå—åˆ°çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å½±å“<br>äº§ç”ŸåŸå› :çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢å¯¼è‡´æŒ‡ä»¤äº¤é”™</p>
</blockquote>
<blockquote>
<p>ä¸¤ä¸ªçº¿ç¨‹å¯¹åˆå§‹å€¼ä¸ºâ—çš„é™æ€å˜é‡ä¸€ä¸ªåšè‡ªå¢ï¼Œä¸€ä¸ªåšè‡ªå‡ï¼Œå„åš5000æ¬¡ï¼Œç»“æœæ˜¯0å—ï¼Ÿ</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">static int s = 0;</span><br><span class="line">public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">    Thread thread1 = new Thread(()-&gt;&#123;</span><br><span class="line">        for (int i = 0; i &lt; 5000; i++) &#123;</span><br><span class="line">            s++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    Thread thread2 = new Thread(()-&gt;&#123;</span><br><span class="line">        for (int i = 0; i &lt; 5000; i++) &#123;</span><br><span class="line">            s--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    thread1.start();</span><br><span class="line">    thread2.start();</span><br><span class="line">    thread1.join();</span><br><span class="line">    thread2.join();</span><br><span class="line">    System.out.println(&quot;s=&quot;+s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>è¾“å‡ºï¼šs=99</p>
</blockquote>
<p><strong>å†…å­˜æ¨¡å‹</strong></p>
<img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2Fimage-20220802165615796.png" width="70%" loading="lazy">

<p><strong>å¤šçº¿ç¨‹ä¸‹æŒ‡ä»¤äº¤é”™</strong></p>
<img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2Fimage-20220802165537556.png" width="70%" loading="lazy">

<p><strong>ä¸´ç•ŒåŒº Critical Seetion</strong></p>
<blockquote>
<p>ä¸€ä¸ªç¨‹åºè¿è¡Œå¤šä¸ªçº¿ç¨‹æœ¬èº«æ˜¯æ²¡æœ‰é—®é¢˜çš„<br>é—®é¢˜å‡ºåœ¨å¤šä¸ªçº¿ç¨‹è®¿é—®å…±äº«èµ„æº<br>å¤šä¸ªçº¿ç¨‹è¯»å…±äº«èµ„æºå…¶å®ä¹Ÿæ²¡æœ‰é—®é¢˜<br>åœ¨å¤šä¸ªçº¿ç¨‹å¯¹å…±äº«èµ„æºè¯»å†™æ“ä½œæ—¶å‘ç”ŸæŒ‡ä»¤äº¤é”™ï¼Œå°±ä¼šå‡ºç°é—®é¢˜<br>ä¸€æ®µä»£ç å—å†…å¦‚æœå­˜åœ¨å¯¹å…±äº«èµ„æºçš„å¤šçº¿ç¨‹è¯»å†™æ“ä½œï¼Œç§°è¿™æ®µä»£ç å—ä¸ºä¸´ç•ŒåŒº</p>
</blockquote>
<p><strong>ä¾‹å¦‚ä¸‹é¢çš„ä»£ç </strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">static int counter = 0;</span><br><span class="line">static void increment()</span><br><span class="line">//ä¸´ç•ŒåŒº</span><br><span class="line">&#123;</span><br><span class="line">    counter++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static void decrement()</span><br><span class="line">//ä¸´ç•ŒåŒº</span><br><span class="line">&#123;</span><br><span class="line">    counter--;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç«æ€æ¡ä»¶Race Condition</strong></p>
<blockquote>
<p>å¤šä¸ªçº¿ç¨‹åœ¨ä¸´ç•ŒåŒºå†…æ‰§è¡Œï¼Œç”±äºä»£ç çš„æ‰§è¡Œåºåˆ—ä¸åŒè€Œå¯¼è‡´ç»“æœæ— æ³•é¢„æµ‹ï¼Œç§°ä¹‹ä¸ºå‘ç”Ÿäº†ç«æ€æ¡ä»¶</p>
</blockquote>
<p><strong>å¦‚ä½•å¤„ç†åŸå­æ€§é—®é¢˜</strong></p>
<blockquote>
<p>ä¸ºäº†é¿å…ä¸´ç•ŒåŒºçš„ç«æ€æ¡ä»¶å‘ç”Ÿï¼Œæœ‰å¤šç§æ‰‹æ®µå¯ä»¥è¾¾åˆ°ç›®çš„ã€‚</p>
<ul>
<li>é˜»å¡å¼çš„è§£å†³æ–¹æ¡ˆï¼šsynchronized, Lock</li>
<li>éé˜»å¡å¼çš„è§£å†³æ–¹æ¡ˆï¼šåŸå­å˜é‡</li>
</ul>
<p><strong>æ³¨æ„</strong><br>é”å¯¹è±¡çš„ç²’åº¦è¦å¤§ä¸€ç‚¹ï¼Œæ¥å‡å°‘ä¸å¿…è¦çš„é‡å¤åŠ é”</p>
</blockquote>
<h2 id="å¯è§æ€§"><a href="#å¯è§æ€§" class="headerlink" title="å¯è§æ€§"></a><strong>å¯è§æ€§</strong></h2><blockquote>
<p>å¯è§æ€§-ä¿è¯æŒ‡ä»¤ä¸ä¼šå— cpuç¼“å­˜çš„å½±å“<br>äº§ç”ŸåŸå› ï¼šç”±äºJITä¼˜åŒ–å¼•èµ·çš„ï¼Œä¼šåœ¨å·¥ä½œå†…å­˜ä¸­åˆ›å»ºä¸€ä¸ªé«˜é€Ÿç¼“å­˜ï¼Œå¯¼è‡´æ›´æ–°ä¸åŒæ­¥</p>
</blockquote>
<h3 id="é€€ä¸å‡ºçš„å¾ªç¯"><a href="#é€€ä¸å‡ºçš„å¾ªç¯" class="headerlink" title="é€€ä¸å‡ºçš„å¾ªç¯"></a><strong>é€€ä¸å‡ºçš„å¾ªç¯</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">static boolean run = true;</span><br><span class="line">public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">    Thread thread = new Thread(() -&gt; &#123;</span><br><span class="line">        while (run) &#123;</span><br><span class="line">            //doSomething</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    thread.start();</span><br><span class="line">    Thread.sleep(1000);</span><br><span class="line">    run = false;//å­çº¿ç¨‹å¹¶ä¸ä¼šåœä¸‹æ¥</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a><strong>åˆ†æ</strong></h3><img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-11_15.51.19.png" width="60%" loading="lazy">

<img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-11_15.51.28.png" width="60%" loading="lazy">

<img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-11_15.51.42.png" width="60%" loading="lazy">

<h3 id="ä½¿ç”¨volatileè§£å†³"><a href="#ä½¿ç”¨volatileè§£å†³" class="headerlink" title="ä½¿ç”¨volatileè§£å†³"></a><strong>ä½¿ç”¨volatileè§£å†³</strong></h3><blockquote>
<p>ç›´æ¥åœ¨å…±äº«å˜é‡å‰åŠ volatileæ˜“å˜å…³é”®å­—ä¿®é¥°å³å¯</p>
</blockquote>
<h3 id="ä½¿ç”¨synchronziedè§£å†³"><a href="#ä½¿ç”¨synchronziedè§£å†³" class="headerlink" title="ä½¿ç”¨synchronziedè§£å†³"></a><strong>ä½¿ç”¨synchronziedè§£å†³</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">static boolean run = true;</span><br><span class="line">static Object lock = new Object();</span><br><span class="line"></span><br><span class="line">public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">    Thread thread = new Thread(() -&gt; &#123;</span><br><span class="line">        while (true) &#123;</span><br><span class="line">            synchronized (lock) &#123;</span><br><span class="line">                if (!run) &#123;</span><br><span class="line">                    //doSomething</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    thread.start();</span><br><span class="line">    Thread.sleep(1000);</span><br><span class="line">    synchronized (lock) &#123;</span><br><span class="line">        run = false;//å­çº¿ç¨‹ä¼šåœä¸‹</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ä½¿ç”¨lockè§£å†³"><a href="#ä½¿ç”¨lockè§£å†³" class="headerlink" title="ä½¿ç”¨lockè§£å†³"></a><strong>ä½¿ç”¨lockè§£å†³</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">static boolean run = true;</span><br><span class="line">static ReentrantLock lock = new ReentrantLock();</span><br><span class="line"></span><br><span class="line">public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">    Thread thread = new Thread(() -&gt; &#123;</span><br><span class="line">        while (true) &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            try &#123;</span><br><span class="line">                if (!run) &#123;</span><br><span class="line">                    //doSomething</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;finally &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    thread.start();</span><br><span class="line">    Thread.sleep(1000);</span><br><span class="line">    lock.lock();</span><br><span class="line">    try &#123;</span><br><span class="line">        run = false;</span><br><span class="line">    &#125;finally &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="è§£å†³æ–¹æ³•å¯¹æ¯”"><a href="#è§£å†³æ–¹æ³•å¯¹æ¯”" class="headerlink" title="è§£å†³æ–¹æ³•å¯¹æ¯”"></a><strong>è§£å†³æ–¹æ³•å¯¹æ¯”</strong></h3><blockquote>
<p>ä½¿ç”¨volatile ï¼ˆæ˜“å˜å…³é”®å­—ï¼‰</p>
<ul>
<li>å®ƒå¯ä»¥ç”¨æ¥ä¿®é¥°æˆå‘˜å˜é‡å’Œé™æ€æˆå‘˜å˜é‡ï¼Œä»–å¯ä»¥é¿å…çº¿ç¨‹ä»è‡ªå·±çš„å·¥ä½œç¼“å­˜ä¸­æŸ¥æ‰¾å˜é‡çš„å€¼ï¼Œå¿…é¡»åˆ°ä¸»å­˜ä¸­è·å–å®ƒçš„å€¼ï¼Œçº¿ç¨‹æ“ä½œ volatile å˜é‡éƒ½æ˜¯ç›´æ¥æ“ä½œä¸»å­˜</li>
<li>å‰é¢ä¾‹å­ä½“ç°çš„å®é™…å°±æ˜¯å¯è§æ€§ï¼Œå®ƒä¿è¯çš„æ˜¯åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹ volatile å˜é‡çš„ä¿®æ”¹å¯¹å¦ä¸€ä¸ªçº¿ç¨‹å¯è§ï¼Œä¸èƒ½ä¿è¯åŸå­æ€§ï¼Œä»…ç”¨åœ¨ä¸€ä¸ªå†™çº¿ç¨‹ï¼Œå¤šä¸ªè¯»çº¿ç¨‹çš„æƒ…å†µ<br>ä½¿ç”¨synchronziedæˆ–è€…lock</li>
<li>synchronized è¯­å¥å—æ—¢å¯ä»¥ä¿è¯ä»£ç å—çš„åŸå­æ€§ï¼Œä¹ŸåŒæ—¶ä¿è¯ä»£ç å—å†…å˜é‡çš„å¯è§æ€§ã€‚ä½†ç¼ºç‚¹æ˜¯synehronizedæ˜¯å±äºé‡é‡çº§æ“ä½œï¼Œæ€§èƒ½ç›¸å¯¹æ›´ä½</li>
<li>ä½†æ˜¯å¦‚æœåœ¨å‰é¢ç¤ºä¾‹çš„æ­»å¾ªç¯ä¸­åŠ å…¥ System.out.println0 ä¼šå‘ç°å³ä½¿ä¸åŠ  volatile ä¿®é¥°ç¬¦ï¼Œçº¿ç¨‹tä¹Ÿèƒ½æ­£ç¡®çœ‹åˆ°å¯¹ run å˜é‡çš„ä¿®æ”¹äº†ï¼Œå› ä¸ºprintlnä¸­æœ‰synchronizedï¼Œå¼ºåˆ¶äº†çº¿ç¨‹èµ°ä¸»å†…å­˜è·å–</li>
</ul>
<p><strong>æ³¨æ„</strong><br>åœ¨å¯è§æ€§è¿™å—å»ºè®®ä½¿ç”¨volatileï¼Œsynchronziedä¼šåˆ›å»ºmonitor,lockä¼šåˆ›å»ºé¢å¤–å¯¹è±¡</p>
</blockquote>
<h3 id="ç»ˆæ­¢æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼"><a href="#ç»ˆæ­¢æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼" class="headerlink" title="ç»ˆæ­¢æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼"></a><strong>ç»ˆæ­¢æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼</strong></h3><blockquote>
<p><strong>Two Phase Termination</strong><br>åœ¨ä¸€ä¸ªçº¿ç¨‹T1 ä¸­å¦‚ä½•â€œä¼˜é›…â€ç»ˆæ­¢çº¿ç¨‹T2ï¼Ÿè¿™é‡Œçš„ã€ä¼˜é›…ã€‘æŒ‡çš„æ˜¯ç»™T2ä¸€ä¸ªæ–™ç†åäº‹çš„æœºä¼šã€‚<br><strong>é”™è¯¯æ€è·¯</strong></p>
<ul>
<li>ä½¿ç”¨çº¿ç¨‹å¯¹è±¡çš„ stopO æ–¹æ³•åœæ­¢çº¿ç¨‹<br>stop æ–¹æ³•ä¼šçœŸæ­£æ€æ­»çº¿ç¨‹ï¼Œå¦‚æœè¿™æ—¶çº¿ç¨‹é”ä½äº†å…±äº«èµ„æºï¼Œé‚£ä¹ˆå½“å®ƒè¢«æ€æ­»åå°±å†ä¹Ÿæ²¡æœ‰æœºä¼šé‡Šæ”¾é”ï¼Œå…¶å®ƒçº¿ç¨‹å°†æ°¸è¿œæ— æ³•è·å–é”</li>
<li>ä½¿ç”¨ System.exit(int) æ–¹æ³•åœæ­¢çº¿ç¨‹<br>ç›®çš„ä»…æ˜¯åœæ­¢ä¸€ä¸ªçº¿ç¨‹ï¼Œä½†è¿™ç§åšæ³•ä¼šè®©æ•´ä¸ªç¨‹åºéƒ½åœæ­¢</li>
</ul>
</blockquote>
<p><strong>æµç¨‹å›¾</strong></p>
<img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-08_17.41.29.png" width="60%" loading="lazy">

<p><strong>ä½¿ç”¨volatileæ¥å®ç°</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">public class day01 &#123;</span><br><span class="line">    public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">        TwoPhaseTermination twoPhaseTermination = new TwoPhaseTermination();</span><br><span class="line">        twoPhaseTermination.start();</span><br><span class="line">        Thread.sleep(3500);</span><br><span class="line">        twoPhaseTermination.stop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class TwoPhaseTermination &#123;</span><br><span class="line">    private volatile boolean stop = false;//æ˜¯å¦åœæ­¢</span><br><span class="line">    private Thread monitor;</span><br><span class="line"></span><br><span class="line">    void start() &#123;</span><br><span class="line">        monitor = new Thread(() -&gt; &#123;</span><br><span class="line">            while (true) &#123;</span><br><span class="line">                Thread thread = Thread.currentThread();</span><br><span class="line">                if (stop) &#123;</span><br><span class="line">                    System.out.println(&quot;å–„åå·¥ä½œ...&quot;);</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                try &#123;</span><br><span class="line">                    System.out.println(&quot;æ‰§è¡Œç›‘æ§...&quot;);</span><br><span class="line">                    Thread.sleep(1000);//ç¡çœ å·²é˜²æ­¢CPU100%</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        monitor.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void stop() &#123;</span><br><span class="line">        stop = true;//è®¾ç½®åœæ­¢</span><br><span class="line">        monitor.interrupt();//å¯ä»¥ä¸ç”¨ï¼Œä½†æ˜¯å½“ç¡çœ æ—¶é—´è¿‡é•¿ï¼Œæƒ³ç«‹åˆ»åœæ­¢éœ€è¦åŠ ä¸Š</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è¾“å‡º</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">æ‰§è¡Œç›‘æ§...</span><br><span class="line">æ‰§è¡Œç›‘æ§...</span><br><span class="line">æ‰§è¡Œç›‘æ§...</span><br><span class="line">æ‰§è¡Œç›‘æ§...</span><br><span class="line">java.lang.InterruptedException: sleep interrupted</span><br><span class="line">	at java.lang.Thread.sleep(Native Method)</span><br><span class="line">	at TwoPhaseTermination.lambda$start$0(day01.java:29)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:750)</span><br><span class="line">å–„åå·¥ä½œ...</span><br></pre></td></tr></table></figure>

<h3 id="åŒæ­¥æ¨¡å¼ä¹‹-çŠ¹è±«æ¨¡å¼"><a href="#åŒæ­¥æ¨¡å¼ä¹‹-çŠ¹è±«æ¨¡å¼" class="headerlink" title="åŒæ­¥æ¨¡å¼ä¹‹ çŠ¹è±«æ¨¡å¼"></a><strong>åŒæ­¥æ¨¡å¼ä¹‹ çŠ¹è±«æ¨¡å¼</strong></h3><blockquote>
<p>Balking (çŠ¹è±«ï¼‰æ¨¡å¼ç”¨åœ¨ä¸€ä¸ªçº¿ç¨‹å‘ç°å¦ä¸€ä¸ªçº¿ç¨‹æˆ–æœ¬çº¿ç¨‹å·²ç»åšäº†æŸä¸€ä»¶ç›¸åŒçš„äº‹ï¼Œé‚£ä¹ˆæœ¬çº¿ç¨‹å°±æ— éœ€å†åšäº†ï¼Œç›´æ¥ç»“æŸè¿”å›</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">class MonitorService &#123;</span><br><span class="line">    private volatile boolean starting;</span><br><span class="line">    public void start()&#123;</span><br><span class="line">        synchronized (this)&#123;</span><br><span class="line">            if (starting)</span><br><span class="line">                return;</span><br><span class="line">            starting = true;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(&quot;start...&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>åº”ç”¨åœºæ™¯ï¼š</p>
<ul>
<li>ç›‘æ§å¼€å…³</li>
<li>å•ä¾‹æ¨¡å¼</li>
</ul>
</blockquote>
<h2 id="æœ‰åºæ€§"><a href="#æœ‰åºæ€§" class="headerlink" title="æœ‰åºæ€§"></a><strong>æœ‰åºæ€§</strong></h2><h3 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a><strong>é—®é¢˜</strong></h3><blockquote>
<p>è€ƒè™‘ä»¥ä¸‹ä»£ç çš„æ‰§è¡Œé¡ºåº<br>å¯èƒ½ready = trueæ‰§è¡Œï¼Œr.r1 = num+num;æ‰§è¡Œï¼Œæœ€ånum = 2æ‰§è¡Œã€‚<br>è¿™ç§ç°è±¡å«åšæŒ‡ä»¤é‡æ’ï¼Œæ˜¯JTç¼–è¯‘å™¨åœ¨è¿è¡Œæ—¶çš„ä¸€äº›ä¼˜åŒ–ï¼Œè¿™ä¸ªç°è±¡éœ€è¦é€šè¿‡å¤§é‡æµ‹è¯•æ‰èƒ½å¤ç°</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">int num = 0;</span><br><span class="line">boolean ready = false;</span><br><span class="line"></span><br><span class="line">//çº¿ç¨‹1æ‰§è¡Œæ­¤æ–¹æ³•</span><br><span class="line">public void  actor1(Object r)&#123;</span><br><span class="line">    if (ready) &#123;</span><br><span class="line">        r.r1 = num+num;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        r.r1 = 1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//çº¿ç¨‹2æ‰§è¡Œæ­¤æ–¹æ³•</span><br><span class="line">public void  actor2(Object r)&#123;</span><br><span class="line">    num = 2;</span><br><span class="line">    ready = true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æŒ‡ä»¤é‡æ’ä¼˜åŒ–"><a href="#æŒ‡ä»¤é‡æ’ä¼˜åŒ–" class="headerlink" title="æŒ‡ä»¤é‡æ’ä¼˜åŒ–"></a><strong>æŒ‡ä»¤é‡æ’ä¼˜åŒ–</strong></h3><blockquote>
<p><strong>ä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æ’ï¼Ÿ</strong><br>åŒä¸€ä¸ªçº¿ç¨‹å…§ï¼ŒJVMä¼šåœ¨ä¸å½±å“æ­£ç¡®æ€§çš„å‰æä¸‹ï¼Œå¯ä»¥è°ƒæ•´è¯­å¥çš„æ‰§è¡Œé¡ºæ–¹<br><strong>ä¸ºä»€ä¹ˆæŒ‡ä»¤é‡æ’åº</strong><br>äº‹å®ä¸Šï¼Œç°ä»£å¤„ç†å™¨ä¼šè®¾è®¡ä¸ºä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå®Œæˆä¸€æ¡æ‰§è¡Œæ—¶é—´æœ€é•¿çš„ CPU æŒ‡ä»¤ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆåšå‘¢ï¼Ÿ<br>å¯ä»¥æƒ³åˆ°æŒ‡ä»¤è¿˜å¯ä»¥å†åˆ’åˆ†æˆä¸€ä¸ªä¸ªæ›´å°çš„é˜¶æ®µï¼Œä¾‹å¦‚ï¼Œæ¯æ¡æŒ‡ä»¤éƒ½å¯ä»¥åˆ†ä¸ºï¼šå–æŒ‡ä»¤ã€‚æŒ‡ä»¤è¯‘ç  ã€‚æ‰§è¡ŒæŒ‡ä»¤-å†…å­˜è®¿é—®ã€‚æ•°æ®å†™å›è¿™5ä¸ªé˜¶æ®µ<br>ç°ä»£ CPU æ”¯æŒå¤šçº§æŒ‡ä»¤æµæ°´çº¿ï¼Œä¾‹å¦‚æ”¯æŒåŒæ—¶æ‰§è¡Œ å–æŒ‡ä»¤â€¢ æŒ‡ä»¤è¯‘ç ã€‚æ‰§è¡ŒæŒ‡ä»¤â€¢ å†…å­˜è®¿é—®ã€‚æ•°æ®å†™å›çš„å¤„ç†å™¨ï¼Œå°±å¯ä»¥ç§°ä¹‹ä¸ºäº”çº§æŒ‡ä»¤æµæ°´çº¿ã€‚<br>è¿™æ—¶ CPU å¯ä»¥åœ¨ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå†…ï¼ŒåŒæ—¶è¿è¡Œäº”æ¡æŒ‡ä»¤çš„ä¸åŒé˜¶æ®µ(ç›¸å½“äºä¸€æ¡æ‰§è¡Œæ—¶é—´æœ€é•¿çš„å¤æ‚æŒ‡ä»¤ï¼‰ï¼ŒPC=1ï¼Œæœ¬è´¨ä¸Šï¼Œæµæ°´çº¿æŠ€æœ¯å¹¶ä¸èƒ½ç¼©çŸ­å•æ¡æŒ‡ä»¤çš„æ‰§è¡Œæ—¶é—´ï¼Œä½†å®ƒå˜ç›¸åœ°æé«˜äº†æŒ‡ä»¤åœ°ååç‡</p>
</blockquote>
<img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-11_17.17.39.png" width="60%" loading="lazy">

<blockquote>
<p>æŒ‡ä»¤é‡æ’çš„å‰ææ˜¯ï¼Œé‡æ’æŒ‡ä»¤ä¸èƒ½å½±å“ç»“æœï¼Œä¾‹å¦‚</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//å¯ä»¥é‡æ’çš„ä¾‹å­</span><br><span class="line">int a = 10;//æŒ‡ä»¤1</span><br><span class="line">int b = 20;//æŒ‡ä»¤2</span><br><span class="line"></span><br><span class="line">//ä¸èƒ½é‡æ’çš„ä¾‹å­</span><br><span class="line">int a = 10;//æŒ‡ä»¤1</span><br><span class="line">int b = a - 5;// æŒ‡ä»¤2</span><br></pre></td></tr></table></figure>

<h3 id="volatileåŸç†"><a href="#volatileåŸç†" class="headerlink" title="volatileåŸç†"></a><strong>volatileåŸç†</strong></h3><blockquote>
<p><strong>volatile çš„åº•å±‚å®ç°åŸç†æ˜¯å†…å­˜å±éšœï¼ŒMemory Barrier (Memory Fence)</strong></p>
<ul>
<li>å¯¹ volatile å˜é‡çš„å†™æŒ‡ä»¤åä¼šåŠ å…¥å†™å±éšœ</li>
<li>å¯¹ volatile å˜é‡çš„è¯»æŒ‡ä»¤å‰ä¼šåŠ å…¥è¯»å±éšœ</li>
</ul>
</blockquote>
<h4 id="ä¿è¯å¯è§æ€§"><a href="#ä¿è¯å¯è§æ€§" class="headerlink" title="ä¿è¯å¯è§æ€§"></a><strong>ä¿è¯å¯è§æ€§</strong></h4><blockquote>
<p>å†™å±éšœä¿è¯åœ¨è¯¥å±éšœä¹‹å‰çš„ï¼Œå¯¹å…±äº«å˜é‡çš„æ”¹åŠ¨ï¼Œéƒ½åŒæ­¥åˆ°ä¸»å­˜å½“ä¸­</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public void actor()&#123;</span><br><span class="line">    num = 2;</span><br><span class="line">    ready = true;//readyè¢«volatileä¿®é¥°ï¼Œä¿®æ”¹å¸¦å†™å±éšœ</span><br><span class="line">    //å†™å±éšœ</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¯»å±éšœä¿è¯åœ¨è¯¥å±éšœä¹‹åï¼Œå¯¹å…±äº«å˜é‡çš„è¯»å–ï¼ŒåŠ è½½çš„æ˜¯ä¸»å­˜ä¸­æœ€æ–°æ•°æ®</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public void actor(Object r) &#123;</span><br><span class="line">    //è¯»å±éšœ</span><br><span class="line">    //readyæ˜¯volatileè¯»å–å€¼å¸¦è¯»å±éšœ</span><br><span class="line">    if (ready) &#123;</span><br><span class="line">        r.r1 = num+num;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        r.r1 = 1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ä¿è¯æœ‰åºæ€§"><a href="#ä¿è¯æœ‰åºæ€§" class="headerlink" title="ä¿è¯æœ‰åºæ€§"></a><strong>ä¿è¯æœ‰åºæ€§</strong></h4><blockquote>
<p>å†™å±éšœä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†å†™å±éšœä¹‹å‰çš„ä»£ç æ’åœ¨å†™å±éšœä¹‹å</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public void actor()&#123;</span><br><span class="line">    num = 2;</span><br><span class="line">    ready = true;//readyè¢«volatileä¿®é¥°ï¼Œä¿®æ”¹å¸¦å†™å±éšœ</span><br><span class="line">    //å†™å±éšœ</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¯»å±éšœä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†è¯»å±éšœä¹‹åçš„ä»£ç æ’åœ¨è¯»å±éšœä¹‹å‰</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public void actor(Object r) &#123;</span><br><span class="line">    //è¯»å±éšœ</span><br><span class="line">    //readyæ˜¯volatileè¯»å–å€¼å¸¦è¯»å±éšœ</span><br><span class="line">    if (ready) &#123;</span><br><span class="line">        r.r1 = num+num;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        r.r1 = 1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h4 id="å†…å­˜å±éšœ"><a href="#å†…å­˜å±éšœ" class="headerlink" title="å†…å­˜å±éšœ"></a><strong>å†…å­˜å±éšœ</strong></h4><blockquote>
<p>å¯¹äºå³æ—¶ç¼–è¯‘å™¨æ¥è¯´ï¼Œå®ƒä¼šé’ˆå¯¹å‰é¢æåˆ°çš„æ¯ä¸€ä¸ª happens-before å…³ç³»ï¼Œå‘æ­£åœ¨ç¼–è¯‘çš„ç›®æ ‡æ–¹æ³•ä¸­æ’å…¥ç›¸åº”çš„è¯»è¯»ã€è¯»å†™ã€å†™è¯»ä»¥åŠå†™å†™å†…å­˜å±éšœã€‚<br>è¿™äº›å†…å­˜å±éšœä¼šé™åˆ¶å³æ—¶ç¼–è¯‘å™¨çš„é‡æ’åºæ“ä½œã€‚<br>å³æ—¶ç¼–è¯‘å™¨å°†æ ¹æ®å…·ä½“çš„åº•å±‚ä½“ç³»æ¶æ„ï¼Œå°†è¿™äº›å†…å­˜å±éšœæ›¿æ¢æˆå…·ä½“çš„ CPU æŒ‡ä»¤ã€‚<br>ä»¥æˆ‘ä»¬æ—¥å¸¸æ¥è§¦çš„ X86_64 æ¶æ„æ¥è¯´ï¼Œè¯»è¯»ã€è¯»å†™ä»¥åŠå†™å†™å†…å­˜å±éšœæ˜¯ç©ºæ“ä½œï¼ˆno-opï¼‰ï¼Œåªæœ‰å†™è¯»å†…å­˜å±éšœä¼šè¢«æ›¿æ¢æˆå…·ä½“æŒ‡ä»¤ã€‚<br>å¯¹äºå³æ—¶ç¼–è¯‘å™¨æ¥è¯´ï¼Œå†…å­˜å±éšœå°†é™åˆ¶å®ƒæ‰€èƒ½åšçš„é‡æ’åºä¼˜åŒ–ã€‚å¯¹äºå¤„ç†å™¨æ¥è¯´ï¼Œå†…å­˜å±éšœä¼šå¯¼è‡´ç¼“å­˜çš„åˆ·æ–°æ“ä½œã€‚</p>
</blockquote>
<blockquote>
<p><strong>æ³¨æ„</strong><br><strong>volatileï¼Œä¸èƒ½è§£å†³æŒ‡ä»¤äº¤é”™ï¼Œå³åŸå­æ€§é—®é¢˜</strong></p>
<ul>
<li>å¯è§æ€§ä»…ä»…æ˜¯ä¿è¯ä¹‹åçš„è¯»èƒ½å¤Ÿè¯»åˆ°æœ€æ–°çš„ç»“æœï¼Œä½†ä¸èƒ½ä¿è¯è¯»è·‘åˆ°å®ƒå‰é¢å»</li>
<li>æœ‰åºæ€§ä¹Ÿåªæ˜¯ä¿è¯äº†æœ¬çº¿ç¨‹å†…ç›¸å…³ä»£ç ä¸è¢«é‡æ’åº,å¤šçº¿ç¨‹çš„ä»ç„¶æ”¹å˜ä¸äº†</li>
</ul>
</blockquote>
<h3 id="åŒé‡æ£€æŸ¥é”çš„å•ä¾‹"><a href="#åŒé‡æ£€æŸ¥é”çš„å•ä¾‹" class="headerlink" title="åŒé‡æ£€æŸ¥é”çš„å•ä¾‹"></a><strong>åŒé‡æ£€æŸ¥é”çš„å•ä¾‹</strong></h3><p>è‘—åçš„ double-checked locking æ¨¡å¼å®ç°å•ä¾‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public final class Singleton &#123;</span><br><span class="line">    private Singleton() &#123;&#125;</span><br><span class="line">    private static Singleton INSTANCE = null;</span><br><span class="line">    public static Singleton getInstance()&#123;</span><br><span class="line">        //å®ä¾‹æ²¡åˆ›å»ºï¼Œæ‰ä¼šè¿›å…¥å†…éƒ¨çš„åŒæ­¥ä»£ç å—</span><br><span class="line">        if (INSTANCE == null)</span><br><span class="line">            synchronized (Singleton.class) &#123;</span><br><span class="line">            //ä¹Ÿè®¸æœ‰å…¶ä»–çº¿ç¨‹å·²ç»åˆ›å»ºå®ä¾‹ï¼Œæ‰€ä»¥å†åˆ¤æ–­ä¸€æ¬¡</span><br><span class="line">                if (INSTANCE == null)</span><br><span class="line">                    INSTANCE = new Singleton();</span><br><span class="line">            &#125;</span><br><span class="line">        return INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>ä»¥ä¸Šçš„å®ç°ç‰¹ç‚¹æ˜¯ï¼š</strong></p>
<ul>
<li>æ‡’æƒ°å®ä¾‹åŒ–</li>
<li>é¦–æ¬¡ä½¿ç”¨ getInstance() æ‰ä½¿ç”¨ synchronized åŠ é”ï¼Œåç»­ä½¿ç”¨æ—¶æ— éœ€åŠ é”</li>
</ul>
<p><strong>ä½†åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä¸Šé¢çš„ä»£ç æ˜¯æœ‰é—®é¢˜çš„ï¼ŒINSTANCE new Singleton(ï¼‰ å¯¹åº”çš„å­—èŠ‚ç ä¸ºï¼š</strong></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">17: new           #3                  // class Singleton</span><br><span class="line">20: dup</span><br><span class="line">21: invokespecial #4                  // Method &quot;&lt;init&gt;&quot;:()V</span><br><span class="line">24: putstatic     #2                  // Field INSTANCE:LSingleton;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>å…¶ä¸­ 21 å’Œ 24 ä¸¤æ­¥çš„é¡ºåºä¸æ˜¯å›ºå®šçš„ï¼Œä¹Ÿè®¸jvm ä¼šä¼˜åŒ–ä¸ºï¼šå…ˆå°†å¼•ç”¨åœ°å€èµ‹å€¼ç»™ INSTANCE å˜é‡åï¼Œå†æ‰§è¡Œæ„é€ æ–¹æ³•<br>å¦‚æœä¸¤ä¸ªçº¿ç¨‹t1ï¼Œt2æŒ‰å¦‚ä¸‹æ—¶é—´åºåˆ—æ‰§è¡Œï¼š</p>
<ul>
<li>t1è¿›å…¥ç¬¬ä¸€æ¬¡if (INSTANCE == null)ä¸­</li>
<li>t2é€‰æ‹©å…ˆæ‰§è¡Œ24å†æ‰§è¡Œ21ï¼Œæ­¤æ—¶æ‰§è¡Œ24<br>æ­¤æ—¶t2è¿è¡Œç»“æŸåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œt1è¿è¡Œåˆ¤æ–­ifï¼Œæ­¤æ—¶INSTANCEæœ‰å€¼ï¼Œä½†æ˜¯æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œä¼šç›´æ¥è¿”å›è¿™ä¸ªæœ‰å€¼ä½†æ˜¯æ²¡æœ‰åˆå§‹åŒ–çš„å¯¹è±¡;</li>
</ul>
</blockquote>
<h3 id="å¤„ç†æœ‰åºæ€§"><a href="#å¤„ç†æœ‰åºæ€§" class="headerlink" title="å¤„ç†æœ‰åºæ€§"></a><strong>å¤„ç†æœ‰åºæ€§</strong></h3><blockquote>
<p><strong>æ–¹æ¡ˆä¸€</strong></p>
<ul>
<li>æ·»åŠ volatileå…³é”®å­—å³å¯</li>
<li>æ‰©å¤§synchronizedå¯¹é—®é¢˜å˜é‡çš„æ§åˆ¶èŒƒå›´<br>æ³¨æ„ï¼š<br>synchronizedæ˜¯å¯ä»¥ä¿è¯æœ‰åºæ€§çš„ï¼Œåªæ˜¯éœ€è¦å®Œå…¨è¦†ç›–å˜é‡<br>synchronizedå†…éƒ¨çš„ä»£ç æ˜¯å¯ä»¥é‡æ’åºçš„</li>
</ul>
</blockquote>
<h3 id="happens-before"><a href="#happens-before" class="headerlink" title="happens-before"></a><strong>happens-before</strong></h3><blockquote>
<p>è§„å®šäº†å¯¹å…±äº«å˜é‡çš„å†™æ“ä½œå¯¹å…¶å®ƒçº¿ç¨‹çš„è¯»æ“ä½œå¯è§ï¼Œå®ƒæ˜¯å¯è§æ€§ä¸æœ‰åºæ€§çš„ä¸€å¥—è§„åˆ™æ€»ç»“<br>æŠ›å¼€ä»¥ä¸‹ happens-before è§„åˆ™ï¼ŒJMM å¹¶ä¸èƒ½ä¿è¯ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„å†™ï¼Œå¯¹äºå…¶å®ƒçº¿ç¨‹å¯¹è¯¥å…±äº«å˜é‡çš„è¯»å¯è§</p>
</blockquote>
<blockquote>
<p>çº¿ç¨‹è§£é”m ä¹‹å‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹äºæ¥ä¸‹æ¥å¯¹ m åŠ é”çš„å…¶å®ƒçº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§<br>t1å…ˆt2åï¼ŒsynchronizedåŸå­æ€§ï¼Œå¯è§æ€§çš„ä½“ç°</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">static int x;</span><br><span class="line">static Object m = new Object();</span><br><span class="line">new Thread(()-&gt;&#123;</span><br><span class="line">    synchronized (m)&#123;</span><br><span class="line">        x = 10;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).start();</span><br><span class="line"></span><br><span class="line">new Thread(()-&gt;&#123;</span><br><span class="line">    synchronized (m)&#123;</span><br><span class="line">        System.out.println(x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).start();</span><br></pre></td></tr></table></figure>

<blockquote>
<p>çº¿ç¨‹å¯¹ volatile å˜é‡çš„å†™ï¼Œå¯¹æ¥ä¸‹æ¥å…¶å®ƒçº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§<br>t1å…ˆt2åï¼Œvolatileå¯è§æ€§çš„ä½“ç°</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">volatile static int x;</span><br><span class="line">new Thread(()-&gt;&#123;</span><br><span class="line">    x = 10;</span><br><span class="line">&#125;).start();</span><br><span class="line"></span><br><span class="line">new Thread(()-&gt;&#123;</span><br><span class="line">    System.out.println(x);</span><br><span class="line">&#125;).start();</span><br></pre></td></tr></table></figure>

<blockquote>
<p>çº¿ç¨‹ start å‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹è¯¥çº¿ç¨‹å¼€å§‹åå¯¹è¯¥å˜é‡çš„è¯»å¯è§</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">static int x;</span><br><span class="line">x = 10;</span><br><span class="line"></span><br><span class="line">new Thread(()-&gt;&#123;</span><br><span class="line">    System.out.println(x);</span><br><span class="line">&#125;).start();</span><br></pre></td></tr></table></figure>
<blockquote>
<p>çº¿ç¨‹ç»“æŸå‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹å…¶å®ƒçº¿ç¨‹å¾—çŸ¥å®ƒç»“æŸåçš„è¯»å¯è§</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">static int x;</span><br><span class="line"></span><br><span class="line">Thread t1 = new Thread(()-&gt;&#123;</span><br><span class="line">    x = 10;</span><br><span class="line">&#125;);</span><br><span class="line">t1.start();</span><br><span class="line">t1.join();</span><br><span class="line">System.out.println(x);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>çº¿ç¨‹t1æ‰“æ–­ t2 (interruptï¼‰å‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹äºå…¶ä»–çº¿ç¨‹å¾—çŸ¥ 2 è¢«æ‰“æ–­åå¯¹å˜é‡çš„è¯»å¯è§ï¼ˆé€šè¿‡t2.interrupted æˆ– t2.isInterrupted)<br>å¯¹å˜é‡é»˜è®¤å€¼(0ï¼Œ falseï¼Œnulï¼‰çš„å†™ï¼Œå¯¹å…¶å®ƒçº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§<br>å…·æœ‰ä¼ é€’æ€§ï¼Œå¦‚æœx hb-ã€‰yå¹¶ä¸”y hb-ã€‰zé‚£ä¹ˆæœ‰x hb-ã€‰zï¼Œé…åˆ volatile çš„é˜²æŒ‡ä»¤é‡æ’,ä¸»è¦æ˜¯è¯»å†™å±éšœå¯¹æ•´ä¸ªèŒƒå›´çš„å½±å“ï¼Œå®ä¾‹å¦‚ä¸‹</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">volatile static int x;</span><br><span class="line">static int y;</span><br><span class="line">new Thread(()-&gt;&#123;</span><br><span class="line">    y = 10;</span><br><span class="line">    x = 20;</span><br><span class="line">&#125;).start();</span><br><span class="line">new Thread(()-&gt;&#123;</span><br><span class="line">    //x = 20å¯¹t2å¯è§ï¼ŒåŒæ—¶y=10å¯¹t2ä¹Ÿå¯è§</span><br><span class="line">    System.out.println(x);</span><br><span class="line">&#125;).start();</span><br></pre></td></tr></table></figure>

<h2 id="ä¹ é¢˜"><a href="#ä¹ é¢˜" class="headerlink" title="ä¹ é¢˜"></a><strong>ä¹ é¢˜</strong></h2><h3 id="balking-æ¨¡å¼ä¹ é¢˜"><a href="#balking-æ¨¡å¼ä¹ é¢˜" class="headerlink" title="balking æ¨¡å¼ä¹ é¢˜"></a><strong>balking æ¨¡å¼ä¹ é¢˜</strong></h3><blockquote>
<p>å¸Œæœ› dolnit0 æ–¹æ³•ä»…è¢«è°ƒç”¨ä¸€æ¬¡ï¼Œä¸‹é¢çš„å®ç°æ˜¯å¦æœ‰é—®é¢˜ï¼Œä¸ºä»€ä¹ˆï¼Ÿ</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">class TestVolatile&#123;</span><br><span class="line">    volatile boolean initialized = false;</span><br><span class="line">    void init()&#123;</span><br><span class="line">        if (initialized)</span><br><span class="line">            return;</span><br><span class="line">        doInit();</span><br><span class="line">        initialized = true;</span><br><span class="line">    &#125;</span><br><span class="line">    private void doInit()&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ä½¿ç”¨äº†volatileä¿è¯äº†å¯è§æ€§å’Œæœ‰åºæ€§ï¼Œä½†æ˜¯åŸå­æ€§æ²¡æœ‰ä¿è¯ï¼Œä¼šå‡ºç°å¤šçº¿ç¨‹å¹¶å‘é—®é¢˜<br>ä¿®æ”¹å»ºè®®ï¼šç›´æ¥ç”¨synchronizedåŒ…å«æ•´ä¸ªæ–¹æ³•ï¼Œvolatileä¹Ÿä¸ç”¨ï¼Œæˆ–è€…åŒé‡æ£€æŸ¥é”é…åˆvolatile</p>
</blockquote>
<h3 id="çº¿ç¨‹å®‰å…¨å•ä¾‹ä¹ é¢˜"><a href="#çº¿ç¨‹å®‰å…¨å•ä¾‹ä¹ é¢˜" class="headerlink" title="çº¿ç¨‹å®‰å…¨å•ä¾‹ä¹ é¢˜"></a><strong>çº¿ç¨‹å®‰å…¨å•ä¾‹ä¹ é¢˜</strong></h3><blockquote>
<p>å•ä¾‹æ¨¡å¼æœ‰å¾ˆå¤šå®ç°æ–¹æ³•ï¼Œé¥¿æ±‰ã€æ‡’æ±‰ã€é™æ€å†…éƒ¨ç±»ã€æšä¸¾ç±»ï¼Œè¯•åˆ†ææ¯ç§å®ç°ä¸‹è·å–å•ä¾‹å¯¹è±¡ï¼ˆå³è°ƒç”¨getInstance)æ—¶çš„çº¿ç¨‹å®‰å…¨ï¼Œå¹¶æ€è€ƒæ³¨é‡Šä¸­çš„é—®é¢˜</p>
<ul>
<li>é¥¿æ±‰å¼ï¼šç±»åŠ è½½å°±ä¼šå¯¼è‡´è¯¥å•å®ä¾‹å¯¹è±¡è¢«åˆ›å»º</li>
<li>æ‡’æ±‰å¼ï¼šç±»åŠ è½½ä¸ä¼šå¯¼è‡´è¯¥å•å®ä¾‹å¯¹è±¡è¢«åˆ›å»ºï¼Œè€Œæ˜¯é¦–æ¬¡ä½¿ç”¨è¯¥å¯¹è±¡æ—¶æ‰ä¼šåˆ›å»º</li>
</ul>
</blockquote>
<p><strong>ç¬¬ä¸€ç§</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">//é—®é¢˜1ï¼šä¸ºä»€ä¹ˆåŠ  final</span><br><span class="line">//é—®é¢˜2ï¼šå¦‚æœå®ç°äº†åºåˆ—åŒ–æ¥å£ï¼Œè¿˜è¦åšä»€ä¹ˆæ¥é˜²æ­¢ååºåˆ—åŒ–ç ´ç¯è¯ä¾‹</span><br><span class="line">final class Singleton implements Serializable&#123;</span><br><span class="line">    //é—®é¢˜3ï¼šä¸ºä»€ä¹ˆè®¾ç½®ä¸ºç§æœ‰ï¼Ÿæ˜¯å¦èƒ½é˜²æ­¢åå°„åˆ›å»ºæ–°çš„å®ä¾‹ï¼Ÿ</span><br><span class="line">    private Singleton()&#123;&#125;</span><br><span class="line">    //é—®é¢˜4ï¼šè¿™æ ·åˆå§‹åŒ–æ˜¯å¦èƒ½ä¿è¯å•ä¾‹å¯¹è±¡åˆ›å»ºæ—¶çš„çº¿ç¨‹å®‰å…¨ï¼Ÿ</span><br><span class="line">    private static final  Singleton INSTANCE = new Singleton();</span><br><span class="line">    //é—®é¢˜5ï¼šä¸ºä»€ä¹ˆæä¾›é™æ€æ–¹æ³•è€Œä¸æ˜¯ç›´æ¥å°† INSTANCE è®¾ç½®ä¸º publicï¼Œè¯´ç”°ä½ çŸ¥é¥çš„ç†ç”°</span><br><span class="line">    public static Singleton getInstance()&#123;</span><br><span class="line">        return INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">    public Object readResovle()&#123;</span><br><span class="line">        return INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>é—®é¢˜1ï¼šä¸ºä»€ä¹ˆåŠ  final<br>é˜²æ­¢å­ç±»ç»§æ‰¿ï¼Œä¸é€‚å½“çš„è¦†ç›–æ–¹æ³•ï¼Œç ´åå•ä¾‹</li>
<li>é—®é¢˜2ï¼šå¦‚æœå®ç°äº†åºåˆ—åŒ–æ¥å£ï¼Œè¿˜è¦åšä»€ä¹ˆæ¥é˜²æ­¢ååºåˆ—åŒ–ç ´ç¯å•ä¾‹<br>æ·»åŠ readResovleå›ºå®šæ–¹æ³•ï¼Œååºåˆ—åŒ–çš„æ—¶å€™ä¼šèµ°readResovleï¼Œç›´æ¥è¿”å›å†…å­˜ä¸­çš„å¯¹è±¡</li>
<li>é—®é¢˜3ï¼šä¸ºä»€ä¹ˆè®¾ç½®ä¸ºç§æœ‰ï¼Ÿæ˜¯å¦èƒ½é˜²æ­¢åå°„åˆ›å»ºæ–°çš„å®ä¾‹ï¼Ÿ<br>ä¸èƒ½</li>
<li>é—®é¢˜4ï¼šè¿™æ ·åˆå§‹åŒ–æ˜¯å¦èƒ½ä¿è¯å•ä¾‹å¯¹è±¡åˆ›å»ºæ—¶çš„çº¿ç¨‹å®‰å…¨ï¼Ÿ<br>é™æ€æˆå‘˜å˜é‡ç±»åŠ è½½é˜¶æ®µå®Œæˆçš„ï¼Œç”±JVMæ¥ä¿è¯çº¿ç¨‹å®‰å…¨æ€§</li>
<li>é—®é¢˜5ï¼šä¸ºä»€ä¹ˆæä¾›é™æ€æ–¹æ³•è€Œä¸æ˜¯ç›´æ¥å°† INSTANCE è®¾ç½®ä¸º publicï¼Œè¯´ç”°ä½ çŸ¥é¥çš„ç†ç”°<br>å¦‚æœpublicå°†æ¥å°±æ²¡æ³•æ”¹è¿›æˆä¸ºæ‡’æƒ°çš„åˆå§‹åŒ–æ–¹å¼äº†ï¼Œè¿˜å¯ä»¥æ”¯æŒèŒƒå‹</li>
</ul>
</blockquote>
<p><strong>ç¬¬äºŒç§</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// é—®é¢˜1ï¼šæšä¸¾å•ä¾‹æ˜¯å¦‚ä½•é™åˆ¶å®ä¾‹ä¸ªæ•°çš„</span><br><span class="line">// é—´é¢˜2ï¼šæšä¸¾å•ä¾‹åœ¨åˆ›å»ºæ—¶æ˜¯å¦æœ‰å¹¶å‘é—®é¢˜</span><br><span class="line">// é—®é¢˜3ï¼šæšä¸¾å•ä¾‹èƒ½å¦è¢«åå°„ç ´åå•ä¾‹</span><br><span class="line">// é—®é¢˜4ï¼šæšä¸¾å•ä¾‹èƒ½é¦™è¢«ååºåˆ—åŒ–ç ´åå•ä¾‹</span><br><span class="line">// é—®é¢˜5ï¼šæšä¸¾å•ä¾‹å±äºæ‡’æ±‰å¼è¿˜æ˜¯é¥¿æ±‰å¼</span><br><span class="line">// é—®é¢˜6ï¼šæšä¸¾å•ä¾‹å¦‚æœå¸Œæœ›åŠ å…¥ä¸€äº›å•ä¾‹åˆ›å»ºæ—¶çš„åˆå§‹åŒ–é€»è¾‘è¯¥å¦‚ä½•åš</span><br><span class="line">enum Singleton &#123;</span><br><span class="line">    INSTANCE</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>é—®é¢˜1ï¼šæšä¸¾å•ä¾‹æ˜¯å¦‚ä½•é™åˆ¶å®ä¾‹ä¸ªæ•°çš„<br>æšä¸¾å•ä¾‹åç¼–è¯‘åå®é™…ä¸Šå°±æ˜¯é™æ€æˆå‘˜å˜é‡</li>
<li>é—´é¢˜2ï¼šæšä¸¾å•ä¾‹åœ¨åˆ›å»ºæ—¶æ˜¯å¦æœ‰å¹¶å‘é—®é¢˜<br>ä¹Ÿæ˜¯åœ¨ç±»åŠ è½½é˜¶æ®µå®Œæˆçš„ï¼Œä¸ä¼šæœ‰</li>
<li>é—®é¢˜3ï¼šæšä¸¾å•ä¾‹èƒ½å¦è¢«åå°„ç ´åå•ä¾‹<br>ä¸èƒ½</li>
<li>é—®é¢˜4ï¼šæšä¸¾å•ä¾‹èƒ½é¦™è¢«ååºåˆ—åŒ–ç ´åå•ä¾‹<br>ä¸èƒ½ï¼Œè®¾è®¡æ—¶è€ƒè™‘åˆ°äº†ï¼Œåº•å±‚å®ç°äº†ï¼Œæ— éœ€è‡ªå·±é¢å¤–å®ç°</li>
<li>é—®é¢˜5ï¼šæšä¸¾å•ä¾‹å±äºæ‡’æ±‰å¼è¿˜æ˜¯é¥¿æ±‰å¼<br>é¥¿æ±‰å¼</li>
<li>é—®é¢˜6ï¼šæšä¸¾å•ä¾‹å¦‚æœå¸Œæœ›åŠ å…¥ä¸€äº›å•ä¾‹åˆ›å»ºæ—¶çš„åˆå§‹åŒ–é€»è¾‘è¯¥å¦‚ä½•åš<br>å¯ä»¥å†™æ„é€ æ–¹æ³•</li>
</ul>
</blockquote>
<p><strong>ç¬¬ä¸‰ç§</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">final class Singleton&#123;</span><br><span class="line">    private Singleton()&#123;&#125;</span><br><span class="line">    private static Singleton INSTANCE = null;</span><br><span class="line"></span><br><span class="line">    public static synchronized Singleton getINSTANCE() &#123;</span><br><span class="line">        if (INSTANCE == null)</span><br><span class="line">            return INSTANCE;</span><br><span class="line">        INSTANCE = new Singleton();</span><br><span class="line">        return INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿™é‡Œæ˜¯çº¿ç¨‹å®‰å…¨çš„å˜›ï¼Œæœ‰ä»€ä¹ˆç¼ºç‚¹<br>æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ŒèŒƒå›´å¤§ï¼Œé™¤äº†ç¬¬ä¸€æ¬¡ï¼Œåç»­æ¯æ¬¡åŠ é”éƒ½æ˜¯æ²¡å¿…è¦çš„<br><strong>æ³¨æ„</strong><br>synchronizedä¸å¯ä»¥åŠ åœ¨INSTANCEä¸Šï¼Œå› ä¸ºæ²¡æœ‰finalä¿®é¥°ï¼Œè€Œä¸”æ˜¯nullï¼Œnullæ˜¯æ²¡æœ‰monitorçš„</p>
</blockquote>
<p><strong>ç¬¬å››ç§</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">final class Singleton &#123;</span><br><span class="line">    private Singleton() &#123;&#125;</span><br><span class="line">    //é—®é¢˜1ï¼šè§£é‡Šä¸ºä»€ä¹ˆè¦åŠ  volatile</span><br><span class="line">    private static volatile Singleton INSTANCE = null;</span><br><span class="line">    //é—®é¢˜2ï¼šå¯¹æ¯”å®ç°3ï¼Œè¯´å‡ºè¿™æ ·åšçš„æ„ä¹‰</span><br><span class="line">    public static Singleton getInstance() &#123;</span><br><span class="line">        if (INSTANCE != null)</span><br><span class="line">            return INSTANCE;</span><br><span class="line">        synchronized (Singleton.class) &#123;</span><br><span class="line">            //åŒé¢˜3ï¼šä¸ºä»€ä¹ˆè¿˜è¦åœ¨è¿™é‡ŒåŠ ä¸ºç©ºåˆ¤æ–­ï¼Œä¹‹å‰ä¸æ˜¯åˆ¤æ–­è¿‡äº†å—</span><br><span class="line">            if (INSTANCE != null)</span><br><span class="line">                return INSTANCE;</span><br><span class="line">            INSTANCE = new Singleton();</span><br><span class="line">            return INSTANCE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>é—®é¢˜1ï¼šè§£é‡Šä¸ºä»€ä¹ˆè¦åŠ  volatile<br>æœ‰åºæ€§é—®é¢˜ï¼Œé˜²æ­¢æŒ‡ä»¤é‡æ’é€ æˆç¬¬ä¸€æ¬¡æˆåŠŸï¼Œç¬¬äºŒæ¬¡è¿”å›ç©ºå¯¹è±¡<br>é—®é¢˜2ï¼šå¯¹æ¯”å®ç°3ï¼Œè¯´å‡ºè¿™æ ·åšçš„æ„ä¹‰<br>å®ç°ç¬¬ä¸€æ¬¡åŠ é”ï¼Œåç»­æ— é”<br>åŒé¢˜3ï¼šä¸ºä»€ä¹ˆè¿˜è¦åœ¨è¿™é‡ŒåŠ ä¸ºç©ºåˆ¤æ–­ï¼Œä¹‹å‰ä¸æ˜¯åˆ¤æ–­è¿‡äº†å—<br>é˜²æ­¢ç¬¬ä¸€æ¬¡å‡ºç°å¹¶å‘å®‰å…¨</p>
</blockquote>
<p><strong>ç¬¬äº”ç§</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">final class Singleton &#123;</span><br><span class="line">    private Singleton() &#123;&#125;</span><br><span class="line">    //é—®é¢˜1ï¼šå±äºæ‡’æ±‰å¼è¿˜æ˜¯é¥¿æ±—å¼</span><br><span class="line">    private static class LazyHolder&#123;</span><br><span class="line">        static final Singleton INSTANCE = new Singleton();</span><br><span class="line">    &#125;</span><br><span class="line">    //é—®é¢˜2:åœ¨åˆ›å»ºæ—¶æ˜¯å¦æœ‰å¹¶å‘é—®é¢˜</span><br><span class="line">    public static Singleton getInstance()&#123;</span><br><span class="line">        return LazyHolder.INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>é—®é¢˜1ï¼šå±äºæ‡’æ±‰å¼è¿˜æ˜¯é¥¿æ±—å¼<br>åˆ©ç”¨äº†ç±»åŠ è½½æœ¬èº«å°±æ˜¯æ‡’æƒ°çš„ï¼Œåªè¦ä¸è°ƒç”¨getInstanceï¼Œå°±ä¸ä¼šç”Ÿæˆ<br>é—®é¢˜2:åœ¨åˆ›å»ºæ—¶æ˜¯å¦æœ‰å¹¶å‘é—®é¢˜<br>ç±»åŠ è½½ç”±JVMæ§åˆ¶å¹¶å‘å®‰å…¨</p>
</blockquote>
<h2 id="æœ¬ç« å°ç»“-2"><a href="#æœ¬ç« å°ç»“-2" class="headerlink" title="æœ¬ç« å°ç»“"></a><strong>æœ¬ç« å°ç»“</strong></h2><blockquote>
<p>æœ¬ç« é‡ç‚¹è®²è§£äº† JMMä¸­çš„</p>
<ul>
<li>å¯è§æ€§-ç”±JVMç¼“å­˜ä¼˜åŒ–å¼•èµ·</li>
<li>æœ‰åºæ€§-ç”±JVMæŒ‡ä»¤é‡æ’åºä¼˜åŒ–å¼•èµ·</li>
<li>happens-before è§„åˆ™<br>åŸç†æ–¹é¢</li>
<li>CPUæŒ‡ä»¤å¹¶è¡Œ</li>
<li>volatile<br>æ¨¡å¼æ–¹é¢</li>
<li>ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼çš„ volatile æ”¹è¿›</li>
<li>åŒæ­¥æ¨¡å¼ä¹‹ balking</li>
</ul>
</blockquote>
<h1 id="å…±äº«æ¨¡å¼ä¹‹æ— é”"><a href="#å…±äº«æ¨¡å¼ä¹‹æ— é”" class="headerlink" title="å…±äº«æ¨¡å¼ä¹‹æ— é”"></a><strong>å…±äº«æ¨¡å¼ä¹‹æ— é”</strong></h1><h2 id="CAS-ä¸-volatile"><a href="#CAS-ä¸-volatile" class="headerlink" title="CAS ä¸ volatile"></a><strong>CAS ä¸ volatile</strong></h2><p><strong>CAS</strong></p>
<blockquote>
<p>CAS å³ Compare and Swapï¼Œå®ƒä½“ç°çš„ä¸€ç§ä¹è§‚é“çš„æ€æƒ³ï¼Œæ¯”å¦‚å¤šä¸ªçº¿ç¨‹è¦å¯¹ä¸€ä¸ªå…±äº«çš„æ•´å‹å˜é‡æ‰§è¡Œ+1æ“ä½œï¼š</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">while (true) &#123;</span><br><span class="line">    int æ—§å€¼ = å…±äº«å˜é‡;</span><br><span class="line">    int ç»“æœ = æ—§å€¼ + 1;</span><br><span class="line">    /*</span><br><span class="line">    è¿™æ—¶å€™å¦‚æœåˆ«çš„çº¿ç¨‹æŠŠå…±äº«å˜é‡æ”¹æˆäº† 5ï¼Œæœ¬çº¿ç¨‹çš„æ­£ç¡®ç»“æœ1 å°±ä½œåºŸäº†ï¼Œè¿™æ—¶å€™</span><br><span class="line">    compareAndSwap è¿”å› falseï¼Œé‡æ–°å°è¯•ï¼Œç›´åˆ°ï¼š</span><br><span class="line">    compareAndSwap è¿”å› trueï¼Œè¡¨ç¤ºæˆ‘æœ¬çº¿ç¨‹åšä¿®æ”¹çš„åŒæ—¶ï¼Œåˆ«çš„çº¿ç¨‹æ²¡æœ‰å¹²æ‰°</span><br><span class="line">     */</span><br><span class="line">    if (compareAndSwap(æ—§å€¼,ç»“æœ))&#123;</span><br><span class="line">        //æˆåŠŸï¼Œé€€å‡ºå¾ªç¯</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>ä¸ºä»€ä¹ˆè¦ç”¨volatileé…åˆ</strong></p>
<ul>
<li>å› ä¸ºCASè·å–å…±äº«å˜é‡æ—¶ï¼Œä¸ºäº†ä¿è¯è¯¥å˜é‡çš„å¯è§æ€§</li>
</ul>
<p><strong>åº”ç”¨åœºæ™¯</strong><br>ç»“åˆ CAS å’Œ volatile å¯ä»¥å®ç°æ— é”å¹¶å‘ï¼Œé€‚ç”¨äºç«äº‰ä¸æ¿€çƒˆã€å¤šæ ¸ CPU çš„åœºæ™¯ä¸‹ã€‚</p>
<ul>
<li>å› ä¸ºæ²¡æœ‰ä½¿ç”¨ synchronizedï¼Œæ‰€ä»¥çº¿ç¨‹ä¸ä¼šé™·å…¥é˜»å¡ï¼Œè¿™æ˜¯æ•ˆç‡æå‡çš„å› ç´ ä¹‹ä¸€</li>
<li>ä½†å¦‚æœç«äº‰æ¿€çƒˆï¼Œå¯ä»¥æƒ³åˆ°é‡è¯•å¿…ç„¶é¢‘ç¹å‘ç”Ÿï¼Œåè€Œæ•ˆç‡ä¼šå—å½±å“</li>
</ul>
</blockquote>
<h2 id="åŸå­åŸºæœ¬ç±»"><a href="#åŸå­åŸºæœ¬ç±»" class="headerlink" title="åŸå­åŸºæœ¬ç±»"></a><strong>åŸå­åŸºæœ¬ç±»</strong></h2><blockquote>
<p><strong>JUC (java.util.concurrentï¼‰ä¸­æä¾›äº†åŸå­æ“ä½œç±»ï¼Œå¯ä»¥æä¾›çº¿ç¨‹å®‰å…¨çš„æ“ä½œï¼Œä¾‹å¦‚ï¼šAtomicinteger,AtomicBooleanç­‰ï¼Œå®ƒä»¬åº•å±‚å°±æ˜¯é‡‡ç”¨ CAS æŠ€æœ¯ + volatile æ¥å®ç°çš„ã€‚</strong><br>åŸå­åŸºæœ¬ç±»åŒ…æ‹¬</p>
<ul>
<li>AtomicBoolean</li>
<li>AtomicInteger</li>
<li>AtomicLong</li>
</ul>
</blockquote>
<p><strong>API</strong></p>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>ä½œç”¨è¯´æ˜</th>
<th>ç­‰åŒ</th>
</tr>
</thead>
<tbody><tr>
<td>new AtomicInteger(0);</td>
<td>åˆå§‹åŒ–èµ‹å€¼</td>
<td>i = 0</td>
</tr>
<tr>
<td>i.incrementAndGet()</td>
<td>å…ˆåŠ 1å†è·å–</td>
<td>++i</td>
</tr>
<tr>
<td>i.getAndIncrement()</td>
<td>å…ˆè·å–å†åŠ 1</td>
<td>i++</td>
</tr>
<tr>
<td>i.getAndAdd(2)</td>
<td>å…ˆè·å–å†åŠ 2</td>
<td></td>
</tr>
<tr>
<td>i.getAndSet(1)</td>
<td>å…ˆè·å–å†è®¾ç½®å€¼</td>
<td></td>
</tr>
<tr>
<td>i.get()</td>
<td>ç›´æ¥è·å–å€¼</td>
<td></td>
</tr>
<tr>
<td>i.compareAndSet(1, 2)</td>
<td>CAS</td>
<td></td>
</tr>
<tr>
<td>i.updateAndGet(value -&gt; value * 10);</td>
<td>ç®—æœ¯è¿ç®—</td>
<td>value=value*10</td>
</tr>
</tbody></table>
<p><strong>updateAndGetåŸç†</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public static int updateAndGet(AtomicInteger i, IntUnaryOperator operator)&#123;</span><br><span class="line">    while (true)&#123;</span><br><span class="line">        int prev = i.get();</span><br><span class="line">        int next = operator.applyAsInt(prev);</span><br><span class="line">        if (i.compareAndSet(prev,next))</span><br><span class="line">            return next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="åŸå­å¼•ç”¨"><a href="#åŸå­å¼•ç”¨" class="headerlink" title="åŸå­å¼•ç”¨"></a><strong>åŸå­å¼•ç”¨</strong></h2><blockquote>
<p>ä¸ºä»€ä¹ˆéœ€è¦åŸå­å¼•ç”¨ç±»å‹ï¼Ÿ<br>å› ä¸ºéœ€è¦çº¿ç¨‹å®‰å…¨çš„ä¸åªæ˜¯åŸºæœ¬ç±»å‹<br>åŸå­å¼•ç”¨æœ‰å“ªäº›ï¼Ÿ</p>
<ul>
<li>AtomicReference</li>
<li>AtomicMarkableReference</li>
<li>AtomicStampedReference</li>
</ul>
</blockquote>
<h3 id="AtomicReference"><a href="#AtomicReference" class="headerlink" title="AtomicReference"></a><strong>AtomicReference</strong></h3><blockquote>
<p>å¦‚ä½•ä½¿ç”¨ï¼Ÿ<br>è¿ç®—ç”¨åŸæ¥APIï¼Œè·å–ï¼Œæ”¹å˜ç­‰ç”¨åŸå­ç±»çš„API</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public AtomicReference&lt;BigDecimal&gt; account = new AtomicReference&lt;&gt;(new BigDecimal(10000));</span><br><span class="line"></span><br><span class="line">public void withDraw(BigDecimal x) &#123;</span><br><span class="line">    while (true) &#123;</span><br><span class="line">        BigDecimal prev = account.get();</span><br><span class="line">        BigDecimal next = prev.subtract(x);</span><br><span class="line">        if (account.compareAndSet(prev, next)) &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="AtomicStampedReference"><a href="#AtomicStampedReference" class="headerlink" title="AtomicStampedReference"></a><strong>AtomicStampedReference</strong></h3><p><strong>ABAé—®é¢˜</strong></p>
<blockquote>
<p>AtomicReferenceåªèƒ½åˆ¤æ–­æ˜¯å¦ä¸€è‡´ï¼Œå¹¶ä¸èƒ½åˆ¤æ–­æœ‰æ— ä¿®æ”¹ï¼Œå¦‚æœä¸­é—´A-&gt;Bï¼ŒB-&gt;Aï¼Œé‚£ä¹ˆæ˜¯æ„ŸçŸ¥ä¸åˆ°çš„<br>è§£å†³ï¼Œä½¿ç”¨AtomicStampedReferenceï¼Œæ·»åŠ ç‰ˆæœ¬å·ï¼Œåˆ¤æ–­æ—¶åŒæ—¶åˆ¤æ–­ç‰ˆæœ¬å·ï¼Œæ¯æ¬¡ä¿®æ”¹è‡ªå¢ç‰ˆæœ¬å·</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public AtomicStampedReference&lt;BigDecimal&gt; account ;</span><br><span class="line"></span><br><span class="line">public DecimalAccount(BigDecimal x,int stamp) &#123;</span><br><span class="line">    this.account = new AtomicStampedReference&lt;&gt;(x,stamp);</span><br><span class="line">&#125;</span><br><span class="line">public void withDraw(BigDecimal x) &#123;</span><br><span class="line">    while (true) &#123;</span><br><span class="line">        BigDecimal prev = account.getReference();</span><br><span class="line">        int stamp = account.getStamp();</span><br><span class="line">        BigDecimal next = prev.subtract(x);</span><br><span class="line">        if (account.compareAndSet(prev, next,stamp,stamp+1)) &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AtomicMarkableReference"><a href="#AtomicMarkableReference" class="headerlink" title="AtomicMarkableReference"></a><strong>AtomicMarkableReference</strong></h3><blockquote>
<p>AtomcStampedketerence å¯äººç»™/å°¿å­å¼•ç”¨å·ä¸Šç‰ˆä¼å·ï¼Œé“é™…å°¿å­å¼•ç”¨æ•´ä¸ªçš„çˆ¶åŒ–è¿ç¨‹ï¼Œå¦‚ï¼š<br>A-ã€‰B-ã€‰A-ã€‰Cï¼Œé€šè¿‡AtomicStampedReferenceï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå¼•|ç”¨å˜é‡ä¸­é€”è¢«æ›´æ”¹äº†å‡ æ¬¡ã€‚<br>ä½†æ˜¯æœ‰æ—¶å€™ï¼Œå¹¶ä¸å…³å¿ƒå¼•ç”¨å˜é‡æ›´æ”¹äº†å‡ æ¬¡ï¼Œåªæ˜¯å•çº¯çš„å…³å¿ƒæ˜¯å¦æ›´æ”¹è¿‡ï¼Œæ‰€ä»¥å°±æœ‰äº†AtomicMarkableReference<br>è¿™æ„å‘³ç€å¤šçº¿ç¨‹ä¸‹åªæœ‰ä¸€æ¬¡æˆåŠŸ</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public AtomicMarkableReference&lt;BigDecimal&gt; account = </span><br><span class="line">        new AtomicMarkableReference&lt;&gt;(new BigDecimal(10000),true);</span><br><span class="line"></span><br><span class="line">public void withDraw(BigDecimal x) &#123;</span><br><span class="line">    while (true) &#123;</span><br><span class="line">        BigDecimal prev = account.getReference();</span><br><span class="line">        BigDecimal next = prev.subtract(x);</span><br><span class="line">        if (account.compareAndSet(prev, next,true,false)) &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="åŸå­æ•°ç»„"><a href="#åŸå­æ•°ç»„" class="headerlink" title="åŸå­æ•°ç»„"></a><strong>åŸå­æ•°ç»„</strong></h2><blockquote>
<p>æ•°ç»„å­˜çš„æ˜¯å¼•ç”¨ï¼Œè€Œæƒ³è¦ä¿æŠ¤æ•°ç»„ä¸€ä¸ªä¸ªå…ƒç´ å†…çš„å€¼éœ€è¦ä½¿ç”¨åŸå­æ•°ç»„<br><strong>åŸå­æ•°ç»„</strong></p>
<ul>
<li>AtomiclntegerArray</li>
<li>AtomicLongArray</li>
<li>AtomicReferenceArray</li>
</ul>
<p><strong>å‡½æ•°å¼æ¥å£</strong></p>
<ul>
<li>supplier æä¾›è€… æ— ä¸­ç”Ÿæœ‰ ()-&gt;ç»“æœ</li>
<li>function å‡½æ•°   ä¸€ä¸ªå‚æ•°ä¸€ä¸ªç»“æœ  (å‚æ•°)-&gt;ç»“æœ    , BiFunction (å‚æ•°1,å‚æ•°2)-&gt;ç»“æœ</li>
<li>consumer æ¶ˆè´¹è€… ä¸€ä¸ªå‚æ•°æ²¡ç»“æœ    (å‚æ•°)â€”&gt;void   ,  BiConsumer (å‚æ•°1ï¼Œå‚æ•°2)â€”&gt;void</li>
</ul>
</blockquote>
<h3 id="é€šç”¨æ–¹æ³•"><a href="#é€šç”¨æ–¹æ³•" class="headerlink" title="é€šç”¨æ–¹æ³•"></a><strong>é€šç”¨æ–¹æ³•</strong></h3><blockquote>
<ul>
<li>æ„é€ å™¨ï¼šåˆ†ä¸ºåˆå§‹é•¿åº¦æ„é€ å™¨å’Œåˆå§‹æ•°ç»„æ„é€ å™¨ï¼Œä¸æä¾›æ— å‚æ„é€ å™¨ã€‚</li>
<li>get(index)ï¼šå–å€¼ï¼Œå…·æœ‰åŸå­æ€§å’Œå¯è§æ€§ã€‚</li>
<li>set(index)ï¼šèµ‹å€¼ï¼Œå…·æœ‰åŸå­æ€§å’Œå¯è§æ€§ã€‚</li>
<li>lazySet(index,newValue)ï¼šèµ‹å€¼ï¼Œå…·æœ‰åŸå­æ€§ï¼Œä¸å…·å¤‡å¯è§æ€§ã€‚</li>
<li>getAndSet(index,newValue)ï¼šèµ‹å€¼å¹¶è¿”å›æ—§å€¼ï¼Œå…·æœ‰åŸå­æ€§å’Œå¯è§æ€§ã€‚</li>
<li>compareAndSet(index,expect,newValue)ï¼šå¦‚æœå½“å‰æ˜¯æœŸæœ›å€¼åˆ™èµ‹å€¼å¹¶è¿”å›èµ‹å€¼æˆåŠŸä¸å¦ï¼Œå…·æœ‰åŸå­æ€§å’Œå¯è§æ€§ã€‚</li>
</ul>
</blockquote>
<h3 id="ç‹¬æœ‰æ–¹æ³•"><a href="#ç‹¬æœ‰æ–¹æ³•" class="headerlink" title="ç‹¬æœ‰æ–¹æ³•"></a><strong>ç‹¬æœ‰æ–¹æ³•</strong></h3><blockquote>
<p><strong>AtomicIntegerArrayå’ŒAtomicLongArrayçš„ç‹¬æœ‰æ–¹æ³•</strong></p>
<ul>
<li>getAndAdd(index,delta)ï¼šå¢é‡è®¡ç®—å¹¶è¿”å›æ—§å€¼ï¼Œå…·æœ‰åŸå­æ€§å’Œå¯è§æ€§ã€‚</li>
<li>addAndGet(index,delta)ï¼šå¢é‡è®¡ç®—å¹¶è¿”å›æ–°å€¼ï¼Œå…·æœ‰åŸå­æ€§å’Œå¯è§æ€§ã€‚</li>
<li>getAndIncrement(index)ï¼šè‡ªå¢å¹¶è¿”å›æ—§å€¼ï¼Œç±»ä¼¼i ++ï¼Œå…·æœ‰åŸå­æ€§å’Œå¯è§æ€§ã€‚</li>
<li>incrementAndGet(index)ï¼šè‡ªå¢å¹¶è¿”å›æ–°å€¼ï¼Œç±»ä¼¼++ iï¼Œå…·æœ‰åŸå­æ€§å’Œå¯è§æ€§ã€‚</li>
<li>getAndDecrement(index)ï¼šè‡ªå‡å¹¶è¿”å›æ—§å€¼ï¼Œç±»ä¼¼i â€“ï¼Œå…·æœ‰åŸå­æ€§å’Œå¯è§æ€§ã€‚</li>
<li>decrementAndGet(index)ï¼šè‡ªå‡å¹¶è¿”å›æ–°å€¼ï¼Œç±»ä¼¼â€“ iï¼Œå…·æœ‰åŸå­æ€§å’Œå¯è§æ€§ã€‚</li>
</ul>
</blockquote>
<h2 id="å­—æ®µæ›´æ–°å™¨"><a href="#å­—æ®µæ›´æ–°å™¨" class="headerlink" title="å­—æ®µæ›´æ–°å™¨"></a><strong>å­—æ®µæ›´æ–°å™¨</strong></h2><blockquote>
<ul>
<li>AtomicReferenceFieldUpdater // åŸŸå­—æ®µ</li>
<li>AtomicIntegerFieldUpdater</li>
<li>AtomicLongFieldUpdater<br>åˆ©ç”¨å­—æ®µæ›´æ–°å™¨ï¼Œå¯ä»¥é’ˆå¯¹å¯¹è±¡çš„æŸä¸ªåŸŸï¼ˆFieldï¼‰è¿›è¡ŒåŸå­æ“ä½œï¼Œåªèƒ½é…åˆ volatile ä¿®é¥°çš„å­—æ®µä½¿ç”¨ï¼Œå¦åˆ™ä¼šå‡ºç°å¼‚å¸¸<br>Exception in thread â€œmainâ€ java.lang. TllegalArgumentException: Must be volatile type<br>ä½¿ç”¨å·®åˆ«åœ¨äºæ„é€ æ–¹æ³•ä¸Š</li>
</ul>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">AtomicIntegerFieldUpdater&lt;DecimalAccount&gt; fieldUpdater = </span><br><span class="line">        AtomicIntegerFieldUpdater.newUpdater(DecimalAccount.class, &quot;name&quot;);</span><br><span class="line"></span><br><span class="line">AtomicReferenceFieldUpdater fieldUpdater = AtomicReferenceFieldUpdater</span><br><span class="line">        .newUpdater(DecimalAccount.class, String.class,&quot;name&quot;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="åŸå­ç´¯åŠ å™¨"><a href="#åŸå­ç´¯åŠ å™¨" class="headerlink" title="åŸå­ç´¯åŠ å™¨"></a><strong>åŸå­ç´¯åŠ å™¨</strong></h2><blockquote>
<p><strong>ç›¸å¯¹äºåŸå­åŸºæœ¬ç±»æ¥è¯´ï¼Œç´¯åŠ æ–¹é¢æ€§èƒ½æ›´å¥½</strong><br><strong>ä¸ºä»€ä¹ˆæé«˜æ€§èƒ½?</strong><br>æ€§èƒ½æå‡çš„åŸå› å¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨æœ‰ç«äº‰æ—¶ï¼Œè®¾ç½®å¤šä¸ªç´¯åŠ å•å…ƒï¼ŒTherad-0 ç´¯åŠ  CelllO]ï¼Œè€Œ Thread-1 ç´¯åŠ <br>Cell[y).æœ€åå°†ç»“æœæ±‡æ€»ã€‚è¿™æ ·å®ƒä»¬åœ¨ç´¯åŠ æ—¶æ“ä½œçš„ä¸åŒçš„ Cell å˜é‡ï¼Œå› æ­¤å‡å°‘äº† CAS é‡è¯•å¤±è´¥ï¼Œä»è€Œæé«˜æ€§èƒ½ã€‚<br><strong>æœ‰å“ªäº›ï¼Ÿ</strong></p>
<ul>
<li>DoubleAccumulator</li>
<li>DoubleAdder</li>
<li>LongAccumulator</li>
<li>LongAdder</li>
</ul>
<p><strong>æ³¨æ„ï¼šç´¯åŠ å•å…ƒå’ŒCPUæ ¸æ•°æœ‰å…³</strong></p>
</blockquote>
<p><strong>LongAdderåˆ†æ</strong></p>
<p><strong>LongAdder ç±»æœ‰å‡ ä¸ªå…³é”®åŸŸ</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//ç´¯åŠ å•å…ƒæ•°ç»„</span><br><span class="line">transient volatile Cell[] cells;</span><br><span class="line"></span><br><span class="line">//æ²¡æœ‰ç«äº‰æ—¶åŸºç¡€å€¼</span><br><span class="line">transient volatile long base;</span><br><span class="line"></span><br><span class="line">//cellsåˆ›å»ºæˆ–æ‰©å®¹æ—¶ï¼Œç½®1ï¼Œè¡¨ç¤ºåŠ é”</span><br><span class="line">transient volatile int cellsBusy;</span><br></pre></td></tr></table></figure>

<p><strong>CASé”</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">class CasLock &#123;</span><br><span class="line">    AtomicInteger lock = new AtomicInteger(0);</span><br><span class="line"></span><br><span class="line">    void lock() &#123;</span><br><span class="line">        while (true) &#123;</span><br><span class="line">            if (lock.compareAndSet(0, 1)) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void unlock() &#123;</span><br><span class="line">        lock.set(0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ³¨æ„ï¼šè¿™ç§å®ç°ä¸è¦è‡ªå·±ç”¨ï¼Œå› ä¸ºwhileå¾ªç¯ï¼Œæµªè´¹æ€§èƒ½ï¼ŒæŠŠæ§ä¸äº†</p>
</blockquote>
<p><strong>åŸç†ä¼ªå…±äº«</strong><br>cpuç¼“å­˜å›¾<br><img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-15_16.06.48.png" width="70%" loading="lazy"><br>cpuç¼“å­˜å—ä¸­èƒ½æ”¾2ä¸ªcellï¼ŒCellæ˜¯æ•°ç»„è¿ç»­å­˜å‚¨çš„ï¼Œå½“çº¿ç¨‹ä¿®æ”¹cellæ—¶ï¼Œå…¶ä»–æ ¸å¿ƒçš„ç¼“å­˜å—å°±å¿…é¡»é‡æ–°è¯»å–<br><img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-15_16.03.20.png" width="50%" loading="lazy"><br>Cellä½¿ç”¨@sun.misc.Contendedæ³¨è§£ï¼Œå¯ä»¥ä½¿å¾—Cellå‰åå¤šä¸€äº›ç©ºç™½ï¼Œå¯¼è‡´ä¸€ä¸ªç¼“å­˜å—åªæœ‰ä¸€ä¸ªCell</p>
<h2 id="Unsafe"><a href="#Unsafe" class="headerlink" title="**Unsafe **"></a>**Unsafe **</h2><blockquote>
<p>Unsafe å¯¹è±¡æä¾›äº†éå¸¸åº•å±‚çš„ï¼Œæ“ä½œå†…å­˜ã€çº¿ç¨‹çš„æ–¹æ³•ï¼ŒUnsalfe å¯¹è±¡ä¸èƒ½ç›´æ¥è°ƒç”¨ï¼Œåªèƒ½é€šè¿‡åå°„è·å¾— </p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public class UnsafeAccessor &#123;</span><br><span class="line">    static Unsafe unsafe;</span><br><span class="line"></span><br><span class="line">    static &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Field theUnsafe = Unsafe.class.getDeclaredField(&quot;theUnsafe&quot;);</span><br><span class="line">            theUnsafe.setAccessible(true);</span><br><span class="line">            Unsafe o = (Unsafe) theUnsafe.get(null);</span><br><span class="line">            unsafe = o;</span><br><span class="line">        &#125; catch (IllegalAccessException | NoSuchFieldException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            throw new Error(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static Unsafe getUnsafe()&#123;</span><br><span class="line">        return unsafe;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>unsafeçš„CASç›¸å…³æ–¹æ³•</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Unsafe unsafe = UnsafeAccessor.getUnsafe();</span><br><span class="line">System.out.println(unsafe);</span><br><span class="line">long idOffset = unsafe.objectFieldOffset(Teacher.class.getDeclaredField(&quot;id&quot;));</span><br><span class="line">long nameOffset = unsafe.objectFieldOffset(Teacher.class.getDeclaredField(&quot;name&quot;));</span><br><span class="line"></span><br><span class="line">Teacher t = new Teacher();</span><br><span class="line">unsafe.compareAndSwapInt(t,idOffset,0,1);</span><br><span class="line">unsafe.compareAndSwapObject(t,nameOffset,null,&quot;å¼ ä¸‰&quot;);</span><br><span class="line">System.out.println(t);</span><br></pre></td></tr></table></figure>

<h2 id="æœ¬ç« å°ç»“-3"><a href="#æœ¬ç« å°ç»“-3" class="headerlink" title="æœ¬ç« å°ç»“"></a><strong>æœ¬ç« å°ç»“</strong></h2><blockquote>
<p>CAS ä¸ volatile<br>API</p>
<ul>
<li>åŸå­æ•´æ•°</li>
<li>åŸå­å¼•ç”¨</li>
<li>åŸå­æ•°ç»„</li>
<li>å­—æ®µæ›´æ–°å™¨</li>
<li>åŸå­ç´¯åŠ å™¨<br>Unsafe<br>åŸç†æ–¹é¢</li>
<li>LongAdder æºç </li>
<li>ä¼ªå…±äº«</li>
</ul>
</blockquote>
<h1 id="å…±äº«æ¨¡å‹ä¹‹ä¸å¯å˜"><a href="#å…±äº«æ¨¡å‹ä¹‹ä¸å¯å˜" class="headerlink" title="å…±äº«æ¨¡å‹ä¹‹ä¸å¯å˜"></a><strong>å…±äº«æ¨¡å‹ä¹‹ä¸å¯å˜</strong></h1><blockquote>
<p>å¦‚æœä¸€ä¸ªå¯¹è±¡æ˜¯ä¸å¯å˜çš„ï¼Œå³ä½¿æ˜¯å…±äº«çš„ï¼Œä¹Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„</p>
</blockquote>
<p><strong>æ—¥æœŸå¯å˜ç±»çš„é—®é¢˜</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span><br><span class="line">for (int i = 0; i &lt; 100; i++) &#123;</span><br><span class="line">    new Thread(()-&gt;&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            sdf.parse(&quot;1951-04-21&quot;);</span><br><span class="line">        &#125; catch (ParseException e) &#123;</span><br><span class="line">            System.out.println(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è¾“å‡º</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">java.lang.NumberFormatException: multiple points</span><br><span class="line">	at sun.misc.FloatingDecimal.readJavaFormatString(FloatingDecimal.java:1890)</span><br><span class="line">	at sun.misc.FloatingDecimal.parseDouble(FloatingDecimal.java:110)</span><br><span class="line">	at java.lang.Double.parseDouble(Double.java:538)</span><br><span class="line">	at java.text.DigitList.getDouble(DigitList.java:169)</span><br><span class="line">	at java.text.DecimalFormat.parse(DecimalFormat.java:2087)</span><br><span class="line">	at java.text.SimpleDateFormat.subParse(SimpleDateFormat.java:1869)</span><br><span class="line">	at java.text.SimpleDateFormat.parse(SimpleDateFormat.java:1514)</span><br><span class="line">	at java.text.DateFormat.parse(DateFormat.java:364)</span><br><span class="line">	at day06.lambda$main$0(day06.java:17)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:750)</span><br><span class="line"></span><br><span class="line">è¿›ç¨‹å·²ç»“æŸ,é€€å‡ºä»£ç 0</span><br></pre></td></tr></table></figure>

<h2 id="ä¸å¯å˜ç±»çš„ä½¿ç”¨"><a href="#ä¸å¯å˜ç±»çš„ä½¿ç”¨" class="headerlink" title="ä¸å¯å˜ç±»çš„ä½¿ç”¨"></a><strong>ä¸å¯å˜ç±»çš„ä½¿ç”¨</strong></h2><blockquote>
<p>DateTimeFormatteræ˜¯ä¸å¯å˜çš„çº¿ç¨‹å®‰å…¨çš„</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DateTimeFormatter dtf = DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd&quot;);</span><br><span class="line">for (int i = 0; i &lt; 100; i++) &#123;</span><br><span class="line">    new Thread(()-&gt;&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            dtf.parse(&quot;1951-04-21&quot;).s;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            System.out.println(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ä¸å¯å˜ç±»è®¾è®¡"><a href="#ä¸å¯å˜ç±»è®¾è®¡" class="headerlink" title="ä¸å¯å˜ç±»è®¾è®¡"></a><strong>ä¸å¯å˜ç±»è®¾è®¡</strong></h2><p><strong>final çš„ä½¿ç”¨</strong></p>
<blockquote>
<p><strong>å‘ç°è¯¥ç±»ã€ç±»ä¸­æ‰€æœ‰å±æ€§éƒ½æ˜¯ final çš„</strong></p>
<ul>
<li>å±æ€§ç”¨ final ä¿®é¥°ä¿è¯äº†è¯¥å±æ€§æ˜¯åªè¯»çš„ï¼Œä¸èƒ½ä¿®æ”¹,æˆ–è€…privateæ— setæ–¹æ³•</li>
<li>ç±»ç”¨ final ä¿®é¥°ä¿è¯äº†è¯¥ç±»ä¸­çš„æ–¹æ³•ä¸èƒ½è¢«è¦†ç›–ï¼Œé˜²æ­¢å­ç±»æ— æ„é—´ç ´åä¸å¯å˜æ€§</li>
</ul>
</blockquote>
<p><strong>ä¿æŠ¤æ€§æ‹·è´</strong></p>
<blockquote>
<p>æ„é€ æ–°å­—ç¬¦ä¸²å¯¹è±¡æ—¶ï¼Œä¼šç”Ÿæˆæ–°çš„ charl] valueï¼Œå¯¹å†…å®¹è¿›è¡Œå¤åˆ¶ã€‚<br>è¿™ç§é€šè¿‡åˆ›å»ºå‰¯æœ¬å¯¹è±¡æ¥é¿å…å…±äº«çš„æ‰‹æ®µç§°ä¹‹ä¸ºã€ä¿æŠ¤æ€§æ‹·è´ (defensive copy)</p>
</blockquote>
<p><strong>åˆå§‹åŒ–</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public String(char value[]) &#123;</span><br><span class="line">    this.value = Arrays.copyOf(value, value.length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>substring</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public String substring(int beginIndex) &#123;</span><br><span class="line">    if (beginIndex &lt; 0) &#123;</span><br><span class="line">        throw new StringIndexOutOfBoundsException(beginIndex);</span><br><span class="line">    &#125;</span><br><span class="line">    int subLen = value.length - beginIndex;</span><br><span class="line">    if (subLen &lt; 0) &#123;</span><br><span class="line">        throw new StringIndexOutOfBoundsException(subLen);</span><br><span class="line">    &#125;</span><br><span class="line">    return (beginIndex == 0) ? this : new String(value, beginIndex, subLen);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="äº«å…ƒæ¨¡å¼"><a href="#äº«å…ƒæ¨¡å¼" class="headerlink" title="äº«å…ƒæ¨¡å¼"></a><strong>äº«å…ƒæ¨¡å¼</strong></h2><blockquote>
<p>è‹±æ–‡åç§°ï¼šFlyweight pattemm.å½“éœ€è¦é‡ç”¨æ•°é‡æœ‰é™çš„åŒä¸€ç±»å¯¹è±¡æ—¶<br>ç›®çš„</p>
<ul>
<li>ä¸ºäº†èŠ‚çœå†…å­˜</li>
</ul>
</blockquote>
<p><strong>ä½“ç°</strong></p>
<blockquote>
<p>åŒ…è£…ç±»çš„valueOfæ–¹æ³•<br>ä¸ä¼šæ–°å»ºä¸€ä¸ªå¯¹è±¡ï¼Œè€Œæ˜¯åœ¨ä¸€ä¸ªç¼“å­˜æ•°ç»„ä¸­æ‰¾åˆ°è¿™ä¸ªå€¼</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public static Long valueOf(long l) &#123;</span><br><span class="line">    final int offset = 128;</span><br><span class="line">    if (l &gt;= -128 &amp;&amp; l &lt;= 127) &#123; // will cache</span><br><span class="line">        return LongCache.cache[(int)l + offset];</span><br><span class="line">    &#125;</span><br><span class="line">    return new Long(l);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ³¨æ„ï¼šè¿™ç§æ¨¡å¼åªæ˜¯å¯ä»¥å•ä¸ªæ“ä½œåŸå­ï¼Œä½†æ˜¯è¿™ç§æ“ä½œçš„ç»„åˆä¸åŸå­<br>å°±å¥½æ¯”ä¹‹å‰ä¾‹å­ä¸­å¯¹BigDecimalåšåŸå­ç±»</p>
</blockquote>
<p><strong>äº«å…ƒæ¨¡å¼çš„demo</strong></p>
<blockquote>
<p>ä¾‹å¦‚ï¼šä¸€ä¸ªçº¿ä¸Šå•†åŸåº”ç”¨ï¼ŒQPSè¾¾åˆ°æ•°å¹²ï¼Œå¦‚æœæ¯æ¬¡éƒ½é‡æ–°åˆ›å»ºå’Œå…³é—­æ•°æ®åº“è¿æ¥ï¼Œæ€§èƒ½ä¼šå—åˆ°æå¤§å½±å“ã€‚<br>è¿™æ—¶é¢„å…ˆåˆ›å»ºå¥½ä¸€æ‰¹è¿æ¥ï¼Œæ”¾å…¥è¿æ¥æ± ã€‚ä¸€æ¬¡è¯·æ±‚åˆ°è¾¾åï¼Œä»è¿æ¥æ± è·å–è¿æ¥ï¼Œä½¿ç”¨å®Œæ¯•åå†è¿˜å›è¿æ¥æ± ï¼Œ<br>è¿™æ ·æ—¢èŠ‚çº¦äº†è¿æ¥çš„åˆ›å»ºå’Œå…³é—­æ—¶é—´ï¼Œä¹Ÿå®ç°äº†è¿æ¥çš„é‡ç”¨ï¼Œä¸è‡³äºè®©åºå¤§çš„è¿æ¥æ•°å‹å®æ•°æ®åº“ã€‚</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">public class Pool &#123;</span><br><span class="line">    private final int poolSize;</span><br><span class="line">    private Connection[] connections;</span><br><span class="line">    private AtomicIntegerArray state;//0ç©ºé—²1å¿™</span><br><span class="line"></span><br><span class="line">    public Pool(int poolSize) &#123;</span><br><span class="line">        this.poolSize = poolSize;</span><br><span class="line">        this.connections = new Connection[poolSize];</span><br><span class="line">        this.state = new AtomicIntegerArray(new int[poolSize]);</span><br><span class="line">        for (int i = 0; i &lt; poolSize; i++) &#123;</span><br><span class="line">            connections[i] = new Mock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //å€Ÿè¿æ¥</span><br><span class="line">    public Connection borrow() &#123;</span><br><span class="line">        while (true) &#123;</span><br><span class="line">            for (int i = 0; i &lt; poolSize; i++) &#123;</span><br><span class="line">                if (state.get(i) == 0) &#123;</span><br><span class="line">                    if (state.compareAndSet(i,0,1)) &#123;</span><br><span class="line">                        return connections[i];</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            synchronized (this)&#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    this.wait();</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //å½’è¿˜è¿æ¥</span><br><span class="line">    public void free(Connection connection) &#123;</span><br><span class="line">        for (int i = 0; i &lt; poolSize; i++) &#123;</span><br><span class="line">            if (connections[i] == connection)</span><br><span class="line">            &#123;</span><br><span class="line">                state.set(i,0);</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        synchronized (this)&#123;</span><br><span class="line">            this.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ä»¥ä¸Šå®ç°æ²¡æœ‰è€ƒè™‘ï¼š<br>è¿æ¥çš„åŠ¨æ€å¢é•¿ä¸æ”¶ç¼©<br>è¿æ¥ä¿æ´»ï¼ˆå¯ç”¨æ€§æ£€æµ‹ï¼‰</p>
<ul>
<li>ç­‰å¾…è¶…æ—¶å¤„ç†</li>
<li>åˆ†å¸ƒå¼ hash<br>å¯¹äºå…³ç³»å‹æ•°æ®åº“ï¼Œæœ‰æ¯”è¾ƒæˆç†Ÿçš„è¿æ¥æ± å®ç°ï¼Œä¾‹å¦‚c3p0, druidç­‰<br>å¯¹äºæ›´é€šç”¨çš„å¯¹è±¡æ± ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨apache commons poolï¼Œä¾‹å¦‚redisè¿æ¥æ± å¯ä»¥å‚è€ƒjedisä¸­å…³äºè¿æ¥æ± çš„å®ç°</li>
</ul>
</blockquote>
<p><strong>finalåŸç†</strong></p>
<p><strong>å£°æ˜final</strong></p>
<blockquote>
<p><strong>ç†è§£äº† volatile åŸç†ï¼Œå†å¯¹æ¯” final çš„å®ç°å°±æ¯”è¾ƒç®€å•äº†</strong></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public class TestFinal &#123;</span><br><span class="line">    final int a= 20;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>å­—èŠ‚ç </strong></p>
<img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-16_09.38.07.png" width="50%" loading="lazy">

<blockquote>
<p>å†™å±éšœä¿è¯äº†finalå˜é‡åœ¨ä¸»å­˜ä¸­çš„å…±äº«ï¼Œå¹¶ä¸”finalä¹Ÿæ˜¯ä¸å¯å˜çš„ï¼Œå¯è§æ€§å¾—åˆ°ä¿è¯</p>
</blockquote>
<p><strong>è¯»å–final</strong></p>
<blockquote>
<p>finalå£°æ˜çš„å˜é‡èµ‹å€¼åè¯»å–è¾ƒå°çš„å€¼åœ¨æ ˆå†…å­˜ï¼Œè¾ƒå¤§çš„åœ¨å¸¸é‡æ± ä¸­<br>ä¸åŠ finalåˆ™åœ¨å †ä¸­ï¼Œä½¿ç”¨getstaticè¯»å–<br>ä½¿ç”¨finalæ•ˆç‡æé«˜</p>
</blockquote>
<h2 id="æ— çŠ¶æ€ç±»è®¾è®¡"><a href="#æ— çŠ¶æ€ç±»è®¾è®¡" class="headerlink" title="æ— çŠ¶æ€ç±»è®¾è®¡"></a><strong>æ— çŠ¶æ€ç±»è®¾è®¡</strong></h2><blockquote>
<p>åœ¨webé˜¶æ®µå­¦ä¹ æ—¶ï¼Œè®¾è®¡ Servlet æ—¶ä¸ºäº†ä¿è¯å…¶çº¿ç¨‹å®‰å…¨ï¼Œéƒ½ä¼šæœ‰è¿™æ ·çš„å»ºè®®ï¼Œä¸è¦ä¸º Servlet è®¾ç½®æˆå‘˜å˜é‡<br>è¿™ç§æ²¡æœ‰ä»»ä½•æˆå‘˜å˜é‡çš„ç±»æ˜¯çº¿ç¨‹å®‰å…¨çš„.å› ä¸ºæˆå‘˜å˜é‡ä¿å­˜çš„æ•°æ®ä¹Ÿå¯ä»¥ç§°ä¸ºçŠ¶æ€ä¿¡æ¯ï¼Œå› æ­¤æ²¡æœ‰æˆå‘˜å˜é‡å°±ç§°ä¹‹ä¸ºã€æ— çŠ¶æ€ã€‘</p>
</blockquote>
<h2 id="æœ¬ç« å°ç»“-4"><a href="#æœ¬ç« å°ç»“-4" class="headerlink" title="æœ¬ç« å°ç»“"></a><strong>æœ¬ç« å°ç»“</strong></h2><blockquote>
<p>ä¸å¯å˜ç±»ä½¿ç”¨<br>ä¸å¯å˜ç±»è®¾è®¡<br><strong>åŸç†æ–¹é¢</strong></p>
<ul>
<li>final</li>
</ul>
<p><strong>æ¨¡å¼æ–¹é¢</strong></p>
<ul>
<li>äº«å…ƒ</li>
</ul>
</blockquote>
<h1 id="çº¿ç¨‹æ± "><a href="#çº¿ç¨‹æ± " class="headerlink" title="çº¿ç¨‹æ± "></a><strong>çº¿ç¨‹æ± </strong></h1><h2 id="è‡ªå®šä¹‰çº¿ç¨‹æ± "><a href="#è‡ªå®šä¹‰çº¿ç¨‹æ± " class="headerlink" title="è‡ªå®šä¹‰çº¿ç¨‹æ± "></a><strong>è‡ªå®šä¹‰çº¿ç¨‹æ± </strong></h2><p><strong>æ¶æ„è®¾è®¡</strong><br><img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-16_15.35.39.png" width="70%" loading="lazy"></p>
<h3 id="é˜»å¡é˜Ÿåˆ—çš„å®ç°"><a href="#é˜»å¡é˜Ÿåˆ—çš„å®ç°" class="headerlink" title="é˜»å¡é˜Ÿåˆ—çš„å®ç°"></a><strong>é˜»å¡é˜Ÿåˆ—çš„å®ç°</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BlockingQueue</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">//åŒå‘é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">private</span> Deque&lt;T&gt; deque = <span class="keyword">new</span> <span class="title class_">ArrayDeque</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//é”</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">    <span class="comment">//æ»¡æ—¶æ¡ä»¶å˜é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Condition</span> <span class="variable">FullWaitSet</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line">    <span class="comment">//ç©ºæ—¶æ¡ä»¶å˜é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Condition</span> <span class="variable">EmptyWaitSet</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line">    <span class="comment">//å®¹é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> captity;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BlockingQueue</span><span class="params">(<span class="type">int</span> captity)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.captity = captity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">take</span><span class="params">()</span> &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (deque.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    EmptyWaitSet.await();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">T</span> <span class="variable">t</span> <span class="operator">=</span> deque.removeFirst();</span><br><span class="line">            FullWaitSet.signal();</span><br><span class="line">            <span class="keyword">return</span> t;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(T element)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">while</span> (deque.size() == captity) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot;ä»»åŠ¡ç­‰å¾…...&quot;</span>);</span><br><span class="line">                    FullWaitSet.await();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot;ä»»åŠ¡è¿›å…¥é˜»å¡é˜Ÿåˆ—...&quot;</span>);</span><br><span class="line">            deque.addLast(element);</span><br><span class="line">            EmptyWaitSet.signal();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="çº¿ç¨‹æ± å®ç°"><a href="#çº¿ç¨‹æ± å®ç°" class="headerlink" title="çº¿ç¨‹æ± å®ç°"></a><strong>çº¿ç¨‹æ± å®ç°</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadPool</span> &#123;</span><br><span class="line">    <span class="comment">//æš‚å­˜ä»»åŠ¡é›†åˆ</span></span><br><span class="line">    <span class="keyword">private</span> BlockingQueue&lt;Runnable&gt; taskQueue;</span><br><span class="line">    <span class="comment">//å·¥ä½œä»»åŠ¡é›†åˆ</span></span><br><span class="line">    <span class="keyword">private</span> HashSet&lt;Worker&gt; workers = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//æ ¸å¿ƒçº¿ç¨‹æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> coreSize;</span><br><span class="line">    <span class="comment">//è¶…æ—¶æ—¶é—´</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> timeout;</span><br><span class="line">    <span class="comment">//æ—¶é—´å•ä½</span></span><br><span class="line">    <span class="keyword">private</span> TimeUnit timeUnit;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable task)</span> &#123;</span><br><span class="line">        <span class="comment">//å½“ä»»åŠ¡æ•°æ²¡æœ‰è¶…è¿‡ coresize æ—¶ï¼Œç›´æ¥äº¤ç»™ workerå¯¹å®¶æ•™è¡Œ</span></span><br><span class="line">        <span class="comment">//å¦‚æœä»»åŠ¡æ•°è¶…è¿‡ coresize æ—¶ï¼ŒåŠ å…¥ä»»åŠ¡é˜Ÿåˆ—æš‚å­˜</span></span><br><span class="line">        <span class="keyword">synchronized</span> (workers) &#123;</span><br><span class="line">            <span class="keyword">if</span> (workers.size() &lt; coreSize) &#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">&quot;åˆ›å»ºæ–°ä»»åŠ¡...&quot;</span>);</span><br><span class="line">                <span class="type">Worker</span> <span class="variable">worker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Worker</span>(task);</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">&quot;åŠ å…¥å·¥ä½œçº¿ç¨‹é›†åˆä¸­...&quot;</span>);</span><br><span class="line">                workers.add(worker);</span><br><span class="line">                worker.start();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                taskQueue.put(task);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ThreadPool</span><span class="params">(<span class="type">int</span> coreSize, <span class="type">long</span> timeout, TimeUnit timeUnit, <span class="type">int</span> captity)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.coreSize = coreSize;</span><br><span class="line">        <span class="built_in">this</span>.timeout = timeout;</span><br><span class="line">        <span class="built_in">this</span>.timeUnit = timeUnit;</span><br><span class="line">        taskQueue = <span class="keyword">new</span> <span class="title class_">BlockingQueue</span>&lt;&gt;(captity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Worker</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> Runnable runnable;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Worker</span><span class="params">(Runnable runnable)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.runnable = runnable;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">//å½“ task ä¸ä¸ºç©ºï¼Œæ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">            <span class="comment">//å½“ task æ‰§è¡Œå® åï¼Œå†æ¥ç€ä»ä»»åŠ¡é˜Ÿåˆ—æˆ‘å–ä»»åŠ¡å¹¶æ‰§è¡Œ</span></span><br><span class="line">            <span class="keyword">while</span> (runnable != <span class="literal">null</span> || (runnable = taskQueue.take) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot;è¿è¡Œ...&quot;</span>);</span><br><span class="line">                    runnable.run();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    runnable = <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//æ²¡æœ‰ä»»åŠ¡äº†ç§»é™¤æ‰</span></span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">&quot;ç»“æŸä»»åŠ¡&quot;</span>);</span><br><span class="line">                workers.remove(<span class="built_in">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="è¶…æ—¶è·å–"><a href="#è¶…æ—¶è·å–" class="headerlink" title="è¶…æ—¶è·å–"></a><strong>è¶…æ—¶è·å–</strong></h3><blockquote>
<p>å¦‚æœæ²¡æœ‰è¶…æ—¶è·å–ï¼Œé‚£ä¹ˆå½“æ²¡æœ‰ä»»ä½•ä»»åŠ¡è¦å¤„ç†ï¼Œçº¿ç¨‹ä¹Ÿä¸ä¼šç»“æŸï¼Œè€Œæ˜¯é˜»å¡ï¼Œä¸€ç›´ç­‰å¾…æœ‰ä»»åŠ¡è¿‡æ¥<br>å¦‚æœæœ‰è¶…æ—¶è·å–ï¼Œé‚£ä¹ˆæ²¡æœ‰ä»»åŠ¡æ—¶ï¼Œç­‰å¾…ä¸€ä¼šï¼ŒæœŸé—´æœ‰ä»»åŠ¡è¿˜ç»§ç»­å¤„ç†ï¼Œæ²¡ä»»åŠ¡ç­‰å®Œäº†å°±ç›´æ¥ç»“æŸ</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//å¸¦è¶…æ—¶ç­‰å¾…çš„è·å–</span></span><br><span class="line"><span class="keyword">public</span> T <span class="title function_">poll</span><span class="params">(<span class="type">long</span> timeout, TimeUnit unit)</span> &#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        timeout = unit.toNanos(timeout);</span><br><span class="line">        <span class="keyword">while</span> (deque.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (timeout &lt;= <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                timeout = EmptyWaitSet.awaitNanos(timeout);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">T</span> <span class="variable">t</span> <span class="operator">=</span> deque.removeFirst();</span><br><span class="line">        FullWaitSet.signal();</span><br><span class="line">        <span class="keyword">return</span> t;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="è¶…æ—¶æ·»åŠ "><a href="#è¶…æ—¶æ·»åŠ " class="headerlink" title="è¶…æ—¶æ·»åŠ "></a><strong>è¶…æ—¶æ·»åŠ </strong></h3><blockquote>
<p>å¦‚æœæ²¡æœ‰è¶…æ—¶æ·»åŠ ï¼Œé‚£ä¹ˆæ·»åŠ æ—¶å¦‚æœå·¥ä½œçº¿ç¨‹é›†åˆå’Œé˜»å¡é˜Ÿåˆ—éƒ½æ»¡äº†ï¼Œé‚£ä¹ˆä¸»çº¿ç¨‹ï¼ˆè°ƒç”¨è€…ï¼‰ä¼šé™·å…¥æ­»ç­‰ï¼ŒçŸ¥é“å‡ºç°ç©ºé—²<br>å¦‚æœæœ‰è¶…æ—¶æ·»åŠ åï¼Œé‚£ä¹ˆä¼šç›´æ¥è¿”å›ï¼Œä¸å†å¤„ç†ä»»åŠ¡ï¼Œå½“ç„¶è¿™åªæ˜¯é˜Ÿåˆ—æ»¡æ—¶çš„å…¶ä¸­ä¸€ç§ç­–ç•¥</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¸¦è¶…æ—¶æ—¶é—´çš„æ·»åŠ </span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">offer</span><span class="params">(T element, <span class="type">long</span> timeout, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            timeout = timeUnit.toNanos(timeout);</span><br><span class="line">            <span class="keyword">while</span> (deque.size() == captity) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (timeout &lt;= <span class="number">0</span>)</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot;ä»»åŠ¡ç­‰å¾…...&quot;</span>);</span><br><span class="line">                    timeout = FullWaitSet.awaitNanos(timeout);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot;ä»»åŠ¡è¿›å…¥é˜»å¡é˜Ÿåˆ—...&quot;</span>);</span><br><span class="line">            deque.addLast(element);</span><br><span class="line">            EmptyWaitSet.signal();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="æ‹’ç»ç­–ç•¥"><a href="#æ‹’ç»ç­–ç•¥" class="headerlink" title="æ‹’ç»ç­–ç•¥"></a><strong>æ‹’ç»ç­–ç•¥</strong></h3><blockquote>
<p><strong>å½“é˜Ÿåˆ—æ»¡äº†ï¼Œä¼šæ ¹æ®ä¸åŒç­–ç•¥åº”å¯¹</strong></p>
<ul>
<li>æ­»ç­‰<br>blockingQueue.take();</li>
<li>è¶…æ—¶ç­‰å¾…<br>blockingQueue.poll(1,TimeUnit.SECONDS);</li>
<li>è°ƒç”¨è€…æ”¾å¼ƒä»»åŠ¡(ç©ºæ“ä½œå³å¯)<br>System.out.println(â€œè°ƒç”¨è€…æ”¾å¼ƒä»»åŠ¡â€);</li>
<li>è°ƒç”¨è€…æŠ›å‡ºå¼‚å¸¸<br>throw new RuntimeException(â€œçº¿ç¨‹æ± å·²æ»¡â€);</li>
<li>è°ƒç”¨è€…è‡ªå·±æ‰§è¡Œä»»åŠ¡</li>
</ul>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ThreadPool</span> <span class="variable">threadPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPool</span>(<span class="number">1</span>, <span class="number">1</span>, TimeUnit.SECONDS, <span class="number">1</span>,</span><br><span class="line">                ((blockingQueue, task) -&gt; &#123;</span><br><span class="line">                    <span class="comment">//1ã€‚æ­»ç­‰</span></span><br><span class="line">                    <span class="comment">//blockingQueue.take();</span></span><br><span class="line">                    <span class="comment">//2ã€‚è¶…æ—¶ç­‰å¾…</span></span><br><span class="line">                    <span class="comment">//blockingQueue.poll(1,TimeUnit.SECONDS);</span></span><br><span class="line">                    <span class="comment">//3ã€‚è°ƒç”¨è€…æ”¾å¼ƒä»»åŠ¡(ç©ºæ“ä½œå³å¯)</span></span><br><span class="line">                    <span class="comment">//System.out.println(&quot;è°ƒç”¨è€…æ”¾å¼ƒä»»åŠ¡&quot;);</span></span><br><span class="line">                    <span class="comment">//4ã€‚è°ƒç”¨è€…æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">                    <span class="comment">//throw new RuntimeException(&quot;çº¿ç¨‹æ± å·²æ»¡&quot;);</span></span><br><span class="line">                    <span class="comment">//5ã€‚è°ƒç”¨è€…è‡ªå·±æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">                    task.run();</span><br><span class="line">                &#125;</span><br><span class="line">                ));</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            threadPool.execute(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000l</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æ‹’ç»ç­–ç•¥æ¥å£</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">RejectPolic</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">reject</span><span class="params">(BlockingQueue&lt;T&gt; blockingQueue, T task)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadPool</span> &#123;</span><br><span class="line">    <span class="comment">//æš‚å­˜ä»»åŠ¡é›†åˆ</span></span><br><span class="line">    <span class="keyword">private</span> BlockingQueue&lt;Runnable&gt; taskQueue;</span><br><span class="line">    <span class="comment">//å·¥ä½œä»»åŠ¡é›†åˆ</span></span><br><span class="line">    <span class="keyword">private</span> HashSet&lt;Worker&gt; workers = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//æ ¸å¿ƒçº¿ç¨‹æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> coreSize;</span><br><span class="line">    <span class="comment">//è¶…æ—¶æ—¶é—´</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> timeout;</span><br><span class="line">    <span class="comment">//æ—¶é—´å•ä½</span></span><br><span class="line">    <span class="keyword">private</span> TimeUnit timeUnit;</span><br><span class="line">    <span class="keyword">private</span> RejectPolic&lt;Runnable&gt; rejectPolicy;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable task)</span> &#123;</span><br><span class="line">        <span class="comment">//å½“ä»»åŠ¡æ•°æ²¡æœ‰è¶…è¿‡ coresize æ—¶ï¼Œç›´æ¥äº¤ç»™ workerå¯¹å®¶æ•™è¡Œ</span></span><br><span class="line">        <span class="comment">//å¦‚æœä»»åŠ¡æ•°è¶…è¿‡ coresize æ—¶ï¼ŒåŠ å…¥ä»»åŠ¡é˜Ÿåˆ—æš‚å­˜</span></span><br><span class="line">        <span class="keyword">synchronized</span> (workers) &#123;</span><br><span class="line">            <span class="keyword">if</span> (workers.size() &lt; coreSize) &#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">&quot;åˆ›å»ºæ–°ä»»åŠ¡...&quot;</span>);</span><br><span class="line">                <span class="type">Worker</span> <span class="variable">worker</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Worker</span>(task);</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">&quot;åŠ å…¥å·¥ä½œçº¿ç¨‹é›†åˆä¸­...&quot;</span>);</span><br><span class="line">                workers.add(worker);</span><br><span class="line">                worker.start();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//taskQueue.put(task);</span></span><br><span class="line">                <span class="comment">//æ‹’ç»ç­–ç•¥</span></span><br><span class="line">                taskQueue.tryPut(rejectPolicy, task);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ThreadPool</span><span class="params">(<span class="type">int</span> coreSize, <span class="type">long</span> timeout, TimeUnit timeUnit, <span class="type">int</span> captity, RejectPolic&lt;Runnable&gt; rejectPolic)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.coreSize = coreSize;</span><br><span class="line">        <span class="built_in">this</span>.timeout = timeout;</span><br><span class="line">        <span class="built_in">this</span>.timeUnit = timeUnit;</span><br><span class="line">        taskQueue = <span class="keyword">new</span> <span class="title class_">BlockingQueue</span>&lt;&gt;(captity);</span><br><span class="line">        <span class="built_in">this</span>.rejectPolicy = rejectPolic;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Worker</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> Runnable runnable;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Worker</span><span class="params">(Runnable runnable)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.runnable = runnable;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">//å½“ task ä¸ä¸ºç©ºï¼Œæ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">            <span class="comment">//å½“ task æ‰§è¡Œå® åï¼Œå†æ¥ç€ä»ä»»åŠ¡é˜Ÿåˆ—æˆ‘å–ä»»åŠ¡å¹¶æ‰§è¡Œ</span></span><br><span class="line">            <span class="keyword">while</span> (runnable != <span class="literal">null</span> || (runnable = taskQueue.poll(timeout, timeUnit)) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread() + <span class="string">&quot;è¿è¡Œ...&quot;</span>);</span><br><span class="line">                    runnable.run();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    runnable = <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//æ²¡æœ‰ä»»åŠ¡äº†ç§»é™¤æ‰</span></span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                System.out.println(Thread.currentThread() + <span class="string">&quot;ç»“æŸä»»åŠ¡&quot;</span>);</span><br><span class="line">                workers.remove(<span class="built_in">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BlockingQueue</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">//åŒå‘é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">private</span> Deque&lt;T&gt; deque = <span class="keyword">new</span> <span class="title class_">ArrayDeque</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//é”</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">    <span class="comment">//æ»¡æ—¶æ¡ä»¶å˜é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Condition</span> <span class="variable">FullWaitSet</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line">    <span class="comment">//ç©ºæ—¶æ¡ä»¶å˜é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Condition</span> <span class="variable">EmptyWaitSet</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line">    <span class="comment">//å®¹é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> captity;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BlockingQueue</span><span class="params">(<span class="type">int</span> captity)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.captity = captity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¸¦è¶…æ—¶ç­‰å¾…çš„è·å–</span></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">poll</span><span class="params">(<span class="type">long</span> timeout, TimeUnit unit)</span> &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            timeout = unit.toNanos(timeout);</span><br><span class="line">            <span class="keyword">while</span> (deque.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (timeout &lt;= <span class="number">0</span>)</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                    timeout = EmptyWaitSet.awaitNanos(timeout);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">T</span> <span class="variable">t</span> <span class="operator">=</span> deque.removeFirst();</span><br><span class="line">            FullWaitSet.signal();</span><br><span class="line">            <span class="keyword">return</span> t;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">take</span><span class="params">()</span> &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (deque.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    EmptyWaitSet.await();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">T</span> <span class="variable">t</span> <span class="operator">=</span> deque.removeFirst();</span><br><span class="line">            FullWaitSet.signal();</span><br><span class="line">            <span class="keyword">return</span> t;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(T element)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">while</span> (deque.size() == captity) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread() + <span class="string">&quot;ä»»åŠ¡ç­‰å¾…...&quot;</span>);</span><br><span class="line">                    FullWaitSet.await();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Thread.currentThread() + <span class="string">&quot;ä»»åŠ¡è¿›å…¥é˜»å¡é˜Ÿåˆ—...&quot;</span>);</span><br><span class="line">            deque.addLast(element);</span><br><span class="line">            EmptyWaitSet.signal();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¸¦è¶…æ—¶æ—¶é—´çš„æ·»åŠ </span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">offer</span><span class="params">(T element, <span class="type">long</span> timeout, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            timeout = timeUnit.toNanos(timeout);</span><br><span class="line">            <span class="keyword">while</span> (deque.size() == captity) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (timeout &lt;= <span class="number">0</span>)</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                    System.out.println(Thread.currentThread() + <span class="string">&quot;ä»»åŠ¡ç­‰å¾…...&quot;</span>);</span><br><span class="line">                    timeout = FullWaitSet.awaitNanos(timeout);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Thread.currentThread() + <span class="string">&quot;ä»»åŠ¡è¿›å…¥é˜»å¡é˜Ÿåˆ—...&quot;</span>);</span><br><span class="line">            deque.addLast(element);</span><br><span class="line">            EmptyWaitSet.signal();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">tryPut</span><span class="params">(RejectPolic&lt;T&gt; rejectPolic, T task)</span> &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (deque.size() == captity) &#123;</span><br><span class="line">                rejectPolic.reject(<span class="built_in">this</span>, task);</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(Thread.currentThread() + <span class="string">&quot;ä»»åŠ¡è¿›å…¥é˜»å¡é˜Ÿåˆ—...&quot;</span>);</span><br><span class="line">                deque.addLast(task);</span><br><span class="line">                EmptyWaitSet.signal();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="ThreadPoolExecutor"><a href="#ThreadPoolExecutor" class="headerlink" title="ThreadPoolExecutor"></a><strong>ThreadPoolExecutor</strong></h2><img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-16_16.51.13.png" width="70%" loading="lazy">

<h3 id="çº¿ç¨‹æ± çŠ¶æ€"><a href="#çº¿ç¨‹æ± çŠ¶æ€" class="headerlink" title="çº¿ç¨‹æ± çŠ¶æ€"></a><strong>çº¿ç¨‹æ± çŠ¶æ€</strong></h3><img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-16_16.56.55.png" width="70%" loading="lazy">

<blockquote>
<p>ThreadPoolExecutor ä½¿ç”¨ int çš„é«˜3 ä½æ¥è¡¨ç¤ºçº¿ç¨‹æ± çŠ¶æ€ï¼Œä½29 ä½è¡¨ç¤ºçº¿ç¨‹æ•°é‡<br>ä»æ•°å­—ä¸Šæ¯”è¾ƒï¼ŒTERMINATED &gt; TIDYING &gt; STOP &gt; SHUTDOWN &gt; RUNNING<br>è¿™äº›ä¿¡æ¯å­˜å‚¨åœ¨ä¸€ä¸ªåŸå­å˜é‡ ctlä¸­ï¼Œç›®çš„æ˜¯å°†çº¿ç¨‹æ± çŠ¶æ€ä¸çº¿ç¨‹ä¸ªæ•°åˆäºŒä¸ºä¸€ï¼Œè¿™æ ·å°±å¯ä»¥ç”¨ä¸€æ¬¡ cas åŸå­æ“ä½œè¿›è¡Œèµ‹å€¼</p>
</blockquote>
<h3 id="çº¿ç¨‹æ± æ„é€ æ–¹æ³•"><a href="#çº¿ç¨‹æ± æ„é€ æ–¹æ³•" class="headerlink" title="çº¿ç¨‹æ± æ„é€ æ–¹æ³•"></a><strong>çº¿ç¨‹æ± æ„é€ æ–¹æ³•</strong></h3><blockquote>
<ul>
<li>corePoolSize æ ¸å¿ƒçº¿ç¨‹æ•°ç›®ï¼ˆæœ€å¤šä¿ç•™çš„çº¿ç¨‹æ•°ï¼‰</li>
<li>maximumPoolsize æœ€å¤§çº¿ç¨‹æ•°ç›®</li>
<li>keepAliveTime ç”Ÿå­˜æ—¶é—´-é’ˆå¯¹æ•‘æ€¥çº¿ç¨‹</li>
<li>unit æ—¶é—´å•ä½- é’ˆå¯¹æ•‘æ€¥çº¿ç¨‹</li>
<li>workQueue é˜³å¡é˜Ÿåˆ—</li>
<li>threadFactory çº¿ç¨‹å·¥å‚-å¯ä»¥ä¸ºçº¿ç¨‹åˆ›å»ºæ—¶èµ·ä¸ªå¥½åå­—</li>
<li>handler æ‹’ç»ç­–ç•¥</li>
</ul>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ThreadPoolExecutor</span><span class="params">(<span class="type">int</span> corePoolSize,</span></span><br><span class="line"><span class="params">                          <span class="type">int</span> maximumPoolSize,</span></span><br><span class="line"><span class="params">                          <span class="type">long</span> keepAliveTime,</span></span><br><span class="line"><span class="params">                          TimeUnit unit,</span></span><br><span class="line"><span class="params">                          BlockingQueue&lt;Runnable&gt; workQueue,</span></span><br><span class="line"><span class="params">                          ThreadFactory threadFactory,</span></span><br><span class="line"><span class="params">                          RejectedExecutionHandler handler)</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>çº¿ç¨‹æ± ä¸­åˆšå¼€å§‹æ²¡æœ‰çº¿ç¨‹ï¼Œå½“ä¸€ä¸ªä»»åŠ¡æäº¤ç»™çº¿ç¨‹æ± åï¼Œçº¿ç¨‹æ± ä¼šåˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚</strong><br><strong>å½“çº¿ç¨‹æ•°è¾¾åˆ° corePoolSize å¹¶æ²¡æœ‰çº¿ç¨‹ç©ºé—²ï¼Œè¿™æ—¶å†åŠ å…¥ä»»åŠ¡ï¼Œæ–°åŠ çš„ä»»åŠ¡ä¼šè¢«åŠ å…¥workQueue é˜Ÿåˆ—æ’é˜Ÿï¼Œç›´åˆ°æœ‰ç©ºé—²çš„çº¿ç¨‹ã€‚</strong><br><strong>å¦‚æœé˜Ÿåˆ—é€‰æ‹©äº†æœ‰ç•Œé˜Ÿåˆ—ï¼Œé‚£ä¹ˆä»»åŠ¡è¶…è¿‡äº†é˜Ÿåˆ—å¤§å°æ—¶ï¼Œä¼šåˆ›å»º maximumPoolSize - corePoolSize æ•°ç›®çš„çº¿ç¨‹æ¥æ•‘æ€¥ã€‚</strong><br><strong>å¦‚æœçº¿ç¨‹åˆ°è¾¾ maximumPoolsize ä»ç„¶æœ‰æ–°ä»»åŠ¡è¿™æ—¶ä¼šæ‰§è¡Œæ‹’ç»ç­–ç•¥ã€‚æ‹’ç»ç­–ç•¥jdkæä¾›äº†4ç§å®ç°ï¼Œå…¶å®ƒè‘—åæ¡†æ¶ä¹Ÿæä¾›äº†å®ç°</strong><br><strong>å½“é«˜å³°è¿‡å»åï¼Œè¶…è¿‡corePoolsize çš„æ•‘æ€¥çº¿ç¨‹å¦‚æœä¸€æ®µæ—¶é—´æ²¡æœ‰ä»»åŠ¡åšï¼Œéœ€è¦ç»“æŸèŠ‚çœèµ„æºï¼Œè¿™ä¸ªæ—¶é—´ç”±keepAliveTime å’Œ unit æ¥æ§åˆ¶ã€‚</strong></p>
<ul>
<li>AbortPolicy è®©è°ƒç”¨è€…æŠ›å‡º RejectedExecutionException å¼‚å¸¸ï¼Œè¿™æ˜¯é»˜è®¤ç­–ç•¥</li>
<li>CallerRunsPolicy è®©è°ƒç”¨è€…è¿è¡Œä»»åŠ¡</li>
<li>DiscardPolicy æ”¾å¼ƒæœ¬æ¬¡ä»»åŠ¡</li>
<li>DiscardoldestPolicy æ”¾å¼ƒé˜Ÿåˆ—ä¸­æœ€æ—©çš„ä»»åŠ¡ï¼Œæœ¬ä»»åŠ¡å–è€Œä»£ä¹‹</li>
<li>Dubbo çš„å®ç°ï¼Œåœ¨æŠ›å‡º RejectedExecutionException å¼‚å¸¸ä¹‹å‰ä¼šè®°å½•æ—¥å¿—ï¼Œå¹¶ dump çº¿ç¨‹æ ˆä¿¡æ¯ï¼Œæ–¹ä¾¿å®šä½é—®é¢˜</li>
<li>Netty çš„å®ç°ï¼Œæ˜¯åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡</li>
<li>ActiveMQ çš„å®ç°ï¼Œå¸¦è¶…æ—¶ç­‰å¾…ï¼ˆ60sï¼‰å°è¯•æ”¾å…¥é˜Ÿåˆ—ï¼Œç±»ä¼¼æˆ‘ä»¬ä¹‹å‰è‡ªå®šä¹‰çš„æ‹’ç»ç­–ç•¥</li>
<li>PinPoint çš„å®ç°ï¼Œå®ƒä½¿ç”¨äº†ä¸€ä¸ªæ‹’ç»ç­–ç•¥é“¾ï¼Œä¼šé€ä¸€å°è¯•ç­–ç•¥é“¾ä¸­æ¯ç§æ‹’ç»ç­–ç•¥</li>
</ul>
</blockquote>
<p><strong>jdkçš„æ‹’ç»ç­–ç•¥</strong></p>
<img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-17_14.44.19.png" width="70%" loading="lazy">

<h3 id="å›ºå®šå¤§å°çº¿ç¨‹"><a href="#å›ºå®šå¤§å°çº¿ç¨‹" class="headerlink" title="å›ºå®šå¤§å°çº¿ç¨‹"></a><strong>å›ºå®šå¤§å°çº¿ç¨‹</strong></h3><blockquote>
<p>newFixedThreadPool<br>åˆ›å»ºæ–¹å¼ï¼šExecutors.newFixedThreadPool();</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public static ExecutorService newFixedThreadPool(int nThreads) &#123;</span><br><span class="line">    return new ThreadPoolExecutor(nThreads, nThreads,</span><br><span class="line">                                  0L, TimeUnit.MILLISECONDS,</span><br><span class="line">                                  new LinkedBlockingQueue&lt;Runnable&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>ç‰¹ç‚¹</strong></p>
<ul>
<li>æ ¸å¿ƒçº¿ç¨‹æ•°-= æœ€å¤§çº¿ç¨‹æ•°ï¼ˆæ²¡æœ‰æ•‘æ€¥çº¿ç¨‹è¢«åˆ›å»ºï¼‰ï¼Œå› æ­¤ä¹Ÿæ— éœ€è¶…æ—¶æ—¶é—´</li>
<li>é˜»å¡é˜Ÿåˆ—æ˜¯æ— ç•Œçš„ï¼Œå¯ä»¥æ”¾ä»»æ„æ•°é‡çš„ä»»åŠ¡</li>
</ul>
<p><strong>è¯„ä»·</strong></p>
<ul>
<li>é€‚ç”¨äºä»»åŠ¡é‡å·²çŸ¥ï¼Œç›¸å¯¹è€—æ—¶çš„ä»»åŠ¡</li>
</ul>
</blockquote>
<h3 id="å¸¦ç¼“å†²çº¿ç¨‹æ± "><a href="#å¸¦ç¼“å†²çº¿ç¨‹æ± " class="headerlink" title="å¸¦ç¼“å†²çº¿ç¨‹æ± "></a><strong>å¸¦ç¼“å†²çº¿ç¨‹æ± </strong></h3><blockquote>
<p>newCachedThreadPool<br>åˆ›å»ºæ–¹å¼ï¼šExecutors.newCachedThreadPool()</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public static ExecutorService newCachedThreadPool() &#123;</span><br><span class="line">    return new ThreadPoolExecutor(0, Integer.MAX_VALUE,</span><br><span class="line">                                  60L, TimeUnit.SECONDS,</span><br><span class="line">                                  new SynchronousQueue&lt;Runnable&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>ç‰¹ç‚¹</strong><br>æ ¸å¿ƒçº¿ç¨‹æ•°æ˜¯0ï¼Œæœ€å¤§çº¿ç¨‹æ•°æ˜¯ Integer.MAX VALUEï¼Œ æ•‘æ€¥çº¿ç¨‹çš„ç©ºé—²ç”Ÿå­˜æ—¶é—´æ˜¯60sï¼Œæ„å‘³ç€</p>
<ul>
<li>å…¨éƒ¨éƒ½æ˜¯æ•‘æ€¥çº¿ç¨‹ï¼ˆ60såå¯ä»¥å›æ”¶ï¼‰</li>
<li>æ•‘æ€¥çº¿ç¨‹å¯ä»¥æ— é™åˆ›å»º<br>é˜Ÿåˆ—é‡‡ç”¨äº† SynchronousQueue å®ç°ç‰¹ç‚¹æ˜¯ï¼Œå®ƒæ²¡æœ‰å®¹é‡ï¼Œæ²¡æœ‰çº¿ç¨‹æ¥å–æ˜¯æ”¾ä¸è¿›å»çš„ï¼ˆä¸€æ‰‹äº¤é’±ã€ä¸€æ‰‹äº¤è´§ï¼‰</li>
</ul>
<p><strong>è¯„ä»·</strong></p>
<ul>
<li>æ•´ä¸ªçº¿ç¨‹æ± è¡¨ç°ä¸ºçº¿ç¨‹æ•°ä¼šæ ¹æ®ä»»åŠ¡é‡ä¸æ–­å¢é•¿ï¼Œæ²¡æœ‰ä¸Šé™ï¼Œå½“ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œç©ºé—²1åˆ†é’Ÿåé‡Šæ”¾çº¿ç¨‹ã€‚</li>
<li>é€‚åˆä»»åŠ¡æ•°æ¯”è¾ƒå¯†é›†ï¼Œä½†æ¯ä¸ªä»»åŠ¡æ‰§è¡Œæ—¶é—´è¾ƒçŸ­çš„æƒ…å†µ</li>
</ul>
</blockquote>
<h3 id="å•çº¿ç¨‹çº¿ç¨‹æ± "><a href="#å•çº¿ç¨‹çº¿ç¨‹æ± " class="headerlink" title="å•çº¿ç¨‹çº¿ç¨‹æ± "></a><strong>å•çº¿ç¨‹çº¿ç¨‹æ± </strong></h3><blockquote>
<p>newSingleThreadExecutor<br>åˆ›å»ºæ–¹å¼ï¼šExecutors.newSingleThreadExecutor()</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public static ExecutorService newSingleThreadExecutor() &#123;</span><br><span class="line">    return new FinalizableDelegatedExecutorService</span><br><span class="line">        (new ThreadPoolExecutor(1, 1,</span><br><span class="line">                                0L, TimeUnit.MILLISECONDS,</span><br><span class="line">                                new LinkedBlockingQueue&lt;Runnable&gt;()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<blockquote>
<p><strong>ä½¿ç”¨åœºæ™¯</strong>ï¼š</p>
<ul>
<li>å¸Œæœ›å¤šä¸ªä»»åŠ¡æ’é˜Ÿæ‰§è¡Œã€‚çº¿ç¨‹æ•°å›ºå®šä¸º1ï¼Œä»»åŠ¡æ•°å¤šäº1 æ—¶ï¼Œä¼šæ”¾å…¥æ— ç•Œé˜Ÿåˆ—æ’é˜Ÿã€‚ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œè¿™å”¯ä¸€çš„çº¿ç¨‹ä¹Ÿä¸ä¼šè¢«é‡Šæ”¾ã€‚</li>
</ul>
<p><strong>åŒºåˆ«</strong>ï¼š</p>
<ul>
<li>è‡ªå·±åˆ›å»ºä¸€ä¸ªå•çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œä»»åŠ¡ï¼Œå¦‚æœä»»åŠ¡æ‰§è¡Œå¤±è´¥è€Œç»ˆæ­¢é‚£ä¹ˆæ²¡æœ‰ä»»ä½•è¡¥æ•‘æªæ–½ï¼Œè€Œçº¿ç¨‹æ± è¿˜ä¼šæ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œä¿è¯æ± çš„æ­£å¸¸å·¥ä½œ</li>
<li>Executors.newSingleThreadExecutorO çº¿ç¨‹ä¸ªæ•°å§‹ç»ˆä¸º1ï¼Œä¸èƒ½ä¿®æ”¹</li>
<li>FinalizableDelegatedExecutorService åº”ç”¨çš„æ˜¯è£…é¥°å™¨æ¨¡å¼ï¼Œåªå¯¹å¤–æš´éœ²äº† ExecutorService æ¥å£ï¼Œå› æ­¤ä¸èƒ½è°ƒç”¨ ThreadPoolExecutor ä¸­ç‰¹æœ‰çš„æ–¹æ³•</li>
<li>Executors.newFixedThreadPool(1) åˆå§‹æ—¶ä¸º1ï¼Œä»¥åè¿˜å¯ä»¥ä¿®æ”¹å¯¹å¤–æš´éœ²çš„æ˜¯ ThreadPoolExecutor å¯¹è±¡ï¼Œå¯ä»¥å¼ºè½¬åè°ƒç”¨ setCorePoolSize ç­‰æ–¹æ³•è¿›è¡Œä¿®æ”¹</li>
</ul>
</blockquote>
<h3 id="æäº¤ä»»åŠ¡"><a href="#æäº¤ä»»åŠ¡" class="headerlink" title="æäº¤ä»»åŠ¡"></a><strong>æäº¤ä»»åŠ¡</strong></h3><blockquote>
<p><strong>æ‰§è¡Œä»»åŠ¡</strong></p>
<ul>
<li>void execute (Runnable command)ï¼›</li>
</ul>
<p><strong>æäº¤taskä»»åŠ¡ï¼Œç”¨è¿”å›ä½ Future è·å¾—ä»»åŠ¡æ‰§è¡Œç»“æœ</strong></p>
<ul>
<li><T> Future T&gt; submit(Callable<T> task)ï¼›</li>
</ul>
<p><strong>æäº¤ tasks ä¸­æ‰€æœ‰ä»»åŠ¡</strong></p>
<ul>
<li><T> List&lt;Future<T>&gt; invokeA11(Collection&lt;? extends Callable<T>ã€‹ tasks) throws InterruptedException;</li>
</ul>
<p><strong>æäº¤ tasks ä¸­æ‰€æœ‰ä»»åŠ¡ï¼Œå¸¦è¶…æ—¶æ—¶é—´,æ—¶é—´å†…æ²¡æ‰§è¡Œå®Œï¼Œåç»­ä»»åŠ¡å›å–æ¶ˆæ‰</strong></p>
<ul>
<li><T> List&lt;Future<T>&gt; invokeAl1(Collection&lt;? extends Callable<T>ã€‹ tasks,long timeoutï¼Œ TimeUnit unit) throws InterruptedException;</li>
</ul>
<p><strong>æäº¤ tasks ä¸­æ‰€æœ‰ä»»åŠ¡ï¼Œå“ªä¸ªä»»åŠ¡å…ˆæˆåŠŸæ‰§è¡Œå®Œåï¼Œè¿”å›æ­¤ä»»åŠ¡æ‰§è¡Œç»“æœï¼Œå…¶å®ƒä»»åŠ¡å–æ¶ˆ</strong></p>
<ul>
<li><T> T invokeAny (Collection&lt;? extends Callable<T>ã€‰ tasks) throws InterruptedException, ExecutionException;</li>
</ul>
<p><strong>æäº¤ tasks ä¸­æ‰€æœ‰ä»»åŠ¡ï¼Œå“ªä¸ªä»»åŠ¡å…ˆæˆåŠŸæ‰§è¡Œå®Œåï¼Œè¿”å›æ­¤ä»»åŠ¡æ‰§è¡Œç»“æœï¼Œå…¶å®ƒä»»åŠ¡å–æ¶ˆï¼Œå¸¦è¶…æ—¶æ—¶é—´</strong><br><T> T invokeAny(Collection&lt;? extends Callable<T>ã€‰ tasks,1ong timeout, TimeUnit unit) throws InterruptedException, ExecutionException TimeoutException;</p>
</blockquote>
<h3 id="ç»“æŸä»»åŠ¡"><a href="#ç»“æŸä»»åŠ¡" class="headerlink" title="ç»“æŸä»»åŠ¡"></a><strong>ç»“æŸä»»åŠ¡</strong></h3><blockquote>
<p><strong>shutdown</strong></p>
<ul>
<li>çº¿ç¨‹æ± çŠ¶æ€å˜ä¸º SHUTDOWN</li>
<li>ä¸ä¼šæ¥æ”¶æ–°ä»»åŠ¡</li>
<li>ä½†å·²æäº¤ä»»åŠ¡ä¼šæ‰§è¡Œå®Œ</li>
<li>æ­¤æ–¹æ³•ä¸ä¼šé˜»å¡è°ƒç”¨çº¿ç¨‹çš„æ‰§è¡Œ</li>
</ul>
<p><strong>shutdownNow</strong></p>
<ul>
<li>çº¿ç¨‹æ± çŠ¶æ€å˜ä¸º STOP</li>
<li>ä¸ä¼šæ¥æ”¶æ–°ä»»åŠ¡</li>
<li>ä¼šå°†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡è¿”å›</li>
<li>å¹¶ç”¨ interrupt çš„æ–¹å¼ä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡</li>
<li>List&lt;Runnableã€‰ shutdownNow();</li>
</ul>
</blockquote>
<h3 id="å…¶å®ƒæ–¹æ³•"><a href="#å…¶å®ƒæ–¹æ³•" class="headerlink" title="å…¶å®ƒæ–¹æ³•"></a><strong>å…¶å®ƒæ–¹æ³•</strong></h3><blockquote>
<p>ä¸åœ¨ RUNNING çŠ¶æ€çš„çº¿ç¨‹æ± ï¼Œæ­¤æ–¹æ³•å°±è¿”å› true</p>
<ul>
<li>boolean isShutdown()ï¼›<br>çº¿ç¨‹æ± çŠ¶æ€æ˜¯å¦æ˜¯ TERMINATED</li>
<li>boolean isTerminated()ï¼›<br>è°ƒç”¨ shutdown åï¼Œç”±äºè°ƒç”¨çº¿ç¨‹å¹¶ä¸ä¼šç­‰å¾…æ‰€æœ‰ä»»åŠ¡è¿è¡Œç»“æŸï¼Œå› æ­¤å¦‚æœå®ƒæƒ³åœ¨çº¿ç¨‹æ±  TERMINATED ååšäº›äº‹æƒ…ï¼Œå¯ä»¥åˆ©ç”¨æ­¤æ–¹æ³•ç­‰å¾…</li>
<li>boolean awaitTermination(long timeout, TimeUnit unit)throws InterruptedExceptionï¼›</li>
</ul>
</blockquote>
<h2 id="å¼‚æ­¥æ¨¡å¼ä¹‹å·¥ä½œçº¿ç¨‹"><a href="#å¼‚æ­¥æ¨¡å¼ä¹‹å·¥ä½œçº¿ç¨‹" class="headerlink" title="å¼‚æ­¥æ¨¡å¼ä¹‹å·¥ä½œçº¿ç¨‹"></a><strong>å¼‚æ­¥æ¨¡å¼ä¹‹å·¥ä½œçº¿ç¨‹</strong></h2><blockquote>
<p><strong>å®šä¹‰</strong><br>è®©æœ‰é™çš„å·¥ä½œçº¿ç¨‹(Worker Thread) æ¥è½®æµå¼‚æ­¥å¤„ç†æ— é™å¤šçš„ä»»åŠ¡ã€‚ä¹Ÿå¯ä»¥å°†å…¶å½’ç±»ä¸ºåˆ†å·¥æ¨¡å¼ï¼Œå®ƒçš„å…¸å‹å®ç°å°±æ˜¯çº¿ç¨‹æ± ï¼Œä¹Ÿä½“ç°äº†ç»å…¸è®¾è®¡æ¨¡å¼ä¸­çš„äº«å…ƒæ¨¡å¼ã€‚<br>.<br>ä¾‹å¦‚ï¼Œæµ·åº•æçš„æœåŠ¡å‘˜ï¼ˆçº¿ç¨‹ï¼‰ï¼Œè½®æµå¤„ç†æ¯ä½å®¢äººçš„ç‚¹é¤ï¼ˆä»»åŠ¡ï¼‰ï¼Œå¦‚æœä¸ºæ¯ä½å®¢äººéƒ½é…ä¸€åä¸“é¢¨çš„æœåŠ¡å‘˜ï¼Œé‚£ä¹ˆæˆæœ¬å°±å¤ªé«˜äº†ï¼ˆå¯¹æ¯”å¦ä¸€ç§å¤šçº¿ç¨‹è®¾è®¡æ¨¡å¼ï¼šThread-Per-Message)<br>.<br>æ³¨æ„ï¼Œä¸åŒä»»åŠ¡ç±»å‹åº”è¯¥ä½¿ç”¨ä¸åŒçš„çº¿ç¨‹æ± ï¼Œè¿™æ ·èƒ½å¤Ÿé¿å…é¥¥é¥¿ï¼Œå¹¶èƒ½æå‡æ•ˆç‡<br>.<br>ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªé¤é¦†çš„å·¥äººæ—¢è¦æ‹›å‘¼å®¢äººï¼ˆä»»åŠ¡ç±»å‹Aï¼‰ï¼Œåˆè¦åˆ°åå¨åšèœï¼ˆä»»åŠ¡ç±»å‹Bï¼‰æ˜¾ç„¶æ•ˆç‡ä¸å’‹åœ°ï¼Œåˆ†æˆæœåŠ¡å‘˜ï¼ˆçº¿ç¨‹æ± Aï¼‰ä¸å¨å¸ˆï¼ˆçº¿ç¨‹æ± Bï¼‰æ›´ä¸ºåˆç†ï¼Œå½“ç„¶ä½ èƒ½æƒ³åˆ°æ›´ç»†è‡´çš„åˆ†å·¥</p>
</blockquote>
<h3 id="é¥¥é¥¿ç°è±¡-1"><a href="#é¥¥é¥¿ç°è±¡-1" class="headerlink" title="é¥¥é¥¿ç°è±¡"></a><strong>é¥¥é¥¿ç°è±¡</strong></h3><blockquote>
<p><strong>å›ºå®šå¤§å°çº¿ç¨‹æ± ï¼ˆåŒ…å«å•çº¿ç¨‹ï¼‰ä¼šæœ‰é¥¥é¥¿ç°è±¡</strong><br>ä¸¤ä¸ªå·¥äººæ˜¯åŒä¸€ä¸ªçº¿ç¨‹æ± ä¸­çš„ä¸¤ä¸ªçº¿ç¨‹<br>ä»–ä»¬è¦åšçš„äº‹æƒ…æ˜¯ï¼šä¸ºå®¢äººç‚¹é¤å’Œåˆ°åå¨åšèœï¼Œè¿™æ˜¯ä¸¤ä¸ªé˜¶æ®µçš„å·¥ä½œ</p>
<ul>
<li>å®¢äººç‚¹é¤ï¼šå¿…é¡»å…ˆç‚¹å®Œé¤ï¼Œç­‰èœåšå¥½ï¼Œä¸Šèœï¼Œåœ¨æ­¤æœŸé—´å¤„ç†ç‚¹é¤çš„å·¥äººå¿…é¡»ç­‰å¾…</li>
<li>åå¨åšèœï¼šæ²¡å•¥è¯´çš„ï¼Œåšå°±æ˜¯äº†<br>æ¯”å¦‚å·¥äººA å¤„ç†äº†ç‚¹é¤ä»»åŠ¡ï¼Œæ¥ä¸‹æ¥å®ƒè¦ç­‰ç€ å·¥äººBæŠŠèœåšå¥½ï¼Œç„¶åä¸Šèœï¼Œä»–ä¿©ä¹Ÿé…åˆçš„èœœå¥½<br>ä½†ç°åœ¨åŒæ—¶æ¥äº†ä¸¤ä¸ªå®¢äººï¼Œè¿™ä¸ªæ—¶å€™å·¥äººA å’Œå·¥äººBéƒ½å»å¤„ç†ç‚¹é¤äº†ï¼Œè¿™æ—¶æ²¡äººåšé¥­äº†ï¼Œæ­»é”</li>
</ul>
<p><strong>ç°è±¡äº§ç”Ÿ</strong><br>ä¸æŠ±é”™<br>ä¸æ˜¯æ­»é”ï¼Œåªæ˜¯ç¼ºå°‘çº¿ç¨‹å¤„ç†<br><strong>è§£å†³</strong><br>æ¯ä¸ªå•ç‹¬çš„ä»»åŠ¡å•ç‹¬ä¸€ä¸ªçº¿ç¨‹æ± </p>
</blockquote>
<h3 id="ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± "><a href="#ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± " class="headerlink" title="ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± "></a><strong>ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± </strong></h3><blockquote>
<p>åœ¨ã€ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± ã€åŠŸèƒ½åŠ å…¥ä¹‹å‰ï¼Œå¯ä»¥ä½¿ç”¨ java.util.Timer æ¥å®ç°å®šæ—¶åŠŸèƒ½<br>Timer çš„ä¼˜ç‚¹åœ¨äºç®€å•æ˜“ç”¨ï¼Œä½†ç”±äºæ‰€æœ‰ä»»åŠ¡éƒ½æ˜¯ç”±åŒä¸€ä¸ªçº¿ç¨‹æ¥è°ƒåº¦<br>å› æ­¤æ‰€æœ‰ä»»åŠ¡éƒ½æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼ŒåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªä»»åŠ¡åœ¨æ‰§è¡Œï¼Œå‰ä¸€ä¸ªä»»åŠ¡çš„å»¶è¿Ÿæˆ–å¼‚å¸¸éƒ½å°†ä¼šå½±å“åˆ°ä¹‹åçš„ä»»åŠ¡ã€‚<br><strong>æ€»ç»“</strong><br>å•ä»»åŠ¡å¯ä»¥ä½¿ç”¨Timerï¼Œå¤šä»»åŠ¡ä½¿ç”¨ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± </p>
</blockquote>
<blockquote>
<p>æ„é€ æ–¹æ³•</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ScheduledThreadPoolExecutor</span><span class="params">(<span class="type">int</span> corePoolSize)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(corePoolSize, Integer.MAX_VALUE, <span class="number">0</span>, NANOSECONDS,</span><br><span class="line">          <span class="keyword">new</span> <span class="title class_">DelayedWorkQueue</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>åˆ›å»ºä¸ä½¿ç”¨</strong></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ScheduledExecutorService pool  = Executors.newScheduledThreadPool(1);</span><br><span class="line">pool.schedule(()-&gt;&#123;</span><br><span class="line">    int i = 1/0;</span><br><span class="line">&#125;,1, TimeUnit.SECONDS);</span><br><span class="line">pool.schedule(()-&gt;&#123;</span><br><span class="line">    System.out.println(12321);</span><br><span class="line">&#125;,1, TimeUnit.SECONDS);</span><br><span class="line">pool.shutdown();</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ä¼˜ç‚¹ï¼šå„ä¸ªä»»åŠ¡ä¸å—å½±å“</p>
</blockquote>
<p><strong>å®šæ—¶æ‰§è¡Œç›¸åŒä»»åŠ¡</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pool.scheduleAtFixedRate(()-&gt;&#123;</span><br><span class="line">    System.out.println(&quot;running&quot;);</span><br><span class="line">&#125;,1,1,TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">pool.scheduleWithFixedDelay(()-&gt;&#123;</span><br><span class="line">    System.out.println(&quot;running&quot;);</span><br><span class="line">&#125;,1,1,TimeUnit.SECONDS);;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>scheduleAtFixedRate</strong></p>
<ul>
<li>ä»»åŠ¡ç»“æŸå†æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ï¼Œå¦‚æœä¸€ä¸ªå‘¨æœŸæ²¡æœ‰æ‰§è¡Œå®Œï¼Œç»§ç»­ç­‰ï¼Œç­‰å®Œä¸‹ä¸€ä¸ªä»»åŠ¡ç«‹é©¬æ‰§è¡Œ</li>
</ul>
<p><strong>scheduleWithFixedDelay</strong></p>
<ul>
<li>å¦‚æœä¸€ä¸ªå‘¨æœŸæ²¡æœ‰æ‰§è¡Œå®Œï¼Œç»§ç»­ç­‰ï¼Œç­‰å®Œå†ç­‰å›ºå®šé—´éš”æ—¶é—´å†æ‰§è¡Œ</li>
</ul>
<p><strong>å¦‚ä½•å¤„ç†çº¿ç¨‹æ± ä¸­ä»»åŠ¡å¼‚å¸¸</strong><br>çº¿ç¨‹æ± ä¸­ä»»åŠ¡å‡ºç°å¼‚å¸¸ï¼Œä¸ä¼šæ‰“å°ä¿¡æ¯å’Œå½±å“å…¶ä»–çº¿ç¨‹ï¼Œé™¤äº†Timerï¼Œä½†timerä¸ä¼šæ‰“å°ä¿¡æ¯<br>å¯ä»¥åœ¨ä»»åŠ¡ä»£ç ä¸­trycatchï¼Œè®°å½•æ—¥å¿—<br>futrueå¯¹è±¡çš„getæ–¹æ³•å‡ºç°å¼‚å¸¸è¿”å›å¼‚å¸¸ä¿¡æ¯ï¼Œè¿™ç‚¹åšçš„å¾ˆå¥½</p>
</blockquote>
<h2 id="Fork-Join"><a href="#Fork-Join" class="headerlink" title="Fork/Join"></a><strong>Fork/Join</strong></h2><h3 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a><strong>æ¦‚å¿µ</strong></h3><blockquote>
<p>Fork/Join æ˜¯ JDK 1.7 åŠ å…¥çš„æ–°çš„çº¿ç¨‹æ± å®ç°ï¼Œå®ƒä½“ç°çš„æ˜¯ä¸€ç§åˆ†æ²»æ€æƒ³ï¼Œé€‚ç”¨äºèƒ½å¤Ÿè¿›è¡Œä»»åŠ¡æ‹†åˆ†çš„ cpué›†å‹è¿ç®—<br>æ‰€è°“çš„ä»»åŠ¡æ‹†åˆ†ï¼Œæ˜¯å°†ä¸€ä¸ªå¤§ä»»åŠ¡æ‹†åˆ†ä¸ºç®—æ³•ä¸Šç›¸åŒçš„å°ä»»åŠ¡ï¼Œç›´è‡³ä¸èƒ½æ‹†åˆ†å¯ä»¥ç›´æ¥æ±‚è§£ã€‚è·Ÿé€’å½’ç›¸å…³çš„<br>ä¸€äº›è®¡ç®—ï¼Œå¦‚å½’å¹¶æ’åºã€æ–æ³¢é‚£å¥‘æ•°åˆ—ã€éƒ½å¯ä»¥ç”¨åˆ†æ²»æ€æƒ³è¿›è¡Œæ±‚è§£<br>Fork/Join åœ¨åˆ†æ²»çš„åŸºç¡€ä¸ŠåŠ å…¥äº†å¤šçº¿ç¨‹ï¼Œå¯ä»¥æŠŠæ¯ä¸ªä»»åŠ¡çš„åˆ†è§£å’Œåˆå¹¶äº¤ç»™ä¸åŒçš„çº¿ç¨‹æ¥å®Œæˆï¼Œè¿›ä¸€æ­¥æå‡äº†è¿ç®—æ•ˆç‡<br>Fork/Join é»˜è®¤ä¼šåˆ›å»ºä¸ cpu æ ¸å¿ƒæ•°å¤§å°ç›¸åŒçš„çº¿ç¨‹æ± </p>
</blockquote>
<h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a><strong>ä½¿ç”¨</strong></h3><blockquote>
<p>æäº¤ç»™ Fork/Join çº¿ç¨‹æ± çš„ä»»åŠ¡éœ€è¦ç»§æ‰¿ RecursiveTaskï¼ˆæœ‰è¿”å›å€¼ï¼‰æˆ– RecursiveAction ï¼ˆæ²¡æœ‰è¿”å›å€¼ï¼‰ï¼Œä¾‹å¦‚ä¸‹é¢å®šä¹‰äº†ä¸€ä¸ªå¯¹1~n ä¹‹é—´çš„æ•´æ•°æ±‚å’Œçš„ä»»åŠ¡</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public class day07 &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        ForkJoinPool pool = new ForkJoinPool(4);</span><br><span class="line">        System.out.println(pool.invoke(new MyTask(5)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class MyTask extends RecursiveTask&lt;Integer&gt; &#123;</span><br><span class="line">    private int n;</span><br><span class="line"></span><br><span class="line">    public MyTask(int n) &#123;</span><br><span class="line">        this.n = n;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected Integer compute() &#123;</span><br><span class="line">        if (n == 1) &#123;</span><br><span class="line">            return 1;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            MyTask t1 = new MyTask(n-1);</span><br><span class="line">            //forkå°†è¯¥ä»»åŠ¡äº¤ç»™çº¿ç¨‹æ± å…¶ä»–çº¿ç¨‹æ‰§è¡Œ</span><br><span class="line">            t1.fork();</span><br><span class="line">            //joinè·å–ç»“æœ</span><br><span class="line">            return n+t1.join();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æ‹†åˆ†ä¼˜åŒ–</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">public class day07 &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        ForkJoinPool pool = new ForkJoinPool(4);</span><br><span class="line">        System.out.println(pool.invoke(new MyTask(0,5)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class MyTask extends RecursiveTask&lt;Integer&gt; &#123;</span><br><span class="line">    private int begin;</span><br><span class="line">    private int end;</span><br><span class="line"></span><br><span class="line">    public MyTask(int begin, int end) &#123;</span><br><span class="line">        this.begin = begin;</span><br><span class="line">        this.end = end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected Integer compute() &#123;</span><br><span class="line">        if (begin == end) &#123;</span><br><span class="line">            return begin;</span><br><span class="line">        &#125;</span><br><span class="line">        if (begin - end == 1) &#123;</span><br><span class="line">            return begin + end;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        int mid = (begin + end) / 2;</span><br><span class="line">        MyTask t1 = new MyTask(begin, mid);</span><br><span class="line">        MyTask t2 = new MyTask(mid + 1, end);</span><br><span class="line">        t1.fork();</span><br><span class="line">        t2.fork();</span><br><span class="line">        //è·å–å„å­ä»»åŠ¡ç»“æœ</span><br><span class="line">        return t1.join() + t2.join();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="J-U-C"><a href="#J-U-C" class="headerlink" title="J.U.C"></a><strong>J.U.C</strong></h1><h2 id="çº¿ç¨‹å®‰å…¨é›†åˆç±»æ¦‚è¿°"><a href="#çº¿ç¨‹å®‰å…¨é›†åˆç±»æ¦‚è¿°" class="headerlink" title="çº¿ç¨‹å®‰å…¨é›†åˆç±»æ¦‚è¿°"></a><strong>çº¿ç¨‹å®‰å…¨é›†åˆç±»æ¦‚è¿°</strong></h2><img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-23_16.09.29.png" width="100%" loading="lazy">

<h3 id="é—ç•™çš„çº¿ç¨‹å®‰å…¨é›†"><a href="#é—ç•™çš„çº¿ç¨‹å®‰å…¨é›†" class="headerlink" title="é—ç•™çš„çº¿ç¨‹å®‰å…¨é›†"></a><strong>é—ç•™çš„çº¿ç¨‹å®‰å…¨é›†</strong></h3><blockquote>
<p>é—ç•™çš„çº¿ç¨‹å®‰å…¨é›†åˆå¦‚ Hashtable, Vector<br>ä»–ä»¬éƒ½æ˜¯synchronizedä¿®é¥°æ–¹æ³•çš„ï¼Œä¸æ¨èä½¿ç”¨</p>
</blockquote>
<h3 id="ä½¿ç”¨Collectionsè£…é¥°çš„çº¿ç¨‹å®‰å…¨é›†åˆ"><a href="#ä½¿ç”¨Collectionsè£…é¥°çš„çº¿ç¨‹å®‰å…¨é›†åˆ" class="headerlink" title="ä½¿ç”¨Collectionsè£…é¥°çš„çº¿ç¨‹å®‰å…¨é›†åˆ"></a><strong>ä½¿ç”¨Collectionsè£…é¥°çš„çº¿ç¨‹å®‰å…¨é›†åˆ</strong></h3><blockquote>
<p>ä»–ä»¬éƒ½æ˜¯åˆ©ç”¨è£…é¥°å™¨æ¨¡å¼åŒ…è£…é›†åˆï¼Œåœ¨æ–¹æ³•ä¸Šæ·»åŠ synchronized<br>ä½¿ç”¨ Collections è£…é¥°çš„çº¿ç¨‹å®‰å…¨é›†åˆï¼Œå¦‚ï¼š</p>
<ul>
<li>Collections . TynchronizedCollection</li>
<li>Collections.synchronizedList</li>
<li>Collections. synchronizedMap</li>
<li>Collections.synchronizedSet</li>
<li>Collections.synchronizedNavigableMap</li>
<li>Collections. synchronizedNavigableSet</li>
<li>Collections.synchronizedSortedMap</li>
<li>Collections.synchronizedSortedSet</li>
</ul>
</blockquote>
<h3 id="java-util-concurrent"><a href="#java-util-concurrent" class="headerlink" title="java.util.concurrent.*"></a><strong>java.util.concurrent.</strong>*</h3><blockquote>
<p><em><em>é‡ç‚¹ä»‹ç»java.util.concurrent.</em> ä¸‹çš„çº¿ç¨‹å®‰å…¨é›†åˆç±»ï¼Œå¯ä»¥å‘ç°å®ƒä»¬æœ‰è§„å¾‹ï¼Œé‡Œé¢åŒ…å«ä¸‰ç±»å…³é”®è¯ï¼šBlocking. CopyOn Writeã€ Concurrent</em>*<br>Blocking å¤§éƒ¨åˆ†å®ç°åŸºäºé”ï¼Œå¹¶æä¾›ç”¨æ¥é˜»å¡çš„æ–¹æ³•<br>CopyOnWrite ä¹‹ç±»å®¹å™¨ä¿®æ”¹å¼€é”€ç›¸å¯¹è¾ƒé‡<br>Concurrent ç±»å‹çš„å®¹å™¨</p>
<ul>
<li>å†…éƒ¨å¾ˆå¤šæ“ä½œä½¿ç”¨ cas ä¼˜åŒ–ï¼Œä¸€èˆ¬å¯ä»¥æä¾›è¾ƒé«˜ååé‡</li>
<li>å¼±ä¸€è‡´æ€§<pre><code>éå†æ—¶å¼±ä¸€è‡´æ€§ï¼Œä¾‹å¦‚ï¼Œå½“åˆ©ç”¨è¿­ä»£å™¨éå†æ—¶ï¼Œå¦‚æœå®¹å™¨å‘ç”Ÿä¿®æ”¹ï¼Œè¿­ä»£å™¨ä»ç„¶å¯ä»¥ç»§ç»­è¿›è¡Œéå†ï¼Œè¿™æ—¶å†…å®¹æ˜¯æ—§çš„
æ±‚å¤§å°å¼±ä¸€è‡´æ€§ï¼Œsize æ“ä½œæœªå¿…æ˜¯100% å‡†ç¡®
è¯»å–å¼±ä¸€è‡´æ€§
</code></pre>
éå†æ—¶å¦‚æœå‘ç”Ÿäº†ä¿®æ”¹ï¼Œå¯¹äºéå®‰å…¨å®¹å™¨æ¥è®²ï¼Œä½¿ç”¨ fail-fast æœºåˆ¶ä¹Ÿå°±æ˜¯è®©éå†ç«‹åˆ»å¤±è´¥ï¼ŒæŠ›å‡ºConcurrentModificationExceptionï¼Œä¸å†ç»§ç»­éå†<br>è€Œçº¿ç¨‹å®‰å…¨çš„åˆ™å¼±ä¸€è‡´æ€§ï¼Œfail-safe</li>
</ul>
</blockquote>
<h2 id="AQS"><a href="#AQS" class="headerlink" title="AQS"></a><strong>AQS</strong></h2><blockquote>
<p>å…¨ç§°æ˜¯ AbstractQueuedSynchronizerï¼Œæ˜¯é˜»å¡å¼é”å’Œç›¸å…³çš„åŒæ­¥å™¨å·¥å…·çš„æ¡†æ¶<br><strong>ç‰¹ç‚¹</strong><br>ç”¨ state å±æ€§æ¥è¡¨ç¤ºèµ„æºçš„çŠ¶æ€ï¼ˆåˆ†ç‹¬å æ¨¡å¼å’Œå…±äº«æ¨¡å¼ï¼‰ï¼Œå­ç±»éœ€è¦å®šä¹‰å¦‚ä½•ç»´æŠ¤è¿™ä¸ªçŠ¶æ€ï¼Œæ§åˆ¶å¦‚ä½•<br>è·å–é”å’Œé‡Šæ”¾é”</p>
<ul>
<li>getState - è·å– state çŠ¶æ€</li>
<li>setState - è®¾ç½® state çŠ¶æ€</li>
<li>compareAndSetState -cas æœºåˆ¶è®¾ç½® state çŠ¶æ€</li>
<li>ç‹¬å æ¨¡å¼æ˜¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿè®¿é—®èµ„æºï¼Œè€Œå…±äº«æ¨¡å¼å¯ä»¥å…è®¸å¤šä¸ªçº¿ç¨‹è®¿é—®èµ„æº<br>æä¾›äº†åŸºäº FIFO çš„ç­‰å¾…é˜Ÿåˆ—ï¼Œç±»ä¼¼äº Monitor çš„ EntryList<br>æ¡ä»¶å˜é‡æ¥å®ç°ç­‰å¾…ã€å”¤é†’æœºåˆ¶ï¼Œæ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡ï¼Œç±»ä¼¼äº Monitor çš„ WaitSet</li>
</ul>
</blockquote>
<p><strong>API</strong></p>
<blockquote>
<p>å­ç±»ä¸»è¦å®ç°è¿™æ ·ä¸€äº›æ–¹æ³•ï¼ˆé»˜è®¤æŠ›å‡º UnsupportedOperationException)</p>
<ul>
<li>tryAcquire</li>
<li>tryRelease</li>
<li>tryAcquire Shared</li>
<li>tryReleaseShared</li>
<li>isHeldExclusively</li>
</ul>
</blockquote>
<p><strong>tryAcquire</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//å¦‚æœè·å–é”å¤±è´¥</span><br><span class="line">if (!tryAcquire(arg))&#123;</span><br><span class="line">    //å…¥é˜Ÿï¼Œå¯ä»¥é€‰æ‹©é˜»å¡å½“å‰çº¿ç¨‹ ä½¿ç”¨parkå’Œunparkæ¥é˜»å¡</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>tryRelease</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//å¦‚æœé‡Šæ”¾é”æˆåŠŸ</span><br><span class="line">if(tryRelease(arg))&#123;</span><br><span class="line">    //è®©é˜»å¡çº¿ç¨‹æ¢å¤è¿è¡Œ</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>AQSè‡ªå®šä¹‰é”å®ç°</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">//è‡ªå®šä¹‰é”ï¼Œä¸å¯é‡å…¥</span><br><span class="line">class MyLock implements Lock &#123;</span><br><span class="line">    private MyAqs myAqs = new MyAqs();</span><br><span class="line"></span><br><span class="line">    //ç‹¬å é” åŒæ­¥å™¨ç±»</span><br><span class="line">    class MyAqs extends AbstractQueuedSynchronizer &#123;</span><br><span class="line">        @Override//å°è¯•è·å–é”</span><br><span class="line">        protected boolean tryAcquire(int arg) &#123;</span><br><span class="line">            if (compareAndSetState(0, 1)) &#123;</span><br><span class="line">                //åŠ é”ï¼Œè®¾ç½®çŠ¶æ€ä¸º1ï¼Œå¹¶ä¸”è®¾ç½®å½“å‰ownä¸ºå½“å‰çº¿ç¨‹</span><br><span class="line">                setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override//å°è¯•é‡Šæ”¾é”</span><br><span class="line">        protected boolean tryRelease(int arg) &#123;</span><br><span class="line">            //ä¸ºä»€ä¹ˆä¸ç”¨CASï¼Ÿ</span><br><span class="line">            //å› ä¸ºé‡Šæ”¾é”ï¼Œé‚£è‚¯å®šæ˜¯æ‹¿åˆ°äº†é”ï¼Œä¸ä¼šæœ‰äººæŠ¢</span><br><span class="line">            //ä¸ºä»€ä¹ˆsetStateåœ¨åé¢?</span><br><span class="line">            //å› ä¸ºstateæ˜¯voliteä¿®é¥°çš„ï¼Œä¿®æ”¹ååé¢åŠ å†™å±éšœï¼Œä¼šåŒæ­¥åˆ°ä¸»å­˜</span><br><span class="line">            setExclusiveOwnerThread(null);</span><br><span class="line">            setState(0);</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override//æ˜¯å¦æŒæœ‰ç‹¬å é”</span><br><span class="line">        protected boolean isHeldExclusively() &#123;</span><br><span class="line">            return getState() == 1;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        //ConditionObjectæ˜¯AQSçš„å†…éƒ¨ç±»ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨</span><br><span class="line">        public Condition newCondition() &#123;</span><br><span class="line">            return new ConditionObject();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override//åŠ é”ï¼Œä¸å¯é‡å…¥ï¼Œå¤±è´¥æ”¾åˆ°é˜Ÿåˆ—ä¸­ç­‰å¾…</span><br><span class="line">    public void lock() &#123;</span><br><span class="line">        //ä¸ºä»€ä¹ˆç”¨acquireï¼Ÿä¸ç›´æ¥ç”¨trylock</span><br><span class="line">        //å› ä¸ºacquireè¿˜èƒ½è®©å¤±è´¥æ—¶è¿›å…¥é˜»å¡é˜Ÿåˆ—</span><br><span class="line">        myAqs.acquire(1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override//åŠ é”ï¼Œå¯æ‰“æ–­</span><br><span class="line">    public void lockInterruptibly() throws InterruptedException &#123;</span><br><span class="line">        myAqs.acquireInterruptibly(1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override//å°è¯•åŠ é”ï¼Œå¤±è´¥ç›´æ¥false</span><br><span class="line">    public boolean tryLock() &#123;</span><br><span class="line">        return myAqs.tryAcquire(1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override//å°è¯•åŠ é”ï¼Œå¸¦è¶…æ—¶æ—¶é—´</span><br><span class="line">    public boolean tryLock(long time, TimeUnit unit) throws InterruptedException &#123;</span><br><span class="line">        return myAqs.tryAcquireNanos(1,unit.toNanos(time));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override//é‡Šæ”¾é”</span><br><span class="line">    public void unlock() &#123;</span><br><span class="line">        //åŒæ—¶è¿˜ä¼šå”¤é†’é˜»å¡é˜Ÿåˆ—</span><br><span class="line">        myAqs.release(0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override//åˆ›å»ºæ¡ä»¶å˜é‡</span><br><span class="line">    public Condition newCondition() &#123;</span><br><span class="line">        return myAqs.newCondition();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ReentrantLock-1"><a href="#ReentrantLock-1" class="headerlink" title="ReentrantLock"></a>ReentrantLock</h2><img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-19_09.29.04.png" width="50%" loading="lazy">

<p><strong>æ„é€ å™¨</strong></p>
<blockquote>
<p>é»˜è®¤æ˜¯éå…¬å¹³é”ï¼ŒNonfairSyncç»§æ‰¿è‡ªAQS</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public ReentrantLock() &#123;</span><br><span class="line">    sync = new NonfairSync();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="é”é‡å…¥åŸç†"><a href="#é”é‡å…¥åŸç†" class="headerlink" title="é”é‡å…¥åŸç†"></a><strong>é”é‡å…¥åŸç†</strong></h3><blockquote>
<p>åŠ é”æ—¶ï¼Œå¦‚æœownæ˜¯è‡ªå·±ï¼Œstate++<br>è§£é”æ—¶ï¼Œstateâ€“ï¼Œstateå‡åˆ°0æ‰æˆåŠŸé‡Šæ”¾</p>
</blockquote>
<h3 id="å¯æ‰“æ–­åŸç†"><a href="#å¯æ‰“æ–­åŸç†" class="headerlink" title="å¯æ‰“æ–­åŸç†"></a><strong>å¯æ‰“æ–­åŸç†</strong></h3><blockquote>
<p>é»˜è®¤æ˜¯ä¸å¯æ‰“æ–­çš„<br>åœ¨ä¸å¯æ‰“æ–­æ¨¡å¼ä¸‹ï¼Œå³ä½¿å®ƒè¢«æ‰“æ–­ï¼Œä»ä¼šé©»ç•™åœ¨ AQSé˜Ÿåˆ—ä¸­ï¼Œç­‰è·å¾—é”åæ–¹èƒ½ç»§ç»­è¿è¡Œï¼ˆæ˜¯ç»§ç»­è¿è¡Œï¼åªæ˜¯æ‰“æ–­æ ‡è®°è¢«è®¾ç½®ä¸º true)<br>åœ¨å¯æ‰“æ–­æ¨¡å¼ä¸‹ï¼Œæ‰“æ–­äº†å°±æŠ›å‡ºå¼‚å¸¸ï¼Œæ¥ç»“æŸforå¾ªç¯ï¼Œæ‰€ä»¥æ˜¯å¯æ‰“æ–­çš„</p>
</blockquote>
<h3 id="å…¬å¹³é”åŸç†"><a href="#å…¬å¹³é”åŸç†" class="headerlink" title="å…¬å¹³é”åŸç†"></a><strong>å…¬å¹³é”åŸç†</strong></h3><blockquote>
<p>é»˜è®¤éå…¬å¹³é”<br>åŒºåˆ«åœ¨äºä¼šä¸ä¼šæ£€æŸ¥AQSç­‰å¾…é˜Ÿåˆ—<br>éå…¬å¹³é”ä¸ä¼šï¼Œè°ç”³è¯·å°±ç»™è°<br>å…¬å¹³é”è¿˜è¦AQSç­‰å¾…é˜Ÿåˆ—ä¸­æŸ¥çœ‹ä¸€ç•ªï¼Œç¡®ä¿ç¬¬äºŒä¸ªæ˜¯è‡ªå·±ï¼Œä¸ç„¶ç»™å…¶ä»–äºº</p>
</blockquote>
<h3 id="æ¡ä»¶å˜é‡åŸç†"><a href="#æ¡ä»¶å˜é‡åŸç†" class="headerlink" title="æ¡ä»¶å˜é‡åŸç†"></a><strong>æ¡ä»¶å˜é‡åŸç†</strong></h3><blockquote>
<p><strong>await</strong></p>
<ul>
<li>è°ƒç”¨awaitæ—¶çº¿ç¨‹ä»ownè½¬åˆ°äº†ConditionObject</li>
<li>ä¹‹åå†è°ƒç”¨parkæ¥ç­‰å¾…</li>
</ul>
<p><strong>signal</strong></p>
<ul>
<li>å°†ConditionObjectä¸­çš„ç­‰å¾…çº¿ç¨‹åŠ å…¥AQSç­‰å¾…é˜Ÿåˆ—ä¸­</li>
</ul>
</blockquote>
<h2 id="è¯»å†™é”"><a href="#è¯»å†™é”" class="headerlink" title="è¯»å†™é”"></a><strong>è¯»å†™é”</strong></h2><blockquote>
<p>å½“è¯»æ“ä½œè¿œè¿œé«˜äºå†™æ“ä½œæ—¶ï¼Œè¿™æ—¶å€™ä½¿ç”¨ è¯»å†™é”è®© è¯»-è¯» å¯ä»¥å¹¶å‘ï¼Œæé«˜æ€§èƒ½ã€‚<br>ç±»ä¼¼äºæ•°æ®åº“ä¸­çš„ select â€¦ from â€¦ lock in share mode<br>æä¾›ä¸€ä¸ª æ•°æ®å®¹å™¨ç±» å†…éƒ¨åˆ†åˆ«ä½¿ç”¨è¯»é”ä¿æŠ¤æ•°æ®çš„ read() æ–¹æ³•ï¼Œå†™é”ä¿æŠ¤æ•°æ®çš„ write(ï¼‰æ–¹æ³•</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">/**åˆ›å»ºè¯»å†™é”**/</span><br><span class="line">private static ReentrantReadWriteLock lock = new ReentrantReadWriteLock();</span><br><span class="line">/**åˆ›å»ºå†™é”**/</span><br><span class="line">private static ReentrantReadWriteLock.WriteLock writeLock = lock.writeLock();</span><br><span class="line">/**åˆ›å»ºè¯»é”**/</span><br><span class="line">private static ReentrantReadWriteLock.ReadLock readLock = lock.readLock();</span><br><span class="line"></span><br><span class="line">public static void write() &#123;</span><br><span class="line">    writeLock.lock();</span><br><span class="line">    try &#123;</span><br><span class="line">        System.out.println(&quot;å†™&quot;);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        writeLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public static void Read() &#123;</span><br><span class="line">    readLock.lock();</span><br><span class="line">    try &#123;</span><br><span class="line">        System.out.println(&quot;è¯»&quot;);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        readLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a><strong>æ³¨æ„äº‹é¡¹</strong></h3><blockquote>
<p><strong>è¯»é”</strong>ä¸æ”¯æŒæ¡ä»¶å˜é‡,å†™é”å¯ä»¥<br>é‡å…¥æ—¶å‡çº§ä¸æ”¯æŒï¼šå³æŒæœ‰è¯»é”çš„æƒ…å†µä¸‹å»è·å–å†™é”ï¼Œä¼šå¯¼è‡´è·å–å†™é”æ°¸ä¹…ç­‰å¾…<br>é‡å…¥æ—¶é™çº§æ”¯æŒï¼šå³æŒæœ‰å†™é”çš„æƒ…å†µä¸‹å»è·å–è¯»é”<br>é¥¥é¥¿ç°è±¡ï¼šwaitsetä¸­è¯»é”åœ¨å†™é”åé¢ï¼Œä½¿å¾—å†™é”ä¸€ç›´å¾—ä¸åˆ°ï¼Œä½¿ç”¨å…¬å¹³é”</p>
</blockquote>
<h3 id="è¯»å†™é”åŸç†"><a href="#è¯»å†™é”åŸç†" class="headerlink" title="è¯»å†™é”åŸç†"></a><strong>è¯»å†™é”åŸç†</strong></h3><p>è¯»å†™é”ç”¨çš„æ˜¯åŒä¸€ä¸ª Syen åŒæ­¥å™¨ï¼Œå› æ­¤ç­‰å¾…é˜Ÿåˆ—ã€state ç­‰ä¹Ÿæ˜¯åŒä¸€ä¸ª<br>æµç¨‹ä¸ ReentrantLock åŠ é”ç›¸æ¯”æ²¡æœ‰ç‰¹æ®Šä¹‹å¤„ï¼Œä¸åŒæ˜¯å†™é”çŠ¶æ€å äº†state çš„ä½16 ä½ï¼Œè€Œè¯»é”ä½¿ç”¨çš„æ˜¯ state çš„é«˜16ä½<br>è€Œwaitsetä¸­ç»“ç‚¹å†™é”æ·»åŠ çš„æ˜¯ç‹¬å çŠ¶æ€ç»“ç‚¹ï¼Œè¯»é”æ˜¯å…±äº«çŠ¶æ€ç»“ç‚¹</p>
<h2 id="stampedlock"><a href="#stampedlock" class="headerlink" title="stampedlock"></a><strong>stampedlock</strong></h2><p>è¯¥ç±»è‡ª JDKï¼„ åŠ å…¥ï¼Œæ˜¯ä¸ºäº†è¿›ä¸€æ­¥ä¼˜åŒ–è¯»æ€§èƒ½ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯åœ¨ä½¿ç”¨è¯»é”ã€å†™é”æ—¶éƒ½å¿…é¡»é…åˆã€æˆ³ã€‘ä½¿ç”¨</p>
<p><strong>åŠ è§£è¯»é”</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">long stamp = lock.readLock();</span><br><span class="line">lock.unlockRead(stamp);</span><br></pre></td></tr></table></figure>

<p><strong>åŠ è§£å†™é”</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">long stamp = lock.writeLock();</span><br><span class="line">lock.writeLock(stamp);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ä¹è§‚è¯»ï¼ŒStampedL.ock æ”¯æŒ tryoptimisticRead() æ–¹æ³•ï¼ˆä¹è§‚è¯»ï¼‰ï¼Œè¯»å–å®Œæ¯•åéœ€è¦åšä¸€æ¬¡ æˆ³æ ¡éªŒ å¦‚æœæ ¡éªŒé€šè¿‡ï¼Œè¡¨ç¤ºè¿™æœŸé—´ç¡®å®æ²¡æœ‰å†™æ“ä½œï¼Œæ•°æ®å¯ä»¥å®‰å…¨ä½¿ç”¨ï¼Œå¦‚æœæ ¡éªŒæ²¡é€šè¿‡ï¼Œéœ€è¦é‡æ–°è·å–è¯»é”ï¼Œä¿è¯æ•°æ®å®‰å…¨ã€‚</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">long stamp = lock.tryOptimisticRead();</span><br><span class="line">//éªŒæˆ³</span><br><span class="line">if (!lock.validate(stamp)) &#123;</span><br><span class="line">    //é”å‡çº§</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ³¨æ„<br>StampedLock ä¸æ”¯æŒæ¡ä»¶å˜é‡<br>StampedLock ä¸æ”¯æŒå¯é‡å…¥</p>
</blockquote>
<h2 id="Semaphore"><a href="#Semaphore" class="headerlink" title="Semaphore"></a><strong>Semaphore</strong></h2><blockquote>
<p>ä¿¡å·é‡,ç”¨æ¥é™åˆ¶èƒ½åŒæ—¶è®¿é—®å…±äº«èµ„æºçš„çº¿ç¨‹ä¸Šé™ã€‚</p>
</blockquote>
<h3 id="Semaphore-åº”ç”¨"><a href="#Semaphore-åº”ç”¨" class="headerlink" title="Semaphore åº”ç”¨"></a><strong>Semaphore åº”ç”¨</strong></h3><blockquote>
<ul>
<li>ä½¿ç”¨ Semaphore é™æµï¼Œåœ¨è®¿é—®é«˜å³°æœŸæ—¶ï¼Œè®©è¯·æ±‚çº¿ç¨‹é˜»å¡ï¼Œé«˜å³°æœŸè¿‡å»å†é‡Šæ”¾è®¸å¯ï¼Œå½“ç„¶å®ƒåªé€‚åˆé™åˆ¶å•æœºçº¿ç¨‹æ•°é‡ï¼Œå¹¶ä¸”ä»…æ˜¯é™åˆ¶çº¿ç¨‹æ•°ï¼Œè€Œä¸æ˜¯é™åˆ¶èµ„æºæ•°ï¼ˆä¾‹å¦‚è¿æ¥æ•°ï¼Œè¯·å¯¹æ¯” Tomcat LimitLatch çš„å®ç°ï¼‰</li>
<li>ç”¨ Semaphore å®ç°ç®€å•è¿æ¥æ± ï¼Œå¯¹æ¯”ã€äº«å…ƒæ¨¡å¼ã€ä¸‹çš„å®ç°ï¼ˆç”¨wait notify)ï¼Œæ€§èƒ½å’Œå¯è¯»æ€§æ˜¾ç„¶æ›´å¥½ï¼Œ</li>
</ul>
<p><strong>æ³¨æ„ä¸‹é¢çš„å®ç°ä¸­çº¿ç¨‹æ•°å’Œæ•°æ®åº“è¿æ¥æ•°æ˜¯ç›¸ç­‰çš„</strong></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">public class Pool &#123;</span><br><span class="line">    private final int poolSize;</span><br><span class="line">    private Connection[] connections;</span><br><span class="line">    private AtomicIntegerArray state;//0ç©ºé—²1å¿™</span><br><span class="line">    private Semaphore semaphore;</span><br><span class="line"></span><br><span class="line">    public Pool(int poolSize) &#123;</span><br><span class="line">        this.poolSize = poolSize;</span><br><span class="line">        this.connections = new Connection[poolSize];</span><br><span class="line">        this.state = new AtomicIntegerArray(new int[poolSize]);</span><br><span class="line">        this.semaphore = new Semaphore(poolSize);</span><br><span class="line">        for (int i = 0; i &lt; poolSize; i++) &#123;</span><br><span class="line">            connections[i] = new Mock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //å€Ÿè¿æ¥</span><br><span class="line">    public Connection borrow() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //è·å–è®¸å¯</span><br><span class="line">            semaphore.acquire();</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        for (int i = 0; i &lt; poolSize; i++) &#123;</span><br><span class="line">            if (state.get(i) == 0) &#123;</span><br><span class="line">                if (state.compareAndSet(i, 0, 1)) &#123;</span><br><span class="line">                    return connections[i];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //å½’è¿˜è¿æ¥</span><br><span class="line">    public void free(Connection connection) &#123;</span><br><span class="line">        for (int i = 0; i &lt; poolSize; i++) &#123;</span><br><span class="line">            if (connections[i] == connection) &#123;</span><br><span class="line">                state.set(i, 0);</span><br><span class="line">                //é‡Šæ”¾è®¸å¯</span><br><span class="line">                semaphore.release();</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>åŸç†è¾ƒä¸ºç®€å•ï¼Œè¿˜æ˜¯åŸºäºAQSï¼Œstateè®¾ç½®ä¸ºä¿¡å·é‡çš„å¤§å°</p>
</blockquote>
<h2 id="CountdownLatch"><a href="#CountdownLatch" class="headerlink" title="CountdownLatch"></a><strong>CountdownLatch</strong></h2><blockquote>
<p>æ˜¯ä¸€ä¸ªåŒæ­¥å·¥å…·ç±»ï¼Œå®ƒå…è®¸ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹æ‰§è¡Œå®Œåå†æ‰§è¡Œã€‚<br>å…¶ä¸­æ„é€ å‚æ•°ç”¨æ¥åˆå§‹åŒ–ç­‰å¾…è®¡æ•°å€¼ï¼ŒawaitO ç”¨æ¥ç­‰å¾…è®¡æ•°å½’é›¶ï¼ŒcountDownO ç”¨æ¥è®©è®¡æ•°å‡ä¸€</p>
</blockquote>
<h3 id="åº”ç”¨"><a href="#åº”ç”¨" class="headerlink" title="åº”ç”¨"></a><strong>åº”ç”¨</strong></h3><blockquote>
<p>åœºæ™¯1 ï¼šè®©å¤šä¸ªçº¿ç¨‹ç­‰å¾…ï¼Œæ¨¡æ‹Ÿå¹¶å‘ï¼Œè®©å¹¶å‘çº¿ç¨‹ä¸€èµ·æ‰§è¡Œ<br>åœºæ™¯2 ï¼šè®©å•ä¸ªçº¿ç¨‹ç­‰å¾…ï¼Œå¤šä¸ªçº¿ç¨‹(ä»»åŠ¡)å®Œæˆåï¼Œè¿›è¡Œæ±‡æ€»åˆå¹¶</p>
<ul>
<li>åº”ç”¨ç¨‹åºçš„ä¸»çº¿ç¨‹å¸Œæœ›åœ¨è´Ÿè´£å¯åŠ¨æ¡†æ¶æœåŠ¡çš„çº¿ç¨‹å·²ç»å¯åŠ¨æ‰€æœ‰æ¡†æ¶æœåŠ¡ä¹‹åæ‰§è¡Œã€‚</li>
<li>è¿œç¨‹è°ƒç”¨ä¸­ï¼Œå„è¿œç¨‹è°ƒç”¨å¹¶è¡Œæ‰§è¡Œç»“æŸåè¿è¡Œï¼Œä½†æ˜¯å¦‚æœæœ‰è¿”å›å€¼çš„è¯ï¼Œä½¿ç”¨futrueæ›´åˆé€‚äº›</li>
</ul>
</blockquote>
<p><strong>åœºæ™¯1</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">CountDownLatch countDownLatch = new CountDownLatch(1);</span><br><span class="line">for (int i = 0; i &lt; 5; i++) &#123;</span><br><span class="line">    new Thread(() -&gt; &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //å‡†å¤‡å®Œæ¯•â€¦â€¦è¿åŠ¨å‘˜éƒ½é˜»å¡åœ¨è¿™ï¼Œç­‰å¾…å·ä»¤</span><br><span class="line">            countDownLatch.await();</span><br><span class="line">            String parter = &quot;ã€&quot; + Thread.currentThread().getName() + &quot;ã€‘&quot;;</span><br><span class="line">            System.out.println(parter + &quot;å¼€å§‹æ‰§è¡Œâ€¦â€¦&quot;);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>åœºæ™¯2</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">CountDownLatch countDownLatch = new CountDownLatch(5);</span><br><span class="line">for (int i = 0; i &lt; 5; i++) &#123;</span><br><span class="line">    final int index = i;</span><br><span class="line">    new Thread(() -&gt; &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Thread.sleep(1000 + ThreadLocalRandom.current().nextInt(1000));</span><br><span class="line">            System.out.println(&quot;finish&quot; + index + Thread.currentThread().getName());</span><br><span class="line">            countDownLatch.countDown();</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="CyclicBarrier"><a href="#CyclicBarrier" class="headerlink" title="CyclicBarrier"></a>CyclicBarrier</h2><blockquote>
<p>å’ŒCountDownLatchç±»ä¼¼ï¼Œåªæ˜¯å‰è€…ä¸èƒ½é‡ç”¨ï¼Œåè€…è®¡æ•°ä¸º0åé‡æ–°å‡ä¼šå¤åŸå†å‡ï¼Œå¯ä»¥å¾ªç¯ä¸­é‡ç”¨<br>å¾ªç¯æ …æ ï¼Œç”¨æ¥è¿›è¡Œçº¿ç¨‹åä½œï¼Œç­‰å¾…çº¿ç¨‹æ»¡è¶³æŸä¸ªè®¡æ•°ã€‚æ„é€ æ—¶è®¾ç½®ã€è®¡æ•°ä¸ªæ•°ã€ï¼Œæ¯ä¸ªçº¿ç¨‹æ‰§è¡Œåˆ°æŸä¸ªéœ€<br>è¦åŒæ­¥çš„æ—¶åˆ»è°ƒç”¨ await() æ–¹æ³•è¿›è¡Œç­‰å¾…ï¼Œå½“ç­‰å¾…çš„çº¿ç¨‹æ•°æ»¡è¶³ã€è®¡æ•°ä¸ªæ•°ã€æ—¶ï¼Œç»§ç»­æ‰§è¡Œ</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">ExecutorService executorService = Executors.newFixedThreadPool(2);</span><br><span class="line">CyclicBarrier cyclicBarrier = new CyclicBarrier(2, () -&gt; &#123;</span><br><span class="line">    System.out.println(&quot;all end&quot;);</span><br><span class="line">&#125;);</span><br><span class="line">for (int i = 0; i &lt; 3; i++) &#123;</span><br><span class="line">    executorService.submit(()-&gt;&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            System.out.println(&quot;t1 start.....&quot;);</span><br><span class="line">            Thread.sleep(1000);</span><br><span class="line">            cyclicBarrier.await();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    executorService.submit(()-&gt;&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            System.out.println(&quot;t2 start.....&quot;);</span><br><span class="line">            Thread.sleep(2000);</span><br><span class="line">            cyclicBarrier.await();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">executorService.shutdown();</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ³¨æ„<br>çº¿ç¨‹æ•°å¿…é¡»å’Œè®¡æ•°ä¸€æ ·<br>cyclicBarrierçš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯æ¯æ¬¡æ±‡æ€»ç»“æœ</p>
</blockquote>
<h1 id="ConcurrentHashMap"><a href="#ConcurrentHashMap" class="headerlink" title="ConcurrentHashMap"></a><strong>ConcurrentHashMap</strong></h1><h2 id="å¯¹æ¯”"><a href="#å¯¹æ¯”" class="headerlink" title="å¯¹æ¯”"></a><strong>å¯¹æ¯”</strong></h2><blockquote>
<ul>
<li>Hashtable ä¸ ConcurrentHashMap éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„Map é›†åˆ</li>
<li>keyå’Œvuleéƒ½ä¸å¯ä»¥ä¸ºnull</li>
<li>Hashtable å¹¶å‘åº¦ä½ï¼Œæ•´ä¸ª Hashtable å¯¹åº”ä¸€æŠŠé”ï¼ŒåŒä¸€æ—¶åˆ»ï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ“ä½œå®ƒ</li>
<li>1.8 ä¹‹å‰ ConcurrentHashMap ä½¿ç”¨äº† Segment +æ•°ç»„ +é“¾è¡¨çš„ç»“æ„ï¼Œæ¯ä¸ª Segment å¯¹åº”ä¸€æŠŠé”ï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹è®¿é—®ä¸åŒçš„Segmentï¼Œåˆ™ä¸ä¼šå†²çª</li>
<li>1.8 å¼€å§‹ ConcurrentHashMap å°†æ•°ç»„çš„æ¯ä¸ªå¤´èŠ‚ç‚¹ä½œä¸ºé”ï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹è®¿é—®çš„å¤´èŠ‚ç‚¹ä¸åŒï¼Œåˆ™ä¸ä¼šå†²çª</li>
</ul>
</blockquote>
<h2 id="hashtable"><a href="#hashtable" class="headerlink" title="hashtable"></a><strong>hashtable</strong></h2><blockquote>
<ul>
<li>åˆå§‹å®¹é‡ä¸º11ï¼Œæ¯æ¬¡æ‰©å®¹*2+1</li>
<li>ä¸éœ€è¦2æ¬¡hash</li>
<li>çº¿ç¨‹å®‰å…¨æ€§ï¼šåœ¨hashmapçš„åŸºç¡€ä¸Šæ‰€æœ‰æ–¹æ³•ä½¿ç”¨synchronizedä¿®é¥°<img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-25_09.25.52.png" width="40%" loading="lazy"></li>
</ul>
</blockquote>
<h2 id="V1-7"><a href="#V1-7" class="headerlink" title="V1.7"></a><strong>V1.7</strong></h2><blockquote>
<p>å®¹å™¨ä¸­æœ‰å¤šæŠŠé”ï¼Œæ¯ä¸€æŠŠé”é”ä¸€æ®µæ•°æ®ï¼Œè¿™æ ·åœ¨å¤šçº¿ç¨‹è®¿é—®æ—¶ä¸åŒæ®µçš„æ•°æ®æ—¶ï¼Œå°±ä¸ä¼šå­˜åœ¨é”ç«äº‰äº†ï¼Œè¿™ æ ·ä¾¿å¯ä»¥æœ‰æ•ˆåœ°æé«˜å¹¶å‘æ•ˆç‡ã€‚<br><img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-25_09.26.12.png" width="40%" loading="lazy"><br><strong>åˆå§‹åŒ–</strong><br>æ„é€ å‡½æ•°å‚æ•°ï¼šcapacity ï¼Œfactor clevel<br>å®¹é‡/å¹¶å‘åº¦ = æ¯ä¸ªsegmentå†…æ•°ç»„å®¹é‡ï¼Œä½†æœ€å°ä¸å°äº2<br>é¥¿æ±‰å¼ï¼Œå…·ä½“åˆ›å»ºçœ‹ä¸‹é¢segment[0]åŸå‹<br><img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-25_14.33.38.png" width="40%" loading="lazy"><br><strong>ç´¢å¼•è®¡ç®—</strong><br>2æ¬¡hashåï¼Œé«˜nä½ å°±æ˜¯ segmentä½ç½®ï¼Œä½nä½ï¼Œå°±æ—¶segmentå†…æ•°ç»„æ¡¶çš„ä½ç½®<br><strong>æ‰©å®¹</strong><br>segmentä¸æ‰©å®¹ï¼Œåˆå§‹åŒ–æ—¶å°±å›ºå®šäº†ï¼Œæ‰©å®¹çš„åªæ˜¯segmentå†…çš„å°æ•°ç»„ï¼Œä¸”ç‹¬è‡ªæ‰©å®¹ï¼Œæ‰©å®¹è§„åˆ™å’Œhashmapä¸€æ ·<br><strong>segment[0]åŸå‹</strong><br>åˆå§‹åŒ–æ—¶ï¼Œåªä¼šåˆ›å»ºsegment[0],å…¶ä»–çš„segmentä¼šåœ¨æ·»åŠ å…ƒç´ æ—¶å¤åˆ¶segment[0]çš„åŸå‹æ¥åˆ›å»º<br>segment[0]åŸå‹æ‰©å®¹äº†ï¼Œåé¢æŒ‰ç…§segment[0]æ¥åˆ›å»ºçš„ä¹Ÿä¼šå’Œsegment[0]ä¸€æ ·å¤§å°</p>
</blockquote>
<h2 id="V1-8"><a href="#V1-8" class="headerlink" title="V1.8"></a><strong>V1.8</strong></h2><blockquote>
<p><strong>åˆå§‹åŒ–</strong><br>æ‡’æ±‰å¼ï¼Œç¬¬ä¸€æ¬¡æ·»åŠ å…ƒç´ æ—¶æ‰åˆ›å»º<br><strong>ç†è§£capacity ï¼Œfactor</strong><br>capacityä¸æ˜¯åˆå§‹åŒ–å®¹é‡äº†ï¼Œè€Œæ˜¯é¢„è®¡è¦æ”¾å¤šå°‘ä¸ªå…ƒç´ ï¼Œä¼šæ›´å…·è¿™ä¸ªå€¼å’Œfactoræ¥è°ƒæ•´ã€‚<br>ä¾‹å¦‚ï¼Œcapatity=11 factorä¸º0.5 ç¬¬ä¸€æ¬¡putæ—¶åˆå§‹å®¹é‡ä¸º32<br>factoråªåœ¨ç¬¬ä¸€æ¬¡åˆ›å»ºæ—¶æœ‰æ•ˆï¼Œåé¢æŒ‰ç…§0.75çš„æ‰©å®¹å› å­æ‰©å®¹<br><strong>å¹¶å‘put</strong><br>é”çš„åªæ˜¯é“¾è¡¨å¤´ï¼Œå½“è®¿é—®ä¸åŒæ¡¶ä¸‹æ ‡æ—¶ï¼Œä¸ä¼šå‡ºç°å¹¶å‘å®‰å…¨é—®é¢˜ï¼Œä¹Ÿä¸ä¼šä¸Šé”<br>å½“è®¿é—®æ¡¶ä¸‹æ ‡ç›¸åŒæ—¶ï¼Œä¼šè¢«é”é˜»å¡ï¼Œä¾æ¬¡æ‰§è¡Œ<br><strong>æ‰©å®¹</strong><br>æ‰©å®¹æ—¶ä»åå¾€å‰æ‰©å®¹ï¼Œæ‰©å®¹åä¼šæ ‡è®°ä¸ºforwardingNodeï¼Œè¡¨ç¤ºå·²ç»è¢«æ‰©å®¹ç§»åˆ°äº†æ–°æ•°ç»„ä¸­<br><img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-25_15.35.08.png" width="40%" loading="lazy"><br><strong>æ‰©å®¹get</strong></p>
<ul>
<li>å½“getè¢«forwardingNodeæ ‡è®°çš„å…ƒç´ ï¼Œåœ¨æ–°æ•°ç»„ä¸­æ‰¾ï¼Œ</li>
<li>å½“getæ­£åœ¨æ­£åœ¨æ‰©å®¹çš„ç»“ç‚¹æ—¶,å†æ—§æ•°ç»„ä¸­æ‰¾ã€‚</li>
<li>å½“getæ²¡æœ‰è¢«æ ‡è®°çš„ç»“ç‚¹æ—¶ï¼Œä¼šå¹¶å‘çš„åœ¨è€æ•°ç»„ä¸­è·å–ç»“ç‚¹çš„å…ƒç´ </li>
</ul>
<p><strong>æ³¨æ„ï¼šæ‰©å®¹é“¾è¡¨æ—¶ï¼Œä¼šå¤åˆ¶ä¸€ä»½ä¸åŒçš„æ–°çš„ç»“ç‚¹ï¼Œé˜²æ­¢ç»“ç‚¹æŒ‡å‘åç»­ç»“ç‚¹ä¸åŒï¼Œå¯¼è‡´æ•°æ®é”™ä¹±,é˜²æ­¢æ‰©å®¹getæ—¶getåˆ°çš„å¯¹è±¡ä¸ä¸€æ ·</strong><br><strong>æ‰©å®¹put</strong></p>
<ul>
<li>putè¢«forwardingNodeæ ‡è®°çš„å…ƒç´ ï¼Œä¼šå¸®åŠ©æ‰©å®¹çº¿ç¨‹æ‰©å®¹ï¼Œæ‰©å®¹å®Œæˆå†put</li>
<li>putæ­£åœ¨è¿ç§»çš„å‰åŠéƒ¨åˆ†ï¼ŒCASåŠ synchronizedå¤´ç»“ç‚¹æ¥ä¿è¯çº¿ç¨‹å®‰å…¨</li>
<li>putæ­£åœ¨è¿ç§»çš„éƒ¨åˆ†ï¼Œé‡è¯•ï¼Œç­‰è¿ç§»å½“å‰ç»“ç‚¹åï¼Œå¸®åŠ©è¿ç§»å†put</li>
</ul>
</blockquote>
<h2 id="LinkedBlockingQueue"><a href="#LinkedBlockingQueue" class="headerlink" title="LinkedBlockingQueue"></a><strong>LinkedBlockingQueue</strong></h2><h3 id="å…¥é˜Ÿå‡ºé˜ŸåŸç†"><a href="#å…¥é˜Ÿå‡ºé˜ŸåŸç†" class="headerlink" title="å…¥é˜Ÿå‡ºé˜ŸåŸç†"></a><strong>å…¥é˜Ÿå‡ºé˜ŸåŸç†</strong></h3><p><strong>å…¥é˜Ÿ</strong></p>
<blockquote>
<p>åˆå§‹åŒ–é“¾è¡¨ last = head = new NodeKE&gt;(nu1l);Dummy èŠ‚ç‚¹ç”¨æ¥å ä½ï¼Œitem ä¸º null</p>
</blockquote>
<img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-24_16.15.22.png" width="80%" loading="lazy">


<blockquote>
<p>å½“ä¸€ä¸ªèŠ‚ç‚¹å…¥é˜Ÿ 1ast = last.next = node;</p>
</blockquote>
<img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-24_16.15.28.png" width="80%" loading="lazy">

<blockquote>
<p>å†æ¥ä¸€ä¸ªèŠ‚ç‚¹å…¥é˜Ÿ last = last.next = node;</p>
</blockquote>
<img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-24_16.18.09.png" width="80%" loading="lazy">



<p><strong>å‡ºé˜Ÿ</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Node&lt;E&gt; h  = head;</span><br><span class="line">Node&lt;E&gt; frist = h.next;</span><br><span class="line">h.next = h ; <span class="comment">//help GC</span></span><br><span class="line">head = frist;</span><br><span class="line"><span class="type">E</span> <span class="variable">x</span> <span class="operator">=</span> frist.item;</span><br><span class="line">frist.item = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">return</span> x;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Node<E> h  = head;è®©ä¸€ä¸ªä¸´æ—¶hç»“ç‚¹æŒ‡å‘äºšå…ƒç»“ç‚¹</p>
</blockquote>
<img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-24_16.20.31.png" width="60%" loading="lazy">


<blockquote>
<p>Node<E> frist = h.next;è®©firstç»“ç‚¹æŒ‡å‘æ­£çœŸç¬¬ä¸€ä¸ªç»“ç‚¹</p>
</blockquote>
<img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-24_16.20.36.png" width="60%" loading="lazy">

<blockquote>
<p>h.next = h ; //help GC è®©äºšå…ƒç»“ç‚¹æŒ‡å‘è‡ªå·±ï¼Œä½¿å¾—GCå›æ”¶æ—¶æ²¡æœ‰è¢«GCRootæŒ‡å‘ï¼Œç›´æ¥å›æ”¶æ‰</p>
</blockquote>
<img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-24_16.26.45.png" width="60%" loading="lazy">



<blockquote>
<p>head = frist; å°†ç¬¬ä¸€ä¸ªç»“ç‚¹è¢«headæŒ‡å‘</p>
</blockquote>
<img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-24_16.26.57.png" width="60%" loading="lazy">


<blockquote>
<p>E x = frist.item;<br>frist.item = null;<br>return x;<br>å°†ç¬¬ä¸€ä¸ªå…ƒç´ çš„å†…å®¹å­˜èµ·æ¥,ç„¶åç½®ç©ºï¼Œå†è¿”å›ï¼Œè¿™æ ·ç¬¬ä¸€ä¸ªç»“ç‚¹åˆå˜ä¸ºäº†äºšå…ƒç»“ç‚¹äº†</p>
</blockquote>
<h3 id="åŠ é”åˆ†æ"><a href="#åŠ é”åˆ†æ" class="headerlink" title="åŠ é”åˆ†æ"></a><strong>åŠ é”åˆ†æ</strong></h3><blockquote>
<p>é«˜æ˜ä¹‹å¤„â€”åœ¨äºç”¨äº†ä¸¤æŠŠé”å’Œ dummy èŠ‚ç‚¹</p>
<ul>
<li>ç”¨ä¸€æŠŠé”ï¼ŒåŒä¸€æ—¶åˆ»ï¼Œæœ€å¤šåªå…è®¸æœ‰ä¸€ä¸ªçº¿ç¨‹ï¼ˆç”Ÿäº§è€…æˆ–æ¶ˆè´¹è€…ï¼ŒäºŒé€‰ä¸€ï¼‰æ‰§è¡Œ</li>
<li>ç”¨ä¸¤æŠŠé”ï¼ŒåŒä¸€æ—¶åˆ»ï¼Œå¯ä»¥å…è®¸ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ï¼ˆä¸€ä¸ªç”Ÿäº§è€…ä¸ä¸€ä¸ªæ¶ˆè´¹è€…ï¼‰æ‰§è¡Œ<br>æ¶ˆè´¹è€…ä¸æ¶ˆè´¹è€…çº¿ç¨‹ä»ç„¶ä¸²è¡Œ<br>ç”Ÿäº§è€…ä¸ç”Ÿäº§è€…çº¿ç¨‹ä»ç„¶ä¸²è¡Œ</li>
</ul>
</blockquote>
<blockquote>
<p><strong>çº¿ç¨‹å®‰å…¨åˆ†æ</strong></p>
<ul>
<li>å½“èŠ‚ç‚¹æ€»æ•°å¤§äº2æ—¶ï¼ˆåŒ…æ‹¬ dummy èŠ‚ç‚¹ï¼‰ï¼ŒputLock ä¿è¯çš„æ˜¯ last èŠ‚ç‚¹çš„çº¿ç¨‹å®‰å…¨ï¼ŒtakeLock ä¿è¯çš„æ˜¯head èŠ‚ç‚¹çš„çº¿ç¨‹å®‰å…¨ã€‚ä¸¤æŠŠé”ä¿è¯äº†å…¥é˜Ÿå’Œå‡ºé˜Ÿæ²¡æœ‰ç«äº‰</li>
<li>å½“èŠ‚ç‚¹æ€»æ•°ç­‰äº2æ—¶ï¼ˆå³ä¸€ä¸ª dummy èŠ‚ç‚¹ï¼Œä¸€ä¸ªæ­£å¸¸èŠ‚ç‚¹ï¼‰è¿™æ—¶å€™ï¼Œä»ç„¶æ˜¯ä¸¤æŠŠé”é”ä¸¤ä¸ªå¯¹è±¡ï¼Œä¸ä¼šç«äº‰</li>
<li>å½“èŠ‚ç‚¹æ€»æ•°ç­‰äº1æ—¶ï¼ˆå°±ä¸€ä¸ª dummy èŠ‚ç‚¹ï¼‰è¿™æ—¶ take çº¿ç¨‹ä¼šè¢« notEmpty æ¡ä»¶é˜»å¡ï¼Œæœ‰ç«äº‰ï¼Œä¼šé˜»å¡</li>
</ul>
</blockquote>
<p><strong>putåˆ†æ</strong></p>
<blockquote>
<p>ä¸èƒ½put nullå€¼<br>æ»¡äº†ä¼šé˜»å¡</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public void put(E e) throws InterruptedException &#123;</span><br><span class="line">    if (e == null) throw new NullPointerException();</span><br><span class="line">    int c = -1;</span><br><span class="line">    Node&lt;E&gt; node = new Node&lt;E&gt;(e);</span><br><span class="line">    //ä½¿ç”¨puté”</span><br><span class="line">    final ReentrantLock putLock = this.putLock;</span><br><span class="line">    //countç»´æŠ¤å…ƒç´ è®¡æ•°</span><br><span class="line">    final AtomicInteger count = this.count;</span><br><span class="line">    //å¯æ‰“æ–­</span><br><span class="line">    putLock.lockInterruptibly();</span><br><span class="line">    try &#123;</span><br><span class="line">        //é˜Ÿåˆ—æ»¡äº†ç­‰å¾…</span><br><span class="line">        while (count.get() == capacity) &#123;</span><br><span class="line">            notFull.await();</span><br><span class="line">        &#125;</span><br><span class="line">        //æœ‰ç©ºä½ï¼Œå…¥é˜Ÿè®¡æ•°--</span><br><span class="line">        enqueue(node);</span><br><span class="line">        c = count.getAndIncrement();</span><br><span class="line">        //é™¤äº†è‡ªå·±putä»¥å¤–ï¼Œé˜Ÿåˆ—è¿˜æœ‰ç©ºä½ï¼Œå«é†’ä¸€ä¸ªput</span><br><span class="line">        if (c + 1 &lt; capacity)</span><br><span class="line">            notFull.signal();</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        putLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    if (c == 0)</span><br><span class="line">        signalNotEmpty();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>takeåˆ†æ</strong></p>
<blockquote>
<p>takeå’Œputä¸€æ ·ï¼ŒåŠ çš„é”æ˜¯takeé”</p>
</blockquote>
<h3 id="æ€§èƒ½æ¯”è¾ƒ"><a href="#æ€§èƒ½æ¯”è¾ƒ" class="headerlink" title="æ€§èƒ½æ¯”è¾ƒ"></a><strong>æ€§èƒ½æ¯”è¾ƒ</strong></h3><blockquote>
<p>ä¸»è¦åˆ—ä¸¾ LinkedBlockingQueue ä¸ ArrayBlockingQueue çš„æ€§èƒ½æ¯”è¾ƒ</p>
<ul>
<li>Linked æ”¯æŒæœ‰ç•Œï¼ŒArray å¼ºåˆ¶æœ‰ç•Œ</li>
<li>Linked å®ç°æ˜¯é“¾è¡¨ï¼ŒArray å®ç°æ˜¯æ•°ç»„</li>
<li>Linked æ˜¯æ‡’æƒ…çš„ï¼Œè€Œ Array éœ€è¦æå‰åˆå§‹åŒ– Node æ•°ç»„</li>
<li>Linked æ¯æ¬¡å…¥é˜Ÿä¼šç”Ÿæˆæ–° Nodeï¼Œè€ŒArray çš„ Node æ˜¯æå‰åˆ›å»ºå¥½çš„</li>
<li>Linked ä¸¤æŠŠé”ï¼ŒArray ä¸€æŠŠé”</li>
</ul>
</blockquote>
<h2 id="ConcurrentLinkedQueue"><a href="#ConcurrentLinkedQueue" class="headerlink" title="ConcurrentLinkedQueue"></a><strong>ConcurrentLinkedQueue</strong></h2><blockquote>
<ul>
<li>ConcurrentLinkedQueue çš„è®¾è®¡ä¸ LinkedBlockingQueue éå¸¸åƒï¼Œä¹Ÿæ˜¯ä¸¤æŠŠã€é”ã€‘ï¼ŒåŒä¸€æ—¶åˆ»ï¼Œå¯ä»¥å…è®¸ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ï¼ˆä¸€ä¸ªç”Ÿäº§è€…ä¸ä¸€ä¸ªæ¶ˆè´¹è€…ï¼‰æ‰§è¡Œ</li>
<li>dummy èŠ‚ç‚¹çš„å¼•å…¥è®©ä¸¤æŠŠã€é”ã€‘å°†æ¥é”ä½çš„æ˜¯ä¸åŒå¯¹è±¡ï¼Œé¿å…ç«äº‰</li>
<li>åªæ˜¯è¿™ã€é”ã€‘ä½¿ç”¨äº† cas æ¥å®ç°</li>
</ul>
</blockquote>
<h2 id="CopyOnWriteArrayList"><a href="#CopyOnWriteArrayList" class="headerlink" title="CopyOnWriteArrayList"></a><strong>CopyOnWriteArrayList</strong></h2><blockquote>
<p>CopyonMriteArrayset æ˜¯å®ƒçš„é©¬ç”²<br>CopyonMriteArraysetåŒ…å«äº†ä¸€ä¸ªCopyOnWriteArrayListå¯¹è±¡ï¼Œä¸åŒçš„æ˜¯addæ—¶åˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼Œç›¸å½“äºè£…é¥°å™¨æ¨¡å¼ã€‚<br>åº•å±‚å®ç°é‡‡ç”¨äº† å†™å…¥æ—¶æ‹·è´ çš„æ€æƒ³ï¼Œå¢åˆ æ”¹æ“ä½œä¼šå°†åº•å±‚æ•°ç»„æ‹·è´ä¸€ä»½ï¼Œæ›´æ”¹æ“ä½œåœ¨æ–°æ•°ç»„ä¸Šæ‰§è¡Œï¼Œè¿™æ—¶ä¸å½±å“å…¶å®ƒçº¿ç¨‹çš„å¹¶å‘è¯»ï¼Œè¯»å†™åˆ†ç¦»ã€‚<br>ç›¸æ¯”äºä¹‹å‰è¯»å†™é”çš„è¯»è¯»å¹¶å‘ï¼Œè¯»å†™äº’æ–¥ï¼Œè¿™ä¸€å®ç°å¯ä»¥è¯»å†™å¹¶å‘ã€‚æ‰€æœ‰çš„è¯»æ“ä½œéƒ½æ˜¯æ— é”çš„.ä¸è¿‡ä¹Ÿå¯¼è‡´äº†å¼±ä¸€è‡´æ€§<br>ä»¥æ–°å¢ä¸ºä¾‹ï¼š</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public boolean add(E e) &#123;</span><br><span class="line">    final ReentrantLock lock = this.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    try &#123;</span><br><span class="line">        //è·å–æ—§æ•°ç»„</span><br><span class="line">        Object[] elements = getArray();</span><br><span class="line">        int len = elements.length;</span><br><span class="line">        //æ‹·è´æ–°æ•°ç»„ï¼ˆè¿™é‡Œæ˜¯æ¯”è¾ƒè€—æ—¶çš„æ“ä½œï¼Œä½†ä¸å½±å“å…¶ä»–è¯»çº¿ç¨‹ï¼‰</span><br><span class="line">        Object[] newElements = Arrays.copyOf(elements, len + 1);</span><br><span class="line">        //æ·»åŠ æ–°å…ƒç´ </span><br><span class="line">        newElements[len] = e;</span><br><span class="line">        //æ›¿æ¢æ—§çš„æ•°ç»„</span><br><span class="line">        setArray(newElements);</span><br><span class="line">        return true;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>getå¼±ä¸€è‡´æ€§</strong></p>
<img src="http://hexo.xuxin.world/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%2FiShot_2022-08-24_17.00.07.png" width="50%" loading="lazy">

<p><strong>è¿­ä»£å™¨å¼±ä¸€è‡´æ€§</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">CopyOnWriteArrayList&lt;Integer&gt; list = new CopyOnWriteArrayList&lt;&gt;();</span><br><span class="line">list.add(1);</span><br><span class="line">list.add(2);</span><br><span class="line">list.add(3);</span><br><span class="line">Iterator&lt;Integer&gt; iterator = list.iterator();</span><br><span class="line">new Thread(()-&gt;&#123;</span><br><span class="line">    list.remove(0);</span><br><span class="line">    System.out.println(list);</span><br><span class="line">&#125;).start();</span><br><span class="line">Thread.sleep(1000);</span><br><span class="line">while (iterator.hasNext())&#123;</span><br><span class="line">    System.out.print(iterator.next());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æ‰“å°ç»“æœ</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[2, 3]</span><br><span class="line">123</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ä¸è¦è§‰å¾—å¼±ä¸€è‡´æ€§å°±ä¸å¥½</p>
<ul>
<li>æ•°æ®åº“çš„ MVCC éƒ½æ˜¯å¼±ä¸€è‡´æ€§çš„è¡¨ç°</li>
<li>å¹¶å‘é«˜å’Œä¸€è‡´æ€§æ˜¯çŸ›ç›¾çš„ï¼Œéœ€è¦æƒè¡¡</li>
</ul>
</blockquote>
<h1 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a><strong>ThreadLocal</strong></h1><p><strong>æ ‡å‡†ä½¿ç”¨</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public class UserThreadLocal &#123;</span><br><span class="line">    private static ThreadLocal&lt;User&gt; tl = new ThreadLocal&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    public static void saveUser(User user)&#123;</span><br><span class="line">        tl.set(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static User getUser()&#123;</span><br><span class="line">        return tl.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void removeUser()&#123;</span><br><span class="line">        tl.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>è°ˆä¸€è°ˆå¯¹ ThreadLocal çš„ç†è§£</strong></p>
<ul>
<li>ThreadLocalå¯ä»¥å®ç°ã€èµ„æºå¯¹è±¡ã€‘çš„çº¿ç¨‹éš”ç¦»ï¼Œè®©æ¯ä¸ªçº¿ç¨‹å„ç”¨å„çš„ã€èµ„æºå¯¹è±¡ã€‘ï¼Œé¿å…äº‰ç”¨å¼•å‘çš„çº¿ç¨‹å®‰å…¨é—®é¢˜</li>
<li>ThreadLocal åŒæ—¶å®ç°äº†çº¿ç¨‹å†…çš„èµ„æºå…±äº«</li>
</ul>
</blockquote>
<blockquote>
<p><strong>ThreadLocalä¸ThreadLocalMapå…³ç³»</strong><br>å…¶åŸç†æ˜¯ï¼Œæ¯ä¸ªçº¿ç¨‹å†…æœ‰ä¸€ä¸ª ThreadLocalMap ç±»å‹çš„æˆå‘˜å˜é‡ï¼Œç”¨æ¥å­˜å‚¨èµ„æºå¯¹è±¡</p>
<ul>
<li>è°ƒç”¨ set æ–¹æ³•ï¼Œå°±æ˜¯ä»¥ ThreadLocal è‡ªå·±ä½œä¸º keyï¼Œèµ„æºå¯¹è±¡ä½œä¸º valueï¼Œæ”¾å…¥å½“å‰çº¿ç¨‹çš„ ThreadLocalMap é›†åˆä¸­</li>
<li>è°ƒç”¨ get æ–¹æ³•ï¼Œå°±æ˜¯ä»¥ ThreadLocal è‡ªå·±ä½œä¸º keyï¼Œåˆ°å½“å‰çº¿ç¨‹ä¸­æŸ¥æ‰¾å…³è”çš„èµ„æºå€¼</li>
<li>è°ƒç”¨ remove æ–¹æ³•ï¼Œå°±æ˜¯ä»¥ ThreadLocal è‡ªå·±ä½œä¸º keyï¼Œç§»é™¤å½“å‰çº¿ç¨‹å…³è”çš„èµ„æºå€¼</li>
</ul>
</blockquote>
<blockquote>
<p><strong>hashå€¼æ€ä¹ˆè®¡ç®—</strong><br>ç¬¬ä¸€æ¬¡æ˜¯0ï¼Œåé¢æ¯æ¬¡ç´¯è®¡ä¸€ä¸ªæ•°å­—ä½œä¸ºhashå€¼</p>
</blockquote>
<blockquote>
<p><strong>æ‰©å®¹</strong><br>åˆå§‹16ï¼Œå½“è¶…è¿‡2/3æ—¶æ‰©å®¹</p>
</blockquote>
<blockquote>
<p><strong>hashå†²çªæ€ä¹ˆè§£å†³</strong><br>å†²çªæ—¶ï¼Œä¸æ–­æ‰¾ä¸‹ä¸€ä¸ªï¼Œç›´åˆ°è¿™ä¸ªä½ç½®æ²¡æœ‰å…ƒç´ </p>
</blockquote>
<blockquote>
<p><strong>ä¸ºä»€ä¹ˆkeyè®¾ç½®ä¸ºå¼±å¼•ç”¨</strong><br>çº¿ç¨‹æœ‰æ—¶éœ€è¦é•¿æ—¶é—´è¿è¡Œï¼Œæ¯”å¦‚çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ï¼Œå› ä¸ºæ‹…å¿ƒç¨‹åºå‘˜æ²¡æœ‰è‰¯å¥½çš„ç¼–ç¨‹ä¹ æƒ¯ï¼Œç”¨å®Œä¸å›æ”¶ï¼Œæ‰€ä»¥è®¾ç½®å¼±å¼•ç”¨ä½¿å¾—å°†æ¥æ²¡æœ‰è¢«å¼•ç”¨æ—¶ï¼Œè¢«åƒåœ¾å›æ”¶æ‰<br>ä½† GC ä»…æ˜¯è®© key çš„å†…å­˜é‡Šæ”¾ï¼Œåç»­è¿˜è¦æ ¹æ® key æ˜¯å¦ä¸º null æ¥è¿›ä¸€æ­¥é‡Šæ”¾å€¼çš„å†…å­˜ï¼Œé‡Šæ”¾æ—¶æœºæœ‰</p>
<ul>
<li>è·å– key å‘ç° null key , ä¼šä½¿valueä¸ºnull ï¼Œå¹¶ä¸”æ·»åŠ ä¸€ä¸ªkeyåœ¨è¯¥ä½ç½®ä¸Š </li>
<li>set key æ—¶ï¼Œä¼šä½¿ç”¨å¯å‘å¼æ‰«æï¼Œæ¸…é™¤ä¸´è¿‘çš„ null keyï¼Œå¯å‘æ¬¡æ•°ä¸å…ƒç´ ä¸ªæ•°å’Œæ˜¯å¦å‘ç° null key æœ‰å…³</li>
<li>ä¸»åŠ¨ remove æ—¶ï¼ˆæ¨èï¼‰ï¼Œå› ä¸ºä¸€èˆ¬ä½¿ç”¨ ThreadLocal æ—¶éƒ½æŠŠå®ƒä½œä¸ºé™æ€å˜é‡ï¼Œå› æ­¤ GC æ— æ³•å›æ”¶<br>æ³¨æ„ï¼šThreadLocalçš„putä¸å…¶ä»–mapä¸ä¸€æ ·ï¼Œå½“å‘ç°keyä¸ºnullæ—¶ï¼Œå°†valueè®¾ç½®ä¸ºnull ï¼Œ å¹¶å°†keyè®¾ç½®</li>
</ul>
</blockquote>
<h1 id="çº¿ç¨‹é€šä¿¡"><a href="#çº¿ç¨‹é€šä¿¡" class="headerlink" title="çº¿ç¨‹é€šä¿¡"></a><strong>çº¿ç¨‹é€šä¿¡</strong></h1>
<div class="markmap-container" style="height:400px">
  <svg data="{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:1,&quot;p&quot;:{&quot;lines&quot;:[1,2]},&quot;v&quot;:&quot;çº¿ç¨‹é€šä¿¡&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[2,3]},&quot;v&quot;:&quot;volatile&quot;},{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[3,4]},&quot;v&quot;:&quot;wait()å’Œnotify()&quot;},{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[4,5]},&quot;v&quot;:&quot;CountDownLatch&quot;},{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[5,6]},&quot;v&quot;:&quot;parkå’Œunpark&quot;},{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[6,7]},&quot;v&quot;:&quot;join&quot;},{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[7,8]},&quot;v&quot;:&quot;interrupt&quot;},{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[8,9]},&quot;v&quot;:&quot;ç®¡é“è¾“å…¥/è¾“å‡ºæµ&quot;}]}"></svg>
</div>



<h1 id="CompletableFuture"><a href="#CompletableFuture" class="headerlink" title="CompletableFuture"></a><strong>CompletableFuture</strong></h1><h2 id="Futureæ¥å£"><a href="#Futureæ¥å£" class="headerlink" title="Futureæ¥å£"></a><strong>Futureæ¥å£</strong></h2><blockquote>
<p>å®šä¹‰äº†ä¸€ç³»åˆ—å¼‚æ­¥ä»»åŠ¡æ¥å£</p>
</blockquote>
<table>
<thead>
<tr>
<th>è¿”å›å€¼</th>
<th>å‡½æ•°å</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>boolean</td>
<td>cancel(boolean)</td>
<td>å–æ¶ˆ</td>
</tr>
<tr>
<td>boolean</td>
<td>isCancelled(boolean)</td>
<td>æ˜¯å¦å–æ¶ˆ</td>
</tr>
<tr>
<td>Boolean</td>
<td>isDone()</td>
<td>æ˜¯å¦å®Œæˆ</td>
</tr>
<tr>
<td>V</td>
<td>get()</td>
<td>è·å–</td>
</tr>
<tr>
<td>V</td>
<td>get(long,TimeUnit)</td>
<td>æœ‰æ—¶é™è·å–</td>
</tr>
</tbody></table>
<h2 id="Futurntask"><a href="#Futurntask" class="headerlink" title="Futurntask"></a><strong>Futurntask</strong></h2><blockquote>
<p>Runableæ— è¿”å›å€¼ï¼Œæ²¡æœ‰æŠ›å¼‚å¸¸<br>Callableæœ‰è¿”å›å€¼ï¼ŒæŠ›å¼‚å¸¸</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Demo1</span> <span class="keyword">implements</span> <span class="title class_">Callable</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Demo2</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>å¦‚ä½•å®ç°</strong><br>FutureTaskå®ç°äº†Runableï¼ŒFutureæ¥å£ï¼Œå¹¶ä¸”å…¥å‚ä¼ ä¸€ä¸ªCallableæ¥å£ï¼Œæ„é€ æ³¨å…¥<br>ç¼ºç‚¹</p>
<ol>
<li>geté˜»å¡åç»­ä»£ç ,å»ºè®®æ”¾åœ¨æœ€åï¼Œä¸€ä½†è°ƒç”¨ï¼Œç¨‹åºç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œåç»­ä»£ç ç­‰å¾…</li>
<li>ä¸æƒ³geté˜»å¡è·å–,å¯ä»¥ä½¿ç”¨isDoneæ¥åˆ¤æ–­æ˜¯å¦å®Œæˆï¼Œæ¥è½®è¯¢ï¼Œä½†è¿™æ ·ä¼šå ç”¨cpuèµ„æºï¼Œå¹¶ä¸”ä¹Ÿä¸èƒ½ç©ºå‡ºæ¥è®©å…¶ä»–ä»£ç è¿è¡Œ<br>æ€»ä¹‹ï¼ŒFutureTaskå¯¹ç»“æœè·å–ä¸æ˜¯å¤ªå‹å¥½</li>
</ol>
<p><strong>æƒ³å®Œæˆä¸€äº›å¤æ‚ä»»åŠ¡ï¼Ÿ</strong></p>
<ul>
<li>å›è°ƒé€šçŸ¥,å®Œæˆåç»™å‡ºç›¸åº”çš„ç›¸åº”ï¼Œæ¯”å¦‚è¿è¡Œæ—¶é—´</li>
<li>å¤šä¸ªä»»åŠ¡å‰åä¾èµ–ï¼ˆæ°´ç…®é±¼ï¼‰</li>
<li>å¯¹è®¡ç®—é€Ÿåº¦é€‰æœ€å¿«çš„ï¼Œå½“Futureé›†åˆä¸­æŸä¸ªä»»åŠ¡ç»“æŸäº†ï¼Œé€‰æœ€å¿«å®Œæˆçš„é‚£ä¸€ä¸ª</li>
</ul>
</blockquote>
<h2 id="CompletableFuture-1"><a href="#CompletableFuture-1" class="headerlink" title="CompletableFuture"></a><strong>CompletableFuture</strong></h2><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a><strong>ä»‹ç»</strong></h3><blockquote>
<p>ç”±äºFutureTaskçš„é˜»å¡æ–¹å¼å’Œå¼‚æ­¥ç¼–ç¨‹è®¾è®¡ç†å¿µç›¸è¿èƒŒï¼Œè€Œè½®è¯¢çš„æ–¹å¼ä¼šè€—è´¹æ— è°“çš„cpuèµ„æºï¼Œå› æ­¤jdk8è®¾è®¡å‡ºCompletableFutrue<br>CompletableFutureæä¾›äº†ä¸€ç§è§‚å¯Ÿè€…æ¨¡å¼ç±»ä¼¼çš„æœºåˆ¶ï¼Œå¯ä»¥è®©ä»»åŠ¡æ‰§è¡Œå®Œæˆåé€šçŸ¥ç›‘å¬çš„ä¸€æ–¹ã€‚<br>Java8å¼€å§‹å¼•å…¥CompletableFutureï¼Œå®ƒæ˜¯Futureçš„å¢å¼ºç‰ˆï¼Œå‡å°‘é˜»å¡å’Œè½®è¯¢,å¯ä»¥ä¼ å…¥å›è°ƒå¯¹è±¡ï¼Œå½“å²¸æ­¥ä»»åŠ¡å®Œæˆæˆ–è€…å‘ç”Ÿå¼‚å¸¶æ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨å›è°ƒå¯¹è±¡çš„å›è°ƒæ–¹æ³•</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CompletableFuture</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Future</span>&lt;T&gt;, CompletionStage&lt;T&gt; </span><br></pre></td></tr></table></figure>

<h3 id="CompletionStageæ¥å£"><a href="#CompletionStageæ¥å£" class="headerlink" title="CompletionStageæ¥å£"></a><strong>CompletionStageæ¥å£</strong></h3><blockquote>
<p><strong>æ¥å£ä»‹ç»</strong><br>CompletionStageä»£è¡¨å¼‚æ­¥è®¡ç®—è¿‡ç¨‹ä¸­çš„æŸä¸€ä¸ªé˜¶æ®µï¼Œä¸€ä¸ªé˜¶æ®µå®Œæˆä»¥åå¯èƒ½ä¼šå‡ºå‘å¦å¤–ä¸€ä¸ªé˜¶æ®µ<br>ä¸€ä¸ªé˜¶æ®µçš„æ‰§è¡Œå¯èƒ½æ˜¯è¢«è€½æé˜¶æ®µçš„å®Œæˆè§¦å‘ï¼Œä¹Ÿå¯èƒ½æ˜¯ç”±å¤šä¸ªé˜¶æ®µä¸€èµ·è§¦å‘</p>
</blockquote>
<h3 id="CompletableFutureä½¿ç”¨"><a href="#CompletableFutureä½¿ç”¨" class="headerlink" title="CompletableFutureä½¿ç”¨"></a><strong>CompletableFutureä½¿ç”¨</strong></h3><h4 id="åˆ›å»º"><a href="#åˆ›å»º" class="headerlink" title="åˆ›å»º"></a><strong>åˆ›å»º</strong></h4><blockquote>
<p>æ­¤å¤„ä¸æ¨èç›´æ¥newï¼Œåº”è¯¥ä½¿ç”¨4ç§é™æ€çš„æ–¹æ³•åˆ›å»ºï¼Œå› ä¸ºç›´æ¥newçš„åŠŸèƒ½ä¸å®Œå–„</p>
<ul>
<li>æ— è¿”å›å€¼ï¼Œæ— çº¿ç¨‹æ± AsyncRun(Runable),ä½¿ç”¨é»˜è®¤çš„ForkJoinçº¿ç¨‹æ± </li>
<li>æ— è¿”å›å€¼ï¼Œæœ‰çº¿ç¨‹æ± AsyncRun(Runableï¼ŒExecutor)ï¼Œä½¿ç”¨æŒ‡å®šçš„çº¿ç¨‹æ± </li>
<li>æœ‰è¿”å›å€¼ï¼Œæ— çº¿ç¨‹æ± supplyAsync(Supplier),ä½¿ç”¨é»˜è®¤çš„ForkJoinçº¿ç¨‹æ± </li>
<li>æœ‰è¿”å›å€¼ï¼Œæœ‰çº¿ç¨‹æ± supplyAsync(Supplier,Executor)ï¼Œä½¿ç”¨æŒ‡å®šçš„çº¿ç¨‹æ± </li>
</ul>
</blockquote>
<h4 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a><strong>åŸºæœ¬ä½¿ç”¨</strong></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">CompletableFuture</span> <span class="variable">future</span> <span class="operator">=</span> CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;come in...&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;sadsa&quot;</span>;</span><br><span class="line">&#125;).whenCompleteAsync((v, e) -&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (e==<span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;é˜¶æ®µäºŒæ”¶åˆ°ï¼š&quot;</span> + v);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).exceptionally((e) -&gt; &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;);</span><br><span class="line">System.out.println(<span class="string">&quot;sadsad&quot;</span>);</span><br><span class="line">Thread.sleep(<span class="number">2000</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¾“å‡º<br>come inâ€¦<br>sadsad<br>é˜¶æ®µäºŒæ”¶åˆ°ï¼šsadsa</p>
</blockquote>
<blockquote>
<p><strong>æ³¨æ„</strong><br>ç¤ºä¾‹é‡‡ç”¨é»˜è®¤çº¿ç¨‹æ± ï¼Œä¼šè‡ªåŠ¨å…³é—­ï¼Œé‡‡ç”¨è‡ªå·±çš„çº¿ç¨‹æ± éœ€è¦æ‰‹åŠ¨å®Œæ¯•<br>ä½¿ç”¨CompletableFutureåˆ›å»ºçš„ä»»åŠ¡æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œå½“ä¸»çº¿ç¨‹ç»“æŸæ—¶ï¼Œç›´æ¥å…³é—­</p>
</blockquote>
<h4 id="getå’ŒjoinåŒºåˆ«"><a href="#getå’ŒjoinåŒºåˆ«" class="headerlink" title="getå’ŒjoinåŒºåˆ«"></a><strong>getå’ŒjoinåŒºåˆ«</strong></h4><blockquote>
<p>getå¸¸è§„è·å–è¿”å›å€¼ï¼Œç¼–è¯‘æ—¶å¿…é¡»æ‰‹åŠ¨å¤„ç†æŠ›å‡ºå¼‚å¸¸<br>joinç”¨æ³•ä¸€æ ·ï¼Œåªæ˜¯ç¼–è¯‘æ—¶å¯ä»¥ä¸å¤„ç†</p>
</blockquote>
<h4 id="æµå¼ç¼–ç¨‹-ComletableFutureæ€§èƒ½ä¼˜åŒ–"><a href="#æµå¼ç¼–ç¨‹-ComletableFutureæ€§èƒ½ä¼˜åŒ–" class="headerlink" title="æµå¼ç¼–ç¨‹+ComletableFutureæ€§èƒ½ä¼˜åŒ–"></a><strong>æµå¼ç¼–ç¨‹+ComletableFutureæ€§èƒ½ä¼˜åŒ–</strong></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Double&gt; list = Arrays.asList(</span><br><span class="line">        ThreadLocalRandom.current().nextDouble() + <span class="string">&quot;mysql&quot;</span>.charAt(<span class="number">0</span>),</span><br><span class="line">        ThreadLocalRandom.current().nextDouble() + <span class="string">&quot;mysql&quot;</span>.charAt(<span class="number">0</span>),</span><br><span class="line">        ThreadLocalRandom.current().nextDouble() + <span class="string">&quot;mysql&quot;</span>.charAt(<span class="number">0</span>),</span><br><span class="line">        ThreadLocalRandom.current().nextDouble() + <span class="string">&quot;mysql&quot;</span>.charAt(<span class="number">0</span>),</span><br><span class="line">        ThreadLocalRandom.current().nextDouble() + <span class="string">&quot;mysql&quot;</span>.charAt(<span class="number">0</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">List&lt;String&gt; collect = list.stream()</span><br><span class="line">        .map(e -&gt; String.format(<span class="string">&quot;mysql &quot;</span> + <span class="string">&quot; price is %.2f&quot;</span>, e, e))</span><br><span class="line">        .collect(Collectors.toList());</span><br><span class="line"><span class="keyword">for</span> (String s : collect) &#123;</span><br><span class="line">    System.out.println(s);</span><br><span class="line">&#125;</span><br><span class="line">System.out.println((System.currentTimeMillis() - start));</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;============================================&quot;</span>);</span><br><span class="line"></span><br><span class="line">start = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">List&lt;String&gt; collect2 = list.stream()</span><br><span class="line">        .map(e -&gt; CompletableFuture.supplyAsync(() -&gt; String.format(<span class="string">&quot;mysql &quot;</span> + <span class="string">&quot; price is %.2f&quot;</span>, e, e)))</span><br><span class="line">        .collect(Collectors.toList())</span><br><span class="line">        .stream().map(s -&gt; s.join())</span><br><span class="line">        .collect(Collectors.toList());</span><br><span class="line"><span class="keyword">for</span> (String s : collect2) &#123;</span><br><span class="line">    System.out.println(s);</span><br><span class="line">&#125;</span><br><span class="line">System.out.println((System.currentTimeMillis() - start));</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>è¾“å‡º</strong><br>mysql  price is 109.26<br>mysql  price is 109.00<br>mysql  price is 109.03<br>mysql  price is 109.99<br>mysql  price is 109.40<br>141<br>============================================<br>mysql  price is 109.26<br>mysql  price is 109.00<br>mysql  price is 109.03<br>mysql  price is 109.99<br>mysql  price is 109.40<br>8</p>
</blockquote>
<h4 id="API"><a href="#API" class="headerlink" title="API"></a><strong>API</strong></h4>
<div class="markmap-container" style="height:300px">
  <svg data="{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:1,&quot;p&quot;:{&quot;lines&quot;:[2,3]},&quot;v&quot;:&quot;è·å¾—ç»“æœå’Œè§¦å‘è®¡ç®—&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[3,4]},&quot;v&quot;:&quot;è·å–ç»“æœ&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:3,&quot;p&quot;:{&quot;lines&quot;:[4,5]},&quot;v&quot;:&quot;public T get()&quot;},{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:3,&quot;p&quot;:{&quot;lines&quot;:[5,6]},&quot;v&quot;:&quot;public T get(long timeout ,TimeUnit unit)&quot;},{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:3,&quot;p&quot;:{&quot;lines&quot;:[6,7]},&quot;v&quot;:&quot;public T join()&quot;},{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:3,&quot;p&quot;:{&quot;lines&quot;:[7,8]},&quot;v&quot;:&quot;public T getNow(T valueIfAbsent)&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[8,9],&quot;f&quot;:true},&quot;v&quot;:&quot;ç«‹å³è·å–ç»“æœï¼Œå¦‚æœæ²¡æœ‰å®Œæˆåˆ™è¿”å›ç»™çš„é»˜è®¤å€¼&quot;}]}]},{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[9,10]},&quot;v&quot;:&quot;ä¸»åŠ¨è§¦å‘è®¡ç®—&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:3,&quot;p&quot;:{&quot;lines&quot;:[10,11]},&quot;v&quot;:&quot;public boolean complete(T value)&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[11,12],&quot;f&quot;:true},&quot;v&quot;:&quot;ä¸»åŠ¨æ‰“æ–­ï¼Œå¦‚æœè¿è¡Œå®Œæˆï¼Œè¿”å›falseï¼Œjoinåæ­£å¸¸è¿”å›ç»“æœ&quot;},{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[12,13],&quot;f&quot;:true},&quot;v&quot;:&quot;ä¸»åŠ¨æ‰“æ–­ï¼Œå¦‚æœæ²¡æœ‰è¿è¡Œå®Œæˆï¼Œè¿”å›trueï¼Œjoinåè¿”å›é»˜è®¤å€¼&quot;},{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[13,14],&quot;f&quot;:true},&quot;v&quot;:&quot;System.out.println(future.complete(&amp;quot;asd&amp;quot;)+&amp;quot;\\t&amp;quot; +future.join());&quot;}]}]},{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[14,15]},&quot;v&quot;:&quot;å¯¹è®¡ç®—ç»“æœè¿›è¡Œå¤„ç†&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:3,&quot;p&quot;:{&quot;lines&quot;:[15,16]},&quot;v&quot;:&quot;thenApply&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[16,17],&quot;f&quot;:true},&quot;v&quot;:&quot;è®¡ç®—ç»“æœå­˜åœ¨ä¾èµ–å…³ç³»ï¼Œè¿™ä¿©ä¸ªçº¿ç¨‹ä¸²è¡ŒåŒ–&quot;},{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[17,18],&quot;f&quot;:true},&quot;v&quot;:&quot;ç”±äºå­˜åœ¨ä¾èµ–å…³ç³»ï¼Œå½“å‰æ­¥éª¤å‡ºé”™ï¼Œä¸èµ°ä¸‹ä¸€æ­¥&quot;}]},{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:3,&quot;p&quot;:{&quot;lines&quot;:[18,19]},&quot;v&quot;:&quot;handle&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[19,20],&quot;f&quot;:true},&quot;v&quot;:&quot;æœ‰å¼‚å¸¸ä¹Ÿå¯ä»¥å¾€ä¸‹ä¸€æ­¥èµ°ï¼Œæ ¹æ®å¸¦å¸¦å¼‚å¸¸å‚æ•°å¯ä»¥è¿›ä¸€æ­¥å¤„ç†&quot;}]}]},{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[20,21]},&quot;v&quot;:&quot;å¯¹è®¡ç®—ç»“æœè¿›è¡Œæ¶ˆè´¹&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:3,&quot;p&quot;:{&quot;lines&quot;:[21,22]},&quot;v&quot;:&quot;thenAccpet&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[22,23],&quot;f&quot;:true},&quot;v&quot;:&quot;æœ‰ä¼ å‚ï¼Œæ— è¿”å›å€¼&quot;}]}]},{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[23,24]},&quot;v&quot;:&quot;é¡ºåºä¾æ¬¡æ‰§è¡Œ&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:3,&quot;p&quot;:{&quot;lines&quot;:[24,25]},&quot;v&quot;:&quot;thenRun&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[25,26],&quot;f&quot;:true},&quot;v&quot;:&quot;æ— ä¼ å‚ï¼Œæ— è¿”å›å€¼ï¼Œåœ¨ä¸Šä¸€æ­¥å®Œæˆåæ‰§è¡Œ&quot;}]}]},{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[26,27]},&quot;v&quot;:&quot;å¯¹è®¡ç®—é€Ÿåº¦è¿›è¡Œé€‰ç”¨&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:3,&quot;p&quot;:{&quot;lines&quot;:[27,28]},&quot;v&quot;:&quot;applyToEither&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[28,29],&quot;f&quot;:true},&quot;v&quot;:&quot;åé¢æœ‰è¯¦è§£&quot;},{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[29,30],&quot;f&quot;:true},&quot;v&quot;:&quot;A.applyToEither(B,function);&quot;}]}]},{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:2,&quot;p&quot;:{&quot;lines&quot;:[30,31]},&quot;v&quot;:&quot;å¯¹è®¡ç®—ç»“æœè¿›è¡Œåˆå¹¶&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:3,&quot;p&quot;:{&quot;lines&quot;:[31,32]},&quot;v&quot;:&quot;thenCombine&quot;,&quot;c&quot;:[{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[32,33],&quot;f&quot;:true},&quot;v&quot;:&quot;åé¢æœ‰è®²è§£&quot;},{&quot;t&quot;:&quot;heading&quot;,&quot;d&quot;:4,&quot;p&quot;:{&quot;lines&quot;:[33,34],&quot;f&quot;:true},&quot;v&quot;:&quot;A.thenCombine(B,BiFunction)&quot;}]}]}]}"></svg>
</div>


<blockquote>
<p>æ³¨æ„<br>APIä¸­å¸¦Asyncå’Œä¸å¸¦çš„åŒºåˆ«ï¼Œå¸¦çš„å½“ä¼ å…¥ä¸€ä¸ªè‡ªå®šä¹‰çº¿ç¨‹æ± æ—¶ï¼Œåç»­çš„ä»ç„¶ç”¨é»˜è®¤çº¿ç¨‹æ± ï¼Œä¸å¸¦çš„åˆ™ä¸€ç›´æ²¿ç”¨ä¸Šä¸€ä¸ª</p>
</blockquote>
<p><strong>å¯¹è®¡ç®—é€Ÿåº¦è¿›è¡Œé€‰ç”¨</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">CompletableFuture</span> <span class="variable">future</span> <span class="operator">=</span> CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;come in...&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;A&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="type">CompletableFuture</span> <span class="variable">future2</span> <span class="operator">=</span> CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;come in...&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;B&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="type">CompletableFuture</span> <span class="variable">future1</span> <span class="operator">=</span> future.applyToEither(future2, f -&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> f + <span class="string">&quot; win&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line">System.out.println(future1.join());</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>å¯¹è®¡ç®—é€Ÿåº¦è¿›è¡Œåˆå¹¶</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">CompletableFuture</span> <span class="variable">future</span> <span class="operator">=</span> CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;A&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="type">CompletableFuture</span> <span class="variable">future2</span> <span class="operator">=</span> CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;B&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="type">CompletableFuture</span> <span class="variable">future1</span> <span class="operator">=</span> future.thenCombine(future2, (x,y) -&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> x+<span class="string">&quot;,&quot;</span>+y;</span><br><span class="line">&#125;);</span><br><span class="line">System.out.println(future1.join());</span><br></pre></td></tr></table></figure>



<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css"></div></section><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="æ‰“èµ" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><span class="icon iconify" data-icon="ri:hand-coin-line"></span></span><div id="reward-comment">I'm so cute. Please give me money.</div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>æœ¬æ–‡ä½œè€…ï¼š</strong>å¾é‘«</li><li class="post-copyright-link"><strong>æœ¬æ–‡é“¾æ¥ï¼š</strong><a href="http://example.com/2022/08/08/JUC/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" title="JUCå¹¶å‘ç¼–ç¨‹">http://example.com/2022/08/08/JUC/JUC%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/</a></li><li class="post-copyright-license"><strong>ç‰ˆæƒå£°æ˜ï¼š</strong>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é»˜è®¤é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><span class="icon iconify" data-icon="ri:creative-commons-line"></span><span class="icon iconify" data-icon="ri:creative-commons-by-line"></span><span class="icon iconify" data-icon="ri:creative-commons-nc-line"></span><span class="icon iconify" data-icon="ri:creative-commons-sa-line"></span></a> è®¸å¯åè®®ã€‚</li></ul></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2022/08/10/JUC/JUC%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="prev" title="JUCè®¾è®¡æ¨¡å¼"><span class="icon iconify" data-icon="ri:arrow-left-s-line"></span><span class="post-nav-text">JUCè®¾è®¡æ¨¡å¼</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2022/08/05/JVM/JVM/" rel="next" title="JVM"><span class="post-nav-text">JVM</span><span class="icon iconify" data-icon="ri:arrow-right-s-line"></span></a></div></div></div><div class="hty-card" id="comment"></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 â€“ 2022 </span><span class="with-love" id="animate"><span class="icon iconify" data-icon="ri:cloud-line"></span></span><span class="author"> å¾é‘«</span></div></footer></div><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><span class="icon iconify" data-icon="ri:arrow-up-s-line"></span><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><script src="/js/markmap.js"></script></body></html>